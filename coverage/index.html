<!DOCTYPE html>
<html xmlns='http://www.w3.org/1999/xhtml'>
  <head>
    <title>Code coverage for Kiwari-engine</title>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <script src='./assets/0.10.2/application.js' type='text/javascript'></script>    
    <link href='./assets/0.10.2/application.css' media='screen, projection, print' rel='stylesheet' type='text/css'>
    <link rel="shortcut icon" type="image/png" href="./assets/0.10.2/favicon_red.png" />
    <link rel="icon" type="image/png" href="./assets/0.10.2/favicon.png" />
  </head>
  
  <body>
    <div id="loading">
      <img src="./assets/0.10.2/loading.gif" alt="loading"/>
    </div>
    <div id="wrapper" style="display:none;">
      <div class="timestamp">Generated <abbr class="timeago" title="2019-06-12T14:34:27+07:00">2019-06-12T14:34:27+07:00</abbr></div>
      <ul class="group_tabs"></ul>

      <div id="content">
        <div class="file_list_container" id="AllFiles">
  <h2>
    <span class="group_name">All Files</span>
    (<span class="covered_percent"><span class="red">55.95%</span></span>
     covered at
     <span class="covered_strength">
       <span class="green">
         4.55
       </span>
    </span> hits/line)
  </h2>
  <a name="AllFiles"></a>
  <div>
    <b>73</b> files in total.
    <b>5190</b> relevant lines. 
    <span class="green"><b>2904</b> lines covered</span> and
    <span class="red"><b>2286</b> lines missed </span>
  </div>
  <table class="file_list">
    <thead>
      <tr>
        <th>File</th>
        <th>% covered</th>
        <th>Lines</th>
        <th>Relevant Lines</th>
        <th>Lines covered</th>
        <th>Lines missed</th>
        <th>Avg. Hits / Line</th>
      </tr>
    </thead>
    <tbody>
      
      <tr>
        <td class="strong"><a href="#dc9745ef79d600c4e80d98f98535f0f46a18cb6c" class="src_link" title="app/controllers/api/v1/admin/calls_controller.rb">app/controllers/api/v1/admin/calls_controller.rb</a></td>
        <td class="red strong">54.9 %</td>
        <td>124</td>
        <td>51</td>
        <td>28</td>
        <td>23</td>
        <td>1.1</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#8abf27caf8dac0a07f5c0c37a789a54e3bdd301f" class="src_link" title="app/controllers/api/v1/auth_controller.rb">app/controllers/api/v1/auth_controller.rb</a></td>
        <td class="red strong">74.05 %</td>
        <td>341</td>
        <td>131</td>
        <td>97</td>
        <td>34</td>
        <td>1.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#67c8d7df4ce2ae8648e82e4b82393f73f72aefb0" class="src_link" title="app/controllers/api/v1/auth_nonce_controller.rb">app/controllers/api/v1/auth_nonce_controller.rb</a></td>
        <td class="red strong">79.25 %</td>
        <td>424</td>
        <td>159</td>
        <td>126</td>
        <td>33</td>
        <td>4.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#388f5f15f61f663122dc30a2541ee65405a4bac1" class="src_link" title="app/controllers/api/v1/calls_controller.rb">app/controllers/api/v1/calls_controller.rb</a></td>
        <td class="red strong">53.9 %</td>
        <td>391</td>
        <td>154</td>
        <td>83</td>
        <td>71</td>
        <td>1.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#e796631e31972737f357e7a59227db066656bba3" class="src_link" title="app/controllers/api/v1/chat/conversations/admins_controller.rb">app/controllers/api/v1/chat/conversations/admins_controller.rb</a></td>
        <td class="red strong">36.57 %</td>
        <td>341</td>
        <td>134</td>
        <td>49</td>
        <td>85</td>
        <td>0.7</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#9a76fbd11627a4192181f45dde45fbebd66f1e75" class="src_link" title="app/controllers/api/v1/chat/conversations/participants_controller.rb">app/controllers/api/v1/chat/conversations/participants_controller.rb</a></td>
        <td class="red strong">47.85 %</td>
        <td>506</td>
        <td>209</td>
        <td>100</td>
        <td>109</td>
        <td>0.7</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#dc406c886ef6b60c592e2e007adb512e21f75582" class="src_link" title="app/controllers/api/v1/chat/conversations/pin_chats_controller.rb">app/controllers/api/v1/chat/conversations/pin_chats_controller.rb</a></td>
        <td class="yellow strong">89.29 %</td>
        <td>212</td>
        <td>84</td>
        <td>75</td>
        <td>9</td>
        <td>2.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#1b34a081b934aed8fb9d1c6417f565d4e3da2253" class="src_link" title="app/controllers/api/v1/chat/conversations_controller.rb">app/controllers/api/v1/chat/conversations_controller.rb</a></td>
        <td class="red strong">33.51 %</td>
        <td>1378</td>
        <td>555</td>
        <td>186</td>
        <td>369</td>
        <td>0.9</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#96f5259d31c55702e5198b8e2d09288a26d5bde8" class="src_link" title="app/controllers/api/v1/contacts/favorites_controller.rb">app/controllers/api/v1/contacts/favorites_controller.rb</a></td>
        <td class="red strong">62.34 %</td>
        <td>203</td>
        <td>77</td>
        <td>48</td>
        <td>29</td>
        <td>1.1</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#555317954452fc37bcceae8e831938e6c9b062f0" class="src_link" title="app/controllers/api/v1/contacts_controller.rb">app/controllers/api/v1/contacts_controller.rb</a></td>
        <td class="red strong">50.0 %</td>
        <td>935</td>
        <td>404</td>
        <td>202</td>
        <td>202</td>
        <td>0.9</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#0c74c6837a5de4f6b8eb0bc2e3be006bfe09f0d7" class="src_link" title="app/controllers/api/v1/me_controller.rb">app/controllers/api/v1/me_controller.rb</a></td>
        <td class="red strong">36.42 %</td>
        <td>484</td>
        <td>173</td>
        <td>63</td>
        <td>110</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#a31cf0fe144ba12633de4c3d543684c7fb0c71c8" class="src_link" title="app/controllers/api/v1/posts/comments_controller.rb">app/controllers/api/v1/posts/comments_controller.rb</a></td>
        <td class="red strong">53.54 %</td>
        <td>250</td>
        <td>99</td>
        <td>53</td>
        <td>46</td>
        <td>0.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#20e582a7b9f7255ec203ecabd747a005550e2d78" class="src_link" title="app/controllers/api/v1/posts_controller.rb">app/controllers/api/v1/posts_controller.rb</a></td>
        <td class="red strong">43.24 %</td>
        <td>385</td>
        <td>148</td>
        <td>64</td>
        <td>84</td>
        <td>0.7</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#5b7d7c3d1474188d380188650149ab82c29b5fc4" class="src_link" title="app/controllers/application_controller.rb">app/controllers/application_controller.rb</a></td>
        <td class="yellow strong">83.02 %</td>
        <td>116</td>
        <td>53</td>
        <td>44</td>
        <td>9</td>
        <td>238.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#7318f6ca0ebe6be6957f8e50e109e4c759a51821" class="src_link" title="app/controllers/protected_controller.rb">app/controllers/protected_controller.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>3</td>
        <td>2</td>
        <td>2</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#ed2ac1537b11681fa6383a33456d2790191eb973" class="src_link" title="app/helpers/admin_session_helper.rb">app/helpers/admin_session_helper.rb</a></td>
        <td class="red strong">30.0 %</td>
        <td>18</td>
        <td>10</td>
        <td>3</td>
        <td>7</td>
        <td>0.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#df474f898901ca15cc59ef27bad9f4e018a35c35" class="src_link" title="app/helpers/application_helper.rb">app/helpers/application_helper.rb</a></td>
        <td class="red strong">4.0 %</td>
        <td>79</td>
        <td>50</td>
        <td>2</td>
        <td>48</td>
        <td>0.1</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#d3bf5a0e72e6e37918cdc06f4f8a314f6adb061d" class="src_link" title="app/helpers/chat_room_helper.rb">app/helpers/chat_room_helper.rb</a></td>
        <td class="red strong">60.68 %</td>
        <td>292</td>
        <td>117</td>
        <td>71</td>
        <td>46</td>
        <td>4.1</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#9049a71cd4015dddc8006fef97c3ecfa45ba233f" class="src_link" title="app/helpers/exception_handling_helper.rb">app/helpers/exception_handling_helper.rb</a></td>
        <td class="red strong">55.56 %</td>
        <td>38</td>
        <td>9</td>
        <td>5</td>
        <td>4</td>
        <td>1.1</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#d333c1120b11e95c5d8cfcb0519c82ab55e42999" class="src_link" title="app/helpers/member_session_helper.rb">app/helpers/member_session_helper.rb</a></td>
        <td class="red strong">68.18 %</td>
        <td>104</td>
        <td>44</td>
        <td>30</td>
        <td>14</td>
        <td>37.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#5d1c610d6bd7d590d84405e194a5b66e0e692357" class="src_link" title="app/helpers/qiscus_sdk.rb">app/helpers/qiscus_sdk.rb</a></td>
        <td class="red strong">22.01 %</td>
        <td>759</td>
        <td>318</td>
        <td>70</td>
        <td>248</td>
        <td>0.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#ec7a00560c72c620b0b88d520ce5f70c63a4e922" class="src_link" title="app/helpers/sms_verification.rb">app/helpers/sms_verification.rb</a></td>
        <td class="red strong">22.46 %</td>
        <td>242</td>
        <td>138</td>
        <td>31</td>
        <td>107</td>
        <td>0.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#857f908ba6e2abc1268153388ecd0eb6f27867de" class="src_link" title="app/helpers/super_admin_session_helper.rb">app/helpers/super_admin_session_helper.rb</a></td>
        <td class="red strong">33.33 %</td>
        <td>16</td>
        <td>9</td>
        <td>3</td>
        <td>6</td>
        <td>0.7</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#b64377d6b6e6e9a3b61e12834caf00f7be33e8ae" class="src_link" title="app/helpers/user_session_helper.rb">app/helpers/user_session_helper.rb</a></td>
        <td class="red strong">30.0 %</td>
        <td>18</td>
        <td>10</td>
        <td>3</td>
        <td>7</td>
        <td>0.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#6aecada08a3870bab61fe6ec35f896836bea2635" class="src_link" title="app/jobs/comment_push_notification_job.rb">app/jobs/comment_push_notification_job.rb</a></td>
        <td class="red strong">10.34 %</td>
        <td>78</td>
        <td>29</td>
        <td>3</td>
        <td>26</td>
        <td>0.1</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#d281b49d5f7b74f657c084dde044e32ed664beaa" class="src_link" title="app/jobs/contact_push_notification_job.rb">app/jobs/contact_push_notification_job.rb</a></td>
        <td class="red strong">10.34 %</td>
        <td>81</td>
        <td>29</td>
        <td>3</td>
        <td>26</td>
        <td>0.1</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#6e41a57be3503d08c83ed7aef5fb949a6ecc2a92" class="src_link" title="app/jobs/contact_sync_smarter_worker.rb">app/jobs/contact_sync_smarter_worker.rb</a></td>
        <td class="red strong">16.67 %</td>
        <td>53</td>
        <td>24</td>
        <td>4</td>
        <td>20</td>
        <td>0.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#543683efd95d159f30e8def8c42f5fe6439c6a48" class="src_link" title="app/models/application.rb">app/models/application.rb</a></td>
        <td class="yellow strong">81.25 %</td>
        <td>22</td>
        <td>16</td>
        <td>13</td>
        <td>3</td>
        <td>1.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#189c6339241cdb47565e58690876644ea7639c0a" class="src_link" title="app/models/application_record.rb">app/models/application_record.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>3</td>
        <td>2</td>
        <td>2</td>
        <td>0</td>
        <td>2.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#d115f7d72589884984fd21f4684ef649c5305482" class="src_link" title="app/models/auth_session.rb">app/models/auth_session.rb</a></td>
        <td class="red strong">75.0 %</td>
        <td>17</td>
        <td>8</td>
        <td>6</td>
        <td>2</td>
        <td>15.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#49295fc41208b2c2ea1f6485c696a28bf78999c2" class="src_link" title="app/models/bot.rb">app/models/bot.rb</a></td>
        <td class="red strong">11.33 %</td>
        <td>380</td>
        <td>256</td>
        <td>29</td>
        <td>227</td>
        <td>0.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#22e2961a486fc0a3045ac43e150fbb0f48789fd5" class="src_link" title="app/models/call_log.rb">app/models/call_log.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>28</td>
        <td>19</td>
        <td>19</td>
        <td>0</td>
        <td>5.7</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#e82aa130f3ca6650a3af4ff6148f78480ba5e92f" class="src_link" title="app/models/chat_room.rb">app/models/chat_room.rb</a></td>
        <td class="red strong">39.86 %</td>
        <td>332</td>
        <td>148</td>
        <td>59</td>
        <td>89</td>
        <td>2.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#6ba280d9657af6bdf00537eab0711f409abd838d" class="src_link" title="app/models/chat_user.rb">app/models/chat_user.rb</a></td>
        <td class="red strong">76.0 %</td>
        <td>49</td>
        <td>25</td>
        <td>19</td>
        <td>6</td>
        <td>8.4</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#dc6a28a96d44c2a4b0934f1d22b313fa9cc3781c" class="src_link" title="app/models/comment.rb">app/models/comment.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>23</td>
        <td>15</td>
        <td>15</td>
        <td>0</td>
        <td>3.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#490181d6f2ea6a8ba15bf1d1e8b9a084fcc432a5" class="src_link" title="app/models/comment_media.rb">app/models/comment_media.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>14</td>
        <td>10</td>
        <td>10</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#fbf96fc2c8fd8fb908e44aae6bd7b12cee72f5f7" class="src_link" title="app/models/contact.rb">app/models/contact.rb</a></td>
        <td class="yellow strong">90.0 %</td>
        <td>51</td>
        <td>20</td>
        <td>18</td>
        <td>2</td>
        <td>7.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#26d79baaea4bc862a3f42f903979fdab6aa7b147" class="src_link" title="app/models/fcm_client.rb">app/models/fcm_client.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>12</td>
        <td>6</td>
        <td>6</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#f492b5941f0c8cf07524d88daa0903d024253d6d" class="src_link" title="app/models/like.rb">app/models/like.rb</a></td>
        <td class="red strong">70.0 %</td>
        <td>19</td>
        <td>10</td>
        <td>7</td>
        <td>3</td>
        <td>1.9</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#12c721a39717db7f5a4ca6b6a1b7b0ca0637bb7e" class="src_link" title="app/models/mute_chat_room.rb">app/models/mute_chat_room.rb</a></td>
        <td class="yellow strong">81.82 %</td>
        <td>21</td>
        <td>11</td>
        <td>9</td>
        <td>2</td>
        <td>1.4</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#405aec855758eb1fa58602eaa39040613a173696" class="src_link" title="app/models/pin_chat_room.rb">app/models/pin_chat_room.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>21</td>
        <td>11</td>
        <td>11</td>
        <td>0</td>
        <td>3.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#ef9613b15bda0b87d1bb5742261821d260e4ccff" class="src_link" title="app/models/post.rb">app/models/post.rb</a></td>
        <td class="red strong">50.0 %</td>
        <td>56</td>
        <td>40</td>
        <td>20</td>
        <td>20</td>
        <td>2.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#fc230b8c160cd98f87f8fc8cef527e4cd2a91182" class="src_link" title="app/models/post_media.rb">app/models/post_media.rb</a></td>
        <td class="red strong">73.33 %</td>
        <td>22</td>
        <td>15</td>
        <td>11</td>
        <td>4</td>
        <td>0.7</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#63a9170e3e92491bd77fdfb01dbb4670247e3048" class="src_link" title="app/models/role.rb">app/models/role.rb</a></td>
        <td class="red strong">60.0 %</td>
        <td>37</td>
        <td>20</td>
        <td>12</td>
        <td>8</td>
        <td>2.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#e0c8eb38ea0e946b12f078f0498931fb50f58959" class="src_link" title="app/models/user.rb">app/models/user.rb</a></td>
        <td class="red strong">38.81 %</td>
        <td>424</td>
        <td>201</td>
        <td>78</td>
        <td>123</td>
        <td>13.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#a41ca0f136c3c185a08e98ded8e137ed94d28d69" class="src_link" title="app/models/user_additional_info.rb">app/models/user_additional_info.rb</a></td>
        <td class="red strong">33.33 %</td>
        <td>41</td>
        <td>24</td>
        <td>8</td>
        <td>16</td>
        <td>16.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#bdcc2a080c9523b2ded2ceafb628565c098b9fe1" class="src_link" title="app/models/user_device_token.rb">app/models/user_device_token.rb</a></td>
        <td class="red strong">77.78 %</td>
        <td>18</td>
        <td>9</td>
        <td>7</td>
        <td>2</td>
        <td>1.1</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#9b3e4afd9ff1b5b751e6daaeb8aa146bfcbaa84e" class="src_link" title="app/models/user_role.rb">app/models/user_role.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>20</td>
        <td>10</td>
        <td>10</td>
        <td>0</td>
        <td>3.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#a9177ca6145c6892baf98b5f7bb3c61a7a9186cb" class="src_link" title="app/validators/email_validator.rb">app/validators/email_validator.rb</a></td>
        <td class="red strong">75.0 %</td>
        <td>7</td>
        <td>4</td>
        <td>3</td>
        <td>1</td>
        <td>4.8</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#161f6206fd712bae1eb47782303552fefafe8d4e" class="src_link" title="app/validators/spaces_only_validator.rb">app/validators/spaces_only_validator.rb</a></td>
        <td class="red strong">75.0 %</td>
        <td>8</td>
        <td>4</td>
        <td>3</td>
        <td>1</td>
        <td>2.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#e18f249bcf9729e76c3ef2ebf58416b5929acad1" class="src_link" title="app/validators/url_validator.rb">app/validators/url_validator.rb</a></td>
        <td class="red strong">28.57 %</td>
        <td>14</td>
        <td>7</td>
        <td>2</td>
        <td>5</td>
        <td>0.6</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#a4b279ad4df13e6920549e503f71707722dc2205" class="src_link" title="test/integration/api/v1/auth_test.rb">test/integration/api/v1/auth_test.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>159</td>
        <td>84</td>
        <td>84</td>
        <td>0</td>
        <td>1.1</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#a252bd6a8b6bb4eaab1928b357e246cc8625d310" class="src_link" title="test/integration/api/v1/calls_test.rb">test/integration/api/v1/calls_test.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>277</td>
        <td>122</td>
        <td>122</td>
        <td>0</td>
        <td>1.1</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#21fffdf1488c96270ec66b42701ff6af52e770b5" class="src_link" title="test/integration/api/v1/chat/admins_test.rb">test/integration/api/v1/chat/admins_test.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>92</td>
        <td>50</td>
        <td>50</td>
        <td>0</td>
        <td>1.1</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#77426e500b4bf2969feee552a4d118361ff44c60" class="src_link" title="test/integration/api/v1/chat/conversations/participants_test.rb">test/integration/api/v1/chat/conversations/participants_test.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>88</td>
        <td>45</td>
        <td>45</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#342cca6db48743684bf85be81a346808eb65d537" class="src_link" title="test/integration/api/v1/chat/conversations_test.rb">test/integration/api/v1/chat/conversations_test.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>197</td>
        <td>97</td>
        <td>97</td>
        <td>0</td>
        <td>1.1</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#830bd208353f4b2196eb67516bd60e23600ef3d5" class="src_link" title="test/integration/api/v1/chat/pin_chats_test.rb">test/integration/api/v1/chat/pin_chats_test.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>153</td>
        <td>83</td>
        <td>83</td>
        <td>0</td>
        <td>1.1</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#71b4b606f8728b4285dc516bf03eda795a91092c" class="src_link" title="test/integration/api/v1/contacts/favorites_test.rb">test/integration/api/v1/contacts/favorites_test.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>108</td>
        <td>53</td>
        <td>53</td>
        <td>0</td>
        <td>1.1</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#7f43bb67b8b6eaef0b7fe5af2306c60de496f257" class="src_link" title="test/integration/api/v1/contacts_test.rb">test/integration/api/v1/contacts_test.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>338</td>
        <td>185</td>
        <td>185</td>
        <td>0</td>
        <td>1.1</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#b87a960705e60d0c11a530b64a54627eff80fcd7" class="src_link" title="test/integration/api/v1/me_test.rb">test/integration/api/v1/me_test.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>129</td>
        <td>81</td>
        <td>81</td>
        <td>0</td>
        <td>1.1</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#bae6a658d1a519a274a23a08d1eec2f9334bc8ee" class="src_link" title="test/integration/api/v1/posts/comments_test.rb">test/integration/api/v1/posts/comments_test.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>102</td>
        <td>56</td>
        <td>56</td>
        <td>0</td>
        <td>1.1</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#cffa6b31be90178f499f2b7d7e858ac5bf65686d" class="src_link" title="test/integration/api/v1/posts_test.rb">test/integration/api/v1/posts_test.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>101</td>
        <td>51</td>
        <td>51</td>
        <td>0</td>
        <td>1.1</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#c571c37ea7cc8c588c9916a29b17287e19d19f53" class="src_link" title="test/models/application_test.rb">test/models/application_test.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>45</td>
        <td>23</td>
        <td>23</td>
        <td>0</td>
        <td>1.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#ba195a3e1b5447aac224746a0d10d89d11c97c21" class="src_link" title="test/models/bot_test.rb">test/models/bot_test.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>7</td>
        <td>2</td>
        <td>2</td>
        <td>0</td>
        <td>1.0</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#c02484425aacc756410117fb9597485275b73ebc" class="src_link" title="test/models/chat_room_test.rb">test/models/chat_room_test.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>47</td>
        <td>21</td>
        <td>21</td>
        <td>0</td>
        <td>1.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#6ccc3dbca789c9e7a97eb2ff9110babb5c633d62" class="src_link" title="test/models/chat_user_test.rb">test/models/chat_user_test.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>25</td>
        <td>12</td>
        <td>12</td>
        <td>0</td>
        <td>1.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#d30decbde173754d61114d776724d1bcc555a638" class="src_link" title="test/models/comment_media_test.rb">test/models/comment_media_test.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>56</td>
        <td>27</td>
        <td>27</td>
        <td>0</td>
        <td>1.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#21d72370ce743bbe41aedaf90fac1148db50f4df" class="src_link" title="test/models/comment_test.rb">test/models/comment_test.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>32</td>
        <td>15</td>
        <td>15</td>
        <td>0</td>
        <td>1.2</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#067ba9919b903c7abce36cb226e9aff5049e7050" class="src_link" title="test/models/contact_test.rb">test/models/contact_test.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>32</td>
        <td>18</td>
        <td>18</td>
        <td>0</td>
        <td>1.5</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#067499bd0c163a88669702e91400e0ada36cfc0b" class="src_link" title="test/models/post_media_test.rb">test/models/post_media_test.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>56</td>
        <td>27</td>
        <td>27</td>
        <td>0</td>
        <td>1.3</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#969ab43ab22653aecdf4c69d4e3d52e06754a0b8" class="src_link" title="test/models/post_test.rb">test/models/post_test.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>23</td>
        <td>9</td>
        <td>9</td>
        <td>0</td>
        <td>1.1</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#a9f15db1e3be8af36fe7f2e99fbbb93745760648" class="src_link" title="test/models/role_test.rb">test/models/role_test.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>19</td>
        <td>9</td>
        <td>9</td>
        <td>0</td>
        <td>1.1</td>
      </tr>
      
      <tr>
        <td class="strong"><a href="#873bee41279604614faa73ef0d734744ca578219" class="src_link" title="test/models/user_test.rb">test/models/user_test.rb</a></td>
        <td class="green strong">100.0 %</td>
        <td>31</td>
        <td>9</td>
        <td>9</td>
        <td>0</td>
        <td>1.1</td>
      </tr>
      
    </tbody>
  </table>
</div>


        
      </div>
    
      <div id="footer">
        Generated by <a href="http://github.com/colszowka/simplecov">simplecov</a> v0.16.1 
        and simplecov-html v0.10.2<br/>
        using Integration Tests, MiniTest
      </div>
    
      <div class="source_files">
      
        <div class="source_table" id="dc9745ef79d600c4e80d98f98535f0f46a18cb6c">
  <div class="header">
    <h3>app/controllers/api/v1/admin/calls_controller.rb</h3>
    <h4><span class="red">54.9 %</span> covered</h4>
    <div>
      <b>51</b> relevant lines. 
      <span class="green"><b>28</b> lines covered</span> and
      <span class="red"><b>23</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class Api::V1::Admin::CallsController &lt; ProtectedController</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  before_action :authorize_admin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">  # =begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">  # @apiVersion 1.0.0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">  # @api {get} /api/v1/admin/calls Admin List of call logs</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">  # @apiName AdminListofCallLogs</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">  # @apiGroup Admin - Calls</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">  # @apiPermission Admin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">  # @apiParam {String} access_token Admin access token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">  # @apiParam {Number} user_id User id. if this parameter not used, it will show all user&#39;s call logs in the application</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">  # @apiParam {Number} page Page number</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">  # @apiParam {Number} limit Limit</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">  # @apiParam {String} [call_participant] Filter call logs by participant except user_id above. You can use user fullname or user phone number</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">	# @apiParam {String} [start_date] Filter call logs by date. filter this by start_date and end_date. use format YYYY-MM-DD</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">	# @apiParam {String} [end_date] Filter call logs by date. filter this by start_date and end_date. use format YYYY-MM-DD</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">  # =end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">  def index</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="20">
          <span class="hits">2</span>
          
          <code class="ruby">    total_page = 0</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="21">
          <span class="hits">2</span>
          
          <code class="ruby">    total = 0</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="22">
          <span class="hits">2</span>
          
          <code class="ruby">    limit = params[:limit]</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="23">
          <span class="hits">2</span>
          
          <code class="ruby">    page = params[:page]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="25">
          <span class="hits">2</span>
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="26">
          <span class="hits">2</span>
          
          <code class="ruby">      if params[:user_id].present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">        user = User.find_by(id: params[:user_id], application_id: @current_user.application_id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">        if user.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">          raise Exception.new(&quot;User not found.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">        call_logs = CallLog.where(caller_user_id: user.id, application_id: @current_user.application_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">        call_logs = call_logs.or(CallLog.where(callee_user_id: user.id, application_id: @current_user.application_id))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="36">
          <span class="hits">2</span>
          
          <code class="ruby">        call_logs = CallLog.where(application_id: @current_user.application_id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="40">
          <span class="hits">2</span>
          
          <code class="ruby">      if params[:start_date].present? &amp;&amp; params[:end_date].present?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="41">
          <span class="hits">1</span>
          
          <code class="ruby">        start_date = params[:start_date].to_time</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="42">
          <span class="hits">1</span>
          
          <code class="ruby">        end_date = params[:end_date].to_time</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="44">
          <span class="hits">1</span>
          
          <code class="ruby">        call_logs = call_logs.where(created_at: start_date.beginning_of_day..end_date.end_of_day)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="47">
          <span class="hits">2</span>
          
          <code class="ruby">      if params[:call_participant].present? &amp;&amp; params[:user_id].present?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">        # can input phone number or name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">        call_participant = params[:call_participant]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">        call_participant = User.where(&quot;phone_number LIKE ?&quot;, &quot;%#{call_participant}%&quot;).or(User.where(&quot;fullname ILIKE ?&quot;, &quot;%#{call_participant}%&quot;)).first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">        call_logs = call_logs.where(caller_user_id: call_participant.id, callee_user_id: user.id, application_id: @current_user.application_id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">                    .or(call_logs.where(caller_user_id: user.id, callee_user_id: call_participant.id, application_id: @current_user.application_id))</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="54">
          <span class="hits">2</span>
          
          <code class="ruby">      elsif params[:call_participant].present? &amp;&amp; !params[:user_id].present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">        raise Exception.new(&quot;you can not get call history data based on the participant if the user parameter is empty.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">      # update call duration and connected_at from call sdk</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="59">
          <span class="hits">2</span>
          
          <code class="ruby">      call_logs.each do |call_log|</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="60">
          <span class="hits">6</span>
          
          <code class="ruby">        if call_log.status == &quot;missed&quot;  # this assume that &quot;missed&quot; status is because the user call is on going</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">          call_sdk = QiscusCallSdk.new()</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">          connected_at, duration, status = call_sdk.logs_by_call_room_id(call_log.call_room_id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="64">
          
          
          <code class="ruby">          call_log.update(duration: duration, connected_at: connected_at, status: status)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="68">
          <span class="hits">2</span>
          
          <code class="ruby">      call_logs = call_logs.order(created_at: :desc)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="70">
          <span class="hits">2</span>
          
          <code class="ruby">      total = call_logs.count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">      # pagination only when exist</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="73">
          <span class="hits">2</span>
          
          <code class="ruby">      if page.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="74">
          
          
          <code class="ruby">        call_logs = call_logs.page(page)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">      # if limit and page present, then use kaminari pagination</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="78">
          <span class="hits">2</span>
          
          <code class="ruby">      if limit.present? &amp;&amp; page.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="79">
          
          
          <code class="ruby">        call_logs = call_logs.per(limit)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">      # else use limit from ActiveRecord</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="81">
          <span class="hits">2</span>
          
          <code class="ruby">      elsif limit.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="82">
          
          
          <code class="ruby">        call_logs = call_logs.limit(limit)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="84">
          <span class="hits">2</span>
          
          <code class="ruby">        limit = 25</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="85">
          <span class="hits">2</span>
          
          <code class="ruby">        call_logs = call_logs.limit(25)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="88">
          <span class="hits">2</span>
          
          <code class="ruby">      total_page = (total / limit.to_f).ceil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="90">
          <span class="hits">2</span>
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">        meta: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">          limit: limit.to_i,</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="93">
          <span class="hits">2</span>
          
          <code class="ruby">          page: page == nil || page.to_i &lt; 0 ? 0 : page.to_i,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">          total_page: total_page,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">          total: total,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby">        },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby">        data: call_logs</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="99">
          
          
          <code class="ruby">    rescue ActiveRecord::RecordInvalid =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="100">
          
          
          <code class="ruby">      msg = &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="101">
          
          
          <code class="ruby">      e.record.errors.map do |k, v|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="102">
          
          
          <code class="ruby">        key = k.to_s.humanize</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="103">
          
          
          <code class="ruby">        msg = msg + &quot;#{key} #{v}, &quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="106">
          
          
          <code class="ruby">      msg = msg.chomp(&quot;, &quot;) + &quot;.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby">          message: msg,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby">          backtrace: e.backtrace</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="112">
          
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">    rescue Exception =&gt; e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">          message: e.message</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="119">
          
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="8abf27caf8dac0a07f5c0c37a789a54e3bdd301f">
  <div class="header">
    <h3>app/controllers/api/v1/auth_controller.rb</h3>
    <h4><span class="red">74.05 %</span> covered</h4>
    <div>
      <b>131</b> relevant lines. 
      <span class="green"><b>97</b> lines covered</span> and
      <span class="red"><b>34</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;jwt&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">class Api::V1::AuthController &lt; ApplicationController</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  before_action :ensure_new_session_params, only: [:create, :resend_passcode]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  before_action :ensure_verify_params, only: [:verify]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">  # =begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">  # @apiVersion 1.0.0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">  # @api {post} /api/v1/auth Login or Register</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">  # @apiDescription Register user if not exist, otherwise only send passcode via SMS</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">  # @apiName LoginOrRegister</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">  # @apiGroup Auth</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">  # @apiParam {String} user[app_id] Application id, &#39;qisme&#39;, &#39;kiwari-stag&#39;, etc</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">  # @apiParam {String} user[phone_number] Phone number to be register or sign in</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">  # =end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">  def create</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="18">
          <span class="hits">4</span>
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="19">
          <span class="hits">4</span>
          
          <code class="ruby">      user = nil</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="20">
          <span class="hits">4</span>
          
          <code class="ruby">      jwt = &quot;&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">      # delete all session if not used within one month</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">      # put here since it will be called everytime user want to login, no need in transaction because it must be deleted whether the transaction success or not</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="24">
          <span class="hits">4</span>
          
          <code class="ruby">      AuthSession.where(&quot;auth_sessions.updated_at &lt; ?&quot;, 1.month.ago).destroy_all</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="26">
          <span class="hits">4</span>
          
          <code class="ruby">      ActiveRecord::Base.transaction do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">        # check the application id</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="28">
          <span class="hits">4</span>
          
          <code class="ruby">        application = Application.find_by(app_id: params[:user][:app_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="30">
          <span class="hits">4</span>
          
          <code class="ruby">        if application.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">          render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">            error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">              message: &quot;Application id is not found.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">            }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="35">
          <span class="hits">1</span>
          
          <code class="ruby">          }, status: 404 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">        # check if user already exist or not</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="39">
          <span class="hits">3</span>
          
          <code class="ruby">        phone_number = params[:user][:phone_number]</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="40">
          <span class="hits">3</span>
          
          <code class="ruby">        if phone_number.nil? != false || phone_number != &quot;&quot;</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="41">
          <span class="hits">2</span>
          
          <code class="ruby">          phone_number = phone_number.strip().delete(&#39; &#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">          # phone_number = PhonyRails.normalize_number(phone_number, default_country_code: &#39;ID&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="44">
          <span class="hits">2</span>
          
          <code class="ruby">          if phone_number == &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">            raise Exception.new(&#39;Phone number is empty.&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="48">
          <span class="hits">1</span>
          
          <code class="ruby">          raise Exception.new(&#39;Phone number is empty.&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="50">
          <span class="hits">2</span>
          
          <code class="ruby">        user = User.find_by(phone_number: phone_number, application_id: application.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">        # if nil then register</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="53">
          <span class="hits">2</span>
          
          <code class="ruby">        if user.nil?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="54">
          <span class="hits">1</span>
          
          <code class="ruby">          passcode = SmsVerification.generate_code(phone_number, application.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">          # new user only for member level</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="56">
          <span class="hits">1</span>
          
          <code class="ruby">          role = Role.member</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="57">
          <span class="hits">1</span>
          
          <code class="ruby">          if role.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">            render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">              error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">                message: &quot;Can&#39;t find user role, please contact admin to seed their database.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">              }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">            }, status: 404 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="65">
          <span class="hits">1</span>
          
          <code class="ruby">          new_user_credential = params[:user].permit!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="67">
          <span class="hits">1</span>
          
          <code class="ruby">          email_sdk = params[:user][:phone_number].tr(&#39;+&#39;, &#39;&#39;).delete(&#39; &#39;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="68">
          <span class="hits">1</span>
          
          <code class="ruby">          email_sdk = email_sdk.downcase.gsub(/[^a-z0-9_.]/i, &quot;&quot;) # only get alphanumeric and _ and . string only</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="69">
          <span class="hits">1</span>
          
          <code class="ruby">          email_sdk = email_sdk + &quot;@&quot; + application.app_id + &quot;.com&quot; # will build string like 085868xxxxxx@app_id.com</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="71">
          <span class="hits">1</span>
          
          <code class="ruby">          new_user_credential.delete(:app_id) # delete app id, replace with application_id</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="72">
          <span class="hits">1</span>
          
          <code class="ruby">          new_user_credential[&quot;application_id&quot;] = application.id</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="73">
          <span class="hits">1</span>
          
          <code class="ruby">          new_user_credential[&quot;passcode&quot;] = passcode</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="74">
          <span class="hits">1</span>
          
          <code class="ruby">          new_user_credential[&quot;qiscus_token&quot;] = &quot;qiscus_token&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="75">
          <span class="hits">1</span>
          
          <code class="ruby">          new_user_credential[&quot;qiscus_email&quot;] = email_sdk</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="76">
          <span class="hits">1</span>
          
          <code class="ruby">          new_user_credential[&quot;phone_number&quot;] = phone_number</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="77">
          <span class="hits">1</span>
          
          <code class="ruby">          new_user_credential[&quot;country_code&quot;] = phone_number.slice(0..2) # assuming the first 3 digits is country code</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">          # using class initiation to avoid user send another params (i.e fullname and it is saved)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="80">
          <span class="hits">1</span>
          
          <code class="ruby">          user = User.new</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="81">
          <span class="hits">1</span>
          
          <code class="ruby">          user.phone_number = new_user_credential[&quot;phone_number&quot;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">          # user.fullname = new_user_credential[&quot;phone_number&quot;] # fullname set to be nil to inform client</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="83">
          <span class="hits">1</span>
          
          <code class="ruby">          user.application_id = new_user_credential[&quot;application_id&quot;]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="84">
          <span class="hits">1</span>
          
          <code class="ruby">          user.passcode = new_user_credential[&quot;passcode&quot;]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="85">
          <span class="hits">1</span>
          
          <code class="ruby">          user.qiscus_token = new_user_credential[&quot;qiscus_token&quot;]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="86">
          <span class="hits">1</span>
          
          <code class="ruby">          user.qiscus_email = new_user_credential[&quot;qiscus_email&quot;]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="87">
          <span class="hits">1</span>
          
          <code class="ruby">          user.is_public = false</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="88">
          <span class="hits">1</span>
          
          <code class="ruby">          user.country_code = new_user_credential[&quot;country_code&quot;]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="89">
          <span class="hits">1</span>
          
          <code class="ruby">          user.save!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">          # Backend no need to register user in SDK (but if it&#39;s okay even it is happen (for easy debugging when trying qisus chat room))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">          # add user id to email to ensure that email is really unique</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="93">
          <span class="hits">1</span>
          
          <code class="ruby">          email_sdk = &quot;userid_&quot; + user.id.to_s + &quot;_&quot; + user.qiscus_email</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">          # this ensure qiscus email sdk to be unique</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="96">
          <span class="hits">1</span>
          
          <code class="ruby">          user.update_attribute(:qiscus_email, email_sdk)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="98">
          <span class="hits">1</span>
          
          <code class="ruby">          user_role = UserRole.new(user_id: user.id, role_id: role.id)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="99">
          <span class="hits">1</span>
          
          <code class="ruby">          user_role.save!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">          # username is user phone_number</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="102">
          <span class="hits">1</span>
          
          <code class="ruby">          username = new_user_credential[&quot;phone_number&quot;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby">          # if exist then just update passcode</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby">          # for now, update passcode only when passcode field in database is nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby">          # if passcode field not nil its mean user request to resend passcode. Then take the existing passcode value</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">          # handling race condition with locking</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="108">
          <span class="hits">1</span>
          
          <code class="ruby">          user.with_lock do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="109">
          <span class="hits">1</span>
          
          <code class="ruby">            if user.passcode.nil? || user.passcode == &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="110">
          
          
          <code class="ruby">              passcode = SmsVerification.generate_code(phone_number, application.id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="111">
          
          
          <code class="ruby">              user.update_columns(passcode: passcode)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby">            else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby">              # get current passcode</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="114">
          <span class="hits">1</span>
          
          <code class="ruby">              passcode = user.passcode</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="116">
          <span class="hits">1</span>
          
          <code class="ruby">            email_sdk = user.qiscus_email</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="117">
          <span class="hits">1</span>
          
          <code class="ruby">            username = user.fullname</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby">        # Calling SDK login or register placed in here to handle token changes. For now token can be changed via rest api</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="123">
          <span class="hits">2</span>
          
          <code class="ruby">        qiscus_sdk = QiscusSdk.new(application.app_id, application.qiscus_sdk_secret)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="124">
          <span class="hits">2</span>
          
          <code class="ruby">        qiscus_token = qiscus_sdk.login_or_register(email_sdk, &quot;password&quot;, username) # get qiscus token</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="125">
          <span class="hits">2</span>
          
          <code class="ruby">        user.update_columns(qiscus_token: qiscus_token)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby">        # here the user must already created, so we can add default contact (official user) here</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="128">
          <span class="hits">2</span>
          
          <code class="ruby">        role_official_user = Role.official</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="129">
          <span class="hits">2</span>
          
          <code class="ruby">        if role_official_user.nil? == false</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="130">
          <span class="hits">2</span>
          
          <code class="ruby">          user_role_ids = UserRole.where(role_id: role_official_user.id).pluck(:user_id).to_a</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="131">
          <span class="hits">2</span>
          
          <code class="ruby">          official_account = User.where(&quot;id IN (?)&quot;, user_role_ids).where(application_id: application.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="133">
          <span class="hits">2</span>
          
          <code class="ruby">          official_account.each do |oa|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="134">
          
          
          <code class="ruby">            contact = Contact.find_by(user_id: user.id, contact_id: oa.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="136">
          
          
          <code class="ruby">            if contact.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="137">
          
          
          <code class="ruby">              contact = Contact.new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="138">
          
          
          <code class="ruby">              contact.user_id = user.id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="139">
          
          
          <code class="ruby">              contact.contact_id = oa.id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="140">
          
          
          <code class="ruby">              contact.save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="142">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby">        # then send the passcode sms</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="146">
          <span class="hits">2</span>
          
          <code class="ruby">        SmsVerification.request(user, passcode)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby">        # For debugging or quality assurance testing, send passcode to Qiscus if phone number contains &quot;+628681&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby">        # why &quot;+628681&quot; because it is a valid predecessor phone number in Indonesia,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="150">
          
          
          <code class="ruby">        # since model using phony_plausible validation it need to be use valid number to register</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="151">
          <span class="hits">2</span>
          
          <code class="ruby">        if user.phone_number.include?(&quot;+628681&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby">          # send to qiscus</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="153">
          
          
          <code class="ruby">          messages = &quot;#{application.app_name} : Passcode for account #{user.phone_number} is #{user.passcode}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="154">
          
          
          <code class="ruby">          SendToQiscus.send_message(110362, messages)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="156">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="158">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby">        data: user</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="160">
          <span class="hits">2</span>
          
          <code class="ruby">      } and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="161">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="162">
          <span class="hits">1</span>
          
          <code class="ruby">    rescue ActiveRecord::RecordInvalid =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="163">
          
          
          <code class="ruby">      msg = &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="164">
          
          
          <code class="ruby">      e.record.errors.map do |k, v|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="165">
          
          
          <code class="ruby">        key = k.to_s.humanize</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="166">
          
          
          <code class="ruby">        msg = msg + &quot;#{key} #{v}, &quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="167">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="168">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="169">
          
          
          <code class="ruby">      msg = msg.chomp(&quot;, &quot;) + &quot;.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="170">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="171">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="172">
          
          
          <code class="ruby">          message: msg</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="173">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="174">
          
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="175">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="176">
          
          
          <code class="ruby">    rescue Exception =&gt; e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="177">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="178">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="179">
          
          
          <code class="ruby">          message: e.message</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="180">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="181">
          <span class="hits">1</span>
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="182">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="183">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="184">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="185">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="186">
          
          
          <code class="ruby">  # =begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="187">
          
          
          <code class="ruby">  # @apiVersion 1.0.0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="188">
          
          
          <code class="ruby">  # @api {post} /api/v1/auth/resend_passcode Resend passcode</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="189">
          
          
          <code class="ruby">  # @apiDescription Resend passcode</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="190">
          
          
          <code class="ruby">  # @apiName ResendPasscode</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="191">
          
          
          <code class="ruby">  # @apiGroup Auth</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="192">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="193">
          
          
          <code class="ruby">  # @apiParam {String} user[app_id] User application id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="194">
          
          
          <code class="ruby">  # @apiParam {String} user[phone_number] Registered phone number</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="195">
          
          
          <code class="ruby">  # =end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="196">
          <span class="hits">1</span>
          
          <code class="ruby">  def resend_passcode</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="197">
          <span class="hits">3</span>
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="198">
          <span class="hits">3</span>
          
          <code class="ruby">      ActiveRecord::Base.transaction do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="199">
          
          
          <code class="ruby">        # check the application id</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="200">
          <span class="hits">3</span>
          
          <code class="ruby">        application = Application.find_by(app_id: params[:user][:app_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="201">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="202">
          <span class="hits">3</span>
          
          <code class="ruby">        if application.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="203">
          
          
          <code class="ruby">          render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="204">
          
          
          <code class="ruby">            error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="205">
          
          
          <code class="ruby">              message: &quot;Application id is not found.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="206">
          
          
          <code class="ruby">            }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="207">
          <span class="hits">1</span>
          
          <code class="ruby">          }, status: 404 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="208">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="209">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="210">
          <span class="hits">2</span>
          
          <code class="ruby">        phone_number = params[:user][:phone_number]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="211">
          
          
          <code class="ruby">        # phone_number = PhonyRails.normalize_number(phone_number, default_country_code: &#39;ID&#39;)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="212">
          <span class="hits">2</span>
          
          <code class="ruby">        user = User.find_by(phone_number: phone_number, application_id: application.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="213">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="214">
          <span class="hits">2</span>
          
          <code class="ruby">        if !user.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="215">
          
          
          <code class="ruby">          # for now, no change passcode on resend passcode</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="216">
          <span class="hits">1</span>
          
          <code class="ruby">          passcode = user.passcode</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="217">
          
          
          <code class="ruby">          # passcode = SmsVerification.generate_code</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="218">
          
          
          <code class="ruby">          # user.update_attribute(:passcode, passcode)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="219">
          
          
          <code class="ruby">          # then send the passcode sms</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="220">
          <span class="hits">1</span>
          
          <code class="ruby">          SmsVerification.request(user, passcode)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="221">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="222">
          
          
          <code class="ruby">          render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="223">
          
          
          <code class="ruby">            data: user</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="224">
          <span class="hits">1</span>
          
          <code class="ruby">          } and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="225">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="226">
          
          
          <code class="ruby">          render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="227">
          
          
          <code class="ruby">            error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="228">
          
          
          <code class="ruby">              message: &quot;Can&#39;t find user.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="229">
          
          
          <code class="ruby">            }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="230">
          <span class="hits">1</span>
          
          <code class="ruby">          }, status: 404 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="231">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="232">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="233">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="234">
          
          
          <code class="ruby">    rescue ActiveRecord::RecordInvalid =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="235">
          
          
          <code class="ruby">      msg = &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="236">
          
          
          <code class="ruby">      e.record.errors.map do |k, v|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="237">
          
          
          <code class="ruby">        key = k.to_s.humanize</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="238">
          
          
          <code class="ruby">        msg = msg + &quot;#{key} #{v}, &quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="239">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="240">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="241">
          
          
          <code class="ruby">      msg = msg.chomp(&quot;, &quot;) + &quot;.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="242">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="243">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="244">
          
          
          <code class="ruby">          message: msg</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="245">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="246">
          
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="247">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="248">
          
          
          <code class="ruby">    rescue Exception =&gt; e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="249">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="250">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="251">
          
          
          <code class="ruby">          message: e.message</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="252">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="253">
          
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="254">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="255">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="256">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="257">
          
          
          <code class="ruby">  # =begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="258">
          
          
          <code class="ruby">  # @apiVersion 1.0.0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="259">
          
          
          <code class="ruby">  # @api {post} /api/v1/auth/verify Verify passcode from SMS</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="260">
          
          
          <code class="ruby">  # @apiDescription Return access token and user object if successful</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="261">
          
          
          <code class="ruby">  # @apiName AuthVerify</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="262">
          
          
          <code class="ruby">  # @apiGroup Auth</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="263">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="264">
          
          
          <code class="ruby">  # @apiParam {String} user[app_id] Application id, &#39;qisme&#39;, &#39;kiwari-stag&#39;, etc</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="265">
          
          
          <code class="ruby">  # @apiParam {String} user[phone_number] Phone number to validate</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="266">
          
          
          <code class="ruby">  # @apiParam {String} user[passcode] Passcode from SMS</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="267">
          
          
          <code class="ruby">  # =end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="268">
          <span class="hits">1</span>
          
          <code class="ruby">  def verify</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="269">
          <span class="hits">3</span>
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="270">
          <span class="hits">3</span>
          
          <code class="ruby">      ActiveRecord::Base.transaction do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="271">
          
          
          <code class="ruby">        # check the application id</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="272">
          <span class="hits">3</span>
          
          <code class="ruby">        application = Application.find_by(app_id: params[:user][:app_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="273">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="274">
          <span class="hits">3</span>
          
          <code class="ruby">        if application.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="275">
          
          
          <code class="ruby">          render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="276">
          
          
          <code class="ruby">            error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="277">
          
          
          <code class="ruby">              message: &quot;Application id is not found.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="278">
          
          
          <code class="ruby">            }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="279">
          <span class="hits">1</span>
          
          <code class="ruby">          }, status: 404 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="280">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="281">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="282">
          <span class="hits">2</span>
          
          <code class="ruby">        phone_number = params[:user][:phone_number]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="283">
          
          
          <code class="ruby">        # phone_number = PhonyRails.normalize_number(phone_number, default_country_code: &#39;ID&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="284">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="285">
          <span class="hits">2</span>
          
          <code class="ruby">        user = User.find_by(phone_number: phone_number,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="286">
          
          
          <code class="ruby">          passcode: params[:user][:passcode], application_id: application.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="287">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="288">
          
          
          <code class="ruby">        # if user with given phone number AND passcode AND app_id is EXIST then return object user</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="289">
          <span class="hits">2</span>
          
          <code class="ruby">        if !user.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="290">
          
          
          <code class="ruby">          # update passcode to nil (so user can&#39;t verify again once the code is used)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="291">
          <span class="hits">1</span>
          
          <code class="ruby">          user.update_columns(passcode: nil) # using update_columns to prevent calling callback</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="292">
          
          
          <code class="ruby">          # now generate access_token for this user</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="293">
          <span class="hits">1</span>
          
          <code class="ruby">          jwt = ApplicationHelper.create_jwt_token(user, request)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="294">
          
          
          <code class="ruby">          render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="295">
          
          
          <code class="ruby">            access_token: jwt,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="296">
          
          
          <code class="ruby">            data: user</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="297">
          <span class="hits">1</span>
          
          <code class="ruby">          } and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="298">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="299">
          
          
          <code class="ruby">          render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="300">
          
          
          <code class="ruby">            error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="301">
          
          
          <code class="ruby">              message: &quot;Can&#39;t find user or wrong passcode.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="302">
          
          
          <code class="ruby">            }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="303">
          <span class="hits">1</span>
          
          <code class="ruby">          }, status: 404 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="304">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="305">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="306">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="307">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="308">
          
          
          <code class="ruby">    rescue ActiveRecord::RecordInvalid =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="309">
          
          
          <code class="ruby">      msg = &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="310">
          
          
          <code class="ruby">      e.record.errors.map do |k, v|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="311">
          
          
          <code class="ruby">        key = k.to_s.humanize</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="312">
          
          
          <code class="ruby">        msg = msg + &quot;#{key} #{v}, &quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="313">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="314">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="315">
          
          
          <code class="ruby">      msg = msg.chomp(&quot;, &quot;) + &quot;.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="316">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="317">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="318">
          
          
          <code class="ruby">          message: msg</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="319">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="320">
          
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="321">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="322">
          
          
          <code class="ruby">    rescue Exception =&gt; e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="323">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="324">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="325">
          
          
          <code class="ruby">          message: e.message,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="326">
          
          
          <code class="ruby">          backtrace: e.backtrace</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="327">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="328">
          
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="329">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="330">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="331">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="332">
          <span class="hits">1</span>
          
          <code class="ruby">  private</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="333">
          <span class="hits">1</span>
          
          <code class="ruby">    def ensure_new_session_params</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="334">
          <span class="hits">7</span>
          
          <code class="ruby">      params.require(:user).permit(:phone_number, :app_id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="335">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="336">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="337">
          <span class="hits">1</span>
          
          <code class="ruby">    def ensure_verify_params</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="338">
          <span class="hits">3</span>
          
          <code class="ruby">      params.require(:user).permit(:phone_number, :app_id, :passcode)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="339">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="340">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="341">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="67c8d7df4ce2ae8648e82e4b82393f73f72aefb0">
  <div class="header">
    <h3>app/controllers/api/v1/auth_nonce_controller.rb</h3>
    <h4><span class="red">79.25 %</span> covered</h4>
    <div>
      <b>159</b> relevant lines. 
      <span class="green"><b>126</b> lines covered</span> and
      <span class="red"><b>33</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="2" data-linenumber="1">
          <span class="hits">2</span>
          
          <code class="ruby">require &#39;jwt&#39;</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="2">
          <span class="hits">2</span>
          
          <code class="ruby">require &#39;securerandom&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="4">
          <span class="hits">2</span>
          
          <code class="ruby">class Api::V1::AuthNonceController &lt; ApplicationController</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="5">
          <span class="hits">2</span>
          
          <code class="ruby">  before_action :ensure_new_session_params, only: [:create, :resend_passcode]</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="6">
          <span class="hits">2</span>
          
          <code class="ruby">  before_action :ensure_verify_params, only: [:verify]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">  # =begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">  # @apiVersion 1.0.0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">  # @api {post} /api/v1/auth_nonce Login or Register</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">  # @apiDescription Register user if not exist, otherwise only send passcode via SMS</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">  # @apiName LoginOrRegister</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">  # @apiGroup Auth Nonce</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">  # @apiParam {String} user[app_id] Application id, &#39;qisme&#39;, &#39;kiwari-stag&#39;, etc</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">  # @apiParam {String} user[phone_number] Phone number to be register or sign in</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">  # @apiParam {String} [user[country_code]] Country code. It also used at the beginning characters</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">  # of your phone number. Even though this parameter is optional, it&#39;ll be better if you use it</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">  # to ensure you can communicate with others in the same country.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">  # =end</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="21">
          <span class="hits">2</span>
          
          <code class="ruby">  def create</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="22">
          <span class="hits">16</span>
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="23">
          <span class="hits">16</span>
          
          <code class="ruby">      user = nil</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="24">
          <span class="hits">16</span>
          
          <code class="ruby">      jwt = &quot;&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">      # delete all session if not used within one month</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">      # put here since it will be called everytime user want to login, no need in transaction because it must be deleted whether the transaction success or not</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="28">
          <span class="hits">16</span>
          
          <code class="ruby">      AuthSession.where(&quot;auth_sessions.updated_at &lt; ?&quot;, 1.month.ago).destroy_all</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="30">
          <span class="hits">16</span>
          
          <code class="ruby">      ActiveRecord::Base.transaction do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">        # check the application id</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="32">
          <span class="hits">16</span>
          
          <code class="ruby">        application = Application.find_by(app_id: params[:user][:app_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="34">
          <span class="hits">16</span>
          
          <code class="ruby">        if application.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">          render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">            error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">              message: &quot;Application id is not found.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">            }</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="39">
          <span class="hits">2</span>
          
          <code class="ruby">          }, status: 404 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">        # check if user already exist or not</code>
        </li>
      
        <li class="covered" data-hits="14" data-linenumber="43">
          <span class="hits">14</span>
          
          <code class="ruby">        phone_number = params[:user][:phone_number]</code>
        </li>
      
        <li class="covered" data-hits="14" data-linenumber="44">
          <span class="hits">14</span>
          
          <code class="ruby">        if phone_number.nil? != false || phone_number != &quot;&quot;</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="45">
          <span class="hits">12</span>
          
          <code class="ruby">          phone_number = phone_number.strip().delete(&#39; &#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">          # phone_number = PhonyRails.normalize_number(phone_number, default_country_code: &#39;ID&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="48">
          <span class="hits">12</span>
          
          <code class="ruby">          if phone_number == &quot;&quot;</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="49">
          <span class="hits">2</span>
          
          <code class="ruby">            raise Exception.new(&#39;Phone number is empty.&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="52">
          <span class="hits">2</span>
          
          <code class="ruby">          raise Exception.new(&#39;Phone number is empty.&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="54">
          <span class="hits">10</span>
          
          <code class="ruby">        user = User.find_by(phone_number: phone_number, application_id: application.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">        # if nil then register</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="57">
          <span class="hits">10</span>
          
          <code class="ruby">        if user.nil?</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="58">
          <span class="hits">6</span>
          
          <code class="ruby">          passcode = SmsVerification.generate_code(phone_number, application.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">          # new user only for member level</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="60">
          <span class="hits">6</span>
          
          <code class="ruby">          role = Role.member</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="61">
          <span class="hits">6</span>
          
          <code class="ruby">          if role.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">            render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">              error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">                message: &quot;Can&#39;t find user role, please contact admin to seed their database.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">              }</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="66">
          <span class="hits">2</span>
          
          <code class="ruby">            }, status: 404 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="69">
          <span class="hits">4</span>
          
          <code class="ruby">          new_user_credential = params[:user].permit!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="71">
          <span class="hits">4</span>
          
          <code class="ruby">          email_sdk = params[:user][:phone_number].tr(&#39;+&#39;, &#39;&#39;).delete(&#39; &#39;)</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="72">
          <span class="hits">4</span>
          
          <code class="ruby">          email_sdk = email_sdk.downcase.gsub(/[^a-z0-9_.]/i, &quot;&quot;) # only get alphanumeric and _ and . string only</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="73">
          <span class="hits">4</span>
          
          <code class="ruby">          email_sdk = email_sdk + &quot;@&quot; + application.app_id + &quot;.com&quot; # will build string like 085868xxxxxx@app_id.com</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="75">
          <span class="hits">4</span>
          
          <code class="ruby">          new_user_credential.delete(:app_id) # delete app id, replace with application_id</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="76">
          <span class="hits">4</span>
          
          <code class="ruby">          new_user_credential[&quot;application_id&quot;] = application.id</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="77">
          <span class="hits">4</span>
          
          <code class="ruby">          new_user_credential[&quot;passcode&quot;] = passcode</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="78">
          <span class="hits">4</span>
          
          <code class="ruby">          new_user_credential[&quot;qiscus_token&quot;] = &quot;qiscus_token&quot;</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="79">
          <span class="hits">4</span>
          
          <code class="ruby">          new_user_credential[&quot;qiscus_email&quot;] = email_sdk</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="80">
          <span class="hits">4</span>
          
          <code class="ruby">          new_user_credential[&quot;phone_number&quot;] = phone_number</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">          # check is parameter country code presence or not</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">          # if yes, we will use it as user&#39;s country code.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">          # if not, we will assuming the first 3 digits is country code</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="85">
          <span class="hits">4</span>
          
          <code class="ruby">          country_code = params[:user][:country_code]</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="86">
          <span class="hits">4</span>
          
          <code class="ruby">          if country_code.present? &amp;&amp; !country_code.nil? &amp;&amp; country_code != &quot;&quot;</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="87">
          <span class="hits">2</span>
          
          <code class="ruby">            new_user_credential[&quot;country_code&quot;] = country_code</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="89">
          <span class="hits">2</span>
          
          <code class="ruby">            new_user_credential[&quot;country_code&quot;] = phone_number.slice(0..2)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">          # set default user avatar</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="93">
          <span class="hits">4</span>
          
          <code class="ruby">          new_user_credential[&quot;avatar_url&quot;] = &quot;https://d1edrlpyc25xu0.cloudfront.net/image/upload/t5XWp2PBRt/1510641299-default_user_avatar.png&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">          # using class initiation to avoid user send another params (i.e fullname and it is saved)</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="96">
          <span class="hits">4</span>
          
          <code class="ruby">          user = User.new</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="97">
          <span class="hits">4</span>
          
          <code class="ruby">          user.phone_number = new_user_credential[&quot;phone_number&quot;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">          # user.fullname = new_user_credential[&quot;phone_number&quot;] # fullname set to be nil to inform client</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="99">
          <span class="hits">4</span>
          
          <code class="ruby">          user.application_id = new_user_credential[&quot;application_id&quot;]</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="100">
          <span class="hits">4</span>
          
          <code class="ruby">          user.passcode = new_user_credential[&quot;passcode&quot;]</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="101">
          <span class="hits">4</span>
          
          <code class="ruby">          user.qiscus_token = new_user_credential[&quot;qiscus_token&quot;]</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="102">
          <span class="hits">4</span>
          
          <code class="ruby">          user.qiscus_email = new_user_credential[&quot;qiscus_email&quot;]</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="103">
          <span class="hits">4</span>
          
          <code class="ruby">          user.is_public = false</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="104">
          <span class="hits">4</span>
          
          <code class="ruby">          user.country_code = new_user_credential[&quot;country_code&quot;]</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="105">
          <span class="hits">4</span>
          
          <code class="ruby">          user.avatar_url = new_user_credential[&quot;avatar_url&quot;]</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="106">
          <span class="hits">4</span>
          
          <code class="ruby">          user.save!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby">          # Backend no need to register user in SDK (but if it&#39;s okay even it is happen (for easy debugging when trying qisus chat room))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby">          # add user id to email to ensure that email is really unique</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="110">
          <span class="hits">4</span>
          
          <code class="ruby">          email_sdk = &quot;userid_&quot; + user.id.to_s + &quot;_&quot; + user.qiscus_email</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby">          # this ensure qiscus email sdk to be unique</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="113">
          <span class="hits">4</span>
          
          <code class="ruby">          user.update_attribute(:qiscus_email, email_sdk)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="115">
          <span class="hits">4</span>
          
          <code class="ruby">          user_role = UserRole.new(user_id: user.id, role_id: role.id)</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="116">
          <span class="hits">4</span>
          
          <code class="ruby">          user_role.save!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">          # username is user phone_number</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="119">
          <span class="hits">4</span>
          
          <code class="ruby">          username = new_user_credential[&quot;phone_number&quot;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby">          # if exist then just update passcode</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby">          # for now, update passcode only when passcode field in database is nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby">          # if passcode field not nil its mean user request to resend passcode. Then take the existing passcode value</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">          # handling race condition with locking</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="125">
          <span class="hits">4</span>
          
          <code class="ruby">          user.with_lock do</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="126">
          <span class="hits">4</span>
          
          <code class="ruby">            if user.passcode.nil? || user.passcode == &quot;&quot;</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="127">
          <span class="hits">2</span>
          
          <code class="ruby">              passcode = SmsVerification.generate_code(phone_number, application.id)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="128">
          <span class="hits">2</span>
          
          <code class="ruby">              user.update_columns(passcode: passcode)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby">            else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="130">
          
          
          <code class="ruby">              # get current passcode</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="131">
          <span class="hits">2</span>
          
          <code class="ruby">              passcode = user.passcode</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="133">
          <span class="hits">4</span>
          
          <code class="ruby">            email_sdk = user.qiscus_email</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="134">
          <span class="hits">4</span>
          
          <code class="ruby">            username = user.fullname</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="138">
          <span class="hits">8</span>
          
          <code class="ruby">        password = SecureRandom.hex # generate random password for security reason</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="140">
          <span class="hits">8</span>
          
          <code class="ruby">        avatar_url = user.avatar_url</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby">        # set default username</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="142">
          <span class="hits">8</span>
          
          <code class="ruby">        if username.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="143">
          
          
          <code class="ruby">          username = user.phone_number</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby">        # set default user avatar</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="147">
          <span class="hits">8</span>
          
          <code class="ruby">        if avatar_url.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="148">
          
          
          <code class="ruby">          avatar_url = &quot;https://d1edrlpyc25xu0.cloudfront.net/image/upload/t5XWp2PBRt/1510641299-default_user_avatar.png&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="149">
          
          
          <code class="ruby">          user.update_attribute(:avatar_url, avatar_url)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="150">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby">        # login or register to SDK using rest api</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="153">
          <span class="hits">8</span>
          
          <code class="ruby">        qiscus_sdk = QiscusSdk.new(application.app_id, application.qiscus_sdk_secret)</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="154">
          <span class="hits">8</span>
          
          <code class="ruby">        qiscus_token = qiscus_sdk.login_or_register_rest(email_sdk, password, username, avatar_url)</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="155">
          <span class="hits">8</span>
          
          <code class="ruby">        user.update_columns(qiscus_token: qiscus_token) # always update qiscus token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="156">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby">        # here the user must already created, so we can add default contact (official user) here</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="158">
          <span class="hits">8</span>
          
          <code class="ruby">        role_official_user = Role.official</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="159">
          <span class="hits">8</span>
          
          <code class="ruby">        if role_official_user.nil? == false</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="160">
          <span class="hits">8</span>
          
          <code class="ruby">          user_role_ids = UserRole.where(role_id: role_official_user.id).pluck(:user_id).to_a</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="161">
          <span class="hits">8</span>
          
          <code class="ruby">          official_account = User.where(&quot;id IN (?)&quot;, user_role_ids).where(application_id: application.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="163">
          <span class="hits">8</span>
          
          <code class="ruby">          official_account.each do |oa|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="164">
          
          
          <code class="ruby">            contact = Contact.find_by(user_id: user.id, contact_id: oa.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="165">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="166">
          
          
          <code class="ruby">            if contact.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="167">
          
          
          <code class="ruby">              contact = Contact.new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="168">
          
          
          <code class="ruby">              contact.user_id = user.id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="169">
          
          
          <code class="ruby">              contact.contact_id = oa.id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="170">
          
          
          <code class="ruby">              contact.save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="171">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="172">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="173">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="174">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="175">
          
          
          <code class="ruby">        # then send the passcode sms</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="176">
          <span class="hits">8</span>
          
          <code class="ruby">        SmsVerification.request(user, passcode)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="177">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="178">
          
          
          <code class="ruby">        # For debugging or quality assurance testing, send passcode to Qiscus if phone number contains &quot;+628681&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="179">
          
          
          <code class="ruby">        # why &quot;+628681&quot; because it is a valid predecessor phone number in Indonesia,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="180">
          
          
          <code class="ruby">        # since model using phony_plausible validation it need to be use valid number to register</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="181">
          <span class="hits">8</span>
          
          <code class="ruby">        if user.phone_number.include?(&quot;+628681&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="182">
          
          
          <code class="ruby">          # send to qiscus</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="183">
          
          
          <code class="ruby">          messages = &quot;#{application.app_name} : Passcode for account #{user.phone_number} is #{user.passcode}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="184">
          
          
          <code class="ruby">          SendToQiscus.send_message(110362, messages)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="185">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="186">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="187">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="188">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="189">
          
          
          <code class="ruby">        data: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="190">
          
          
          <code class="ruby">          message: &quot;Passcode sent. Please verify your account.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="191">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="192">
          <span class="hits">8</span>
          
          <code class="ruby">      } and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="193">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="194">
          <span class="hits">4</span>
          
          <code class="ruby">    rescue ActiveRecord::RecordInvalid =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="195">
          
          
          <code class="ruby">      msg = &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="196">
          
          
          <code class="ruby">      e.record.errors.map do |k, v|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="197">
          
          
          <code class="ruby">        key = k.to_s.humanize</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="198">
          
          
          <code class="ruby">        msg = msg + &quot;#{key} #{v}, &quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="199">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="200">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="201">
          
          
          <code class="ruby">      msg = msg.chomp(&quot;, &quot;) + &quot;.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="202">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="203">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="204">
          
          
          <code class="ruby">          message: msg</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="205">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="206">
          
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="207">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="208">
          
          
          <code class="ruby">    rescue Exception =&gt; e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="209">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="210">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="211">
          
          
          <code class="ruby">          message: e.message</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="212">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="213">
          <span class="hits">4</span>
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="214">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="215">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="216">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="217">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="218">
          
          
          <code class="ruby">  # =begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="219">
          
          
          <code class="ruby">  # @apiVersion 1.0.0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="220">
          
          
          <code class="ruby">  # @api {post} /api/v1/auth_nonce/resend_passcode Resend passcode</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="221">
          
          
          <code class="ruby">  # @apiDescription Resend passcode</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="222">
          
          
          <code class="ruby">  # @apiName ResendPasscode</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="223">
          
          
          <code class="ruby">  # @apiGroup Auth Nonce</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="224">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="225">
          
          
          <code class="ruby">  # @apiParam {String} user[app_id] User application id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="226">
          
          
          <code class="ruby">  # @apiParam {String} user[phone_number] Registered phone number</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="227">
          
          
          <code class="ruby">  # =end</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="228">
          <span class="hits">2</span>
          
          <code class="ruby">  def resend_passcode</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="229">
          <span class="hits">6</span>
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="230">
          <span class="hits">6</span>
          
          <code class="ruby">      ActiveRecord::Base.transaction do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="231">
          
          
          <code class="ruby">        # check the application id</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="232">
          <span class="hits">6</span>
          
          <code class="ruby">        application = Application.find_by(app_id: params[:user][:app_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="233">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="234">
          <span class="hits">6</span>
          
          <code class="ruby">        if application.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="235">
          
          
          <code class="ruby">          render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="236">
          
          
          <code class="ruby">            error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="237">
          
          
          <code class="ruby">              message: &quot;Application id is not found.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="238">
          
          
          <code class="ruby">            }</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="239">
          <span class="hits">2</span>
          
          <code class="ruby">          }, status: 404 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="240">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="241">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="242">
          <span class="hits">4</span>
          
          <code class="ruby">        phone_number = params[:user][:phone_number]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="243">
          
          
          <code class="ruby">        # phone_number = PhonyRails.normalize_number(phone_number, default_country_code: &#39;ID&#39;)</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="244">
          <span class="hits">4</span>
          
          <code class="ruby">        user = User.find_by(phone_number: phone_number, application_id: application.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="245">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="246">
          <span class="hits">4</span>
          
          <code class="ruby">        if !user.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="247">
          
          
          <code class="ruby">          # for now, no change passcode on resend passcode</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="248">
          <span class="hits">2</span>
          
          <code class="ruby">          if !user.passcode.nil?</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="249">
          <span class="hits">2</span>
          
          <code class="ruby">            passcode = user.passcode</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="250">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="251">
          
          
          <code class="ruby">            passcode = SmsVerification.generate_code(phone_number, application.id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="252">
          
          
          <code class="ruby">            user.update_attribute(:passcode, passcode)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="253">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="254">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="255">
          
          
          <code class="ruby">          # then send the passcode sms</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="256">
          <span class="hits">2</span>
          
          <code class="ruby">          SmsVerification.request(user, passcode)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="257">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="258">
          
          
          <code class="ruby">          render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="259">
          
          
          <code class="ruby">            data: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="260">
          
          
          <code class="ruby">              message: &quot;Passcode sent. Please verify your account.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="261">
          
          
          <code class="ruby">            }</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="262">
          <span class="hits">2</span>
          
          <code class="ruby">          } and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="263">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="264">
          
          
          <code class="ruby">          render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="265">
          
          
          <code class="ruby">            error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="266">
          
          
          <code class="ruby">              message: &quot;Can&#39;t find user.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="267">
          
          
          <code class="ruby">            }</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="268">
          <span class="hits">2</span>
          
          <code class="ruby">          }, status: 404 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="269">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="270">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="271">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="272">
          
          
          <code class="ruby">    rescue ActiveRecord::RecordInvalid =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="273">
          
          
          <code class="ruby">      msg = &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="274">
          
          
          <code class="ruby">      e.record.errors.map do |k, v|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="275">
          
          
          <code class="ruby">        key = k.to_s.humanize</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="276">
          
          
          <code class="ruby">        msg = msg + &quot;#{key} #{v}, &quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="277">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="278">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="279">
          
          
          <code class="ruby">      msg = msg.chomp(&quot;, &quot;) + &quot;.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="280">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="281">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="282">
          
          
          <code class="ruby">          message: msg</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="283">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="284">
          
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="285">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="286">
          
          
          <code class="ruby">    rescue Exception =&gt; e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="287">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="288">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="289">
          
          
          <code class="ruby">          message: e.message</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="290">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="291">
          
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="292">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="293">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="294">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="295">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="296">
          
          
          <code class="ruby">  # =begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="297">
          
          
          <code class="ruby">  # @apiVersion 1.0.0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="298">
          
          
          <code class="ruby">  # @api {post} /api/v1/auth_nonce/verify Verify passcode from SMS</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="299">
          
          
          <code class="ruby">  # @apiDescription Return access token and user object if successful</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="300">
          
          
          <code class="ruby">  # @apiName AuthVerify</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="301">
          
          
          <code class="ruby">  # @apiGroup Auth Nonce</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="302">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="303">
          
          
          <code class="ruby">  # @apiParam {String} user[app_id] Application id, &#39;qisme&#39;, &#39;kiwari-stag&#39;, etc</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="304">
          
          
          <code class="ruby">  # @apiParam {String} user[phone_number] Phone number to validate</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="305">
          
          
          <code class="ruby">  # @apiParam {String} user[passcode] Passcode from SMS</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="306">
          
          
          <code class="ruby">  # @apiParam {String} user[nonce] Nonce from SDK</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="307">
          
          
          <code class="ruby">  # =end</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="308">
          <span class="hits">2</span>
          
          <code class="ruby">  def verify</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="309">
          <span class="hits">12</span>
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="310">
          <span class="hits">12</span>
          
          <code class="ruby">      ActiveRecord::Base.transaction do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="311">
          
          
          <code class="ruby">        # check the application id</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="312">
          <span class="hits">12</span>
          
          <code class="ruby">        application = Application.find_by(app_id: params[:user][:app_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="313">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="314">
          <span class="hits">12</span>
          
          <code class="ruby">        if application.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="315">
          
          
          <code class="ruby">          render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="316">
          
          
          <code class="ruby">            error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="317">
          
          
          <code class="ruby">              message: &quot;Application id is not found.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="318">
          
          
          <code class="ruby">            }</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="319">
          <span class="hits">2</span>
          
          <code class="ruby">          }, status: 404 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="320">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="321">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="322">
          <span class="hits">10</span>
          
          <code class="ruby">        phone_number = params[:user][:phone_number]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="323">
          
          
          <code class="ruby">        # phone_number = PhonyRails.normalize_number(phone_number, default_country_code: &#39;ID&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="324">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="325">
          
          
          <code class="ruby">        # check empty passcode</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="326">
          <span class="hits">10</span>
          
          <code class="ruby">        passcode = params[:user][:passcode]</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="327">
          <span class="hits">10</span>
          
          <code class="ruby">        if passcode.nil? || passcode.blank?</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="328">
          <span class="hits">2</span>
          
          <code class="ruby">          raise Exception.new(&#39;passcode cannot be empty.&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="329">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="330">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="331">
          
          
          <code class="ruby">        # check empty nonce</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="332">
          <span class="hits">8</span>
          
          <code class="ruby">        nonce = params[:user][:nonce]</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="333">
          <span class="hits">8</span>
          
          <code class="ruby">        if nonce.nil? || nonce.blank?</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="334">
          <span class="hits">2</span>
          
          <code class="ruby">          raise Exception.new(&#39;nonce cannot be empty.&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="335">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="336">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="337">
          <span class="hits">6</span>
          
          <code class="ruby">        user = User.find_by(phone_number: phone_number,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="338">
          
          
          <code class="ruby">          passcode: passcode, application_id: application.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="339">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="340">
          
          
          <code class="ruby">        # if user with given phone number AND passcode AND app_id is EXIST then return object user</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="341">
          <span class="hits">6</span>
          
          <code class="ruby">        if !user.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="342">
          
          
          <code class="ruby">          # update passcode to nil (so user can&#39;t verify again once the code is used)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="343">
          <span class="hits">2</span>
          
          <code class="ruby">          user.update_columns(passcode: nil) # using update_columns to prevent calling callback</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="344">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="345">
          
          
          <code class="ruby">          # now generate access_token for this user</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="346">
          <span class="hits">2</span>
          
          <code class="ruby">          access_token = ApplicationHelper.create_jwt_token(user, request)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="347">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="348">
          
          
          <code class="ruby">          # need to destroy access_token since it using auth nonce</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="349">
          
          
          <code class="ruby">          # release_date = &quot;2017-11-23 15:30:00&quot; # set auth nonce release date</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="350">
          
          
          <code class="ruby">          # AuthSession.where(&quot;updated_at &lt; ? AND user_id = ?&quot;, release_date, user.id).destroy_all</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="351">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="352">
          <span class="hits">2</span>
          
          <code class="ruby">          email_sdk = user.qiscus_email</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="353">
          
          
          <code class="ruby">          </code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="354">
          <span class="hits">2</span>
          
          <code class="ruby">          avatar_url = user.avatar_url</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="355">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="356">
          <span class="hits">2</span>
          
          <code class="ruby">          payload = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="357">
          
          
          <code class="ruby">            &quot;iss&quot;: application.app_id, # your qiscus app id, can obtained from dashboard</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="358">
          
          
          <code class="ruby">            &quot;iat&quot;: Time.now.to_i, # current timestamp in unix</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="359">
          <span class="hits">2</span>
          
          <code class="ruby">            &quot;exp&quot;: (Time.now + 2*60).to_i, # An arbitrary time in the future when this token should expire. In epoch/unix time. We encourage you to limit 2 minutes</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="360">
          
          
          <code class="ruby">            &quot;nbf&quot;: Time.now.to_i, # current timestamp in unix</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="361">
          
          
          <code class="ruby">            &quot;nce&quot;: nonce, # nonce string from nonce API</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="362">
          
          
          <code class="ruby">            &quot;prn&quot;: email_sdk, # your user identity such as email</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="363">
          
          
          <code class="ruby">            &quot;name&quot;: &quot;&quot;, # optional, string for user name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="364">
          
          
          <code class="ruby">            &quot;avatar_url&quot;: &quot;&quot; # optional, string url of user avatar</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="365">
          
          
          <code class="ruby">          }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="366">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="367">
          <span class="hits">2</span>
          
          <code class="ruby">          header = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="368">
          
          
          <code class="ruby">            &quot;alg&quot;: &quot;HS256&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="369">
          
          
          <code class="ruby">            &quot;typ&quot;: &quot;JWT&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="370">
          
          
          <code class="ruby">            &quot;ver&quot;: &quot;v2&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="371">
          
          
          <code class="ruby">          }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="372">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="373">
          
          
          <code class="ruby">          # generate identity_token using nonce</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="374">
          <span class="hits">2</span>
          
          <code class="ruby">          identity_token = JWT.encode(payload, application.qiscus_sdk_secret, &#39;HS256&#39;, header)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="375">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="376">
          
          
          <code class="ruby">          render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="377">
          
          
          <code class="ruby">            access_token: access_token,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="378">
          
          
          <code class="ruby">            identity_token: identity_token,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="379">
          
          
          <code class="ruby">            data: user</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="380">
          <span class="hits">2</span>
          
          <code class="ruby">          } and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="381">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="382">
          
          
          <code class="ruby">          render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="383">
          
          
          <code class="ruby">            error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="384">
          
          
          <code class="ruby">              message: &quot;Can&#39;t find user or wrong passcode.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="385">
          
          
          <code class="ruby">            }</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="386">
          <span class="hits">4</span>
          
          <code class="ruby">          }, status: 404 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="387">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="388">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="389">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="390">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="391">
          <span class="hits">4</span>
          
          <code class="ruby">    rescue ActiveRecord::RecordInvalid =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="392">
          
          
          <code class="ruby">      msg = &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="393">
          
          
          <code class="ruby">      e.record.errors.map do |k, v|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="394">
          
          
          <code class="ruby">        key = k.to_s.humanize</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="395">
          
          
          <code class="ruby">        msg = msg + &quot;#{key} #{v}, &quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="396">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="397">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="398">
          
          
          <code class="ruby">      msg = msg.chomp(&quot;, &quot;) + &quot;.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="399">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="400">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="401">
          
          
          <code class="ruby">          message: msg</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="402">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="403">
          
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="404">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="405">
          
          
          <code class="ruby">    rescue Exception =&gt; e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="406">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="407">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="408">
          
          
          <code class="ruby">          message: e.message,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="409">
          
          
          <code class="ruby">          # backtrace: e.backtrace</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="410">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="411">
          <span class="hits">4</span>
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="412">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="413">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="414">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="415">
          <span class="hits">2</span>
          
          <code class="ruby">  private</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="416">
          <span class="hits">2</span>
          
          <code class="ruby">    def ensure_new_session_params</code>
        </li>
      
        <li class="covered" data-hits="22" data-linenumber="417">
          <span class="hits">22</span>
          
          <code class="ruby">      params.require(:user).permit(:phone_number, :app_id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="418">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="419">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="420">
          <span class="hits">2</span>
          
          <code class="ruby">    def ensure_verify_params</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="421">
          <span class="hits">12</span>
          
          <code class="ruby">      params.require(:user).permit(:phone_number, :app_id, :passcode)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="422">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="423">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="424">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="388f5f15f61f663122dc30a2541ee65405a4bac1">
  <div class="header">
    <h3>app/controllers/api/v1/calls_controller.rb</h3>
    <h4><span class="red">53.9 %</span> covered</h4>
    <div>
      <b>154</b> relevant lines. 
      <span class="green"><b>83</b> lines covered</span> and
      <span class="red"><b>71</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class Api::V1::CallsController &lt; ProtectedController</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  before_action :authorize_user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">  # =begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">  # @apiVersion 1.0.0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">  # @api {post} /api/v1/calls System event message for call</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">  # @apiDescription System event message for call</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">  # @apiName SystemEventMessageForCall</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">  # @apiGroup Calls</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">  # @apiParam {String} access_token User access token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">  # @apiParam {String} user_email It&#39;s using qiscus_email</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">  # @apiParam {String} user_type User_type = &#39;caller&#39; or &#39;callee&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">  # @apiParam {String} call_room_id It&#39;s generated by client</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">  # @apiParam {Boolean} is_video Is_video = &#39;true&#39; or &#39;false&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">  # @apiParam {String} call_event Call_event = &#39;incoming&#39;, &#39;accept&#39;, &#39;end&#39;, &#39;cancel&#39;, &#39;reject&#39;. incoming and cancel send from caller user. accept, reject send from callee user. end can be send from caller and callee user.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">  # @apiParam {String} [extras = null] Extras must be json object string</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">  # @apiParam {String} [bot_user_email = null] If this parameter set, it will create a group chat with is_official_chat = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">  # =end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">  def create</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="21">
          <span class="hits">6</span>
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="22">
          <span class="hits">6</span>
          
          <code class="ruby">      user_email = params[:user_email]</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="23">
          <span class="hits">6</span>
          
          <code class="ruby">      if user_email.nil? || user_email == &quot;&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">        raise Exception.new(&quot;user_email cannot be empty.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="27">
          <span class="hits">5</span>
          
          <code class="ruby">      user1 = User.find_by(qiscus_email: user_email, application_id: @current_user.application.id)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="28">
          <span class="hits">5</span>
          
          <code class="ruby">      if user1.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">        raise Exception.new(&quot;User is not found.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="32">
          <span class="hits">5</span>
          
          <code class="ruby">      user_type = params[:user_type]</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="33">
          <span class="hits">5</span>
          
          <code class="ruby">      if user_type.nil? || !user_type.present? || user_type == &quot;&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">        raise Exception.new(&quot;user_type can&#39;t be empty.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="36">
          <span class="hits">4</span>
          
          <code class="ruby">        if user_type.downcase.delete(&#39; &#39;) != &quot;caller&quot; &amp;&amp; user_type.downcase.delete(&#39; &#39;) != &quot;callee&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">          raise Exception.new(&quot;Permitted user_type is &#39;caller&#39; or &#39;callee&#39;.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="41">
          <span class="hits">4</span>
          
          <code class="ruby">      call_room_id = params[:call_room_id]</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="42">
          <span class="hits">4</span>
          
          <code class="ruby">      if call_room_id.nil? || call_room_id == &quot;&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="43">
          <span class="hits">1</span>
          
          <code class="ruby">        raise Exception.new(&quot;call_room_id cannot be empty.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="46">
          <span class="hits">3</span>
          
          <code class="ruby">      if params[:is_video].nil? || !params[:is_video].present? || params[:is_video] == &quot;&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="47">
          <span class="hits">1</span>
          
          <code class="ruby">        raise Exception.new(&quot;is_video can&#39;t be empty.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="49">
          <span class="hits">2</span>
          
          <code class="ruby">        if params[:is_video].downcase.delete(&#39; &#39;) != &quot;true&quot; &amp;&amp; params[:is_video].downcase.delete(&#39; &#39;) != &quot;false&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">          raise Exception.new(&quot;Permitted is_video is &#39;true&#39; or &#39;false&#39;.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="54">
          <span class="hits">2</span>
          
          <code class="ruby">      if params[:is_video] == &quot;true&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">        is_video = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="57">
          <span class="hits">2</span>
          
          <code class="ruby">        is_video = false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="60">
          <span class="hits">2</span>
          
          <code class="ruby">      call_event = params[:call_event]</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="61">
          <span class="hits">2</span>
          
          <code class="ruby">      if call_event.nil? || !call_event.present? || call_event == &quot;&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="62">
          <span class="hits">1</span>
          
          <code class="ruby">        raise Exception.new(&quot;Call event can&#39;t be empty.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="64">
          <span class="hits">1</span>
          
          <code class="ruby">        if call_event.downcase.delete(&#39; &#39;) != &quot;incoming&quot; &amp;&amp; call_event.downcase.delete(&#39; &#39;) != &quot;accept&quot; &amp;&amp; call_event.downcase.delete(&#39; &#39;) != &quot;end&quot; &amp;&amp; call_event.downcase.delete(&#39; &#39;) != &quot;cancel&quot; &amp;&amp; call_event.downcase.delete(&#39; &#39;) != &quot;reject&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="65">
          
          
          <code class="ruby">          raise Exception.new(&quot;Permitted call_event is &#39;incoming&#39;, &#39;accept&#39;, &#39;end&#39;, &#39;cancel&#39;, &#39;reject&#39;.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="71">
          <span class="hits">1</span>
          
          <code class="ruby">      user2 = @current_user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">      # define caller and callee user</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="73">
          <span class="hits">1</span>
          
          <code class="ruby">      if user_type == &#39;callee&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="74">
          <span class="hits">1</span>
          
          <code class="ruby">        caller_user = user2</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="75">
          <span class="hits">1</span>
          
          <code class="ruby">        callee_user = user1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="77">
          
          
          <code class="ruby">        caller_user = user1</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="78">
          
          
          <code class="ruby">        callee_user = user2</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="81">
          <span class="hits">1</span>
          
          <code class="ruby">      qiscus_sdk = QiscusSdk.new(@current_user.application.app_id, @current_user.application.qiscus_sdk_secret)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="82">
          <span class="hits">1</span>
          
          <code class="ruby">      bot_user_email = params[:bot_user_email]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="84">
          <span class="hits">1</span>
          
          <code class="ruby">      if bot_user_email.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">        # Looking for a single chat between caller and callee</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="86">
          <span class="hits">1</span>
          
          <code class="ruby">        chat_room = ChatRoom.where(is_group_chat: false, user_id: [caller_user.id, callee_user.id], target_user_id: [caller_user.id, callee_user.id]).first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="88">
          <span class="hits">1</span>
          
          <code class="ruby">        if chat_room.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">          # If single chat is nil then create single chat between caller and callee</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="90">
          
          
          <code class="ruby">          emails = [caller_user.qiscus_email, callee_user.qiscus_email]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="91">
          
          
          <code class="ruby">          room = qiscus_sdk.get_or_create_room_with_target_rest(emails) # call sdk to create single room</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">          # Then get room_id from sdk</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="94">
          
          
          <code class="ruby">          qiscus_room_id = room.id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby">          # Insert data into qisme database</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="97">
          
          
          <code class="ruby">          chat_room = ChatRoom.find_by(qiscus_room_id: qiscus_room_id, application_id: @current_user.application.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">          # if chat room with room id and room topic id not exist then create it</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="100">
          
          
          <code class="ruby">          if chat_room.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="101">
          
          
          <code class="ruby">            chat_name = &quot;Group Chat Name&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="103">
          
          
          <code class="ruby">            chat_room = ChatRoom.new(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby">              group_chat_name: chat_name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby">              qiscus_room_name: chat_name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby">              qiscus_room_id: qiscus_room_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">              is_group_chat: false,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby">              user_id: @current_user.id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby">              target_user_id: callee_user.id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby">              application_id: @current_user.application.id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby">            )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="113">
          
          
          <code class="ruby">            chat_room.save!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="115">
          
          
          <code class="ruby">            ChatUser.create(chat_room_id: chat_room.id, user_id: @current_user.id) unless ChatUser.exists?(chat_room_id: chat_room.id, user_id: @current_user.id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="116">
          
          
          <code class="ruby">            ChatUser.create(chat_room_id: chat_room.id, user_id: callee_user.id) unless ChatUser.exists?(chat_room_id: chat_room.id, user_id: callee_user.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby">          # If single chat already exist then get qiscus_room_id</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="120">
          <span class="hits">1</span>
          
          <code class="ruby">          qiscus_room_id = chat_room.qiscus_room_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="123">
          
          
          <code class="ruby">        bot_user = User.find_by(qiscus_email: bot_user_email, application_id: @current_user.application_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="124">
          
          
          <code class="ruby">        if bot_user.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="125">
          
          
          <code class="ruby">          raise Exception.new(&quot;Bot user is not found.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby">        # Looking for a group chat with is_official_chat=true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby">        # The participants are caller, callee and bot</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="130">
          
          
          <code class="ruby">        chat_room = ChatRoom.where(is_group_chat: true, is_official_chat: true, user_id: [caller_user.id, callee_user.id], target_user_id: [caller_user.id, callee_user.id]).first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="132">
          
          
          <code class="ruby">        if chat_room.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby">          # If group chat is nil then create group chat with caller, callee, and bot as participants</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="134">
          
          
          <code class="ruby">          chat_name = &quot;Group Chat Name&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="135">
          
          
          <code class="ruby">          participants = [caller_user.qiscus_email, callee_user.qiscus_email, bot_user.qiscus_email]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="136">
          
          
          <code class="ruby">          room = qiscus_sdk.create_room(chat_name, participants, @current_user.qiscus_email) # call sdk to create group chat</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby">          # Then get room_id from sdk</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="139">
          
          
          <code class="ruby">          qiscus_room_id = room.id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby">          # Insert data into qisme database</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="142">
          
          
          <code class="ruby">          chat_room = ChatRoom.find_by(qiscus_room_id: qiscus_room_id, application_id: @current_user.application.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby">          # if chat room with room id and room topic id not exist then create it</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="145">
          
          
          <code class="ruby">          if chat_room.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="146">
          
          
          <code class="ruby">            chat_room = ChatRoom.new(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby">              group_chat_name: chat_name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby">              qiscus_room_name: chat_name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby">              qiscus_room_id: qiscus_room_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="150">
          
          
          <code class="ruby">              is_group_chat: true,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby">              user_id: @current_user.id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby">              target_user_id: callee_user.id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby">              application_id: @current_user.application.id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="154">
          
          
          <code class="ruby">              is_official_chat: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby">            )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="156">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="157">
          
          
          <code class="ruby">            chat_room.save!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="158">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="159">
          
          
          <code class="ruby">            ChatUser.create(chat_room_id: chat_room.id, user_id: @current_user.id) unless ChatUser.exists?(chat_room_id: chat_room.id, user_id: @current_user.id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="160">
          
          
          <code class="ruby">            ChatUser.create(chat_room_id: chat_room.id, user_id: callee_user.id) unless ChatUser.exists?(chat_room_id: chat_room.id, user_id: callee_user.id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="161">
          
          
          <code class="ruby">            ChatUser.create(chat_room_id: chat_room.id, user_id: bot_user.id) unless ChatUser.exists?(chat_room_id: chat_room.id, user_id: bot_user.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="164">
          
          
          <code class="ruby">          # If single chat already exist then get qiscus_room_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="165">
          
          
          <code class="ruby">          qiscus_room_id = chat_room.qiscus_room_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="166">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="167">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="168">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="169">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="170">
          
          
          <code class="ruby">      # Define system_event_type to be stored in payload</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="171">
          <span class="hits">1</span>
          
          <code class="ruby">      system_event_type = &quot;call&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="172">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="173">
          
          
          <code class="ruby">      # define message because its has 5 call_event (&#39;incoming&#39;, &#39;accept&#39;, &#39;end&#39;, &#39;cancel&#39;, &#39;reject&#39;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="174">
          <span class="hits">1</span>
          
          <code class="ruby">      if call_event == &#39;incoming&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="175">
          <span class="hits">1</span>
          
          <code class="ruby">        message = &quot;#{caller_user.fullname} call #{callee_user.fullname}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="176">
          
          
          <code class="ruby">      elsif call_event == &#39;accept&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="177">
          
          
          <code class="ruby">        message = &quot;#{callee_user.fullname} accept call from #{caller_user.fullname}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="178">
          
          
          <code class="ruby">      elsif call_event == &#39;end&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="179">
          
          
          <code class="ruby">        message = &quot;#{user2.fullname} end call to #{user1.fullname}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="180">
          
          
          <code class="ruby">      elsif call_event == &#39;cancel&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="181">
          
          
          <code class="ruby">        message = &quot;#{caller_user.fullname} cancel call to #{callee_user.fullname}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="182">
          
          
          <code class="ruby">      elsif call_event == &#39;reject&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="183">
          
          
          <code class="ruby">        message = &quot;#{callee_user.fullname} reject call from #{caller_user.fullname}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="184">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="185">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="186">
          
          
          <code class="ruby">      # send data to call_logs</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="187">
          <span class="hits">1</span>
          
          <code class="ruby">      CallLog.create(caller_user_id: caller_user.id, callee_user_id: callee_user.id, call_event: call_event, message: message, application_id: @current_user.application_id, call_room_id: call_room_id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="188">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="189">
          
          
          <code class="ruby">      # Create payload</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="190">
          <span class="hits">1</span>
          
          <code class="ruby">      payload = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="191">
          
          
          <code class="ruby">        &quot;system_event_type&quot;:  system_event_type,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="192">
          
          
          <code class="ruby">        &quot;caller_user&quot;:        caller_user,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="193">
          
          
          <code class="ruby">        &quot;callee_user&quot;:        callee_user,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="194">
          
          
          <code class="ruby">        &quot;message&quot;:            message,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="195">
          
          
          <code class="ruby">        &quot;call_room_id&quot;:       call_room_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="196">
          
          
          <code class="ruby">        &quot;is_video&quot;:           is_video,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="197">
          
          
          <code class="ruby">        &quot;call_event&quot;:         call_event</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="198">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="199">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="200">
          <span class="hits">1</span>
          
          <code class="ruby">      extras = params[:extras] # string</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="201">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="202">
          
          
          <code class="ruby">      # set payload for extras parameter</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="203">
          <span class="hits">1</span>
          
          <code class="ruby">      if !extras.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="204">
          
          
          <code class="ruby">        qiscus_ios_pn = JSON.parse(extras)[&#39;qiscus_ios_pn&#39;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="205">
          
          
          <code class="ruby">        if !qiscus_ios_pn.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="206">
          
          
          <code class="ruby">          extras = JSON.parse(extras)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="207">
          
          
          <code class="ruby">          extras[&#39;qiscus_ios_pn&#39;][&#39;payload&#39;] = payload</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="208">
          
          
          <code class="ruby">          extras = extras.to_json</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="209">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="210">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="211">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="212">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="213">
          
          
          <code class="ruby">      # Set android payload</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="214">
          <span class="hits">1</span>
          
          <code class="ruby">       android_payload = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="215">
          
          
          <code class="ruby">         data: payload</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="216">
          
          
          <code class="ruby">       }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="217">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="218">
          
          
          <code class="ruby">      # Set ios payload</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="219">
          <span class="hits">1</span>
          
          <code class="ruby">      ios_payload = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="220">
          
          
          <code class="ruby">        &quot;system_event_type&quot;:  system_event_type,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="221">
          
          
          <code class="ruby">        &quot;caller_user&quot;:        caller_user.as_json.to_json,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="222">
          
          
          <code class="ruby">        &quot;callee_user&quot;:        callee_user.as_json.to_json,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="223">
          
          
          <code class="ruby">        &quot;message&quot;:            message,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="224">
          
          
          <code class="ruby">        &quot;call_room_id&quot;:       call_room_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="225">
          
          
          <code class="ruby">        &quot;is_video&quot;:           is_video,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="226">
          
          
          <code class="ruby">        &quot;call_event&quot;:         call_event</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="227">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="228">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="229">
          
          
          <code class="ruby">      # Alert for ios PN</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="230">
          <span class="hits">1</span>
          
          <code class="ruby">      alert = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="231">
          
          
          <code class="ruby">          title: &quot;Incoming Call&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="232">
          
          
          <code class="ruby">          body: &quot;#{caller_user.fullname} calling you&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="233">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="234">
          <span class="hits">1</span>
          
          <code class="ruby">      sound = &quot;phone_ring.caf&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="235">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="236">
          <span class="hits">1</span>
          
          <code class="ruby">      type = &quot;custom&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="237">
          <span class="hits">1</span>
          
          <code class="ruby">      qiscus_token = @current_user.qiscus_token</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="238">
          <span class="hits">1</span>
          
          <code class="ruby">      topic_id = qiscus_room_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="239">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="240">
          
          
          <code class="ruby">      # post system event message for incoming call_event</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="241">
          <span class="hits">1</span>
          
          <code class="ruby">      if call_event == &quot;incoming&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="242">
          <span class="hits">1</span>
          
          <code class="ruby">        qiscus_sdk.post_system_event_message(type, topic_id, &quot;&quot;, [], &quot;&quot;, payload.to_json, message, extras)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="243">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="244">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="245">
          
          
          <code class="ruby">      # send call push notification</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="246">
          <span class="hits">1</span>
          
          <code class="ruby">      userdevicetokens = user1.user_device_tokens</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="247">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="248">
          
          
          <code class="ruby">      # find fcm_key that store in applications table</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="249">
          <span class="hits">1</span>
          
          <code class="ruby">			fcm_key = @current_user.application.fcm_key</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="250">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="251">
          <span class="hits">1</span>
          
          <code class="ruby">      registration_ids = Array.new</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="252">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="253">
          <span class="hits">1</span>
          
          <code class="ruby">      userdevicetokens.each do | u |</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="254">
          
          
          <code class="ruby">        # collect android devicetoken into array</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="255">
          
          
          <code class="ruby">        if u.user_type == &quot;android&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="256">
          
          
          <code class="ruby">          registration_ids.push(u.devicetoken)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="257">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="258">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="259">
          
          
          <code class="ruby">        # send push notification to ios for call signaling</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="260">
          
          
          <code class="ruby">        if @current_user.application.is_send_call_pn == true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="261">
          
          
          <code class="ruby">          if u.user_type == &#39;ios&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="262">
          
          
          <code class="ruby">            SendApnsJob.perform_later(@current_user.application, alert, u.devicetoken, ios_payload, sound)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="263">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="264">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="265">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="266">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="267">
          
          
          <code class="ruby">      # send push notification to android using fcm</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="268">
          <span class="hits">1</span>
          
          <code class="ruby">      FcmClient.send(fcm_key, registration_ids, android_payload)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="269">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="270">
          <span class="hits">1</span>
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="271">
          
          
          <code class="ruby">        data: payload</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="272">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="273">
          <span class="hits">5</span>
          
          <code class="ruby">    rescue ActiveRecord::RecordInvalid =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="274">
          
          
          <code class="ruby">      msg = &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="275">
          
          
          <code class="ruby">      e.record.errors.map do |k, v|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="276">
          
          
          <code class="ruby">        key = k.to_s.humanize</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="277">
          
          
          <code class="ruby">        msg = msg + &quot;#{key} #{v}, &quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="278">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="279">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="280">
          
          
          <code class="ruby">      msg = msg.chomp(&quot;, &quot;) + &quot;.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="281">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="282">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="283">
          
          
          <code class="ruby">          message: msg,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="284">
          
          
          <code class="ruby">          backtrace: e.backtrace</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="285">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="286">
          
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="287">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="288">
          
          
          <code class="ruby">    rescue Exception =&gt; e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="289">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="290">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="291">
          
          
          <code class="ruby">          message: e.message</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="292">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="293">
          <span class="hits">5</span>
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="294">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="295">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="296">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="297">
          
          
          <code class="ruby">  # =begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="298">
          
          
          <code class="ruby">  # @apiVersion 1.0.0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="299">
          
          
          <code class="ruby">  # @api {get} /api/v1/calls List of user call logs</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="300">
          
          
          <code class="ruby">  # @apiDescription CallLogs</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="301">
          
          
          <code class="ruby">  # @apiName CallLogs</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="302">
          
          
          <code class="ruby">  # @apiGroup Calls</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="303">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="304">
          
          
          <code class="ruby">  # @apiParam {String} access_token User access token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="305">
          
          
          <code class="ruby">  # @apiParam {Number} page Page number</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="306">
          
          
          <code class="ruby">	# @apiParam {Number} limit Limit</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="307">
          
          
          <code class="ruby">	# @apiParam {String} [start_date] Filter call logs by date. filter this by start_date and end_date. use format YYYY-MM-DD</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="308">
          
          
          <code class="ruby">	# @apiParam {String} [end_date] Filter call logs by date. filter this by start_date and end_date. use format YYYY-MM-DD</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="309">
          
          
          <code class="ruby">  # =end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="310">
          <span class="hits">1</span>
          
          <code class="ruby">  def index</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="311">
          <span class="hits">3</span>
          
          <code class="ruby">    total_page = 0</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="312">
          <span class="hits">3</span>
          
          <code class="ruby">    total = 0</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="313">
          <span class="hits">3</span>
          
          <code class="ruby">    limit = params[:limit]</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="314">
          <span class="hits">3</span>
          
          <code class="ruby">    page = params[:page]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="315">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="316">
          <span class="hits">3</span>
          
          <code class="ruby">    user = @current_user</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="317">
          <span class="hits">3</span>
          
          <code class="ruby">    call_logs = CallLog.where(caller_user_id: user.id, application_id: user.application_id)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="318">
          <span class="hits">3</span>
          
          <code class="ruby">		call_logs = call_logs.or(CallLog.where(callee_user_id: user.id, application_id: user.application_id))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="319">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="320">
          <span class="hits">3</span>
          
          <code class="ruby">		if params[:start_date].present? &amp;&amp; params[:end_date].present?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="321">
          <span class="hits">1</span>
          
          <code class="ruby">			start_date = params[:start_date].to_time</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="322">
          <span class="hits">1</span>
          
          <code class="ruby">			end_date = params[:end_date].to_time</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="323">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="324">
          <span class="hits">1</span>
          
          <code class="ruby">			call_logs = call_logs.where(created_at: start_date.beginning_of_day..end_date.end_of_day)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="325">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="326">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="327">
          
          
          <code class="ruby">    # update call duration and connected_at from call sdk</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="328">
          <span class="hits">3</span>
          
          <code class="ruby">    call_logs.each do |call_log|</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="329">
          <span class="hits">10</span>
          
          <code class="ruby">      if call_log.status == &quot;missed&quot;  # this assume that &quot;missed&quot; status is because the user call is on going</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="330">
          
          
          <code class="ruby">        call_sdk = QiscusCallSdk.new()</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="331">
          
          
          <code class="ruby">        connected_at, duration, status = call_sdk.logs_by_call_room_id(call_log.call_room_id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="332">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="333">
          
          
          <code class="ruby">        call_log.update(duration: duration, connected_at: connected_at, status: status)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="334">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="335">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="336">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="337">
          <span class="hits">3</span>
          
          <code class="ruby">    call_logs = call_logs.order(created_at: :desc)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="338">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="339">
          <span class="hits">3</span>
          
          <code class="ruby">    total = call_logs.count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="340">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="341">
          
          
          <code class="ruby">    # pagination only when exist</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="342">
          <span class="hits">3</span>
          
          <code class="ruby">    if page.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="343">
          
          
          <code class="ruby">      call_logs = call_logs.page(page)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="344">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="345">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="346">
          
          
          <code class="ruby">    # if limit and page present, then use kaminari pagination</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="347">
          <span class="hits">3</span>
          
          <code class="ruby">    if limit.present? &amp;&amp; page.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="348">
          
          
          <code class="ruby">      call_logs = call_logs.per(limit)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="349">
          
          
          <code class="ruby">    # else use limit from ActiveRecord</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="350">
          <span class="hits">3</span>
          
          <code class="ruby">    elsif limit.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="351">
          
          
          <code class="ruby">      call_logs = call_logs.limit(limit)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="352">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="353">
          <span class="hits">3</span>
          
          <code class="ruby">      limit = 25</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="354">
          <span class="hits">3</span>
          
          <code class="ruby">      call_logs = call_logs.limit(25)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="355">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="356">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="357">
          <span class="hits">3</span>
          
          <code class="ruby">    total_page = (total / limit.to_f).ceil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="358">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="359">
          <span class="hits">3</span>
          
          <code class="ruby">    render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="360">
          
          
          <code class="ruby">      meta: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="361">
          
          
          <code class="ruby">        limit: limit.to_i,</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="362">
          <span class="hits">3</span>
          
          <code class="ruby">        page: page == nil || page.to_i &lt; 0 ? 0 : page.to_i,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="363">
          
          
          <code class="ruby">        total_page: total_page,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="364">
          
          
          <code class="ruby">        total: total,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="365">
          
          
          <code class="ruby">      },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="366">
          
          
          <code class="ruby">      data: call_logs</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="367">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="368">
          
          
          <code class="ruby">    rescue ActiveRecord::RecordInvalid =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="369">
          
          
          <code class="ruby">      msg = &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="370">
          
          
          <code class="ruby">      e.record.errors.map do |k, v|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="371">
          
          
          <code class="ruby">        key = k.to_s.humanize</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="372">
          
          
          <code class="ruby">        msg = msg + &quot;#{key} #{v}, &quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="373">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="374">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="375">
          
          
          <code class="ruby">      msg = msg.chomp(&quot;, &quot;) + &quot;.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="376">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="377">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="378">
          
          
          <code class="ruby">          message: msg,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="379">
          
          
          <code class="ruby">          backtrace: e.backtrace</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="380">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="381">
          
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="382">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="383">
          
          
          <code class="ruby">    rescue Exception =&gt; e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="384">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="385">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="386">
          
          
          <code class="ruby">          message: e.message</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="387">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="388">
          
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="389">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="390">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="391">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="e796631e31972737f357e7a59227db066656bba3">
  <div class="header">
    <h3>app/controllers/api/v1/chat/conversations/admins_controller.rb</h3>
    <h4><span class="red">36.57 %</span> covered</h4>
    <div>
      <b>134</b> relevant lines. 
      <span class="green"><b>49</b> lines covered</span> and
      <span class="red"><b>85</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class Api::V1::Chat::Conversations::AdminsController &lt; ProtectedController</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  before_action :authorize_user</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  before_action :ensure_eligible_access_to_chatroom</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">  # =begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">  # @apiVersion 1.0.0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">  # @api {get} /api/v1/chat/conversations/:qiscus_room_id/admins Get Group Admins</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">  # @apiName GetGroupAdmins</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">  # @apiGroup Group Chat Admin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">  # @apiParam {Number} qiscus_room_id Qiscus room id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">  # @apiParam {String} access_token User access token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">  # =end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">  def index</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">      participants = @chat_room</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">      chat_room_id = participants.id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">      # Get user_id that assign as group admin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">      group_admin_ids = ChatUser.where(chat_room_id: chat_room_id).where(is_group_admin: TRUE).pluck(:user_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">      group_admins = User.where(&quot;id IN (?)&quot;, group_admin_ids)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">        data: group_admins</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">    rescue Exception =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">          message: e.message</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">      }, status: 422</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">  # =begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">  # @apiVersion 1.0.0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">  # @api {post} /api/v1/chat/conversations/:qiscus_room_id/admins Add Group Admins</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">  # @apiName AddGroupAdmins</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">  # @apiGroup Group Chat Admin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">  # @apiParam {Number} qiscus_room_id Qiscus room id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">  # @apiParam {Array} [user_id[]] Array of integer of user id, e.g: `user_id[]=1&amp;user_id[]=2`</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">  # @apiParam {Array} [qiscus_email[]] Array of registered qiscus email, e.g: `qiscus_email[]=userid_6_qismetest3.mailinator.com@qisme.com&amp;qiscus_email[]=userid_5_qismetest2.mailinator.com@qisme.com`</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">  # @apiParam {String} access_token User access token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">  # =end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="46">
          <span class="hits">1</span>
          
          <code class="ruby">  def create</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="47">
          <span class="hits">4</span>
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="48">
          <span class="hits">4</span>
          
          <code class="ruby">      chat_room = @chat_room</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="49">
          <span class="hits">4</span>
          
          <code class="ruby">      new_admin_ids = Array.new</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="51">
          <span class="hits">4</span>
          
          <code class="ruby">      ActiveRecord::Base.transaction do</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="52">
          <span class="hits">4</span>
          
          <code class="ruby">        user_ids_already_in_group = chat_room.users.pluck(:id).to_a</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="53">
          <span class="hits">4</span>
          
          <code class="ruby">        if user_ids_already_in_group.include?(@current_user.id) == false</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="54">
          <span class="hits">1</span>
          
          <code class="ruby">          raise Exception.new(&quot;You are not member of this group.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">        # only admin can add new group admin</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="58">
          <span class="hits">3</span>
          
          <code class="ruby">        is_group_admin = ChatUser.find_by(chat_room_id: chat_room.id, user_id: @current_user.id, is_group_admin: true)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="59">
          <span class="hits">3</span>
          
          <code class="ruby">        if is_group_admin.nil?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="60">
          <span class="hits">1</span>
          
          <code class="ruby">          raise Exception.new(&quot;You are not admin of this group. Only admin can add new group admin.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="63">
          <span class="hits">2</span>
          
          <code class="ruby">        if !params[:user_id].present? &amp;&amp; !params[:qiscus_email].present?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="64">
          <span class="hits">1</span>
          
          <code class="ruby">          raise Exception.new(&quot;Array of user id or qiscus email must be present.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">        # add group admins using array of user_id</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="68">
          <span class="hits">1</span>
          
          <code class="ruby">        if params[:user_id].kind_of?(Array) &amp;&amp; params[:user_id].present?</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="69">
          <span class="hits">2</span>
          
          <code class="ruby">          user_ids = params[:user_id].to_a.map { |e| e.to_i  }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">          # ensure that candidate group admin has been already in group</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="72">
          <span class="hits">1</span>
          
          <code class="ruby">          user_ids_not_in_group = user_ids - user_ids_already_in_group</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="73">
          <span class="hits">1</span>
          
          <code class="ruby">          if !user_ids_not_in_group.empty?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="74">
          
          
          <code class="ruby">            raise Exception.new(&quot;Users with user_id #{user_ids_not_in_group} are not group participants.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="77">
          <span class="hits">1</span>
          
          <code class="ruby">          new_admin_ids = User.where(&quot;id IN (?)&quot;, user_ids).pluck(:id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="79">
          <span class="hits">1</span>
          
          <code class="ruby">          new_admin_ids.each do |aid|</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="80">
          <span class="hits">1</span>
          
          <code class="ruby">            c = ChatUser.find_by(chat_room_id: chat_room.id, user_id: aid)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="81">
          <span class="hits">1</span>
          
          <code class="ruby">            c.update_attribute(:is_group_admin, true)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">          # get user qiscus_email</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="85">
          <span class="hits">1</span>
          
          <code class="ruby">          user_qiscus_emails = User.where(&quot;id IN (?)&quot;, user_ids).pluck(:qiscus_email)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">        # add group admins using array of qiscus email</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="89">
          <span class="hits">1</span>
          
          <code class="ruby">        if params[:qiscus_email].kind_of?(Array) &amp;&amp; params[:qiscus_email].present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="90">
          
          
          <code class="ruby">          user_qiscus_emails = params[:qiscus_email].to_a.map { |e| e.to_s  }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="91">
          
          
          <code class="ruby">          registered_user_qiscus_emails = chat_room.users.pluck(:qiscus_email).to_a</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">          # ensure that candidate group admin has been already in group</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="94">
          
          
          <code class="ruby">          user_qiscus_email_not_in_group = user_qiscus_emails - registered_user_qiscus_emails</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="95">
          
          
          <code class="ruby">          if !user_qiscus_email_not_in_group.empty?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="96">
          
          
          <code class="ruby">            raise Exception.new(&quot;Users with qiscus_email #{user_qiscus_email_not_in_group} are not group participants.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="99">
          
          
          <code class="ruby">          new_admin_ids = User.where(&quot;qiscus_email IN (?)&quot;, user_qiscus_emails).pluck(:id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="101">
          
          
          <code class="ruby">          new_admin_ids.each do |aid|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="102">
          
          
          <code class="ruby">            c = ChatUser.find_by(chat_room_id: chat_room.id, user_id: aid)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="103">
          
          
          <code class="ruby">            c.update_attribute(:is_group_admin, true)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">        # Backend need to post system event message after add participants as admin</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="108">
          <span class="hits">1</span>
          
          <code class="ruby">        if !user_qiscus_emails.empty? || !user_qiscus_email.nil?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="109">
          <span class="hits">1</span>
          
          <code class="ruby">          subject_email = User.find(@current_user.id)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="110">
          <span class="hits">1</span>
          
          <code class="ruby">          user_qiscus_emails = user_qiscus_emails.uniq</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="112">
          <span class="hits">1</span>
          
          <code class="ruby">          qiscus_sdk = QiscusSdk.new(@current_user.application.app_id, @current_user.application.qiscus_sdk_secret)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="114">
          <span class="hits">1</span>
          
          <code class="ruby">          user_qiscus_emails.each do |email|</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="115">
          <span class="hits">1</span>
          
          <code class="ruby">            object_user = User.find_by(qiscus_email: email)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">            # Define system_event_type to be stored in payload</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="118">
          <span class="hits">1</span>
          
          <code class="ruby">            system_event_type = &quot;add_group_admin&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="119">
          <span class="hits">1</span>
          
          <code class="ruby">            message = &quot;#{subject_email.fullname} added #{object_user.fullname} as admin&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby">            # Create payload</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="122">
          <span class="hits">1</span>
          
          <code class="ruby">            payload = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby">              &quot;system_event_type&quot;:    system_event_type,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">              &quot;subject_email&quot;:        subject_email,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby">              &quot;object_email&quot;:         email,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby">              &quot;subject&quot;:              subject_email,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby">              &quot;object&quot;:               object_user,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby">              &quot;message&quot;:              message</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby">            }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="130">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="131">
          <span class="hits">1</span>
          
          <code class="ruby">            system_event_type = &quot;custom&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="132">
          <span class="hits">1</span>
          
          <code class="ruby">            qiscus_sdk.post_system_event_message(system_event_type, chat_room.qiscus_room_id, &quot;&quot;, [], &quot;&quot;, payload.to_json, message)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby">      # Get user_id that assign as group admin</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="139">
          <span class="hits">1</span>
          
          <code class="ruby">      group_admins = User.where(&quot;id IN (?)&quot;, new_admin_ids)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="142">
          
          
          <code class="ruby">        data: group_admins</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="143">
          <span class="hits">1</span>
          
          <code class="ruby">      } and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="145">
          <span class="hits">3</span>
          
          <code class="ruby">    rescue ActiveRecord::RecordInvalid =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="146">
          
          
          <code class="ruby">      msg = &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="147">
          
          
          <code class="ruby">      e.record.errors.map do |k, v|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="148">
          
          
          <code class="ruby">        key = k.to_s.humanize</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="149">
          
          
          <code class="ruby">        msg = msg + &quot;#{key} #{v}, &quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="150">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="152">
          
          
          <code class="ruby">      msg = msg.chomp(&quot;, &quot;) + &quot;.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="154">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby">          message: msg</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="156">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="157">
          
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="158">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby">    rescue Exception =&gt; e</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="160">
          <span class="hits">3</span>
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="161">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby">          message: e.message</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="164">
          
          
          <code class="ruby">      }, status: 422</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="165">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="166">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="167">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="168">
          
          
          <code class="ruby">  # =begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="169">
          
          
          <code class="ruby">  # @apiVersion 1.0.0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="170">
          
          
          <code class="ruby">  # @api {delete} /api/v1/chat/conversations/:qiscus_room_id/admins/ Delete Group Admins</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="171">
          
          
          <code class="ruby">  # @apiName DeleteGroupAdmins</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="172">
          
          
          <code class="ruby">  # @apiGroup Group Chat Admin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="173">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="174">
          
          
          <code class="ruby">  # @apiParam {Number} qiscus_room_id Qiscus room id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="175">
          
          
          <code class="ruby">  # @apiParam {Array} [user_id[]] Array of integer of user id, e.g: `user_id[]=1&amp;user_id[]=2`</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="176">
          
          
          <code class="ruby">  # @apiParam {Array} [qiscus_email[]] Array of registered qiscus email, e.g: `qiscus_email[]=userid_6_qismetest3.mailinator.com@qisme.com&amp;qiscus_email[]=userid_5_qismetest2.mailinator.com@qisme.com`</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="177">
          
          
          <code class="ruby">  # @apiParam {String} access_token User access token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="178">
          
          
          <code class="ruby">  # =end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="179">
          <span class="hits">1</span>
          
          <code class="ruby">  def delete_group_admins</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="180">
          
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="181">
          
          
          <code class="ruby">      chat_room = @chat_room</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="182">
          
          
          <code class="ruby">      delete_admin_ids = Array.new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="183">
          
          
          <code class="ruby">      ActiveRecord::Base.transaction do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="184">
          
          
          <code class="ruby">        if !params[:user_id].present? &amp;&amp; !params[:qiscus_email].present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="185">
          
          
          <code class="ruby">          raise Exception.new(&quot;Array of user id or qiscus email must be present.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="186">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="187">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="188">
          
          
          <code class="ruby">        user_ids_already_in_group = chat_room.users.pluck(:id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="189">
          
          
          <code class="ruby">        if user_ids_already_in_group.to_a.include?(@current_user.id) == false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="190">
          
          
          <code class="ruby">          raise Exception.new(&quot;You are not member of this group.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="191">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="192">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="193">
          
          
          <code class="ruby">        # only admin can delete group admin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="194">
          
          
          <code class="ruby">        is_group_admin = ChatUser.find_by(chat_room_id: chat_room.id, user_id: @current_user.id, is_group_admin: true)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="195">
          
          
          <code class="ruby">        if is_group_admin.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="196">
          
          
          <code class="ruby">          raise Exception.new(&quot;You are not admin of this group. Only admin can delete group admin.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="197">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="198">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="199">
          
          
          <code class="ruby">        # delete group admins using array of user_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="200">
          
          
          <code class="ruby">        if params[:user_id].kind_of?(Array) &amp;&amp; params[:user_id].present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="201">
          
          
          <code class="ruby">          user_ids = params[:user_id].to_a.map { |e| e.to_i  }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="202">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="203">
          
          
          <code class="ruby">          # admin can&#39;t remove themselves from admin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="204">
          
          
          <code class="ruby">          if user_ids.include?(@current_user.id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="205">
          
          
          <code class="ruby">            raise Exception.new(&quot;You can&#39;t remove yourself from admin.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="206">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="207">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="208">
          
          
          <code class="ruby">          # ensure that candidate group admin has been already in group</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="209">
          
          
          <code class="ruby">          user_ids_not_in_group = user_ids - user_ids_already_in_group</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="210">
          
          
          <code class="ruby">          if !user_ids_not_in_group.empty?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="211">
          
          
          <code class="ruby">            raise Exception.new(&quot;Users with user_id #{user_ids_not_in_group} are not group participants.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="212">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="213">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="214">
          
          
          <code class="ruby">          delete_admin_ids = User.where(&quot;id IN (?)&quot;, user_ids).pluck(:id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="215">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="216">
          
          
          <code class="ruby">          delete_admin_ids.each do |aid|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="217">
          
          
          <code class="ruby">            c = ChatUser.find_by(chat_room_id: chat_room.id, user_id: aid)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="218">
          
          
          <code class="ruby">            c.update_attribute(:is_group_admin, false)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="219">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="220">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="221">
          
          
          <code class="ruby">          # get user qiscus_email</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="222">
          
          
          <code class="ruby">          user_qiscus_emails = User.where(&quot;id IN (?)&quot;, user_ids).pluck(:qiscus_email)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="223">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="224">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="225">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="226">
          
          
          <code class="ruby">        # delete group admins using array of qiscus email</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="227">
          
          
          <code class="ruby">        if params[:qiscus_email].kind_of?(Array) &amp;&amp; params[:qiscus_email].present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="228">
          
          
          <code class="ruby">          user_qiscus_emails = params[:qiscus_email].to_a.map { |e| e.to_s  }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="229">
          
          
          <code class="ruby">          registered_user_qiscus_emails = chat_room.users.pluck(:qiscus_email).to_a</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="230">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="231">
          
          
          <code class="ruby">          # admin can&#39;t remove themselves from admin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="232">
          
          
          <code class="ruby">          if user_qiscus_emails.include?(@current_user.qiscus_email)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="233">
          
          
          <code class="ruby">            raise Exception.new(&quot;You can&#39;t remove yourself from admin.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="234">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="235">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="236">
          
          
          <code class="ruby">          # ensure that candidate group admin has been already in group</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="237">
          
          
          <code class="ruby">          user_qiscus_email_not_in_group = user_qiscus_emails - registered_user_qiscus_emails</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="238">
          
          
          <code class="ruby">          if !user_qiscus_email_not_in_group.empty?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="239">
          
          
          <code class="ruby">            raise Exception.new(&quot;Users with qiscus_email #{user_qiscus_email_not_in_group} are not group participants.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="240">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="241">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="242">
          
          
          <code class="ruby">          delete_admin_ids = User.where(&quot;qiscus_email IN (?)&quot;, user_qiscus_emails).pluck(:id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="243">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="244">
          
          
          <code class="ruby">          delete_admin_ids.each do |aid|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="245">
          
          
          <code class="ruby">            c = ChatUser.find_by(chat_room_id: chat_room.id, user_id: aid)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="246">
          
          
          <code class="ruby">            c.update_attribute(:is_group_admin, false)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="247">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="248">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="249">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="250">
          
          
          <code class="ruby">        # Backend need to post system event message after remove participants as admin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="251">
          
          
          <code class="ruby">        if !user_qiscus_emails.empty? || !user_qiscus_email.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="252">
          
          
          <code class="ruby">          subject_email = User.find(@current_user.id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="253">
          
          
          <code class="ruby">          user_qiscus_emails = user_qiscus_emails.uniq</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="254">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="255">
          
          
          <code class="ruby">          qiscus_sdk = QiscusSdk.new(@current_user.application.app_id, @current_user.application.qiscus_sdk_secret)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="256">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="257">
          
          
          <code class="ruby">          user_qiscus_emails.each do |email|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="258">
          
          
          <code class="ruby">            object_user = User.find_by(qiscus_email: email)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="259">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="260">
          
          
          <code class="ruby">            # Define system_event_type to be stored in payload</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="261">
          
          
          <code class="ruby">            system_event_type = &quot;remove_group_admin&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="262">
          
          
          <code class="ruby">            message = &quot;#{subject_email.fullname} removed #{object_user.fullname} as admin&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="263">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="264">
          
          
          <code class="ruby">            # Create payload</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="265">
          
          
          <code class="ruby">            payload = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="266">
          
          
          <code class="ruby">              &quot;system_event_type&quot;:    system_event_type,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="267">
          
          
          <code class="ruby">              &quot;subject_email&quot;:        subject_email,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="268">
          
          
          <code class="ruby">              &quot;object_email&quot;:         email,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="269">
          
          
          <code class="ruby">              &quot;subject&quot;:              subject_email,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="270">
          
          
          <code class="ruby">              &quot;object&quot;:               object_user,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="271">
          
          
          <code class="ruby">              &quot;message&quot;:              message,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="272">
          
          
          <code class="ruby">            }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="273">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="274">
          
          
          <code class="ruby">            system_event_type = &quot;custom&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="275">
          
          
          <code class="ruby">            qiscus_sdk.post_system_event_message(system_event_type, chat_room.qiscus_room_id, &quot;&quot;, [], &quot;&quot;, payload.to_json, message)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="276">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="277">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="278">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="279">
          
          
          <code class="ruby">        # Get user_id that delete as group admin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="280">
          
          
          <code class="ruby">        group_admins = User.where(&quot;id IN (?)&quot;, delete_admin_ids)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="281">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="282">
          
          
          <code class="ruby">        render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="283">
          
          
          <code class="ruby">          data: group_admins</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="284">
          
          
          <code class="ruby">        } and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="285">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="286">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="287">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="288">
          
          
          <code class="ruby">        data: nil</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="289">
          
          
          <code class="ruby">      } and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="290">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="291">
          
          
          <code class="ruby">    rescue ActiveRecord::RecordInvalid =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="292">
          
          
          <code class="ruby">      msg = &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="293">
          
          
          <code class="ruby">      e.record.errors.map do |k, v|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="294">
          
          
          <code class="ruby">        key = k.to_s.humanize</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="295">
          
          
          <code class="ruby">        msg = msg + &quot;#{key} #{v}, &quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="296">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="297">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="298">
          
          
          <code class="ruby">      msg = msg.chomp(&quot;, &quot;) + &quot;.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="299">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="300">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="301">
          
          
          <code class="ruby">          message: msg</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="302">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="303">
          
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="304">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="305">
          
          
          <code class="ruby">    rescue Exception =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="306">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="307">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="308">
          
          
          <code class="ruby">          message: e.message</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="309">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="310">
          
          
          <code class="ruby">      }, status: 422</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="311">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="312">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="313">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="314">
          <span class="hits">1</span>
          
          <code class="ruby">  private</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="315">
          <span class="hits">1</span>
          
          <code class="ruby">    def ensure_eligible_access_to_chatroom</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="316">
          <span class="hits">4</span>
          
          <code class="ruby">      if params[:chatroom_id].present? &amp;&amp; params[:chatroom_id] != &quot;&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="317">
          
          
          <code class="ruby">        # only chat room maker who can add or remove participant for this group</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="318">
          
          
          <code class="ruby">        # @chat_room = ChatRoom.find_by(id: params[:chatroom_id], user_id: @current_user.id)</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="319">
          <span class="hits">4</span>
          
          <code class="ruby">        @chat_room = ChatRoom.find_by(qiscus_room_id: params[:chatroom_id], application_id: @current_user.application.id)</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="320">
          <span class="hits">4</span>
          
          <code class="ruby">        if @chat_room.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="321">
          
          
          <code class="ruby">          render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="322">
          
          
          <code class="ruby">            error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="323">
          
          
          <code class="ruby">              message: &#39;You have no access to this chatroom or this chat room is not found.&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="324">
          
          
          <code class="ruby">            }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="325">
          
          
          <code class="ruby">          }, status: 401 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="326">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="327">
          <span class="hits">4</span>
          
          <code class="ruby">          if !@chat_room.is_group_chat</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="328">
          
          
          <code class="ruby">            raise Exception.new(&quot;This is not group chat. You can&#39;t add/remove participants.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="329">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="330">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="331">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="332">
          
          
          <code class="ruby">        render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="333">
          
          
          <code class="ruby">          error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="334">
          
          
          <code class="ruby">            message: &#39;Parameter chatroom_id required&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="335">
          
          
          <code class="ruby">          }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="336">
          
          
          <code class="ruby">        }, status: 400 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="337">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="338">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="339">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="340">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="341">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="9a76fbd11627a4192181f45dde45fbebd66f1e75">
  <div class="header">
    <h3>app/controllers/api/v1/chat/conversations/participants_controller.rb</h3>
    <h4><span class="red">47.85 %</span> covered</h4>
    <div>
      <b>209</b> relevant lines. 
      <span class="green"><b>100</b> lines covered</span> and
      <span class="red"><b>109</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class Api::V1::Chat::Conversations::ParticipantsController &lt; ProtectedController</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  before_action :authorize_user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby">  # expect index method, because it get participants for single and group chat room</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  before_action :ensure_eligible_access_to_chatroom, except: [:index]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  PREFIX_KEY = &quot;chat_room_user_&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">  # =begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">  # @apiVersion 1.0.0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">  # @api {get} /api/v1/chat/conversations/:qiscus_room_id/participants Get Group Participants</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">  # @apiName GroupParticipants</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">  # @apiGroup Group Chat Participant</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">  # @apiParam {Number} qiscus_room_id Qiscus room id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">  # @apiParam {String} access_token User access token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">  # =end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">  def index</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="18">
          <span class="hits">4</span>
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">      # participants = @chat_room</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="20">
          <span class="hits">4</span>
          
          <code class="ruby">      chat_room = ChatRoom.find_by(qiscus_room_id: params[:chatroom_id], application_id: @current_user.application.id)</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="21">
          <span class="hits">4</span>
          
          <code class="ruby">      participants = chat_room</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="23">
          <span class="hits">4</span>
          
          <code class="ruby">      chat_room_id = participants.id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="25">
          <span class="hits">4</span>
          
          <code class="ruby">      group_participants =  participants.users.includes(:roles, :application).map(&amp;:as_json)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">      # Map is_group_admin key</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="27">
          <span class="hits">4</span>
          
          <code class="ruby">      group_participants.map do |participant|</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="28">
          <span class="hits">10</span>
          
          <code class="ruby">        is_group_admin = ChatUser.where(chat_room_id: chat_room_id, user_id: participant[&quot;id&quot;]).pluck(:is_group_admin).first</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="29">
          <span class="hits">10</span>
          
          <code class="ruby">        participant.merge!(&#39;is_group_admin&#39; =&gt; is_group_admin)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">      # Get user_id that assign as group admin</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="33">
          <span class="hits">4</span>
          
          <code class="ruby">      group_admin_ids = ChatUser.where(chat_room_id: chat_room_id).where(is_group_admin: true).pluck(:user_id)</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="34">
          <span class="hits">4</span>
          
          <code class="ruby">      group_admins = User.where(&quot;id IN (?)&quot;, group_admin_ids).pluck(:id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="36">
          <span class="hits">4</span>
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">        # data: participants.users.includes(:roles, :application).map(&amp;:as_json),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">        data: group_participants,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">        group_admins: group_admins</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">    rescue Exception =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">          message: e.message</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">      }, status: 422</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">  # =begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">  # @apiVersion 1.0.0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">  # @api {post} /api/v1/chat/conversations/:qiscus_room_id/participants Add Group Participants</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">  # @apiName GroupAddParticipants</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">  # @apiGroup Group Chat Participant</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">  # @apiParam {Number} qiscus_room_id Qiscus room id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">  # @apiParam {Array} [user_id[]] Array of integer of user id, e.g: `user_id[]=1&amp;user_id[]=2`</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">  # @apiParam {Array} [qiscus_email[]] Array of registered qiscus email, e.g: `qiscus_email[]=userid_6_qismetest3.mailinator.com@qisme.com&amp;qiscus_email[]=userid_5_qismetest2.mailinator.com@qisme.com`</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">  # @apiParam {String} access_token User access token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">  # @apiParam {String} message Message to be posted they (participant[s]) is added</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">  # =end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="62">
          <span class="hits">1</span>
          
          <code class="ruby">  def create</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="63">
          <span class="hits">1</span>
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">      # data for post comment after data saved in qisme</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="65">
          <span class="hits">1</span>
          
          <code class="ruby">      new_participants_for_post_comment = Array.new</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="66">
          <span class="hits">1</span>
          
          <code class="ruby">      new_chat_users = Array.new</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="67">
          <span class="hits">1</span>
          
          <code class="ruby">      chat_room = @chat_room</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="68">
          <span class="hits">1</span>
          
          <code class="ruby">      new_participant_ids = Array.new</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="69">
          <span class="hits">1</span>
          
          <code class="ruby">      new_participant_emails = Array.new</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="71">
          <span class="hits">1</span>
          
          <code class="ruby">      ActiveRecord::Base.transaction do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">        # if group_chat is not channel, set maximum member to 100</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="73">
          <span class="hits">1</span>
          
          <code class="ruby">        if !chat_room.is_channel</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="74">
          <span class="hits">1</span>
          
          <code class="ruby">          total_participants = chat_room.users.count</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="75">
          <span class="hits">1</span>
          
          <code class="ruby">          if total_participants &gt; 100</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="76">
          
          
          <code class="ruby">            raise Exception.new(&quot;You cannot add more than 100 participants in group chat. Please use channel instead&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="80">
          <span class="hits">1</span>
          
          <code class="ruby">        user_ids_already_in_group = chat_room.users.pluck(:id).to_a</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="81">
          <span class="hits">1</span>
          
          <code class="ruby">        if user_ids_already_in_group.include?(@current_user.id) == false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="82">
          
          
          <code class="ruby">          raise Exception.new(&quot;You are not member of this group.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">        # only admin can add group participants</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="86">
          <span class="hits">1</span>
          
          <code class="ruby">        is_group_admin = ChatUser.find_by(chat_room_id: chat_room.id, user_id: @current_user.id, is_group_admin: true)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="87">
          <span class="hits">1</span>
          
          <code class="ruby">        if is_group_admin.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="88">
          
          
          <code class="ruby">          raise Exception.new(&quot;You are not admin of this group. Only admin can add group participants.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="91">
          <span class="hits">1</span>
          
          <code class="ruby">        if !params[:user_id].present? &amp;&amp; !params[:qiscus_email].present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="92">
          
          
          <code class="ruby">          raise Exception.new(&quot;Array of user id or qiscus email must be present.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="95">
          <span class="hits">1</span>
          
          <code class="ruby">        if params[:user_id].kind_of?(Array) &amp;&amp; params[:user_id].present?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="97">
          <span class="hits">2</span>
          
          <code class="ruby">          user_ids = params[:user_id].to_a.map { |e| e.to_i  }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">          # only get user id where aren&#39;t ready in group</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="99">
          <span class="hits">1</span>
          
          <code class="ruby">          user_ids = user_ids - user_ids_already_in_group</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="101">
          <span class="hits">1</span>
          
          <code class="ruby">          new_participants = User.includes(:roles, :application).where(&quot;users.id IN (?)&quot;, user_ids)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="102">
          <span class="hits">1</span>
          
          <code class="ruby">          new_participant_emails = new_participants.pluck(:qiscus_email)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="103">
          <span class="hits">1</span>
          
          <code class="ruby">          new_participant_ids = new_participants.pluck(:id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby">          # add to new participant array</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="106">
          <span class="hits">1</span>
          
          <code class="ruby">          new_participants_for_post_comment = new_participants_for_post_comment + new_participants</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="108">
          <span class="hits">1</span>
          
          <code class="ruby">          new_participant_ids.each do |uid|</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="109">
          <span class="hits">1</span>
          
          <code class="ruby">            tmp = Hash.new</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="110">
          <span class="hits">1</span>
          
          <code class="ruby">            tmp[:chat_room_id] = chat_room.id</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="111">
          <span class="hits">1</span>
          
          <code class="ruby">            tmp[:user_id] = uid</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="112">
          <span class="hits">1</span>
          
          <code class="ruby">            new_chat_users.push(tmp)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">          # add to sdk participant</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="116">
          <span class="hits">1</span>
          
          <code class="ruby">          if !new_participant_emails.empty?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="117">
          <span class="hits">1</span>
          
          <code class="ruby">            qiscus_sdk = QiscusSdk.new(@current_user.application.app_id, @current_user.application.qiscus_sdk_secret)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="118">
          <span class="hits">1</span>
          
          <code class="ruby">            qiscus_sdk.add_room_participants(new_participant_emails, chat_room.qiscus_room_id.to_i)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby">        # Add participant using array of qiscus email</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="123">
          <span class="hits">1</span>
          
          <code class="ruby">        if params[:qiscus_email].kind_of?(Array) &amp;&amp; params[:qiscus_email].present?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="125">
          
          
          <code class="ruby">          user_qiscus_emails = params[:qiscus_email].to_a.map { |e| e.to_s  }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="126">
          
          
          <code class="ruby">          registered_user_qiscus_emails = chat_room.users.pluck(:qiscus_email).to_a</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby">          # only get user with qiscus email where aren&#39;t ready in group</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="128">
          
          
          <code class="ruby">          user_qiscus_emails = user_qiscus_emails - registered_user_qiscus_emails</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="130">
          
          
          <code class="ruby">          new_participants = User.includes(:roles, :application).where(&quot;users.qiscus_email IN (?)&quot;, user_qiscus_emails)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="131">
          
          
          <code class="ruby">          new_participant_emails = new_participants.pluck(:qiscus_email)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="132">
          
          
          <code class="ruby">          new_participant_ids = new_participants.pluck(:id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby">          # add to new participant array</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="135">
          
          
          <code class="ruby">          new_participants_for_post_comment = new_participants_for_post_comment + new_participants</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="137">
          
          
          <code class="ruby">          new_participant_ids.each do |uid|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="138">
          
          
          <code class="ruby">            tmp = Hash.new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="139">
          
          
          <code class="ruby">            tmp[:chat_room_id] = chat_room.id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="140">
          
          
          <code class="ruby">            tmp[:user_id] = uid</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="141">
          
          
          <code class="ruby">            new_chat_users.push(tmp)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="142">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby">          # add to sdk participant</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="145">
          
          
          <code class="ruby">          if !new_participant_emails.empty?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="146">
          
          
          <code class="ruby">            qiscus_sdk = QiscusSdk.new(@current_user.application.app_id, @current_user.application.qiscus_sdk_secret)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="147">
          
          
          <code class="ruby">            qiscus_sdk.add_room_participants(new_participant_emails, chat_room.qiscus_room_id.to_i)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="150">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby">        # get only uniq user to prevent duplicate data</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="152">
          <span class="hits">1</span>
          
          <code class="ruby">        new_chat_users = new_chat_users.uniq</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="153">
          <span class="hits">1</span>
          
          <code class="ruby">        ChatUser.create(new_chat_users)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="154">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="156">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby">      # post message to group chat to make user notice about user add</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="158">
          
          
          <code class="ruby">      # post here to make sure all user has been added and commited to transaction before send to hooks</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="159">
          <span class="hits">1</span>
          
          <code class="ruby">      if !params[:message].nil? &amp;&amp; params[:message] != &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="160">
          
          
          <code class="ruby">        qiscus_sdk = QiscusSdk.new(@current_user.application.app_id, @current_user.application.qiscus_sdk_secret)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="161">
          
          
          <code class="ruby">        new_participants_for_post_comment.each do | new_participant |</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="162">
          
          
          <code class="ruby">          qiscus_sdk.post_comment(new_participant.qiscus_token, @chat_room.qiscus_room_id.to_i, params[:message])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="164">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="165">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="166">
          
          
          <code class="ruby">      # Backend need to post system event message after add group participants</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="167">
          
          
          <code class="ruby">      # Contact sync smarter after add group participants. It&#39;s only temporary to increase the number of contact</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="168">
          <span class="hits">1</span>
          
          <code class="ruby">      if !new_participant_emails.empty?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="169">
          <span class="hits">1</span>
          
          <code class="ruby">        system_event_type = &quot;add_member&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="170">
          <span class="hits">1</span>
          
          <code class="ruby">        qiscus_sdk = QiscusSdk.new(@current_user.application.app_id, @current_user.application.qiscus_sdk_secret)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="171">
          <span class="hits">1</span>
          
          <code class="ruby">        qiscus_sdk.post_system_event_message(system_event_type, @chat_room.qiscus_room_id.to_i, @current_user.qiscus_email, new_participant_emails, &quot;&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="172">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="173">
          <span class="hits">1</span>
          
          <code class="ruby">        group_participant_ids = chat_room.users.pluck(:id).to_a</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="174">
          <span class="hits">1</span>
          
          <code class="ruby">        ContactSyncSmarterWorker.perform_later(new_participant_ids, group_participant_ids, @current_user.application.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="175">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="176">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="177">
          <span class="hits">1</span>
          
          <code class="ruby">      chat_room = ChatRoom.includes(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="178">
          
          
          <code class="ruby">        [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="179">
          
          
          <code class="ruby">          :user =&gt; [],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="180">
          
          
          <code class="ruby">          :chat_users =&gt; [],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="181">
          
          
          <code class="ruby">          :users =&gt; [:roles, :application],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="182">
          
          
          <code class="ruby">          :target =&gt; [:roles, :application]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="183">
          
          
          <code class="ruby">        ]).find(chat_room.id).as_json()</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="184">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="185">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="186">
          
          
          <code class="ruby">        data: chat_room</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="187">
          <span class="hits">1</span>
          
          <code class="ruby">      } and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="188">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="189">
          
          
          <code class="ruby">    rescue ActiveRecord::RecordInvalid =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="190">
          
          
          <code class="ruby">      msg = &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="191">
          
          
          <code class="ruby">      e.record.errors.map do |k, v|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="192">
          
          
          <code class="ruby">        key = k.to_s.humanize</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="193">
          
          
          <code class="ruby">        msg = msg + &quot;#{key} #{v}, &quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="194">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="195">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="196">
          
          
          <code class="ruby">      msg = msg.chomp(&quot;, &quot;) + &quot;.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="197">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="198">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="199">
          
          
          <code class="ruby">          message: msg</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="200">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="201">
          
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="202">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="203">
          
          
          <code class="ruby">    rescue Exception =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="204">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="205">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="206">
          
          
          <code class="ruby">          message: e.message</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="207">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="208">
          
          
          <code class="ruby">      }, status: 422</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="209">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="210">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="211">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="212">
          
          
          <code class="ruby">  # =begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="213">
          
          
          <code class="ruby">  # @apiVersion 1.0.0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="214">
          
          
          <code class="ruby">  # @api {delete} /api/v1/chat/conversations/:qiscus_room_id/participants Delete Group Participants</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="215">
          
          
          <code class="ruby">  # @apiDescription use this alias `POST /api/v1/chat/conversations/:qiscus_room_id/delete_participants` if you prefer POST method,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="216">
          
          
          <code class="ruby">  # since in Delete method will cause error when it requested by unstable connection in client side.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="217">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="218">
          
          
          <code class="ruby">  # @apiName DeleteAddParticipants</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="219">
          
          
          <code class="ruby">  # @apiGroup Group Chat Participant</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="220">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="221">
          
          
          <code class="ruby">  # @apiParam {Number} qiscus_room_id Qiscus room id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="222">
          
          
          <code class="ruby">  # @apiParam {Array} [user_id[]] Array of integer of user id, e.g: `user_id[]=1&amp;user_id[]=2`</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="223">
          
          
          <code class="ruby">  # @apiParam {Array} [qiscus_email[]] Array of registered qiscus email, e.g: `qiscus_email[]=userid_6_qismetest3.mailinator.com@qisme.com&amp;qiscus_email[]=userid_5_qismetest2.mailinator.com@qisme.com`</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="224">
          
          
          <code class="ruby">  # @apiParam {String} access_token User access token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="225">
          
          
          <code class="ruby">  # @apiParam {String} message Message to be posted they (participant[s]) is removed</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="226">
          
          
          <code class="ruby">  # =end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="227">
          <span class="hits">1</span>
          
          <code class="ruby">  def delete_participants</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="228">
          <span class="hits">1</span>
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="229">
          <span class="hits">1</span>
          
          <code class="ruby">      ActiveRecord::Base.transaction do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="230">
          <span class="hits">1</span>
          
          <code class="ruby">        chat_room = @chat_room</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="231">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="232">
          <span class="hits">1</span>
          
          <code class="ruby">        if !params[:user_id].present? &amp;&amp; !params[:qiscus_email].present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="233">
          
          
          <code class="ruby">          raise Exception.new(&quot;Array of user id or qiscus email must be present.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="234">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="235">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="236">
          
          
          <code class="ruby">        # only admin can delete group participants</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="237">
          <span class="hits">1</span>
          
          <code class="ruby">        is_group_admin = ChatUser.find_by(chat_room_id: chat_room.id, user_id: @current_user.id, is_group_admin: true)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="238">
          <span class="hits">1</span>
          
          <code class="ruby">        if is_group_admin.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="239">
          
          
          <code class="ruby">          raise Exception.new(&quot;You are not admin of this group. Only admin can delete group participants.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="240">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="241">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="242">
          <span class="hits">1</span>
          
          <code class="ruby">        user_ids_already_in_group = chat_room.users.pluck(:id)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="243">
          <span class="hits">1</span>
          
          <code class="ruby">        if user_ids_already_in_group.to_a.include?(@current_user.id) == false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="244">
          
          
          <code class="ruby">          raise Exception.new(&quot;You are not member of this group.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="245">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="246">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="247">
          <span class="hits">1</span>
          
          <code class="ruby">        if params[:user_id].kind_of?(Array) &amp;&amp; params[:user_id].present?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="248">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="249">
          <span class="hits">2</span>
          
          <code class="ruby">          user_ids = params[:user_id].to_a.map { |e| e.to_i  }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="250">
          <span class="hits">1</span>
          
          <code class="ruby">          user_unpermitted_to_remove = user_ids_already_in_group - user_ids</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="251">
          <span class="hits">1</span>
          
          <code class="ruby">          user_permitted_to_remove = user_ids_already_in_group - user_unpermitted_to_remove</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="252">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="253">
          <span class="hits">1</span>
          
          <code class="ruby">          to_be_deleted = User.includes(:roles, :application).where(&quot;users.id IN (?)&quot;, user_permitted_to_remove)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="254">
          <span class="hits">1</span>
          
          <code class="ruby">          deleted_participant_emails = to_be_deleted.pluck(:qiscus_email)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="255">
          <span class="hits">1</span>
          
          <code class="ruby">          deleted_participant_ids = to_be_deleted.pluck(:id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="256">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="257">
          <span class="hits">1</span>
          
          <code class="ruby">          chat_user = ChatUser.where(&quot;chat_users.user_id IN (?)&quot;, deleted_participant_ids)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="258">
          <span class="hits">1</span>
          
          <code class="ruby">          chat_user = chat_user.where(chat_room_id: chat_room.id)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="259">
          <span class="hits">1</span>
          
          <code class="ruby">          chat_user.destroy_all</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="260">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="261">
          
          
          <code class="ruby">          # Begin delete redis cache</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="262">
          <span class="hits">1</span>
          
          <code class="ruby">          keys = []</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="263">
          <span class="hits">1</span>
          
          <code class="ruby">          user_ids.each do |uid|</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="264">
          <span class="hits">1</span>
          
          <code class="ruby">            k = &quot;#{PREFIX_KEY}#{uid}&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="265">
          <span class="hits">1</span>
          
          <code class="ruby">            keys.push(k)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="266">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="267">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="268">
          
          
          <code class="ruby">          # Redis SET, GET and DEL is atomic.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="269">
          <span class="hits">1</span>
          
          <code class="ruby">          if !keys.empty?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="270">
          <span class="hits">1</span>
          
          <code class="ruby">            $redis.del(keys)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="271">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="272">
          
          
          <code class="ruby">          # End delete redis cache</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="273">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="274">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="275">
          
          
          <code class="ruby">          # delete from sdk participants</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="276">
          <span class="hits">1</span>
          
          <code class="ruby">          if !deleted_participant_emails.empty?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="277">
          <span class="hits">1</span>
          
          <code class="ruby">            qiscus_sdk = QiscusSdk.new(@current_user.application.app_id, @current_user.application.qiscus_sdk_secret)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="278">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="279">
          
          
          <code class="ruby">            # post comment when users are removed, post before remove</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="280">
          <span class="hits">1</span>
          
          <code class="ruby">            if !params[:message].nil? &amp;&amp; params[:message] != &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="281">
          
          
          <code class="ruby">              to_be_deleted.each do | to_delete |</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="282">
          
          
          <code class="ruby">                qiscus_sdk.post_comment(to_delete.qiscus_token, chat_room.qiscus_room_id.to_i, params[:message])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="283">
          
          
          <code class="ruby">              end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="284">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="285">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="286">
          
          
          <code class="ruby">            # Post system event message before remove participants</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="287">
          
          
          <code class="ruby">            # It&#39;s to make sure that all participants get system event message</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="288">
          <span class="hits">1</span>
          
          <code class="ruby">            system_event_type = &quot;remove_member&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="289">
          <span class="hits">1</span>
          
          <code class="ruby">            qiscus_sdk.post_system_event_message(system_event_type, chat_room.qiscus_room_id.to_i, @current_user.qiscus_email, deleted_participant_emails, &quot;&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="290">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="291">
          <span class="hits">1</span>
          
          <code class="ruby">            qiscus_sdk.remove_room_participants(deleted_participant_emails, chat_room.qiscus_room_id.to_i)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="292">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="293">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="294">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="295">
          <span class="hits">1</span>
          
          <code class="ruby">        if params[:qiscus_email].kind_of?(Array) &amp;&amp; params[:qiscus_email].present?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="296">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="297">
          
          
          <code class="ruby">          user_qiscus_emails = params[:qiscus_email].to_a.map { |e| e.to_s  }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="298">
          
          
          <code class="ruby">          user_qiscus_emails_already_in_group = chat_room.users.pluck(:qiscus_email)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="299">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="300">
          
          
          <code class="ruby">          user_unpermitted_to_remove = user_qiscus_emails_already_in_group - user_qiscus_emails</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="301">
          
          
          <code class="ruby">          user_permitted_to_remove = user_qiscus_emails_already_in_group - user_unpermitted_to_remove</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="302">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="303">
          
          
          <code class="ruby">          to_be_deleted = User.includes(:roles, :application).where(&quot;users.qiscus_email IN (?)&quot;, user_permitted_to_remove)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="304">
          
          
          <code class="ruby">          deleted_participant_emails = to_be_deleted.pluck(:qiscus_email)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="305">
          
          
          <code class="ruby">          deleted_participant_ids = to_be_deleted.pluck(:id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="306">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="307">
          
          
          <code class="ruby">          chat_user = ChatUser.where(&quot;chat_users.user_id IN (?)&quot;, deleted_participant_ids)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="308">
          
          
          <code class="ruby">          chat_user = chat_user.where(chat_room_id: chat_room.id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="309">
          
          
          <code class="ruby">          chat_user.destroy_all</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="310">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="311">
          
          
          <code class="ruby">          # delete from sdk participants</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="312">
          
          
          <code class="ruby">          if !deleted_participant_emails.empty?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="313">
          
          
          <code class="ruby">            qiscus_sdk = QiscusSdk.new(@current_user.application.app_id, @current_user.application.qiscus_sdk_secret)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="314">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="315">
          
          
          <code class="ruby">            # post comment when users are removed, post before remove</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="316">
          
          
          <code class="ruby">            if !params[:message].nil? &amp;&amp; params[:message] != &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="317">
          
          
          <code class="ruby">              to_be_deleted.each do | to_delete |</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="318">
          
          
          <code class="ruby">                qiscus_sdk.post_comment(to_delete.qiscus_token, chat_room.qiscus_room_id.to_i, params[:message])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="319">
          
          
          <code class="ruby">              end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="320">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="321">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="322">
          
          
          <code class="ruby">            # Post system event message before remove participants</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="323">
          
          
          <code class="ruby">            # It&#39;s to make sure that all participants get system event message</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="324">
          
          
          <code class="ruby">            system_event_type = &quot;remove_member&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="325">
          
          
          <code class="ruby">            qiscus_sdk.post_system_event_message(system_event_type, chat_room.qiscus_room_id.to_i, @current_user.qiscus_email, deleted_participant_emails, &quot;&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="326">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="327">
          
          
          <code class="ruby">            qiscus_sdk.remove_room_participants(deleted_participant_emails, chat_room.qiscus_room_id.to_i)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="328">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="329">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="330">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="331">
          <span class="hits">1</span>
          
          <code class="ruby">        chat_room = ChatRoom.includes(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="332">
          
          
          <code class="ruby">        [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="333">
          
          
          <code class="ruby">          :user =&gt; [],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="334">
          
          
          <code class="ruby">          :chat_users =&gt; [],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="335">
          
          
          <code class="ruby">          :users =&gt; [:roles, :application],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="336">
          
          
          <code class="ruby">          :target =&gt; [:roles, :application]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="337">
          
          
          <code class="ruby">        ]).find(chat_room.id).as_json()</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="338">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="339">
          
          
          <code class="ruby">        render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="340">
          
          
          <code class="ruby">          data: chat_room</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="341">
          <span class="hits">1</span>
          
          <code class="ruby">        } and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="342">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="343">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="344">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="345">
          
          
          <code class="ruby">        data: nil</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="346">
          
          
          <code class="ruby">      } and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="347">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="348">
          
          
          <code class="ruby">    rescue ActiveRecord::RecordInvalid =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="349">
          
          
          <code class="ruby">      msg = &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="350">
          
          
          <code class="ruby">      e.record.errors.map do |k, v|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="351">
          
          
          <code class="ruby">        key = k.to_s.humanize</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="352">
          
          
          <code class="ruby">        msg = msg + &quot;#{key} #{v}, &quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="353">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="354">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="355">
          
          
          <code class="ruby">      msg = msg.chomp(&quot;, &quot;) + &quot;.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="356">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="357">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="358">
          
          
          <code class="ruby">          message: msg</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="359">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="360">
          
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="361">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="362">
          
          
          <code class="ruby">    rescue Exception =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="363">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="364">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="365">
          
          
          <code class="ruby">          message: e.message</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="366">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="367">
          
          
          <code class="ruby">      }, status: 422</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="368">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="369">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="370">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="371">
          
          
          <code class="ruby">  # =begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="372">
          
          
          <code class="ruby">  # @apiVersion 1.0.0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="373">
          
          
          <code class="ruby">  # @api {post} /api/v1/chat/conversations/:qiscus_room_id/leave_group Leave Group</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="374">
          
          
          <code class="ruby">  # @apiName LeaveGroup</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="375">
          
          
          <code class="ruby">  # @apiGroup Group Chat Participant</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="376">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="377">
          
          
          <code class="ruby">  # @apiParam {Number} qiscus_room_id Qiscus room id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="378">
          
          
          <code class="ruby">  # @apiParam {String} access_token User access token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="379">
          
          
          <code class="ruby">  # =end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="380">
          <span class="hits">1</span>
          
          <code class="ruby">  def leave_group</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="381">
          
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="382">
          
          
          <code class="ruby">      chat_room = @chat_room</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="383">
          
          
          <code class="ruby">      ActiveRecord::Base.transaction do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="384">
          
          
          <code class="ruby">        if !params[:qiscus_room_id].present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="385">
          
          
          <code class="ruby">          raise Exception.new(&quot;Qiscus room id must be present.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="386">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="387">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="388">
          
          
          <code class="ruby">				application = @current_user.application</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="389">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="390">
          
          
          <code class="ruby">        user_ids_already_in_group = chat_room.users.pluck(:id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="391">
          
          
          <code class="ruby">        if user_ids_already_in_group.to_a.include?(@current_user.id) == false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="392">
          
          
          <code class="ruby">          raise Exception.new(&quot;You are not member of this group.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="393">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="394">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="395">
          
          
          <code class="ruby">        is_group_admin = ChatUser.find_by(chat_room_id: chat_room.id, user_id: @current_user.id, is_group_admin: true)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="396">
          
          
          <code class="ruby">        participants_count = ChatUser.where(chat_room_id: chat_room.id).count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="397">
          
          
          <code class="ruby">        count_group_admin = ChatUser.where(chat_room_id: chat_room.id, is_group_admin: true).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="398">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="399">
          
          
          <code class="ruby">        if is_group_admin &amp;&amp; count_group_admin == 1 &amp;&amp; participants_count &gt; 1</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="400">
          
          
          <code class="ruby">          first_participant = chat_room.chat_users.where(is_group_admin: false).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="401">
          
          
          <code class="ruby">          first_participant.is_group_admin = true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="402">
          
          
          <code class="ruby">          first_participant.save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="403">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="404">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="405">
          
          
          <code class="ruby">        # delete from chat_user table</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="406">
          
          
          <code class="ruby">        chat_user = ChatUser.find_by(user_id: @current_user.id, chat_room_id: chat_room.id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="407">
          
          
          <code class="ruby">        if chat_user.nil? == false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="408">
          
          
          <code class="ruby">          chat_user.destroy</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="409">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="410">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="411">
          
          
          <code class="ruby">        qiscus_sdk = QiscusSdk.new(@current_user.application.app_id, @current_user.application.qiscus_sdk_secret)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="412">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="413">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="414">
          
          
          <code class="ruby">        # backend need to post system event message before user leave group</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="415">
          
          
          <code class="ruby">        # post system event message only for group chat that is not public chat</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="416">
          
          
          <code class="ruby">        if chat_room.is_public_chat == false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="417">
          
          
          <code class="ruby">          system_event_type = &quot;left_room&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="418">
          
          
          <code class="ruby">          qiscus_sdk.post_system_event_message(system_event_type, chat_room.qiscus_room_id.to_i, @current_user.qiscus_email, [], &quot;&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="419">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="420">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="421">
          
          
          <code class="ruby">        # delete from sdk participants</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="422">
          
          
          <code class="ruby">        qiscus_sdk.remove_room_participants([@current_user.qiscus_email], chat_room.qiscus_room_id.to_i)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="423">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="424">
          
          
          <code class="ruby">        # Begin delete redis cache</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="425">
          
          
          <code class="ruby">        user_ids = [@current_user.id]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="426">
          
          
          <code class="ruby">        keys = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="427">
          
          
          <code class="ruby">        user_ids.each do |uid|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="428">
          
          
          <code class="ruby">          k = &quot;#{PREFIX_KEY}#{uid}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="429">
          
          
          <code class="ruby">          keys.push(k)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="430">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="431">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="432">
          
          
          <code class="ruby">        # Redis SET, GET and DEL is atomic.</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="433">
          
          
          <code class="ruby">        if !keys.empty?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="434">
          
          
          <code class="ruby">          $redis.del(keys)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="435">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="436">
          
          
          <code class="ruby">        # End delete redis cache</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="437">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="438">
          
          
          <code class="ruby">        chat_room = ChatRoom.includes(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="439">
          
          
          <code class="ruby">        [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="440">
          
          
          <code class="ruby">          :user =&gt; [],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="441">
          
          
          <code class="ruby">          :chat_users =&gt; [],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="442">
          
          
          <code class="ruby">          :users =&gt; [:roles, :application],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="443">
          
          
          <code class="ruby">          :target =&gt; [:roles, :application]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="444">
          
          
          <code class="ruby">        ]).find(chat_room.id).as_json()</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="445">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="446">
          
          
          <code class="ruby">        render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="447">
          
          
          <code class="ruby">          data: chat_room</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="448">
          
          
          <code class="ruby">        } and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="449">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="450">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="451">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="452">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="453">
          
          
          <code class="ruby">        data: nil</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="454">
          
          
          <code class="ruby">      } and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="455">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="456">
          
          
          <code class="ruby">    rescue ActiveRecord::RecordInvalid =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="457">
          
          
          <code class="ruby">      msg = &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="458">
          
          
          <code class="ruby">      e.record.errors.map do |k, v|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="459">
          
          
          <code class="ruby">        key = k.to_s.humanize</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="460">
          
          
          <code class="ruby">        msg = msg + &quot;#{key} #{v}, &quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="461">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="462">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="463">
          
          
          <code class="ruby">      msg = msg.chomp(&quot;, &quot;) + &quot;.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="464">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="465">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="466">
          
          
          <code class="ruby">          message: msg</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="467">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="468">
          
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="469">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="470">
          
          
          <code class="ruby">    rescue Exception =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="471">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="472">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="473">
          
          
          <code class="ruby">          message: e.message</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="474">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="475">
          
          
          <code class="ruby">      }, status: 422</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="476">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="477">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="478">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="479">
          <span class="hits">1</span>
          
          <code class="ruby">  private</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="480">
          <span class="hits">1</span>
          
          <code class="ruby">    def ensure_eligible_access_to_chatroom</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="481">
          <span class="hits">2</span>
          
          <code class="ruby">      if params[:chatroom_id].present? &amp;&amp; params[:chatroom_id] != &quot;&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="482">
          
          
          <code class="ruby">        # only chat room maker who can add or remove participant for this group</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="483">
          
          
          <code class="ruby">        # @chat_room = ChatRoom.find_by(id: params[:chatroom_id], user_id: @current_user.id)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="484">
          <span class="hits">2</span>
          
          <code class="ruby">        @chat_room = ChatRoom.find_by(qiscus_room_id: params[:chatroom_id], application_id: @current_user.application.id)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="485">
          <span class="hits">2</span>
          
          <code class="ruby">        if @chat_room.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="486">
          
          
          <code class="ruby">          render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="487">
          
          
          <code class="ruby">            error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="488">
          
          
          <code class="ruby">              message: &#39;You have no access to this chatroom or this chat room is not found.&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="489">
          
          
          <code class="ruby">            }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="490">
          
          
          <code class="ruby">          }, status: 401 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="491">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="492">
          <span class="hits">2</span>
          
          <code class="ruby">          if !@chat_room.is_group_chat</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="493">
          
          
          <code class="ruby">            raise Exception.new(&quot;This is not group chat. You can&#39;t add/remove participants.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="494">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="495">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="496">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="497">
          
          
          <code class="ruby">        render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="498">
          
          
          <code class="ruby">          error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="499">
          
          
          <code class="ruby">            message: &#39;Parameter chatroom_id required&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="500">
          
          
          <code class="ruby">          }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="501">
          
          
          <code class="ruby">        }, status: 400 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="502">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="503">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="504">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="505">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="506">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="dc406c886ef6b60c592e2e007adb512e21f75582">
  <div class="header">
    <h3>app/controllers/api/v1/chat/conversations/pin_chats_controller.rb</h3>
    <h4><span class="yellow">89.29 %</span> covered</h4>
    <div>
      <b>84</b> relevant lines. 
      <span class="green"><b>75</b> lines covered</span> and
      <span class="red"><b>9</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class Api::V1::Chat::Conversations::PinChatsController &lt; ProtectedController</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  before_action :authorize_user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">  # =begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">  # @apiVersion 1.0.0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">  # @api {get} /api/v1/chat/conversations/pin_chats Get Pin Chat Rooms</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">  # @apiName ListPinChatRooms</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">  # @apiGroup Pin Chat Rooms</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">  # @apiParam {String} access_token User access token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">  # =end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  def index</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">			chat_room_ids = @current_user.pin_chat_rooms.pluck(:chat_room_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">			pin_chat_rooms = ChatRoom.where(&quot;chat_rooms.id IN (?)&quot;, chat_room_ids).pluck(:qiscus_room_id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">			render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">				data: pin_chat_rooms</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">			}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">  # =begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">  # @apiVersion 1.0.0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">  # @api {post} /api/v1/chat/conversations/pin_chats Add Pin Chat Rooms</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">  # @apiDescription Add Pin Chat Rooms</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">  # @apiName AddPinChatRooms</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">  # @apiGroup Pin Chat Rooms</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">  # @apiParam {String} access_token User access token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">  # @apiParam {Array} qiscus_room_id[] Array of qiscus_room_id, e.g: `qiscus_room_id[]=1&amp;qiscus_room_id[]=2`</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">  # =end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">  def create</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="35">
          <span class="hits">6</span>
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="36">
          <span class="hits">6</span>
          
          <code class="ruby">      qiscus_room_id = params[:qiscus_room_id]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="38">
          <span class="hits">6</span>
          
          <code class="ruby">      if !qiscus_room_id.is_a?(Array)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="39">
          <span class="hits">1</span>
          
          <code class="ruby">        raise Exception.new(&quot;Qiscus room id must be an array of qiscus room id.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="42">
          <span class="hits">5</span>
          
          <code class="ruby">      qiscus_room_ids = qiscus_room_id.to_a</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">      # anticipate empty index of qiscus room id</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="45">
          <span class="hits">5</span>
          
          <code class="ruby">      qiscus_room_ids.each do |id|</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="46">
          <span class="hits">8</span>
          
          <code class="ruby">        if id.nil? || id == &quot;&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="47">
          <span class="hits">1</span>
          
          <code class="ruby">          raise Exception.new(&quot;Qiscus room id must be present.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">      # get current pin chat rooms</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="52">
          <span class="hits">4</span>
          
          <code class="ruby">      current_pin_chat_rooms = PinChatRoom.where(user_id: @current_user.id).order(created_at: :desc)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">      # count current pin chat rooms</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="54">
          <span class="hits">4</span>
          
          <code class="ruby">      count_current_pin_chat_rooms = current_pin_chat_rooms.count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="56">
          <span class="hits">4</span>
          
          <code class="ruby">      max = 3 # user can only pin up (max) chats</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="57">
          <span class="hits">4</span>
          
          <code class="ruby">      if count_current_pin_chat_rooms + qiscus_room_ids.size &gt; max</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="58">
          <span class="hits">1</span>
          
          <code class="ruby">        raise Exception.new(&quot;You can only pin up #{max} chats.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="61">
          <span class="hits">3</span>
          
          <code class="ruby">      chat_rooms = nil</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="62">
          <span class="hits">3</span>
          
          <code class="ruby">      ActiveRecord::Base.transaction do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">        # ensure that qiscus_room_id exist in chat_rooms</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="64">
          <span class="hits">3</span>
          
          <code class="ruby">        candidate_pin_chat_rooms = ChatRoom.where(&quot;chat_rooms.qiscus_room_id IN (?)&quot;, qiscus_room_ids)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="65">
          <span class="hits">3</span>
          
          <code class="ruby">        candidate_pin_chat_rooms_ids = candidate_pin_chat_rooms.pluck(:id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="67">
          <span class="hits">3</span>
          
          <code class="ruby">        qiscus_room_id_in_database = candidate_pin_chat_rooms.pluck(:qiscus_room_id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">        # chat room not found</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="70">
          <span class="hits">3</span>
          
          <code class="ruby">        if qiscus_room_ids.size != qiscus_room_id_in_database.size</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="71">
          <span class="hits">1</span>
          
          <code class="ruby">          qiscus_room_ids_not_found = qiscus_room_ids.map(&amp;:to_i) - qiscus_room_id_in_database</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="72">
          <span class="hits">1</span>
          
          <code class="ruby">          raise Exception.new(&quot;Chat room with qiscus_room_id #{qiscus_room_ids_not_found} not found.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">        # chat_room_id already in pin chat rooms</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="76">
          <span class="hits">2</span>
          
          <code class="ruby">        already_been_in_pin_chat_rooms = current_pin_chat_rooms.pluck(:chat_room_id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">        # chat rooms to be pinned is only chat rooms where not in pin chat rooms</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="79">
          <span class="hits">2</span>
          
          <code class="ruby">        duplicat_chat_rooms = candidate_pin_chat_rooms_ids &amp; already_been_in_pin_chat_rooms # duplicat chat rooms</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="80">
          <span class="hits">2</span>
          
          <code class="ruby">        if !duplicat_chat_rooms.empty?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="81">
          <span class="hits">1</span>
          
          <code class="ruby">          qiscus_room_ids = ChatRoom.where(&quot;chat_rooms.id IN (?)&quot;, duplicat_chat_rooms).pluck(:qiscus_room_id)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="82">
          <span class="hits">1</span>
          
          <code class="ruby">          raise Exception.new(&quot;Chat room with qiscus_room_id #{qiscus_room_ids} already pinned.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">        # now add to pin chat rooms</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="87">
          <span class="hits">1</span>
          
          <code class="ruby">        chat_rooms_to_be_pinned = Array.new</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="88">
          <span class="hits">1</span>
          
          <code class="ruby">        candidate_pin_chat_rooms_ids.each do |id|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">          # double check ifchat_rooms_to_be_pinned chat room already been in pin chat rooms.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">          # maybe in race condition it throw error if chat room already been in pinned chat and then breaks all</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">          # transaction</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="92">
          <span class="hits">1</span>
          
          <code class="ruby">          if PinChatRoom.find_by(user_id: @current_user.id, chat_room_id: id).nil?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="93">
          <span class="hits">1</span>
          
          <code class="ruby">            chat_rooms_to_be_pinned.push({:user_id =&gt; @current_user.id, :chat_room_id =&gt; id})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby">        # add pin chat rooms</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="98">
          <span class="hits">1</span>
          
          <code class="ruby">        PinChatRoom.create(chat_rooms_to_be_pinned)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">      # last, load chat room that successfully to be pin</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="102">
          <span class="hits">1</span>
          
          <code class="ruby">      qiscus_sdk = QiscusSdk.new(@current_user.application.app_id, @current_user.application.qiscus_sdk_secret)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="103">
          <span class="hits">1</span>
          
          <code class="ruby">      sdk_status, chat_room_sdk_info = qiscus_sdk.get_rooms_info(@current_user.qiscus_email, qiscus_room_ids)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="105">
          <span class="hits">1</span>
          
          <code class="ruby">      page = 1</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="106">
          <span class="hits">1</span>
          
          <code class="ruby">      per_page = qiscus_room_ids.size</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="108">
          <span class="hits">1</span>
          
          <code class="ruby">      _, chat_rooms = ChatRoomHelper.load_for(@current_user, chat_room_sdk_info, page, per_page)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="110">
          <span class="hits">1</span>
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby">        data: chat_rooms</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="114">
          <span class="hits">5</span>
          
          <code class="ruby">    rescue ActiveRecord::RecordInvalid =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="115">
          
          
          <code class="ruby">      msg = &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="116">
          
          
          <code class="ruby">      e.record.errors.map do |k, v|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="117">
          
          
          <code class="ruby">        key = k.to_s.humanize</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="118">
          
          
          <code class="ruby">        msg = msg + &quot;#{key} #{v}, &quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="121">
          
          
          <code class="ruby">      msg = msg.chomp(&quot;, &quot;) + &quot;.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">          message: msg</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="126">
          
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby">    rescue Exception =&gt; e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="130">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby">          message: e.message</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="133">
          <span class="hits">5</span>
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby">  # =begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby">  # @apiVersion 1.0.0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby">  # @api {delete} /api/v1/chat/conversations/pin_chats Delete Pin Chat Rooms</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby">  # @apiDescription Delete Pin Chat Rooms</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="142">
          
          
          <code class="ruby">  # @apiName DeletePinChatRooms</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby">  # @apiGroup Pin Chat Rooms</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby">  # @apiParam {String} access_token User access token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby">  # @apiParam {Array} qiscus_room_id[] Array of qiscus_room_id, e.g: `qiscus_room_id[]=1&amp;qiscus_room_id[]=2`</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby">  # =end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="148">
          <span class="hits">1</span>
          
          <code class="ruby">  def destroy_pin_chats</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="149">
          <span class="hits">5</span>
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="150">
          <span class="hits">5</span>
          
          <code class="ruby">      qiscus_room_id = params[:qiscus_room_id]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="152">
          <span class="hits">5</span>
          
          <code class="ruby">      if !qiscus_room_id.is_a?(Array)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="153">
          <span class="hits">1</span>
          
          <code class="ruby">        raise Exception.new(&quot;Qiscus room id must be an array of qiscus room id.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="154">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="156">
          <span class="hits">4</span>
          
          <code class="ruby">      qiscus_room_ids = qiscus_room_id.to_a</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="158">
          
          
          <code class="ruby">      # anticipate empty index of qiscus room id</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="159">
          <span class="hits">4</span>
          
          <code class="ruby">      qiscus_room_ids.each do |id|</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="160">
          <span class="hits">4</span>
          
          <code class="ruby">        if id.nil? || id == &quot;&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="161">
          <span class="hits">1</span>
          
          <code class="ruby">          raise Exception.new(&quot;Qiscus room id must be present.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="164">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="165">
          <span class="hits">3</span>
          
          <code class="ruby">      pin_chat_rooms_ids = nil</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="166">
          <span class="hits">3</span>
          
          <code class="ruby">      ActiveRecord::Base.transaction do</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="167">
          <span class="hits">3</span>
          
          <code class="ruby">        chat_rooms = ChatRoom.where(&quot;chat_rooms.qiscus_room_id IN (?)&quot;, qiscus_room_ids)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="168">
          <span class="hits">3</span>
          
          <code class="ruby">        chat_room_ids = chat_rooms.pluck(:id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="169">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="170">
          
          
          <code class="ruby">        # anticipate invalid qiscus_room_id</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="171">
          <span class="hits">3</span>
          
          <code class="ruby">        qiscus_room_id_in_database = chat_rooms.pluck(:qiscus_room_id)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="172">
          <span class="hits">3</span>
          
          <code class="ruby">        if qiscus_room_ids.size != qiscus_room_id_in_database.size</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="173">
          <span class="hits">1</span>
          
          <code class="ruby">          invalid_qiscus_room_ids = qiscus_room_ids.map(&amp;:to_i) - qiscus_room_id_in_database</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="174">
          <span class="hits">1</span>
          
          <code class="ruby">          raise Exception.new(&quot;Invalid chat room with qiscus_room_id #{invalid_qiscus_room_ids}.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="175">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="176">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="177">
          
          
          <code class="ruby">        # get all pin chat rooms</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="178">
          <span class="hits">2</span>
          
          <code class="ruby">        pin_chat_rooms = PinChatRoom.where(user_id: @current_user.id).where(&quot;pin_chat_rooms.chat_room_id IN (?)&quot;, chat_room_ids)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="179">
          <span class="hits">2</span>
          
          <code class="ruby">        pin_chat_rooms_ids = pin_chat_rooms.pluck(:chat_room_id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="180">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="181">
          
          
          <code class="ruby">        # anticipate qiscus_room_id that not in pin chat</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="182">
          <span class="hits">2</span>
          
          <code class="ruby">        pin_chat_room_qiscus_room_ids = ChatRoom.where(&quot;chat_rooms.id IN (?)&quot;, pin_chat_rooms_ids).pluck(:qiscus_room_id)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="183">
          <span class="hits">2</span>
          
          <code class="ruby">        qiscus_room_ids_not_found = qiscus_room_ids.map(&amp;:to_i) - pin_chat_room_qiscus_room_ids</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="184">
          <span class="hits">2</span>
          
          <code class="ruby">        if !qiscus_room_ids_not_found.empty?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="185">
          <span class="hits">1</span>
          
          <code class="ruby">          raise Exception.new(&quot;Chat room with qiscus_room_id #{qiscus_room_ids_not_found} is not pin chats.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="186">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="187">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="188">
          <span class="hits">1</span>
          
          <code class="ruby">        pin_chat_rooms.destroy_all</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="189">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="190">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="191">
          
          
          <code class="ruby">      # last, load chat room that successfully to be unpin</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="192">
          <span class="hits">1</span>
          
          <code class="ruby">      chat_rooms = ChatRoom.where(&quot;chat_rooms.id IN (?)&quot;, pin_chat_rooms_ids)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="193">
          <span class="hits">1</span>
          
          <code class="ruby">      chat_rooms = chat_rooms.as_json</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="194">
          <span class="hits">1</span>
          
          <code class="ruby">      chat_rooms = chat_rooms.map do |e|</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="195">
          <span class="hits">1</span>
          
          <code class="ruby">        e.merge!(&#39;is_pin_chat&#39; =&gt; false )</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="196">
          <span class="hits">1</span>
          
          <code class="ruby">        e.merge!(&#39;pin_chat_room_id&#39; =&gt; nil)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="197">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="198">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="199">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="200">
          
          
          <code class="ruby">        data: chat_rooms</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="201">
          <span class="hits">1</span>
          
          <code class="ruby">      } and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="202">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="203">
          <span class="hits">4</span>
          
          <code class="ruby">    rescue Exception =&gt; e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="204">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="205">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="206">
          
          
          <code class="ruby">          message: e.message</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="207">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="208">
          <span class="hits">4</span>
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="209">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="210">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="211">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="212">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="1b34a081b934aed8fb9d1c6417f565d4e3da2253">
  <div class="header">
    <h3>app/controllers/api/v1/chat/conversations_controller.rb</h3>
    <h4><span class="red">33.51 %</span> covered</h4>
    <div>
      <b>555</b> relevant lines. 
      <span class="green"><b>186</b> lines covered</span> and
      <span class="red"><b>369</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class Api::V1::Chat::ConversationsController &lt; ProtectedController</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  before_action :authorize_user</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  before_action :ensure_raw_file, only: [:change_group_avatar]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">  # =begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">  # @apiVersion 1.0.0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">  # @api {get} /api/v1/chat/conversations Get Conversation List</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">  # @apiName ChatList</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">  # @apiGroup Chat</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">  # @apiParam {String} access_token User access token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">  # @apiParam {Number} [page=1] Pagination. Per page is 10 conversation.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">  # @apiParam {Boolean} [get_all=false] Show all conversation. Get_all = &#39;true&#39; or &#39;false&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">  # =end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">  def index</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">      # get current time, to measure calling time each process</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">      start_time_pluck_room_id = Time.now</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">      qiscus_room_ids = @current_user.chat_rooms.pluck(:qiscus_room_id)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">      end_time_pluck_room_id = Time.now</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">      chat_room_sdk_info = []</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">      # if not empty qiscus room id, then call sdk to avoid error</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">      start_time_sdk = Time.now</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">      if qiscus_room_ids.empty? == false</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">        qiscus_sdk = QiscusSdk.new(@current_user.application.app_id, @current_user.application.qiscus_sdk_secret)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">        sdk_status, chat_room_sdk_info = qiscus_sdk.get_rooms_info(@current_user.qiscus_email, qiscus_room_ids)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">        if sdk_status != 200</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">          room_ids = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">          splitted_string = chat_room_sdk_info[&#39;error&#39;][&#39;errors&#39;][&#39;room_id&#39;][0].gsub(/\s+/m, &#39; &#39;).strip.split(&quot; &quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">          if !splitted_string.empty?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">            splitted_string = splitted_string.first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">            room_ids = splitted_string.strip.split(&quot;,&quot;).map(&amp;:to_i)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">            room_ids = room_ids.uniq</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">          # now we now array of room id where user has no access to it</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">          # so delete it from chat user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">          # first, get chat room id from backend</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">          local_room_id = ChatRoom.where(&quot;chat_rooms.qiscus_room_id IN (?)&quot;, room_ids).where(application_id: @current_user.application.id).pluck(:id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">          # using destroy all will invoke callback after destroy</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">          # http://guides.rubyonrails.org/active_record_callbacks.html</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">          ChatUser.where(user_id: @current_user.id).where(&quot;chat_users.chat_room_id IN (?)&quot;, local_room_id).destroy_all</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">          # after that, try to call SDK again, this to minimize user show an error while call this API due to SDK not found error</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">          # first, load new chat room again, using new call to ensure that data will be retrieved is a new data</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">          qiscus_room_ids = User.find(@current_user.id).chat_rooms.pluck(:qiscus_room_id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">          chat_room_sdk_info = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">          if qiscus_room_ids.empty? == false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">            qiscus_sdk = QiscusSdk.new(@current_user.application.app_id, @current_user.application.qiscus_sdk_secret)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="56">
          
          
          <code class="ruby">            if qiscus_room_ids.count &gt; 100</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="57">
          
          
          <code class="ruby">              array_of_ids = qiscus_room_ids.each_slice(100).to_a</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">              merged_info = Hash.new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="59">
          
          
          <code class="ruby">              array_of_ids.each do | ids |</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">                sdk_status, chat_room_sdk_info = qiscus_sdk.get_rooms_info(@current_user.qiscus_email, ids)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">                # if after second call the error from SDK still occured, then throw an error instead trying a new call.</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="63">
          
          
          <code class="ruby">                if sdk_status != 200</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="64">
          
          
          <code class="ruby">                  raise Exception.new(chat_room_sdk_info[&#39;error&#39;][&#39;detailed_messages&#39;].to_a.join(&quot;, &quot;).capitalize)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">                end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="67">
          
          
          <code class="ruby">                merged_info.merge!(chat_room_sdk_info)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">              end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="70">
          
          
          <code class="ruby">              chat_room_sdk_info = merged_info</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">            else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="72">
          
          
          <code class="ruby">              sdk_status, chat_room_sdk_info = qiscus_sdk.get_rooms_info(@current_user.qiscus_email, qiscus_room_ids)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">              # if after second call the error from SDK still occured, then throw an error instead trying a new call.</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="75">
          
          
          <code class="ruby">              if sdk_status != 200</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="76">
          
          
          <code class="ruby">                raise Exception.new(chat_room_sdk_info[&#39;error&#39;][&#39;detailed_messages&#39;].to_a.join(&quot;, &quot;).capitalize)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">              end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="83">
          <span class="hits">1</span>
          
          <code class="ruby">      end_time_sdk = Time.now</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="85">
          <span class="hits">1</span>
          
          <code class="ruby">      page = params[:page]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="86">
          <span class="hits">1</span>
          
          <code class="ruby">      if !page.present? || page.to_i &lt;= 0</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="87">
          <span class="hits">1</span>
          
          <code class="ruby">        page = 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="90">
          <span class="hits">1</span>
          
          <code class="ruby">      per_page = 10</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">      # If params page not present then show all conversations</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="93">
          <span class="hits">1</span>
          
          <code class="ruby">      if !params[:page].present? || params[:page].to_i &lt;= 0</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="94">
          <span class="hits">1</span>
          
          <code class="ruby">        per_page = 100</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby">			# Overwrite per_page to show all data</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="98">
          <span class="hits">1</span>
          
          <code class="ruby">			if params[:get_all] == true || params[:get_all] == 1 || params[:get_all] == &quot;1&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="99">
          
          
          <code class="ruby">				if qiscus_room_ids.size &gt; 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="100">
          
          
          <code class="ruby">					per_page = qiscus_room_ids.size</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">				end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">			end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="104">
          <span class="hits">1</span>
          
          <code class="ruby">      start_chat_room_load = Time.now</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="105">
          <span class="hits">1</span>
          
          <code class="ruby">      chat_rooms_total, chat_rooms = ChatRoomHelper.load_for(@current_user, chat_room_sdk_info, page, per_page)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="106">
          <span class="hits">1</span>
          
          <code class="ruby">      end_chat_room_load = Time.now</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="108">
          <span class="hits">1</span>
          
          <code class="ruby">      pluck_room_id_time = (end_time_pluck_room_id - start_time_pluck_room_id) * 1000</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="109">
          <span class="hits">1</span>
          
          <code class="ruby">      sdk_call_time = (end_time_sdk - start_time_sdk) * 1000</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="110">
          <span class="hits">1</span>
          
          <code class="ruby">      chat_room_load = (end_chat_room_load - start_chat_room_load) * 1000</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby">      # roundup total_page</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="113">
          <span class="hits">1</span>
          
          <code class="ruby">      total_page = (chat_rooms_total/per_page.to_f).ceil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby">        meta: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">          total: chat_rooms_total,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">          per_page: per_page,</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="119">
          <span class="hits">1</span>
          
          <code class="ruby">          total_page: ((chat_rooms_total / per_page) &lt;= 0) ? 1 : (total_page),</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="120">
          <span class="hits">1</span>
          
          <code class="ruby">          current_page: (params[:page].to_i &lt;= 0) ? 1 : params[:page].to_i,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby">          debug: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby">            pluck_room_id: &quot;#{pluck_room_id_time} ms&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby">            sdk_call: &quot;#{sdk_call_time} ms&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">            chat_room_load: &quot;#{chat_room_load} ms&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby">            total_time: &quot;#{pluck_room_id_time + sdk_call_time + chat_room_load} ms&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby">          }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby">        },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby">        data: chat_rooms</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="129">
          <span class="hits">1</span>
          
          <code class="ruby">      } and return</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="130">
          
          
          <code class="ruby">    rescue Exception =&gt; e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby">          message: e.message,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby">          backtrace: e.backtrace</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="136">
          
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby">  # =begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby">  # @apiVersion 1.0.0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="142">
          
          
          <code class="ruby">  # @api {get} /api/v1/chat/conversations/:id Show single chat</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby">  # @apiDescription show chat room detail</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby">  # @apiName ChatShow</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby">  # @apiGroup Chat</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby">  # @apiParam {Number} id Qisme chat room id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby">  # @apiParam {String} access_token User access token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby">  # =end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="150">
          <span class="hits">1</span>
          
          <code class="ruby">  def show</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="151">
          
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="152">
          
          
          <code class="ruby">      chat_room = ChatRoom.includes({</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby">            users: [:roles, :application],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="154">
          
          
          <code class="ruby">            # user: [:roles, :application],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby">          })</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="156">
          
          
          <code class="ruby">      chat_room = chat_room.find_by(id: params[:id], application_id: @current_user.application.id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="157">
          
          
          <code class="ruby">      if chat_room.users.pluck(:id).to_a.include?(@current_user.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="158">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="159">
          
          
          <code class="ruby">        qiscus_sdk = QiscusSdk.new(@current_user.application.app_id, @current_user.application.qiscus_sdk_secret)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="160">
          
          
          <code class="ruby">        sdk_status, chat_room_sdk_info = qiscus_sdk.get_rooms_info(@current_user.qiscus_email, [chat_room.qiscus_room_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="161">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="162">
          
          
          <code class="ruby">        if sdk_status != 200</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="163">
          
          
          <code class="ruby">          raise Exception.new(chat_room_sdk_info[&#39;error&#39;][&#39;detailed_messages&#39;].to_a.join(&quot;, &quot;).capitalize)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="164">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="165">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="166">
          
          
          <code class="ruby">        chat_room = chat_room.as_json({:me =&gt; @current_user, :chat_room_sdk_info =&gt; chat_room_sdk_info})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="167">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="168">
          
          
          <code class="ruby">        # get user current contact</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="169">
          
          
          <code class="ruby">        contact_ids = @current_user.contacts.pluck(:contact_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="170">
          
          
          <code class="ruby">        current_user_contacts = User.where(&quot;id IN (?)&quot;, contact_ids).pluck(:id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="171">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="172">
          
          
          <code class="ruby">        # for mapping is favorite status</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="173">
          
          
          <code class="ruby">        favored_status = @current_user.contacts.pluck(:contact_id, :is_favored)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="174">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="175">
          
          
          <code class="ruby">        chat_room[&#39;users&#39;].map do |user|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="176">
          
          
          <code class="ruby">          # if user id included in contact id list, then return true, otherwise return false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="177">
          
          
          <code class="ruby">          is_contact = current_user_contacts.include?(user[&#39;id&#39;])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="178">
          
          
          <code class="ruby">          user.merge!(&#39;is_contact&#39; =&gt; is_contact)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="179">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="180">
          
          
          <code class="ruby">          is_favored = (favored_status.to_h[ user[&quot;id&quot;] ] == nil) ? false : favored_status.to_h[ user[&quot;id&quot;] ]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="181">
          
          
          <code class="ruby">          user.merge!(&#39;is_favored&#39; =&gt; is_favored)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="182">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="183">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="184">
          
          
          <code class="ruby">        render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="185">
          
          
          <code class="ruby">          data: chat_room</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="186">
          
          
          <code class="ruby">        } and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="187">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="188">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="189">
          
          
          <code class="ruby">        raise Exception.new(&quot;You are not member of this group.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="190">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="191">
          
          
          <code class="ruby">    rescue Exception =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="192">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="193">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="194">
          
          
          <code class="ruby">          message: e.message</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="195">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="196">
          
          
          <code class="ruby">      }, status: 422</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="197">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="198">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="199">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="200">
          
          
          <code class="ruby">  # =begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="201">
          
          
          <code class="ruby">  # @apiVersion 1.0.0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="202">
          
          
          <code class="ruby">  # @api {post} /api/v1/chat/conversations Get or create room with target</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="203">
          
          
          <code class="ruby">  # @apiDescription Get or create single chat</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="204">
          
          
          <code class="ruby">  # @apiName CreateSingleChat</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="205">
          
          
          <code class="ruby">  # @apiGroup Chat</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="206">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="207">
          
          
          <code class="ruby">  # @apiParam {String} access_token User access token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="208">
          
          
          <code class="ruby">  # @apiParam {Number} target_user_id User id in Qisme database</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="209">
          
          
          <code class="ruby">  # @apiParam {Number} qiscus_room_id Qiscus room id from SDK get_or_create_room_with_target. If client doesn&#39;t send this params, it&#39;s mean backend will create room in sdk</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="210">
          
          
          <code class="ruby">  # =end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="211">
          <span class="hits">1</span>
          
          <code class="ruby">  def create</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="212">
          <span class="hits">4</span>
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="213">
          <span class="hits">4</span>
          
          <code class="ruby">      chat_room = nil</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="214">
          <span class="hits">4</span>
          
          <code class="ruby">      ActiveRecord::Base.transaction do</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="215">
          <span class="hits">4</span>
          
          <code class="ruby">        qiscus_token = @current_user.qiscus_token</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="216">
          <span class="hits">4</span>
          
          <code class="ruby">        application = @current_user.application</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="217">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="218">
          <span class="hits">4</span>
          
          <code class="ruby">        target_user_id = params[:target_user_id]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="219">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="220">
          <span class="hits">4</span>
          
          <code class="ruby">        if target_user_id.nil? || target_user_id == &quot;&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="221">
          <span class="hits">1</span>
          
          <code class="ruby">          raise Exception.new(&quot;Target user id can not be blank.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="222">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="223">
          <span class="hits">3</span>
          
          <code class="ruby">          if target_user_id.to_s == @current_user.id.to_s</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="224">
          <span class="hits">1</span>
          
          <code class="ruby">            raise Exception.new(&quot;You can not chat only with yourself.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="225">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="226">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="227">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="228">
          <span class="hits">2</span>
          
          <code class="ruby">        target_user = User.find(target_user_id)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="229">
          <span class="hits">2</span>
          
          <code class="ruby">        email_sdk = target_user.qiscus_email</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="230">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="231">
          <span class="hits">2</span>
          
          <code class="ruby">        emails = [@current_user.qiscus_email, target_user.qiscus_email]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="232">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="233">
          
          
          <code class="ruby">        # If client doesn&#39;t qiscus_room_id params, it&#39;s mean backend will create room in sdk</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="234">
          <span class="hits">2</span>
          
          <code class="ruby">        if params[:qiscus_room_id].nil? || params[:qiscus_room_id] == &quot;&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="235">
          <span class="hits">1</span>
          
          <code class="ruby">          qiscus_sdk = QiscusSdk.new(application.app_id, application.qiscus_sdk_secret)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="236">
          <span class="hits">1</span>
          
          <code class="ruby">          room = qiscus_sdk.get_or_create_room_with_target(qiscus_token, [email_sdk])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="237">
          
          
          <code class="ruby">          qiscus_room_id = room.id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="238">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="239">
          <span class="hits">1</span>
          
          <code class="ruby">          qiscus_room_id = params[:qiscus_room_id]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="240">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="241">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="242">
          
          
          <code class="ruby">        # Backend need to get chat room from to sdk to ensure single chat room contain valid participants</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="243">
          <span class="hits">1</span>
          
          <code class="ruby">        qiscus_sdk = QiscusSdk.new(application.app_id, application.qiscus_sdk_secret)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="244">
          <span class="hits">1</span>
          
          <code class="ruby">        room = qiscus_sdk.get_or_create_room_with_target_rest(emails)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="245">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="246">
          <span class="hits">1</span>
          
          <code class="ruby">        if qiscus_room_id.to_i != room.id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="247">
          
          
          <code class="ruby">          raise Exception.new(&quot;Invalid qiscus_room_id.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="248">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="249">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="250">
          
          
          <code class="ruby">        chat_room = ChatRoom.find_by(qiscus_room_id: qiscus_room_id, application_id: @current_user.application.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="251">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="252">
          
          
          <code class="ruby">        # if chat room with room id and room topic id not exist then create it</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="253">
          
          
          <code class="ruby">        if chat_room.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="254">
          
          
          <code class="ruby">          chat_name = &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="255">
          
          
          <code class="ruby">          if !params[:chat_name].nil? &amp;&amp; params[:chat_name] != &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="256">
          
          
          <code class="ruby">            chat_name = params[:chat_name]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="257">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="258">
          
          
          <code class="ruby">            chat_name = &quot;Group Chat Name&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="259">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="260">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="261">
          
          
          <code class="ruby">          chat_room = ChatRoom.new(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="262">
          
          
          <code class="ruby">            group_chat_name: chat_name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="263">
          
          
          <code class="ruby">            qiscus_room_name: chat_name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="264">
          
          
          <code class="ruby">            qiscus_room_id: qiscus_room_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="265">
          
          
          <code class="ruby">            is_group_chat: false,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="266">
          
          
          <code class="ruby">            user_id: @current_user.id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="267">
          
          
          <code class="ruby">            target_user_id: target_user.id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="268">
          
          
          <code class="ruby">            application_id: @current_user.application.id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="269">
          
          
          <code class="ruby">          )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="270">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="271">
          
          
          <code class="ruby">          chat_room.save!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="272">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="273">
          
          
          <code class="ruby">          ChatUser.create(chat_room_id: chat_room.id, user_id: @current_user.id) unless ChatUser.exists?(chat_room_id: chat_room.id, user_id: @current_user.id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="274">
          
          
          <code class="ruby">          ChatUser.create(chat_room_id: chat_room.id, user_id: target_user.id) unless ChatUser.exists?(chat_room_id: chat_room.id, user_id: target_user.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="275">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="276">
          
          
          <code class="ruby">					# if chat with official then post comment &#39;get started&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="277">
          
          
          <code class="ruby">					if target_user.is_official</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="278">
          
          
          <code class="ruby">						message = &quot;Get started&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="279">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="280">
          
          
          <code class="ruby">						qiscus_sdk = QiscusSdk.new(@current_user.application.app_id, @current_user.application.qiscus_sdk_secret)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="281">
          
          
          <code class="ruby">						qiscus_sdk.post_comment(@current_user.qiscus_token, qiscus_room_id, message)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="282">
          
          
          <code class="ruby">					end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="283">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="284">
          
          
          <code class="ruby">          # if exist then return error with warning that qiscus room id has been inserted before</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="285">
          
          
          <code class="ruby">          # raise Exception.new(&quot;Qiscus room id has been inserted before, it must be unique.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="286">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="287">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="288">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="289">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="290">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="291">
          
          
          <code class="ruby">        data: chat_room.as_json({:me =&gt; @current_user})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="292">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="293">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="294">
          <span class="hits">4</span>
          
          <code class="ruby">    rescue ActiveRecord::RecordInvalid =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="295">
          
          
          <code class="ruby">      msg = &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="296">
          
          
          <code class="ruby">      e.record.errors.map do |k, v|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="297">
          
          
          <code class="ruby">        key = k.to_s.humanize</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="298">
          
          
          <code class="ruby">        msg = msg + &quot;#{key} #{v}, &quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="299">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="300">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="301">
          
          
          <code class="ruby">      msg = msg.chomp(&quot;, &quot;) + &quot;.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="302">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="303">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="304">
          
          
          <code class="ruby">          message: msg</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="305">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="306">
          
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="307">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="308">
          
          
          <code class="ruby">    rescue Exception =&gt; e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="309">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="310">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="311">
          
          
          <code class="ruby">          message: e.message</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="312">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="313">
          <span class="hits">4</span>
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="314">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="315">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="316">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="317">
          
          
          <code class="ruby">  # =begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="318">
          
          
          <code class="ruby">  # @apiVersion 1.0.0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="319">
          
          
          <code class="ruby">  # @api {post} /api/v1/chat/conversations/group_chat Create group chat with participants</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="320">
          
          
          <code class="ruby">  # @apiDescription Create group chat with participants</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="321">
          
          
          <code class="ruby">  # Please note that if initiator (your access token id) is official, it will be logged as target user id.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="322">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="323">
          
          
          <code class="ruby">  # @apiName CreateGroupChat</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="324">
          
          
          <code class="ruby">  # @apiGroup Chat</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="325">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="326">
          
          
          <code class="ruby">  # @apiParam {String} access_token User access token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="327">
          
          
          <code class="ruby">  # @apiParam {Array} target_user_id[] Array of user id in Qisme database</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="328">
          
          
          <code class="ruby">  # @apiParam {Number} qiscus_room_id Qiscus room id from SDK create_room. If client doesn&#39;t send this params, it&#39;s mean backend will create room in sdk</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="329">
          
          
          <code class="ruby">  # @apiParam {String} [chat_name=&quot;Group Chat Name&quot;] Group chat name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="330">
          
          
          <code class="ruby">  # @apiParam {String} [group_avatar_url=https://d1edrlpyc25xu0.cloudfront.net/kiwari-prod/image/upload/1yahAVOqLy/1510804279-default_group_avatar.png] URL of picture for group avatar</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="331">
          
          
          <code class="ruby">  # @apiParam {Boolean} [is_official_chat=false] It is official group chat or not</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="332">
          
          
          <code class="ruby">  # =end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="333">
          <span class="hits">1</span>
          
          <code class="ruby">  def group_chat</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="334">
          <span class="hits">6</span>
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="335">
          <span class="hits">6</span>
          
          <code class="ruby">      chat_room = nil</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="336">
          <span class="hits">6</span>
          
          <code class="ruby">      ActiveRecord::Base.transaction do</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="337">
          <span class="hits">6</span>
          
          <code class="ruby">        qiscus_token = @current_user.qiscus_token</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="338">
          <span class="hits">6</span>
          
          <code class="ruby">        application = @current_user.application</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="339">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="340">
          <span class="hits">6</span>
          
          <code class="ruby">        target_user_id = params[:target_user_id]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="341">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="342">
          <span class="hits">6</span>
          
          <code class="ruby">        if !target_user_id.is_a?(Array)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="343">
          <span class="hits">1</span>
          
          <code class="ruby">          raise Exception.new(&quot;Target user id must be an array of user id.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="344">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="345">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="346">
          <span class="hits">5</span>
          
          <code class="ruby">        if target_user_id.count &gt; 100</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="347">
          
          
          <code class="ruby">          raise Exception.new(&quot;Maximum group participants is 100. Please use the channel instead for more than 100 participants&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="348">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="349">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="350">
          
          
          <code class="ruby">        # need to convert array of target_user_id (string) into integer</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="351">
          <span class="hits">12</span>
          
          <code class="ruby">        target_user_id = target_user_id.collect{|i| i.to_i}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="352">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="353">
          <span class="hits">5</span>
          
          <code class="ruby">        chat_name = &quot;&quot;</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="354">
          <span class="hits">5</span>
          
          <code class="ruby">        if !params[:chat_name].nil? &amp;&amp; params[:chat_name] != &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="355">
          
          
          <code class="ruby">          chat_name = params[:chat_name]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="356">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="357">
          <span class="hits">5</span>
          
          <code class="ruby">          chat_name = &quot;Group Chat Name&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="358">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="359">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="360">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="361">
          <span class="hits">5</span>
          
          <code class="ruby">        is_official_chat = params[:is_official_chat]</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="362">
          <span class="hits">5</span>
          
          <code class="ruby">        if is_official_chat == &quot;true&quot; || params[:is_official_chat] == true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="363">
          
          
          <code class="ruby">          is_official_chat = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="364">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="365">
          <span class="hits">5</span>
          
          <code class="ruby">          is_official_chat = false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="366">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="367">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="368">
          <span class="hits">5</span>
          
          <code class="ruby">        if is_official_chat</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="369">
          
          
          <code class="ruby">          chat_name = @current_user.fullname</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="370">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="371">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="372">
          <span class="hits">5</span>
          
          <code class="ruby">        target_user = User.where(&quot;id IN (?)&quot;, target_user_id.to_a)</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="373">
          <span class="hits">12</span>
          
          <code class="ruby">        target_user = target_user.sort_by { |u| target_user_id.index(u.id) } # sort by index of target_user_id</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="374">
          <span class="hits">5</span>
          
          <code class="ruby">        email_sdk = target_user.pluck(:qiscus_email)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="375">
          <span class="hits">5</span>
          
          <code class="ruby">        email_sdk = email_sdk + [@current_user.qiscus_email]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="376">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="377">
          
          
          <code class="ruby">        # prevent error if target user is not found</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="378">
          <span class="hits">5</span>
          
          <code class="ruby">        if target_user.empty?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="379">
          
          
          <code class="ruby">          raise Exception.new(&quot;No one target user found.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="380">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="381">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="382">
          
          
          <code class="ruby">        # default group avatar</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="383">
          <span class="hits">5</span>
          
          <code class="ruby">        group_avatar_placeholder = &quot;https://d1edrlpyc25xu0.cloudfront.net/kiwari-prod/image/upload/1yahAVOqLy/1510804279-default_group_avatar.png&quot;</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="384">
          <span class="hits">5</span>
          
          <code class="ruby">        if params[:group_avatar_url].present? &amp;&amp; !params[:group_avatar_url].nil? &amp;&amp; params[:group_avatar_url] != &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="385">
          
          
          <code class="ruby">          group_avatar_placeholder = params[:group_avatar_url]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="386">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="387">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="388">
          
          
          <code class="ruby">        # If client doesn&#39;t qiscus_room_id params, it&#39;s mean backend will create room in sdk</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="389">
          <span class="hits">5</span>
          
          <code class="ruby">        if params[:qiscus_room_id].nil? || params[:qiscus_room_id] == &quot;&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="390">
          <span class="hits">1</span>
          
          <code class="ruby">          qiscus_sdk = QiscusSdk.new(application.app_id, application.qiscus_sdk_secret)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="391">
          <span class="hits">1</span>
          
          <code class="ruby">          room = qiscus_sdk.create_room(chat_name, email_sdk, @current_user.qiscus_email, group_avatar_placeholder)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="392">
          
          
          <code class="ruby">          qiscus_room_id = room.id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="393">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="394">
          <span class="hits">4</span>
          
          <code class="ruby">          qiscus_room_id = params[:qiscus_room_id]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="395">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="396">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="397">
          <span class="hits">4</span>
          
          <code class="ruby">        chat_room = ChatRoom.find_by(qiscus_room_id: qiscus_room_id, application_id: @current_user.application.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="398">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="399">
          <span class="hits">4</span>
          
          <code class="ruby">        target_user_id = target_user.first.id</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="400">
          <span class="hits">4</span>
          
          <code class="ruby">        initiator = @current_user</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="401">
          <span class="hits">4</span>
          
          <code class="ruby">        if initiator.is_official</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="402">
          
          
          <code class="ruby">          initiator = target_user.first # initiator must be member</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="403">
          
          
          <code class="ruby">          target_user_id = @current_user.id # target user must be official</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="404">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="405">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="406">
          <span class="hits">4</span>
          
          <code class="ruby">        if chat_room.nil?</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="407">
          <span class="hits">4</span>
          
          <code class="ruby">          chat_room = ChatRoom.new(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="408">
          
          
          <code class="ruby">            group_chat_name: chat_name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="409">
          
          
          <code class="ruby">            qiscus_room_name: chat_name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="410">
          
          
          <code class="ruby">            qiscus_room_id: qiscus_room_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="411">
          
          
          <code class="ruby">            is_group_chat: true,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="412">
          
          
          <code class="ruby">            user_id: initiator.id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="413">
          
          
          <code class="ruby">            target_user_id: target_user_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="414">
          
          
          <code class="ruby">            application_id: @current_user.application.id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="415">
          
          
          <code class="ruby">            group_avatar_url: group_avatar_placeholder,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="416">
          
          
          <code class="ruby">            is_official_chat: is_official_chat</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="417">
          
          
          <code class="ruby">          )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="418">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="419">
          <span class="hits">4</span>
          
          <code class="ruby">          chat_room.save!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="420">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="421">
          <span class="hits">4</span>
          
          <code class="ruby">          chat_user = ChatUser.new</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="422">
          <span class="hits">4</span>
          
          <code class="ruby">          chat_user.chat_room_id = chat_room.id</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="423">
          <span class="hits">4</span>
          
          <code class="ruby">          chat_user.user_id = @current_user.id</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="424">
          <span class="hits">4</span>
          
          <code class="ruby">          chat_user.is_group_admin = true # group creator assign as group admin</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="425">
          <span class="hits">4</span>
          
          <code class="ruby">          chat_user.save!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="426">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="427">
          
          
          <code class="ruby">          # save each participant</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="428">
          <span class="hits">4</span>
          
          <code class="ruby">          target_user.each do |target_user_id|</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="429">
          <span class="hits">6</span>
          
          <code class="ruby">            chat_user = ChatUser.new</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="430">
          <span class="hits">6</span>
          
          <code class="ruby">            chat_user.chat_room_id = chat_room.id</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="431">
          <span class="hits">6</span>
          
          <code class="ruby">            chat_user.user_id = target_user_id.id</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="432">
          <span class="hits">6</span>
          
          <code class="ruby">            chat_user.is_group_admin = false # group participant assign as group member</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="433">
          <span class="hits">6</span>
          
          <code class="ruby">            chat_user.save!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="434">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="435">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="436">
          <span class="hits">4</span>
          
          <code class="ruby">          if is_official_chat == false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="437">
          
          
          <code class="ruby">            # Backend need to post system event message after create new group with participants</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="438">
          
          
          <code class="ruby">            # Post system event message with system_event_type = create_room</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="439">
          <span class="hits">4</span>
          
          <code class="ruby">            system_event_type = &quot;create_room&quot;</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="440">
          <span class="hits">4</span>
          
          <code class="ruby">            qiscus_sdk = QiscusSdk.new(application.app_id, application.qiscus_sdk_secret)</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="441">
          <span class="hits">4</span>
          
          <code class="ruby">            qiscus_sdk.post_system_event_message(system_event_type, qiscus_room_id, @current_user.qiscus_email, [], chat_name)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="442">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="443">
          
          
          <code class="ruby">            # Contact sync smarter after create new group with participants. It&#39;s only temporary to increase the number of contact</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="444">
          <span class="hits">4</span>
          
          <code class="ruby">            group_participant_ids = target_user.pluck(:id).to_a + [@current_user.id]</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="445">
          <span class="hits">4</span>
          
          <code class="ruby">            new_participant_ids = group_participant_ids</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="446">
          <span class="hits">4</span>
          
          <code class="ruby">            ContactSyncSmarterWorker.perform_later(new_participant_ids, group_participant_ids, @current_user.application.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="447">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="448">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="449">
          
          
          <code class="ruby">          # if exist then return error with warning that qiscus room id has been inserted before</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="450">
          
          
          <code class="ruby">          raise Exception.new(&quot;Qiscus room id has been inserted before, it must be unique.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="451">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="452">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="453">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="454">
          <span class="hits">4</span>
          
          <code class="ruby">      chat_room = chat_room.as_json({:me =&gt; @current_user})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="455">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="456">
          
          
          <code class="ruby">      # add group_admins payload in chat_room json</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="457">
          <span class="hits">4</span>
          
          <code class="ruby">      chat_room.merge!(&#39;group_admins&#39; =&gt; [@current_user.id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="458">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="459">
          <span class="hits">4</span>
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="460">
          
          
          <code class="ruby">        data: chat_room</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="461">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="462">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="463">
          <span class="hits">2</span>
          
          <code class="ruby">    rescue ActiveRecord::RecordInvalid =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="464">
          
          
          <code class="ruby">      msg = &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="465">
          
          
          <code class="ruby">      e.record.errors.map do |k, v|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="466">
          
          
          <code class="ruby">        key = k.to_s.humanize</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="467">
          
          
          <code class="ruby">        msg = msg + &quot;#{key} #{v}, &quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="468">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="469">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="470">
          
          
          <code class="ruby">      msg = msg.chomp(&quot;, &quot;) + &quot;.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="471">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="472">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="473">
          
          
          <code class="ruby">          message: msg</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="474">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="475">
          
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="476">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="477">
          
          
          <code class="ruby">    rescue Exception =&gt; e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="478">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="479">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="480">
          
          
          <code class="ruby">          message: e.message</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="481">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="482">
          <span class="hits">2</span>
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="483">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="484">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="485">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="486">
          
          
          <code class="ruby">  # =begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="487">
          
          
          <code class="ruby">  # @apiVersion 1.0.0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="488">
          
          
          <code class="ruby">  # @api {post} /api/v1/chat/conversations/channel Create Channel</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="489">
          
          
          <code class="ruby">  # @apiDescription Create group chat with participants. Channel is a type of room that allows you to have participants with a maximum 5000 participants. The difference between channel and group chat is users or participants cannot get typing, read, and delivered indicators.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="490">
          
          
          <code class="ruby">  # Please note that if initiator (your access token id) is official, it will be logged as target user id.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="491">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="492">
          
          
          <code class="ruby">  # @apiName CreateChannel</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="493">
          
          
          <code class="ruby">  # @apiGroup Chat</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="494">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="495">
          
          
          <code class="ruby">  # @apiParam {String} access_token User access token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="496">
          
          
          <code class="ruby">  # @apiParam {Array} target_user_id[] Array of user id in Qisme database</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="497">
          
          
          <code class="ruby">  # @apiParam {Number} qiscus_room_id Qiscus room id from SDK create_room. If client doesn&#39;t send this params, it&#39;s mean backend will create room in sdk</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="498">
          
          
          <code class="ruby">  # @apiParam {String} [chat_name=&quot;Group Chat Name&quot;] Channel name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="499">
          
          
          <code class="ruby">  # @apiParam {String} [unique_id=&quot;Channel Unique Id&quot;] Channel unique id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="500">
          
          
          <code class="ruby">  # @apiParam {Boolean} [is_official_chat=false] It is official group chat or not</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="501">
          
          
          <code class="ruby">  # =end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="502">
          <span class="hits">1</span>
          
          <code class="ruby">  def channel</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="503">
          <span class="hits">3</span>
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="504">
          <span class="hits">3</span>
          
          <code class="ruby">      chat_room = nil</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="505">
          <span class="hits">3</span>
          
          <code class="ruby">      ActiveRecord::Base.transaction do</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="506">
          <span class="hits">3</span>
          
          <code class="ruby">        qiscus_token = @current_user.qiscus_token</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="507">
          <span class="hits">3</span>
          
          <code class="ruby">        application = @current_user.application</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="508">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="509">
          <span class="hits">3</span>
          
          <code class="ruby">        target_user_id = params[:target_user_id]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="510">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="511">
          <span class="hits">3</span>
          
          <code class="ruby">        if !target_user_id.is_a?(Array)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="512">
          <span class="hits">1</span>
          
          <code class="ruby">          raise Exception.new(&quot;Target user id must be an array of user id.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="513">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="514">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="515">
          
          
          <code class="ruby">        # need to convert array of target_user_id (string) into integer</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="516">
          <span class="hits">5</span>
          
          <code class="ruby">        target_user_id = target_user_id.collect{|i| i.to_i}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="517">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="518">
          <span class="hits">2</span>
          
          <code class="ruby">        chat_name = &quot;&quot;</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="519">
          <span class="hits">2</span>
          
          <code class="ruby">        if !params[:chat_name].nil? &amp;&amp; params[:chat_name] != &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="520">
          
          
          <code class="ruby">          chat_name = params[:chat_name]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="521">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="522">
          <span class="hits">2</span>
          
          <code class="ruby">          chat_name = &quot;Channel Name&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="523">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="524">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="525">
          
          
          <code class="ruby">        # unique id created using pattern: :app_id-&quot;channel&quot;-:random_string</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="526">
          <span class="hits">2</span>
          
          <code class="ruby">        random = SecureRandom.hex</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="527">
          <span class="hits">2</span>
          
          <code class="ruby">        unique_id = &quot;app-#{@current_user.application.app_id}-channel-#{random}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="528">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="529">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="530">
          <span class="hits">2</span>
          
          <code class="ruby">        is_official_chat = params[:is_official_chat]</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="531">
          <span class="hits">2</span>
          
          <code class="ruby">        if is_official_chat == &quot;true&quot; || params[:is_official_chat] == true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="532">
          
          
          <code class="ruby">          is_official_chat = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="533">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="534">
          <span class="hits">2</span>
          
          <code class="ruby">          is_official_chat = false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="535">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="536">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="537">
          <span class="hits">2</span>
          
          <code class="ruby">        if is_official_chat</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="538">
          
          
          <code class="ruby">          chat_name = @current_user.fullname</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="539">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="540">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="541">
          <span class="hits">2</span>
          
          <code class="ruby">        target_user = User.where(&quot;id IN (?)&quot;, target_user_id.to_a)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="542">
          <span class="hits">5</span>
          
          <code class="ruby">        target_user = target_user.sort_by { |u| target_user_id.index(u.id) } # sort by index of target_user_id</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="543">
          <span class="hits">2</span>
          
          <code class="ruby">        email_sdk = target_user.pluck(:qiscus_email)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="544">
          <span class="hits">2</span>
          
          <code class="ruby">        email_sdk = email_sdk + [@current_user.qiscus_email]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="545">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="546">
          
          
          <code class="ruby">        # prevent error if target user is not found</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="547">
          <span class="hits">2</span>
          
          <code class="ruby">        if target_user.empty?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="548">
          
          
          <code class="ruby">          raise Exception.new(&quot;No one target user found.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="549">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="550">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="551">
          
          
          <code class="ruby">        # default group avatar</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="552">
          <span class="hits">2</span>
          
          <code class="ruby">        channel_avatar_placeholder = &quot;https://d1edrlpyc25xu0.cloudfront.net/kiwari-prod/image/upload/1yahAVOqLy/1510804279-default_group_avatar.png&quot;</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="553">
          <span class="hits">2</span>
          
          <code class="ruby">        if params[:channel_avatar_url].present? &amp;&amp; !params[:channel_avatar_url].nil? &amp;&amp; params[:group_avatar_url] != &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="554">
          
          
          <code class="ruby">          group_avatar_placeholder = params[:channel_avatar_url]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="555">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="556">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="557">
          
          
          <code class="ruby">        # If client doesn&#39;t qiscus_room_id params, it&#39;s mean backend will create room in sdk</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="558">
          <span class="hits">2</span>
          
          <code class="ruby">        if params[:qiscus_room_id].nil? || params[:qiscus_room_id] == &quot;&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="559">
          <span class="hits">1</span>
          
          <code class="ruby">          qiscus_sdk = QiscusSdk.new(application.app_id, application.qiscus_sdk_secret)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="560">
          <span class="hits">1</span>
          
          <code class="ruby">          room = qiscus_sdk.get_or_create_channel(chat_name, unique_id, email_sdk, channel_avatar_placeholder)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="561">
          
          
          <code class="ruby">          qiscus_room_id = room.id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="562">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="563">
          <span class="hits">1</span>
          
          <code class="ruby">          qiscus_room_id = params[:qiscus_room_id]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="564">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="565">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="566">
          <span class="hits">1</span>
          
          <code class="ruby">        chat_room = ChatRoom.find_by(qiscus_room_id: qiscus_room_id, application_id: @current_user.application.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="567">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="568">
          <span class="hits">1</span>
          
          <code class="ruby">        target_user_id = target_user.first.id</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="569">
          <span class="hits">1</span>
          
          <code class="ruby">        initiator = @current_user</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="570">
          <span class="hits">1</span>
          
          <code class="ruby">        if initiator.is_official</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="571">
          
          
          <code class="ruby">          initiator = target_user.first # initiator must be member</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="572">
          
          
          <code class="ruby">          target_user_id = @current_user.id # target user must be official</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="573">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="574">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="575">
          <span class="hits">1</span>
          
          <code class="ruby">        if chat_room.nil?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="576">
          <span class="hits">1</span>
          
          <code class="ruby">          chat_room = ChatRoom.new(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="577">
          
          
          <code class="ruby">            group_chat_name: chat_name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="578">
          
          
          <code class="ruby">            qiscus_room_name: chat_name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="579">
          
          
          <code class="ruby">            qiscus_room_id: qiscus_room_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="580">
          
          
          <code class="ruby">            is_group_chat: true,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="581">
          
          
          <code class="ruby">            is_channel: true,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="582">
          
          
          <code class="ruby">            user_id: initiator.id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="583">
          
          
          <code class="ruby">            target_user_id: target_user_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="584">
          
          
          <code class="ruby">            application_id: @current_user.application.id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="585">
          
          
          <code class="ruby">            group_avatar_url: group_avatar_placeholder,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="586">
          
          
          <code class="ruby">            is_official_chat: is_official_chat</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="587">
          
          
          <code class="ruby">          )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="588">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="589">
          <span class="hits">1</span>
          
          <code class="ruby">          chat_room.save!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="590">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="591">
          <span class="hits">1</span>
          
          <code class="ruby">          chat_user = ChatUser.new</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="592">
          <span class="hits">1</span>
          
          <code class="ruby">          chat_user.chat_room_id = chat_room.id</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="593">
          <span class="hits">1</span>
          
          <code class="ruby">          chat_user.user_id = @current_user.id</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="594">
          <span class="hits">1</span>
          
          <code class="ruby">          chat_user.is_group_admin = true # group creator assign as group admin</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="595">
          <span class="hits">1</span>
          
          <code class="ruby">          chat_user.save!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="596">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="597">
          
          
          <code class="ruby">          # save each participant</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="598">
          <span class="hits">1</span>
          
          <code class="ruby">          target_user.each do |target_user_id|</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="599">
          <span class="hits">2</span>
          
          <code class="ruby">            chat_user = ChatUser.new</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="600">
          <span class="hits">2</span>
          
          <code class="ruby">            chat_user.chat_room_id = chat_room.id</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="601">
          <span class="hits">2</span>
          
          <code class="ruby">            chat_user.user_id = target_user_id.id</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="602">
          <span class="hits">2</span>
          
          <code class="ruby">            chat_user.is_group_admin = false # group participant assign as group member</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="603">
          <span class="hits">2</span>
          
          <code class="ruby">            chat_user.save!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="604">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="605">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="606">
          <span class="hits">1</span>
          
          <code class="ruby">          if is_official_chat == false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="607">
          
          
          <code class="ruby">            # Backend need to post system event message after create new group with participants</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="608">
          
          
          <code class="ruby">            # Post system event message with system_event_type = create_room</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="609">
          <span class="hits">1</span>
          
          <code class="ruby">            system_event_type = &quot;create_room&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="610">
          <span class="hits">1</span>
          
          <code class="ruby">            qiscus_sdk = QiscusSdk.new(application.app_id, application.qiscus_sdk_secret)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="611">
          <span class="hits">1</span>
          
          <code class="ruby">            qiscus_sdk.post_system_event_message(system_event_type, qiscus_room_id, @current_user.qiscus_email, [], chat_name)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="612">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="613">
          
          
          <code class="ruby">            # Contact sync smarter after create new group with participants. It&#39;s only temporary to increase the number of contact</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="614">
          <span class="hits">1</span>
          
          <code class="ruby">            group_participant_ids = target_user.pluck(:id).to_a + [@current_user.id]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="615">
          <span class="hits">1</span>
          
          <code class="ruby">            new_participant_ids = group_participant_ids</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="616">
          <span class="hits">1</span>
          
          <code class="ruby">            ContactSyncSmarterWorker.perform_later(new_participant_ids, group_participant_ids, @current_user.application.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="617">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="618">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="619">
          
          
          <code class="ruby">          # if exist then return error with warning that qiscus room id has been inserted before</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="620">
          
          
          <code class="ruby">          raise Exception.new(&quot;Qiscus room id has been inserted before, it must be unique.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="621">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="622">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="623">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="624">
          <span class="hits">1</span>
          
          <code class="ruby">      chat_room = chat_room.as_json({:me =&gt; @current_user})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="625">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="626">
          
          
          <code class="ruby">      # add group_admins payload in chat_room json</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="627">
          <span class="hits">1</span>
          
          <code class="ruby">      chat_room.merge!(&#39;group_admins&#39; =&gt; [@current_user.id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="628">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="629">
          <span class="hits">1</span>
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="630">
          
          
          <code class="ruby">        data: chat_room</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="631">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="632">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="633">
          <span class="hits">2</span>
          
          <code class="ruby">    rescue ActiveRecord::RecordInvalid =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="634">
          
          
          <code class="ruby">      msg = &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="635">
          
          
          <code class="ruby">      e.record.errors.map do |k, v|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="636">
          
          
          <code class="ruby">        key = k.to_s.humanize</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="637">
          
          
          <code class="ruby">        msg = msg + &quot;#{key} #{v}, &quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="638">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="639">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="640">
          
          
          <code class="ruby">      msg = msg.chomp(&quot;, &quot;) + &quot;.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="641">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="642">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="643">
          
          
          <code class="ruby">          message: msg</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="644">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="645">
          
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="646">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="647">
          
          
          <code class="ruby">    rescue Exception =&gt; e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="648">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="649">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="650">
          
          
          <code class="ruby">          message: e.message</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="651">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="652">
          <span class="hits">2</span>
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="653">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="654">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="655">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="656">
          
          
          <code class="ruby">  # =begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="657">
          
          
          <code class="ruby">  # @apiVersion 1.0.0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="658">
          
          
          <code class="ruby">  # @api {post} /api/v1/chat/conversations/change_group_name Change Group Name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="659">
          
          
          <code class="ruby">  # @apiDescription Change Group Name, this will not change group name in SDK, so please change it manually</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="660">
          
          
          <code class="ruby">  # @apiName ChangeGroupName</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="661">
          
          
          <code class="ruby">  # @apiGroup Chat</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="662">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="663">
          
          
          <code class="ruby">  # @apiParam {String} access_token User access token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="664">
          
          
          <code class="ruby">  # @apiParam {Number} chat_room_id Chat room id which will be renamed, this is qiscus room id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="665">
          
          
          <code class="ruby">  # @apiParam {String} group_chat_name New group chat name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="666">
          
          
          <code class="ruby">  # =end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="667">
          <span class="hits">1</span>
          
          <code class="ruby">  def change_group_name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="668">
          
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="669">
          
          
          <code class="ruby">      chat_room = nil</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="670">
          
          
          <code class="ruby">      ActiveRecord::Base.transaction do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="671">
          
          
          <code class="ruby">        id = params[:chat_room_id]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="672">
          
          
          <code class="ruby">        group_chat_name = params[:group_chat_name]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="673">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="674">
          
          
          <code class="ruby">        chat_room = ChatRoom.includes({</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="675">
          
          
          <code class="ruby">            users: [:roles, :application],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="676">
          
          
          <code class="ruby">            # user: [:roles, :application],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="677">
          
          
          <code class="ruby">          }).find_by(qiscus_room_id: id, application_id: @current_user.application.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="678">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="679">
          
          
          <code class="ruby">        # if current user has access or is a participant of this chat room, then change the chat room group name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="680">
          
          
          <code class="ruby">        if chat_room.users.pluck(:id).to_a.include?(@current_user.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="681">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="682">
          
          
          <code class="ruby">          # # no need to activate, this handled by client</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="683">
          
          
          <code class="ruby">          # # update group name in sdk info from back-end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="684">
          
          
          <code class="ruby">          # qiscus_sdk = QiscusSdk.new(@current_user.application.app_id, @current_user.application.qiscus_sdk_secret)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="685">
          
          
          <code class="ruby">          # qiscus_sdk.update_room(@current_user.qiscus_token, chat_room.qiscus_room_id, group_chat_name, chat_room.group_avatar_url)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="686">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="687">
          
          
          <code class="ruby">          chat_room.update_attribute(:group_chat_name, group_chat_name)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="688">
          
          
          <code class="ruby">          # also update qiscus_room_name, because Android client have update qiscus room name from their SDK API</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="689">
          
          
          <code class="ruby">          chat_room.update_attribute(:qiscus_room_name, group_chat_name)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="690">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="691">
          
          
          <code class="ruby">          # Backend need to post system event message after change room name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="692">
          
          
          <code class="ruby">          system_event_type = &quot;change_room_name&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="693">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="694">
          
          
          <code class="ruby">          qiscus_sdk = QiscusSdk.new(@current_user.application.app_id, @current_user.application.qiscus_sdk_secret)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="695">
          
          
          <code class="ruby">          qiscus_sdk.post_system_event_message(system_event_type, id, @current_user.qiscus_email, [], group_chat_name)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="696">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="697">
          
          
          <code class="ruby">          render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="698">
          
          
          <code class="ruby">            data: chat_room.as_json({:me =&gt; @current_user})</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="699">
          
          
          <code class="ruby">          } and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="700">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="701">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="702">
          
          
          <code class="ruby">          raise Exception.new(&quot;You are not member of this group.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="703">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="704">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="705">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="706">
          
          
          <code class="ruby">    rescue ActiveRecord::RecordInvalid =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="707">
          
          
          <code class="ruby">      msg = &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="708">
          
          
          <code class="ruby">      e.record.errors.map do |k, v|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="709">
          
          
          <code class="ruby">        key = k.to_s.humanize</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="710">
          
          
          <code class="ruby">        msg = msg + &quot;#{key} #{v}, &quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="711">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="712">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="713">
          
          
          <code class="ruby">      msg = msg.chomp(&quot;, &quot;) + &quot;.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="714">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="715">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="716">
          
          
          <code class="ruby">          message: msg</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="717">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="718">
          
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="719">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="720">
          
          
          <code class="ruby">    rescue Exception =&gt; e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="721">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="722">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="723">
          
          
          <code class="ruby">          message: e.message</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="724">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="725">
          
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="726">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="727">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="728">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="729">
          
          
          <code class="ruby">  # =begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="730">
          
          
          <code class="ruby">  # @apiVersion 1.0.0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="731">
          
          
          <code class="ruby">  # @api {post} /api/v1/chat/conversations/change_group_avatar Change Group Avatar</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="732">
          
          
          <code class="ruby">  # @apiDescription Change Group Avatar, this will not change group avatar in SDK, so please change it manually</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="733">
          
          
          <code class="ruby">  # @apiName ChangeGroupAvatar</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="734">
          
          
          <code class="ruby">  # @apiGroup Chat</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="735">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="736">
          
          
          <code class="ruby">  # @apiParam {String} access_token User access token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="737">
          
          
          <code class="ruby">  # @apiParam {Number} chat_room_id Chat room id which will be changed, this is qiscus room id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="738">
          
          
          <code class="ruby">  # @apiParam {File} group_avatar Image file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="739">
          
          
          <code class="ruby">  # =end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="740">
          <span class="hits">1</span>
          
          <code class="ruby">  def change_group_avatar</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="741">
          
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="742">
          
          
          <code class="ruby">      chat_room = nil</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="743">
          
          
          <code class="ruby">      ActiveRecord::Base.transaction do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="744">
          
          
          <code class="ruby">        id = params[:chat_room_id]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="745">
          
          
          <code class="ruby">        chat_room = ChatRoom.includes({</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="746">
          
          
          <code class="ruby">            users: [:roles, :application],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="747">
          
          
          <code class="ruby">            # user: [:roles, :application],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="748">
          
          
          <code class="ruby">          }).find_by(qiscus_room_id: id, application_id: @current_user.application.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="749">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="750">
          
          
          <code class="ruby">        # if current user has access or is a participant of this chat room, then change the chat room group name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="751">
          
          
          <code class="ruby">        if chat_room.users.pluck(:id).to_a.include?(@current_user.id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="752">
          
          
          <code class="ruby">          qiscus_sdk = QiscusSdk.new(@current_user.application.app_id, @current_user.application.qiscus_sdk_secret)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="753">
          
          
          <code class="ruby">          group_chat_avatar = qiscus_sdk.upload_file(@current_user.qiscus_token, @group_avatar)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="754">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="755">
          
          
          <code class="ruby">          # change group avatar</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="756">
          
          
          <code class="ruby">          chat_room.update_attribute(:group_avatar_url, group_chat_avatar)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="757">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="758">
          
          
          <code class="ruby">          # # no need to activate, this handled by client</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="759">
          
          
          <code class="ruby">          # # update group avatar in sdk info from back-end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="760">
          
          
          <code class="ruby">          # qiscus_sdk = QiscusSdk.new(@current_user.application.app_id, @current_user.application.qiscus_sdk_secret)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="761">
          
          
          <code class="ruby">          # qiscus_sdk.update_room(@current_user.qiscus_token, chat_room.qiscus_room_id, chat_room.group_chat_name, group_chat_avatar)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="762">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="763">
          
          
          <code class="ruby">          # Backend need to post system event message after change room avatar</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="764">
          
          
          <code class="ruby">          system_event_type = &quot;change_room_avatar&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="765">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="766">
          
          
          <code class="ruby">          qiscus_sdk = QiscusSdk.new(@current_user.application.app_id, @current_user.application.qiscus_sdk_secret)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="767">
          
          
          <code class="ruby">          qiscus_sdk.post_system_event_message(system_event_type, id, @current_user.qiscus_email, [], group_chat_avatar)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="768">
          
          
          <code class="ruby">          render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="769">
          
          
          <code class="ruby">            data: chat_room.as_json({:me =&gt; @current_user})</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="770">
          
          
          <code class="ruby">          } and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="771">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="772">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="773">
          
          
          <code class="ruby">          raise Exception.new(&quot;You are not member of this group.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="774">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="775">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="776">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="777">
          
          
          <code class="ruby">    rescue ActiveRecord::RecordInvalid =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="778">
          
          
          <code class="ruby">      msg = &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="779">
          
          
          <code class="ruby">      e.record.errors.map do |k, v|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="780">
          
          
          <code class="ruby">        key = k.to_s.humanize</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="781">
          
          
          <code class="ruby">        msg = msg + &quot;#{key} #{v}, &quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="782">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="783">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="784">
          
          
          <code class="ruby">      msg = msg.chomp(&quot;, &quot;) + &quot;.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="785">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="786">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="787">
          
          
          <code class="ruby">          message: msg</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="788">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="789">
          
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="790">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="791">
          
          
          <code class="ruby">    rescue Exception =&gt; e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="792">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="793">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="794">
          
          
          <code class="ruby">          message: e.message</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="795">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="796">
          
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="797">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="798">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="799">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="800">
          
          
          <code class="ruby">  # =begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="801">
          
          
          <code class="ruby">  # @apiVersion 1.0.0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="802">
          
          
          <code class="ruby">  # @api {post} /api/v1/chat/conversations/post_comment Post Comment</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="803">
          
          
          <code class="ruby">  # @apiDescription Send message to SDK through Qisme engine.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="804">
          
          
          <code class="ruby">  # @apiName PostComment</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="805">
          
          
          <code class="ruby">  # @apiGroup Chat</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="806">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="807">
          
          
          <code class="ruby">  # @apiParam {String} access_token User access token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="808">
          
          
          <code class="ruby">  # @apiParam {Number} topic_id Chat room id which will be post</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="809">
          
          
          <code class="ruby">  # @apiParam {String} comment Message comment to send</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="810">
          
          
          <code class="ruby">  # @apiParam {String} type Message type `text`, `buttons`, `card`, `carousel`, or `account_linking`</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="811">
          
          
          <code class="ruby">  # @apiParam {String} payload JSON string for payload, example: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="812">
          
          
          <code class="ruby">  #     &quot;url&quot;: &quot;http://google.com&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="813">
          
          
          <code class="ruby">  #     &quot;redirect_url&quot;: &quot;http://google.com/redirect&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="814">
          
          
          <code class="ruby">  #     &quot;params&quot;: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="815">
          
          
          <code class="ruby">  #         &quot;user_id&quot;: 1,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="816">
          
          
          <code class="ruby">  #         &quot;topic_id&quot;: 1,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="817">
          
          
          <code class="ruby">  #         &quot;button_text&quot;: &quot;ini button&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="818">
          
          
          <code class="ruby">  #         &quot;view_title&quot;: &quot;title&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="819">
          
          
          <code class="ruby">  #     }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="820">
          
          
          <code class="ruby">  # }. For more payload example, please refer to this documentation,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="821">
          
          
          <code class="ruby">  # https://www.qiscus.com/documentation/rest/latest/comment#post-comment.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="822">
          
          
          <code class="ruby">  # =end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="823">
          <span class="hits">1</span>
          
          <code class="ruby">  def post_comment</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="824">
          
          
          <code class="ruby">    comments = Array.new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="825">
          
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="826">
          
          
          <code class="ruby">      ActiveRecord::Base.transaction do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="827">
          
          
          <code class="ruby">        qiscus_token = @current_user.qiscus_token</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="828">
          
          
          <code class="ruby">        application = @current_user.application</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="829">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="830">
          
          
          <code class="ruby">        topic_id = params[:topic_id]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="831">
          
          
          <code class="ruby">        comment = params[:comment]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="832">
          
          
          <code class="ruby">        type = params[:type]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="833">
          
          
          <code class="ruby">        payload = params[:payload]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="834">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="835">
          
          
          <code class="ruby">        if type.nil? || type == &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="836">
          
          
          <code class="ruby">          type = &quot;text&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="837">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="838">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="839">
          
          
          <code class="ruby">        if payload.nil? || payload == &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="840">
          
          
          <code class="ruby">          payload = &quot;&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="841">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="842">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="843">
          
          
          <code class="ruby">        qiscus_sdk = QiscusSdk.new(application.app_id, application.qiscus_sdk_secret)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="844">
          
          
          <code class="ruby">        comments = qiscus_sdk.post_comment(qiscus_token, topic_id, comment, type, payload)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="845">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="846">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="847">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="848">
          
          
          <code class="ruby">        data: comments</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="849">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="850">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="851">
          
          
          <code class="ruby">    rescue ActiveRecord::RecordInvalid =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="852">
          
          
          <code class="ruby">      msg = &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="853">
          
          
          <code class="ruby">      e.record.errors.map do |k, v|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="854">
          
          
          <code class="ruby">        key = k.to_s.humanize</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="855">
          
          
          <code class="ruby">        msg = msg + &quot;#{key} #{v}, &quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="856">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="857">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="858">
          
          
          <code class="ruby">      msg = msg.chomp(&quot;, &quot;) + &quot;.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="859">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="860">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="861">
          
          
          <code class="ruby">          message: msg</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="862">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="863">
          
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="864">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="865">
          
          
          <code class="ruby">    rescue Exception =&gt; e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="866">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="867">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="868">
          
          
          <code class="ruby">          message: e.message</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="869">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="870">
          
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="871">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="872">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="873">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="874">
          
          
          <code class="ruby">  # load comment by topic id</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="875">
          <span class="hits">1</span>
          
          <code class="ruby">  def load_comments</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="876">
          
          
          <code class="ruby">    comments = Array.new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="877">
          
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="878">
          
          
          <code class="ruby">      ActiveRecord::Base.transaction do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="879">
          
          
          <code class="ruby">        qiscus_token = @current_user.qiscus_token</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="880">
          
          
          <code class="ruby">        application = @current_user.application</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="881">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="882">
          
          
          <code class="ruby">        qiscus_sdk = QiscusSdk.new(application.app_id, application.qiscus_sdk_secret)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="883">
          
          
          <code class="ruby">        comments = qiscus_sdk.load_comments(qiscus_token, params[:topic_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="884">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="885">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="886">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="887">
          
          
          <code class="ruby">        data: comments</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="888">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="889">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="890">
          
          
          <code class="ruby">    rescue ActiveRecord::RecordInvalid =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="891">
          
          
          <code class="ruby">      msg = &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="892">
          
          
          <code class="ruby">      e.record.errors.map do |k, v|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="893">
          
          
          <code class="ruby">        key = k.to_s.humanize</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="894">
          
          
          <code class="ruby">        msg = msg + &quot;#{key} #{v}, &quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="895">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="896">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="897">
          
          
          <code class="ruby">      msg = msg.chomp(&quot;, &quot;) + &quot;.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="898">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="899">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="900">
          
          
          <code class="ruby">          message: msg</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="901">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="902">
          
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="903">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="904">
          
          
          <code class="ruby">    rescue Exception =&gt; e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="905">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="906">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="907">
          
          
          <code class="ruby">          message: e.message</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="908">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="909">
          
          
          <code class="ruby">      }, status: 500 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="910">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="911">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="912">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="913">
          <span class="hits">1</span>
          
          <code class="ruby">  def get_room_by_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="914">
          
          
          <code class="ruby">    rooms = Array.new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="915">
          
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="916">
          
          
          <code class="ruby">      ActiveRecord::Base.transaction do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="917">
          
          
          <code class="ruby">        qiscus_token = @current_user.qiscus_token</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="918">
          
          
          <code class="ruby">        application = @current_user.application</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="919">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="920">
          
          
          <code class="ruby">        qiscus_sdk = QiscusSdk.new(application.app_id, application.qiscus_sdk_secret)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="921">
          
          
          <code class="ruby">        rooms = qiscus_sdk.get_room_by_id(qiscus_token, params[:room_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="922">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="923">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="924">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="925">
          
          
          <code class="ruby">        data: rooms</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="926">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="927">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="928">
          
          
          <code class="ruby">    rescue ActiveRecord::RecordInvalid =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="929">
          
          
          <code class="ruby">      msg = &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="930">
          
          
          <code class="ruby">      e.record.errors.map do |k, v|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="931">
          
          
          <code class="ruby">        key = k.to_s.humanize</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="932">
          
          
          <code class="ruby">        msg = msg + &quot;#{key} #{v}, &quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="933">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="934">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="935">
          
          
          <code class="ruby">      msg = msg.chomp(&quot;, &quot;) + &quot;.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="936">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="937">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="938">
          
          
          <code class="ruby">          message: msg</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="939">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="940">
          
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="941">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="942">
          
          
          <code class="ruby">    rescue Exception =&gt; e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="943">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="944">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="945">
          
          
          <code class="ruby">            message: e.message</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="946">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="947">
          
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="948">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="949">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="950">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="951">
          
          
          <code class="ruby">  # Sync conversation</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="952">
          
          
          <code class="ruby">  # if return empty then there is no comment after given last comment id (no new comment)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="953">
          <span class="hits">1</span>
          
          <code class="ruby">  def sync</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="954">
          
          
          <code class="ruby">    comments = Array.new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="955">
          
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="956">
          
          
          <code class="ruby">      ActiveRecord::Base.transaction do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="957">
          
          
          <code class="ruby">        qiscus_token = @current_user.qiscus_token</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="958">
          
          
          <code class="ruby">        application = @current_user.application</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="959">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="960">
          
          
          <code class="ruby">        qiscus_sdk = QiscusSdk.new(application.app_id, application.qiscus_sdk_secret)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="961">
          
          
          <code class="ruby">        comments = qiscus_sdk.sync(qiscus_token, params[:last_comment_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="962">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="963">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="964">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="965">
          
          
          <code class="ruby">        data: comments</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="966">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="967">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="968">
          
          
          <code class="ruby">    rescue ActiveRecord::RecordInvalid =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="969">
          
          
          <code class="ruby">      msg = &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="970">
          
          
          <code class="ruby">      e.record.errors.map do |k, v|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="971">
          
          
          <code class="ruby">        key = k.to_s.humanize</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="972">
          
          
          <code class="ruby">        msg = msg + &quot;#{key} #{v}, &quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="973">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="974">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="975">
          
          
          <code class="ruby">      msg = msg.chomp(&quot;, &quot;) + &quot;.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="976">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="977">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="978">
          
          
          <code class="ruby">          message: msg</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="979">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="980">
          
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="981">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="982">
          
          
          <code class="ruby">    rescue Exception =&gt; e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="983">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="984">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="985">
          
          
          <code class="ruby">          message: e.message</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="986">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="987">
          
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="988">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="989">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="990">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="991">
          
          
          <code class="ruby">  # =begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="992">
          
          
          <code class="ruby">  # @apiVersion 1.0.0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="993">
          
          
          <code class="ruby">  # @api {get} /api/v1/chat/conversations/filter Filter Conversation List</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="994">
          
          
          <code class="ruby">  # @apiName FilterChat</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="995">
          
          
          <code class="ruby">  # @apiGroup Chat</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="996">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="997">
          
          
          <code class="ruby">  # @apiParam {String} access_token User access token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="998">
          
          
          <code class="ruby">  # @apiParam {String} chat_room_type Chat room type : &#39;single&#39; or &#39;group&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="999">
          
          
          <code class="ruby">  # =end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="1000">
          <span class="hits">1</span>
          
          <code class="ruby">  def filter</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1001">
          
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1002">
          
          
          <code class="ruby">      if params[:chat_room_type].nil? || !params[:chat_room_type].present? || params[:chat_room_type] == &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1003">
          
          
          <code class="ruby">        raise Exception.new(&quot;Please specify your chat_room_type.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1004">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1005">
          
          
          <code class="ruby">        if params[:chat_room_type].downcase.delete(&#39; &#39;) != &quot;single&quot; &amp;&amp; params[:chat_room_type].downcase.delete(&#39; &#39;) != &quot;group&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1006">
          
          
          <code class="ruby">          raise Exception.new(&quot;Permitted chat_room_type is &#39;single&#39; or &#39;group&#39;.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1007">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1008">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1009">
          
          
          <code class="ruby">      #</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1010">
          
          
          <code class="ruby">      if params[:chat_room_type] == &quot;single&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1011">
          
          
          <code class="ruby">        is_group_chat = false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1012">
          
          
          <code class="ruby">      elsif params[:chat_room_type] == &quot;group&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1013">
          
          
          <code class="ruby">        is_group_chat = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1014">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1015">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1016">
          
          
          <code class="ruby">      # get current time, to measure calling time each process</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1017">
          
          
          <code class="ruby">      start_time_pluck_room_id = Time.now</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1018">
          
          
          <code class="ruby">      qiscus_room_ids = @current_user.chat_rooms.where(is_group_chat: is_group_chat).pluck(:qiscus_room_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1019">
          
          
          <code class="ruby">      end_time_pluck_room_id = Time.now</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1020">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1021">
          
          
          <code class="ruby">      chat_room_sdk_info = []</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1022">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1023">
          
          
          <code class="ruby">      # if not empty qiscus room id, then call sdk to avoid error</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1024">
          
          
          <code class="ruby">      start_time_sdk = Time.now</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1025">
          
          
          <code class="ruby">      if qiscus_room_ids.empty? == false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1026">
          
          
          <code class="ruby">        qiscus_sdk = QiscusSdk.new(@current_user.application.app_id, @current_user.application.qiscus_sdk_secret)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1027">
          
          
          <code class="ruby">        sdk_status, chat_room_sdk_info = qiscus_sdk.get_rooms_info(@current_user.qiscus_email, qiscus_room_ids)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1028">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1029">
          
          
          <code class="ruby">        # throw an error</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1030">
          
          
          <code class="ruby">        if sdk_status != 200</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1031">
          
          
          <code class="ruby">          raise Exception.new(chat_room_sdk_info[&#39;error&#39;][&#39;detailed_messages&#39;].to_a.join(&quot;, &quot;).capitalize)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1032">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1033">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1034">
          
          
          <code class="ruby">      end_time_sdk = Time.now</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1035">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1036">
          
          
          <code class="ruby">      page = 1</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1037">
          
          
          <code class="ruby">      per_page = 100</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1038">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1039">
          
          
          <code class="ruby">      start_chat_room_load = Time.now</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1040">
          
          
          <code class="ruby">      _, chat_rooms = ChatRoomHelper.load_for(@current_user, chat_room_sdk_info, page, per_page)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1041">
          
          
          <code class="ruby">      end_chat_room_load = Time.now</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1042">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1043">
          
          
          <code class="ruby">      pluck_room_id_time = (end_time_pluck_room_id - start_time_pluck_room_id) * 1000</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1044">
          
          
          <code class="ruby">      sdk_call_time = (end_time_sdk - start_time_sdk) * 1000</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1045">
          
          
          <code class="ruby">      chat_room_load = (end_chat_room_load - start_chat_room_load) * 1000</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1046">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1047">
          
          
          <code class="ruby">      # filter chat_room</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1048">
          
          
          <code class="ruby">      filtered_chat_rooms = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1049">
          
          
          <code class="ruby">      qiscus_room_ids.each do |id|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1050">
          
          
          <code class="ruby">        chat_rooms.each do |hash|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1051">
          
          
          <code class="ruby">          filtered_chat_rooms &lt;&lt; hash if hash[&quot;qiscus_room_id&quot;] == id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1052">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1053">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1054">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1055">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1056">
          
          
          <code class="ruby">        meta: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1057">
          
          
          <code class="ruby">          debug: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1058">
          
          
          <code class="ruby">            pluck_room_id: &quot;#{pluck_room_id_time} ms&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1059">
          
          
          <code class="ruby">            sdk_call: &quot;#{sdk_call_time} ms&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1060">
          
          
          <code class="ruby">            chat_room_load: &quot;#{chat_room_load} ms&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1061">
          
          
          <code class="ruby">            total_time: &quot;#{pluck_room_id_time + sdk_call_time + chat_room_load} ms&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1062">
          
          
          <code class="ruby">          }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1063">
          
          
          <code class="ruby">        },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1064">
          
          
          <code class="ruby">        data: filtered_chat_rooms</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1065">
          
          
          <code class="ruby">      } and return</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1066">
          
          
          <code class="ruby">    rescue Exception =&gt; e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1067">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1068">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1069">
          
          
          <code class="ruby">          message: e.message,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1070">
          
          
          <code class="ruby">          backtrace: e.backtrace</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1071">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1072">
          
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1073">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1074">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1075">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1076">
          
          
          <code class="ruby">  # =begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1077">
          
          
          <code class="ruby">  # @apiVersion 1.0.0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1078">
          
          
          <code class="ruby">  # @api {post} /api/v1/chat/conversations/join_room_with_unique_id Join room with unique id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1079">
          
          
          <code class="ruby">  # @apiDescription Join room with unique id.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1080">
          
          
          <code class="ruby">  # @apiName JoinRoomWithUniqueId</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1081">
          
          
          <code class="ruby">  # @apiGroup Chat</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1082">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1083">
          
          
          <code class="ruby">  # @apiParam {String} access_token User access token.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1084">
          
          
          <code class="ruby">  # @apiParam {Number} creator_user_id It&#39;s official user_id.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1085">
          
          
          <code class="ruby">  # @apiParam {String} unique_id Unique_id is combination of app_id, creator (official) qiscus_email, app_id using # as separator. For example unique_id = &quot;kiwari-prod#userid_001_62812345678987@kiwari-prod.com#kiwari-prod&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1086">
          
          
          <code class="ruby">  # =end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="1087">
          <span class="hits">1</span>
          
          <code class="ruby">  def join_room_with_unique_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1088">
          
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1089">
          
          
          <code class="ruby">      chat_room = nil</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1090">
          
          
          <code class="ruby">      ActiveRecord::Base.transaction do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1091">
          
          
          <code class="ruby">        application = @current_user.application</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1092">
          
          
          <code class="ruby">        qiscus_token = @current_user.qiscus_token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1093">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1094">
          
          
          <code class="ruby">        creator_user_id = params[:creator_user_id]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1095">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1096">
          
          
          <code class="ruby">        if !creator_user_id.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1097">
          
          
          <code class="ruby">          raise Exception.new(&quot;Creator user id must be present.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1098">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1099">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1100">
          
          
          <code class="ruby">        unique_id = params[:unique_id]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1101">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1102">
          
          
          <code class="ruby">        if !unique_id.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1103">
          
          
          <code class="ruby">          raise Exception.new(&quot;Unique id must be present.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1104">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1105">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1106">
          
          
          <code class="ruby">        creator = User.find(creator_user_id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1107">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1108">
          
          
          <code class="ruby">        # Ensure that unique_id format is valid</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1109">
          
          
          <code class="ruby">        # Unique id is combination of app_id, creator (official) qiscus_email, app_id using # as separator. For example unique_id = &quot;kiwari-prod#userid_001_62812345678987@kiwari-prod.com#kiwari-prod</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1110">
          
          
          <code class="ruby">        split_unique_id = unique_id.split(&quot;#&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1111">
          
          
          <code class="ruby">        if split_unique_id[0] != application.app_id || split_unique_id[1] != creator.qiscus_email || split_unique_id[2] != application.app_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1112">
          
          
          <code class="ruby">          raise Exception.new(&quot;Invalid unique id format.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1113">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1114">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1115">
          
          
          <code class="ruby">        # Ensure that public chat room is exist</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1116">
          
          
          <code class="ruby">        chat_room = ChatRoom.find_by(user_id: creator.id, is_public_chat: true, application_id: application.id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1117">
          
          
          <code class="ruby">        if chat_room.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1118">
          
          
          <code class="ruby">          raise Exception.new(&quot;Chat room is not exist.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1119">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1120">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1121">
          
          
          <code class="ruby">        chat_name = creator.fullname</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1122">
          
          
          <code class="ruby">        chat_avatar_url = creator.avatar_url</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1123">
          
          
          <code class="ruby">        qiscus_room_id = chat_room.qiscus_room_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1124">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1125">
          
          
          <code class="ruby">        # Backend need to get chat room with unique id in SDK</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1126">
          
          
          <code class="ruby">        qiscus_sdk = QiscusSdk.new(application.app_id, application.qiscus_sdk_secret)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1127">
          
          
          <code class="ruby">        room = qiscus_sdk.get_or_create_room_with_unique_id(qiscus_token, unique_id, chat_name, chat_avatar_url)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1128">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1129">
          
          
          <code class="ruby">        if !chat_room.qiscus_room_id == room.id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1130">
          
          
          <code class="ruby">          raise Exception.new(&quot;Chat room is not exist.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1131">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1132">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1133">
          
          
          <code class="ruby">        # Ensure that chat_user is not exist</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1134">
          
          
          <code class="ruby">        chat_user = ChatUser.find_by(chat_room_id: chat_room.id, user_id: @current_user.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1135">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1136">
          
          
          <code class="ruby">        if chat_user.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1137">
          
          
          <code class="ruby">          chat_user = ChatUser.new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1138">
          
          
          <code class="ruby">          chat_user.chat_room_id = chat_room.id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1139">
          
          
          <code class="ruby">          chat_user.user_id = @current_user.id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1140">
          
          
          <code class="ruby">          chat_user.is_group_admin = false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1141">
          
          
          <code class="ruby">          chat_user.save!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1142">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1143">
          
          
          <code class="ruby">          # Backend need to post system event message after participant joined chat room</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1144">
          
          
          <code class="ruby">          # Post system event message with system_event_type = join_room</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1145">
          
          
          <code class="ruby">          system_event_type = &quot;join_room&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1146">
          
          
          <code class="ruby">          qiscus_sdk = QiscusSdk.new(application.app_id, application.qiscus_sdk_secret)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1147">
          
          
          <code class="ruby">          qiscus_sdk.post_system_event_message(system_event_type, qiscus_room_id, @current_user.qiscus_email, [], chat_name)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1148">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1149">
          
          
          <code class="ruby">          # Contact sync smarter after participant joined chat room. It&#39;s only temporary to increase the number of contact</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1150">
          
          
          <code class="ruby">          # group_participant_ids = chat_room.users.pluck(:id).to_a</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1151">
          
          
          <code class="ruby">          ContactSyncSmarterWorker.perform_later(@current_user.id, group_participant_ids, @current_user.application.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1152">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1153">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1154">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1155">
          
          
          <code class="ruby">      chat_room = chat_room.as_json({:me =&gt; @current_user})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1156">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1157">
          
          
          <code class="ruby">      # add group_admins payload in chat_room json</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1158">
          
          
          <code class="ruby">      chat_room.merge!(&#39;group_admins&#39; =&gt; [@current_user.id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1159">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1160">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1161">
          
          
          <code class="ruby">        data: chat_room</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1162">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1163">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1164">
          
          
          <code class="ruby">    rescue ActiveRecord::RecordInvalid =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1165">
          
          
          <code class="ruby">      msg = &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1166">
          
          
          <code class="ruby">      e.record.errors.map do |k, v|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1167">
          
          
          <code class="ruby">        key = k.to_s.humanize</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1168">
          
          
          <code class="ruby">        msg = msg + &quot;#{key} #{v}, &quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1169">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1170">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1171">
          
          
          <code class="ruby">      msg = msg.chomp(&quot;, &quot;) + &quot;.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1172">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1173">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1174">
          
          
          <code class="ruby">          message: msg</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1175">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1176">
          
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1177">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1178">
          
          
          <code class="ruby">    rescue Exception =&gt; e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1179">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1180">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1181">
          
          
          <code class="ruby">          message: e.message</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1182">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1183">
          
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1184">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1185">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1186">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1187">
          
          
          <code class="ruby">  # =begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1188">
          
          
          <code class="ruby">  # @apiVersion 1.0.0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1189">
          
          
          <code class="ruby">  # @api {get} /api/v1/chat/conversations/rooms Get Conversation List</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1190">
          
          
          <code class="ruby">  # @apiName ChatList</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1191">
          
          
          <code class="ruby">  # @apiGroup Chat</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1192">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1193">
          
          
          <code class="ruby">  # @apiParam {String} access_token User access token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1194">
          
          
          <code class="ruby">  # @apiParam {Number} [page=1] Pagination. Per page is 10 conversation.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1195">
          
          
          <code class="ruby">  # =end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="1196">
          <span class="hits">1</span>
          
          <code class="ruby">  def rooms</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1197">
          
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1198">
          
          
          <code class="ruby">      page = params[:page]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1199">
          
          
          <code class="ruby">      if !page.present? || page.to_i &lt;= 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1200">
          
          
          <code class="ruby">        page = 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1201">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1202">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1203">
          
          
          <code class="ruby">      per_page = 10</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1204">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1205">
          
          
          <code class="ruby">      # If params page not present then show all conversations</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1206">
          
          
          <code class="ruby">      if !params[:page].present? || params[:page].to_i &lt;= 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1207">
          
          
          <code class="ruby">        per_page = 100</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1208">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1209">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1210">
          
          
          <code class="ruby">      chat_room_sdk_info = []</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1211">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1212">
          
          
          <code class="ruby">      # if current_user have chat room in qisme database then call sdk</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1213">
          
          
          <code class="ruby">      start_time_sdk = Time.now</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1214">
          
          
          <code class="ruby">      if @current_user.chat_rooms.count &gt; 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1215">
          
          
          <code class="ruby">        qiscus_sdk = QiscusSdk.new(@current_user.application.app_id, @current_user.application.qiscus_sdk_secret)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1216">
          
          
          <code class="ruby">        sdk_status, chat_room_sdk_info = qiscus_sdk.get_user_rooms(@current_user.qiscus_email, page, per_page)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1217">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1218">
          
          
          <code class="ruby">      end_time_sdk = Time.now</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1219">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1220">
          
          
          <code class="ruby">      start_chat_room_load = Time.now</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1221">
          
          
          <code class="ruby">      chat_rooms_total, chat_rooms = ChatRoomHelper.load_for(@current_user, chat_room_sdk_info, page, per_page)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1222">
          
          
          <code class="ruby">      end_chat_room_load = Time.now</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1223">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1224">
          
          
          <code class="ruby">      sdk_call_time = (end_time_sdk - start_time_sdk) * 1000</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1225">
          
          
          <code class="ruby">      chat_room_load = (end_chat_room_load - start_chat_room_load) * 1000</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1226">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1227">
          
          
          <code class="ruby">      # roundup total_page</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1228">
          
          
          <code class="ruby">      total_page = (chat_rooms_total/per_page.to_f).ceil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1229">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1230">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1231">
          
          
          <code class="ruby">        meta: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1232">
          
          
          <code class="ruby">          total: chat_rooms_total,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1233">
          
          
          <code class="ruby">          per_page: per_page,</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1234">
          
          
          <code class="ruby">          total_page: ((chat_rooms_total / per_page) &lt;= 0) ? 1 : (total_page),</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1235">
          
          
          <code class="ruby">          current_page: (params[:page].to_i &lt;= 0) ? 1 : params[:page].to_i,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1236">
          
          
          <code class="ruby">          debug: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1237">
          
          
          <code class="ruby">            sdk_call: &quot;#{sdk_call_time} ms&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1238">
          
          
          <code class="ruby">            chat_room_load: &quot;#{chat_room_load} ms&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1239">
          
          
          <code class="ruby">            total_time: &quot;#{sdk_call_time + chat_room_load} ms&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1240">
          
          
          <code class="ruby">          }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1241">
          
          
          <code class="ruby">        },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1242">
          
          
          <code class="ruby">        data: chat_rooms</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1243">
          
          
          <code class="ruby">      } and return</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1244">
          
          
          <code class="ruby">    rescue Exception =&gt; e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1245">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1246">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1247">
          
          
          <code class="ruby">          message: e.message,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1248">
          
          
          <code class="ruby">          backtrace: e.backtrace</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1249">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1250">
          
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1251">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1252">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1253">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1254">
          
          
          <code class="ruby">  # =begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1255">
          
          
          <code class="ruby">  # @apiVersion 1.0.0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1256">
          
          
          <code class="ruby">  # @api {post} /api/v1/chat/conversations/post_system_event_message Post system event message</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1257">
          
          
          <code class="ruby">  # @apiDescription Post system event message type &quot;custom&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1258">
          
          
          <code class="ruby">  # @apiName PostSystemEventMessage</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1259">
          
          
          <code class="ruby">  # @apiGroup System Event Message</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1260">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1261">
          
          
          <code class="ruby">  # @apiParam {String} access_token User access token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1262">
          
          
          <code class="ruby">  # @apiParam {String} target_email It&#39;s using qiscus_email</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1263">
          
          
          <code class="ruby">  # @apiParam {String} message Message will be sent</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1264">
          
          
          <code class="ruby">  # @apiParam {String} payload Payload must be json object string</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1265">
          
          
          <code class="ruby">  # @apiParam {String} extras Extras must be json object string</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1266">
          
          
          <code class="ruby">  # =end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="1267">
          <span class="hits">1</span>
          
          <code class="ruby">  def post_system_event_message</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1268">
          
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1269">
          
          
          <code class="ruby">      target_email = params[:target_email]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1270">
          
          
          <code class="ruby">      if target_email.nil? || target_email == &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1271">
          
          
          <code class="ruby">        raise Exception.new(&quot;target_email cannot be empty.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1272">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1273">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1274">
          
          
          <code class="ruby">      current_user = @current_user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1275">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1276">
          
          
          <code class="ruby">      target_user = User.find_by(qiscus_email: target_email, application_id: current_user.application.id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1277">
          
          
          <code class="ruby">      if target_user.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1278">
          
          
          <code class="ruby">        raise Exception.new(&quot;User is not found.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1279">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1280">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1281">
          
          
          <code class="ruby">      message = params[:message]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1282">
          
          
          <code class="ruby">      if message.nil? || message == &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1283">
          
          
          <code class="ruby">        raise Exception.new(&quot;message cannot be empty.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1284">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1285">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1286">
          
          
          <code class="ruby">      payload = params[:payload]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1287">
          
          
          <code class="ruby">      if payload.nil? || payload == &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1288">
          
          
          <code class="ruby">        raise Exception.new(&quot;payload cannot be empty.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1289">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1290">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1291">
          
          
          <code class="ruby">      extras = params[:extras]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1292">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1293">
          
          
          <code class="ruby">      # Looking for a single chat between current_user and target_user</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1294">
          
          
          <code class="ruby">      chat_room = ChatRoom.where(is_group_chat: false, user_id: [current_user.id, target_user.id], target_user_id: [current_user.id, target_user.id]).first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1295">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1296">
          
          
          <code class="ruby">      qiscus_sdk = QiscusSdk.new(current_user.application.app_id, current_user.application.qiscus_sdk_secret)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1297">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1298">
          
          
          <code class="ruby">      if chat_room.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1299">
          
          
          <code class="ruby">        # If single chat is nil then create single chat between current user and target user</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1300">
          
          
          <code class="ruby">        emails = [current_user.qiscus_email, target_user.qiscus_email]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1301">
          
          
          <code class="ruby">        room = qiscus_sdk.get_or_create_room_with_target_rest(emails) # call sdk to create single room</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1302">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1303">
          
          
          <code class="ruby">        # Then get room_id from sdk</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1304">
          
          
          <code class="ruby">        qiscus_room_id = room.id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1305">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1306">
          
          
          <code class="ruby">        # Insert data into qisme database</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1307">
          
          
          <code class="ruby">        chat_room = ChatRoom.find_by(qiscus_room_id: qiscus_room_id, application_id: current_user.application.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1308">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1309">
          
          
          <code class="ruby">        # if chat room with room id and room topic id not exist then create it</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1310">
          
          
          <code class="ruby">        if chat_room.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1311">
          
          
          <code class="ruby">          chat_name = &quot;Group Chat Name&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1312">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1313">
          
          
          <code class="ruby">          chat_room = ChatRoom.new(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1314">
          
          
          <code class="ruby">            group_chat_name: chat_name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1315">
          
          
          <code class="ruby">            qiscus_room_name: chat_name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1316">
          
          
          <code class="ruby">            qiscus_room_id: qiscus_room_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1317">
          
          
          <code class="ruby">            is_group_chat: false,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1318">
          
          
          <code class="ruby">            user_id: current_user.id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1319">
          
          
          <code class="ruby">            target_user_id: target_user.id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1320">
          
          
          <code class="ruby">            application_id: current_user.application.id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1321">
          
          
          <code class="ruby">          )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1322">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1323">
          
          
          <code class="ruby">          chat_room.save!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1324">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1325">
          
          
          <code class="ruby">          ChatUser.create(chat_room_id: chat_room.id, user_id: current_user.id) unless ChatUser.exists?(chat_room_id: chat_room.id, user_id: current_user.id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1326">
          
          
          <code class="ruby">          ChatUser.create(chat_room_id: chat_room.id, user_id: target_user.id) unless ChatUser.exists?(chat_room_id: chat_room.id, user_id: target_user.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1327">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1328">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1329">
          
          
          <code class="ruby">          # if exist then return error with warning that qiscus room id has been inserted before</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1330">
          
          
          <code class="ruby">          # raise Exception.new(&quot;Qiscus room id has been inserted before, it must be unique.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1331">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1332">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1333">
          
          
          <code class="ruby">        # If single chat already exist then get qiscus_room_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1334">
          
          
          <code class="ruby">        qiscus_room_id = chat_room.qiscus_room_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1335">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1336">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1337">
          
          
          <code class="ruby">      type = &quot;custom&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1338">
          
          
          <code class="ruby">      room_id = chat_room.qiscus_room_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1339">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1340">
          
          
          <code class="ruby">      # post system event message for incoming call_event</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1341">
          
          
          <code class="ruby">			system_event_message = qiscus_sdk.post_system_event_message(type, room_id, &quot;&quot;, [], &quot;&quot;, payload, message, extras)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1342">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1343">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1344">
          
          
          <code class="ruby">        data: system_event_message</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1345">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1346">
          
          
          <code class="ruby">    rescue ActiveRecord::RecordInvalid =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1347">
          
          
          <code class="ruby">      msg = &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1348">
          
          
          <code class="ruby">      e.record.errors.map do |k, v|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1349">
          
          
          <code class="ruby">        key = k.to_s.humanize</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1350">
          
          
          <code class="ruby">        msg = msg + &quot;#{key} #{v}, &quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1351">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1352">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1353">
          
          
          <code class="ruby">      msg = msg.chomp(&quot;, &quot;) + &quot;.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1354">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1355">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1356">
          
          
          <code class="ruby">          message: msg</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1357">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1358">
          
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1359">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1360">
          
          
          <code class="ruby">    rescue Exception =&gt; e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1361">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1362">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1363">
          
          
          <code class="ruby">          message: e.message</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1364">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1365">
          
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1366">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1367">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1368">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="1369">
          <span class="hits">1</span>
          
          <code class="ruby">  def ensure_raw_file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1370">
          
          
          <code class="ruby">    @group_avatar = params[:group_avatar]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1371">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1372">
          
          
          <code class="ruby">    render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1373">
          
          
          <code class="ruby">      status: &#39;fail&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1374">
          
          
          <code class="ruby">      message: &#39;invalid avatar file&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="1375">
          
          
          <code class="ruby">    }, status: 422 unless @group_avatar</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1376">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1377">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="1378">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="96f5259d31c55702e5198b8e2d09288a26d5bde8">
  <div class="header">
    <h3>app/controllers/api/v1/contacts/favorites_controller.rb</h3>
    <h4><span class="red">62.34 %</span> covered</h4>
    <div>
      <b>77</b> relevant lines. 
      <span class="green"><b>48</b> lines covered</span> and
      <span class="red"><b>29</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class Api::V1::Contacts::FavoritesController &lt; ProtectedController</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  before_action :authorize_user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">  # =begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">  # @apiVersion 1.0.0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">  # @api {get} /api/v1/contacts/favorites List of favourite contacts</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">  # @apiDescription show all favorited contact</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">  # @apiName ListFav</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">  # @apiGroup Contact</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">  # @apiParam {String} access_token User access token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">  # =end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  def index</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">      contacts = nil</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">      ActiveRecord::Base.transaction do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">        contact_id = @current_user.contacts.where(is_favored: true).pluck(:contact_id)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">        contacts = User.where(&quot;id IN (?)&quot;, contact_id).order(fullname: :asc)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">        contacts = contacts.as_json({:show_profile =&gt; true})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">        favored_status = @current_user.contacts.pluck(:contact_id, :is_favored)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">        contacts = contacts.map do |e|</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">          e.merge!(&#39;is_favored&#39; =&gt; favored_status.to_h[ e[&quot;id&quot;] ], &#39;is_contact&#39; =&gt; true )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">        data: contacts</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">    rescue Exception =&gt; e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">          message: e.message</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">  # =begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">  # @apiVersion 1.0.0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">  # @api {get} /api/v1/contacts/favorites/:id Show Single Favourite Contact</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">  # @apiDescription where id is contact user id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">  # @apiName ShowFav</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">  # @apiGroup Contact</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">  # @apiParam {String} access_token User access token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">  # @apiParam {Number} id Contact id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">  # =end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="51">
          <span class="hits">1</span>
          
          <code class="ruby">  def show</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">      contact_to_show = nil</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">      ActiveRecord::Base.transaction do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">        contact_to_show = User.find(params[:id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="57">
          
          
          <code class="ruby">        if contact_to_show.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">          raise Exception.new(&quot;User is not found.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">          contact = Contact.find_by(user_id: @current_user.id, contact_id: contact_to_show.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">          if contact.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="63">
          
          
          <code class="ruby">            raise Exception.new(&quot;This user is not in your contact. Please add before mark it as favourites.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="66">
          
          
          <code class="ruby">          favored_status = @current_user.contacts.pluck(:contact_id, :is_favored)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="67">
          
          
          <code class="ruby">          is_favored = favored_status.to_h[ contact_to_show.id ]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="68">
          
          
          <code class="ruby">          contact_to_show = contact_to_show.as_json({:show_profile =&gt; true}).merge!(&#39;is_favored&#39; =&gt;  is_favored, &#39;is_contact&#39; =&gt; true)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="72">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">        data: contact_to_show</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="75">
          
          
          <code class="ruby">    rescue Exception =&gt; e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">          message: e.message</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="80">
          
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">  # =begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">  # @apiVersion 1.0.0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">  # @api {post} /api/v1/contacts/favorites Add Contact as Favourite</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">  # @apiDescription Mark contact as favourite</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">  # @apiName AddFav</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">  # @apiGroup Contact</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">  # @apiParam {String} access_token User access token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">  # @apiParam {Number} user_id Contact id to be added as favourite</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">  # =end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="94">
          <span class="hits">1</span>
          
          <code class="ruby">  def create</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="95">
          <span class="hits">4</span>
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="96">
          <span class="hits">4</span>
          
          <code class="ruby">      contact_candidate = nil</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="97">
          <span class="hits">4</span>
          
          <code class="ruby">      ActiveRecord::Base.transaction do</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="98">
          <span class="hits">4</span>
          
          <code class="ruby">        contact_candidate = User.find_by(id: params[:user_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="100">
          <span class="hits">4</span>
          
          <code class="ruby">        if contact_candidate.nil?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="101">
          <span class="hits">1</span>
          
          <code class="ruby">          raise Exception.new(&quot;User is not found.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="103">
          <span class="hits">3</span>
          
          <code class="ruby">          contact = Contact.find_by(user_id: @current_user.id, contact_id: contact_candidate.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="105">
          <span class="hits">3</span>
          
          <code class="ruby">          if contact.nil?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="106">
          <span class="hits">1</span>
          
          <code class="ruby">            raise Exception.new(&quot;This user is not in your contact. Please add before mark it as favourites.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="108">
          <span class="hits">2</span>
          
          <code class="ruby">            contact.update_attribute(:is_favored, true)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="111">
          <span class="hits">2</span>
          
          <code class="ruby">          favored_status = @current_user.contacts.pluck(:contact_id, :is_favored)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="112">
          <span class="hits">2</span>
          
          <code class="ruby">          is_favored = favored_status.to_h[ contact_candidate.id ]</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="113">
          <span class="hits">2</span>
          
          <code class="ruby">          contact_candidate = contact_candidate.as_json({:show_profile =&gt; true}).merge!(&#39;is_favored&#39; =&gt;  is_favored, &#39;is_contact&#39; =&gt; true)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="117">
          <span class="hits">2</span>
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">        data: contact_candidate</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="121">
          <span class="hits">2</span>
          
          <code class="ruby">    rescue ActiveRecord::RecordInvalid =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="122">
          
          
          <code class="ruby">      msg = &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="123">
          
          
          <code class="ruby">      e.record.errors.map do |k, v|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="124">
          
          
          <code class="ruby">        key = k.to_s.humanize</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="125">
          
          
          <code class="ruby">        msg = msg + &quot;#{key} #{v}, &quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="128">
          
          
          <code class="ruby">      msg = msg.chomp(&quot;, &quot;) + &quot;.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="130">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby">          message: msg</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="133">
          
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby">    rescue Exception =&gt; e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby">          message: e.message</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="140">
          <span class="hits">2</span>
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="142">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby">  # =begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby">  # @apiVersion 1.0.0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby">  # @api {delete} /api/v1/contacts/favorites/:id Remove Contact from Favourite</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby">  # @apiDescription where id is contact user id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby">  # @apiName DeleteFav</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby">  # @apiGroup Contact</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="150">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby">  # @apiParam {String} access_token User access token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby">  # @apiParam {Number} id Contact id to be deleted from favourites</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby">  # =end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="154">
          <span class="hits">1</span>
          
          <code class="ruby">  def destroy</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="155">
          <span class="hits">3</span>
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="156">
          <span class="hits">3</span>
          
          <code class="ruby">      unfavorited_candidate = nil</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="157">
          <span class="hits">3</span>
          
          <code class="ruby">      ActiveRecord::Base.transaction do</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="158">
          <span class="hits">3</span>
          
          <code class="ruby">        unfavorited_candidate = User.find_by(id: params[:id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="160">
          <span class="hits">3</span>
          
          <code class="ruby">        if unfavorited_candidate.nil?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="161">
          <span class="hits">1</span>
          
          <code class="ruby">          raise Exception.new(&quot;User is not found.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="163">
          <span class="hits">2</span>
          
          <code class="ruby">          contact = Contact.find_by(user_id: @current_user.id, contact_id: unfavorited_candidate.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="164">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="165">
          <span class="hits">2</span>
          
          <code class="ruby">          if contact.nil?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="166">
          <span class="hits">1</span>
          
          <code class="ruby">            raise Exception.new(&quot;This user is not in your contact. Please add before mark it as favourites.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="167">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="168">
          <span class="hits">1</span>
          
          <code class="ruby">            contact.update_attribute(:is_favored, false)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="169">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="170">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="171">
          <span class="hits">1</span>
          
          <code class="ruby">          favored_status = @current_user.contacts.pluck(:contact_id, :is_favored)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="172">
          <span class="hits">1</span>
          
          <code class="ruby">          is_favored = favored_status.to_h[ unfavorited_candidate.id ]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="173">
          <span class="hits">1</span>
          
          <code class="ruby">          unfavorited_candidate = unfavorited_candidate.as_json({:show_profile =&gt; true}).merge!(&#39;is_favored&#39; =&gt;  is_favored, &#39;is_contact&#39; =&gt; true)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="174">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="175">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="176">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="177">
          <span class="hits">1</span>
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="178">
          
          
          <code class="ruby">        data: unfavorited_candidate</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="179">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="180">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="181">
          <span class="hits">2</span>
          
          <code class="ruby">    rescue ActiveRecord::RecordInvalid =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="182">
          
          
          <code class="ruby">      msg = &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="183">
          
          
          <code class="ruby">      e.record.errors.map do |k, v|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="184">
          
          
          <code class="ruby">        key = k.to_s.humanize</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="185">
          
          
          <code class="ruby">        msg = msg + &quot;#{key} #{v}, &quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="186">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="187">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="188">
          
          
          <code class="ruby">      msg = msg.chomp(&quot;, &quot;) + &quot;.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="189">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="190">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="191">
          
          
          <code class="ruby">          message: msg</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="192">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="193">
          
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="194">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="195">
          
          
          <code class="ruby">    rescue Exception =&gt; e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="196">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="197">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="198">
          
          
          <code class="ruby">          message: e.message</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="199">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="200">
          <span class="hits">2</span>
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="201">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="202">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="203">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="555317954452fc37bcceae8e831938e6c9b062f0">
  <div class="header">
    <h3>app/controllers/api/v1/contacts_controller.rb</h3>
    <h4><span class="red">50.0 %</span> covered</h4>
    <div>
      <b>404</b> relevant lines. 
      <span class="green"><b>202</b> lines covered</span> and
      <span class="red"><b>202</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class Api::V1::ContactsController &lt; ProtectedController</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  before_action :authorize_user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">  # =begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">  # @apiVersion 1.0.0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">  # @api {get} /api/v1/contacts Contact List</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">  # @apiName ContactList</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">  # @apiGroup Contact</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">  # @apiParam {String} access_token User access token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">  # @apiParam {String} show Possible value is: `all` to show all user within this application, `contact` to show only their contact, `official` to only show official account.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">  # `not_contact` to show all users thats not in contact.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">  # If you don&#39;t send any parameter, it will be use previous logic, where `only` and `exclude` parameter stills work, otherwise that two parameter will not work.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">  # @apiParam {Number} page Page number</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">  # @apiParam {Number} limit Limit</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">  # @apiParam {String} only Possible value is: `official`. If you use this parameter (`only=official`) you will only see official account member.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">  # @apiParam {String} exclude Possible value is: `official`. If you use this parameter (`exclude=official`) you will see all contact except official account.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">  # =end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">  def index</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">      total_page = 0</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">      total = 0</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">      contacts = nil</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">      limit = params[:limit]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">      page = params[:page]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">      ActiveRecord::Base.transaction do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">        # add all official user before loading contacts</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">        role_official_user = Role.official</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">        if role_official_user.nil? == false</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">          user_role_ids = UserRole.where(role_id: role_official_user.id).pluck(:user_id).to_a</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">          official_account = User.where(&quot;id IN (?)&quot;, user_role_ids).where(application_id: @current_user.application_id)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">          official_account = official_account.where.not(id: @current_user.id)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="33">
          <span class="hits">1</span>
          
          <code class="ruby">          official_account = official_account.pluck(:id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="35">
          <span class="hits">1</span>
          
          <code class="ruby">          official_account = official_account - @current_user.contacts.pluck(:contact_id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="37">
          <span class="hits">1</span>
          
          <code class="ruby">          official_account_to_be_added = Array.new</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="38">
          <span class="hits">1</span>
          
          <code class="ruby">          official_account.each do |id|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">            official_account_to_be_added.push({:user_id =&gt; @current_user.id, :contact_id =&gt; id})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">          # add official contact</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="43">
          <span class="hits">1</span>
          
          <code class="ruby">          Contact.create(official_account_to_be_added)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="46">
          <span class="hits">1</span>
          
          <code class="ruby">        show = params[:show]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="47">
          <span class="hits">1</span>
          
          <code class="ruby">        if show == &#39;all&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">          contacts = User.includes([:roles, :application]).where(&quot;users.application_id = ?&quot;, @current_user.application_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">          contacts = contacts.where.not(fullname: nil).where.not(fullname: &quot;&quot;) # only show contact who has complete their profile (fullname not nil)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">          contacts = contacts.order(fullname: :asc)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">          total = contacts.count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">          # pagination only when exist</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">          if page.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="56">
          
          
          <code class="ruby">            contacts = contacts.page(page)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">          # if limit and page present, then use kaminari pagination</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">          if limit.present? &amp;&amp; page.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">            contacts = contacts.per(limit)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">          # else use limit from ActiveRecord</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="63">
          
          
          <code class="ruby">          elsif limit.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="64">
          
          
          <code class="ruby">            contacts = contacts.limit(limit)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="66">
          
          
          <code class="ruby">            limit = 25</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="67">
          
          
          <code class="ruby">            contacts = contacts.limit(25)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="70">
          
          
          <code class="ruby">          total_page = (total / limit.to_f).ceil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="72">
          <span class="hits">1</span>
          
          <code class="ruby">        elsif show == &#39;contact&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">          # show contact except official account and bot</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="74">
          
          
          <code class="ruby">          sql = &lt;&lt;-SQL</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">          contacts.contact_id NOT IN (</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">            SELECT user_id </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">            FROM user_roles </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">            WHERE role_id = ? OR role_id = ?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">          )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">          SQL</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="81">
          
          
          <code class="ruby">          contact_id = @current_user.contacts</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">            .where(sql, Role.official.id, Role.bot.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">            .pluck(:contact_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="84">
          
          
          <code class="ruby">          contacts = User.includes([:roles, :application]).where(&quot;users.application_id = ?&quot;, @current_user.application_id).where(&quot;users.id IN (?)&quot;, contact_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="85">
          
          
          <code class="ruby">          contacts = contacts.where.not(fullname: nil).where.not(fullname: &quot;&quot;) # only show contact who has complete their profile (fullname not nil)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="86">
          
          
          <code class="ruby">          contacts = contacts.order(fullname: :asc)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="88">
          
          
          <code class="ruby">          total = contacts.count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">          # pagination only when exist</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="91">
          
          
          <code class="ruby">          if page.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="92">
          
          
          <code class="ruby">            contacts = contacts.page(page)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">          # if limit and page present, then use kaminari pagination</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="96">
          
          
          <code class="ruby">          if limit.present? &amp;&amp; page.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="97">
          
          
          <code class="ruby">            contacts = contacts.per(limit)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">          # else use limit from ActiveRecord</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="99">
          
          
          <code class="ruby">          elsif limit.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="100">
          
          
          <code class="ruby">            contacts = contacts.limit(limit)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="102">
          
          
          <code class="ruby">            limit = 25</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="103">
          
          
          <code class="ruby">            contacts = contacts.limit(25)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="106">
          
          
          <code class="ruby">          total_page = (total / limit.to_f).ceil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="108">
          <span class="hits">1</span>
          
          <code class="ruby">        elsif show == &#39;official&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby">          # show contact except official account</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="110">
          
          
          <code class="ruby">          contact_id = @current_user.contacts.where(&quot;contacts.contact_id IN (select user_id from user_roles where role_id = ?)&quot;, Role.official.id).pluck(:contact_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="111">
          
          
          <code class="ruby">          contacts = User.includes([:roles, :application]).where(&quot;users.application_id = ?&quot;, @current_user.application_id).where(&quot;users.id IN (?)&quot;, contact_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="112">
          
          
          <code class="ruby">          contacts = contacts.where.not(fullname: nil).where.not(fullname: &quot;&quot;) # only show contact who has complete their profile (fullname not nil)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="113">
          
          
          <code class="ruby">          contacts = contacts.order(fullname: :asc)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="115">
          
          
          <code class="ruby">          total = contacts.count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">          # pagination only when exist</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="118">
          
          
          <code class="ruby">          if page.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="119">
          
          
          <code class="ruby">            contacts = contacts.page(page)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby">          # if limit and page present, then use kaminari pagination</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="123">
          
          
          <code class="ruby">          if limit.present? &amp;&amp; page.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="124">
          
          
          <code class="ruby">            contacts = contacts.per(limit)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby">          # else use limit from ActiveRecord</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="126">
          
          
          <code class="ruby">          elsif limit.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="127">
          
          
          <code class="ruby">            contacts = contacts.limit(limit)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="129">
          
          
          <code class="ruby">            limit = 25</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="130">
          
          
          <code class="ruby">            contacts = contacts.limit(25)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="133">
          
          
          <code class="ruby">          total_page = (total / limit.to_f).ceil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="135">
          <span class="hits">1</span>
          
          <code class="ruby">        elsif show == &#39;not_contact&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby">          # show all users in the apps except official users and @current_user</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="137">
          
          
          <code class="ruby">          all_users_ids = User.where(application_id: @current_user.application_id).where.not(&quot;id IN (select user_id from user_roles where role_id = ?)&quot;, Role.official.id).where.not(id: @current_user.id).pluck(:id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby">          # show user contact</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="139">
          
          
          <code class="ruby">          contact_ids = @current_user.contacts.where(&quot;contacts.contact_id NOT IN (select user_id from user_roles where role_id = ?)&quot;, Role.official.id).pluck(:contact_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="140">
          
          
          <code class="ruby">          contact_ids = all_users_ids - contact_ids</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="142">
          
          
          <code class="ruby">          contacts = User.where(id: contact_ids, application_id: @current_user.application_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="143">
          
          
          <code class="ruby">          contacts = contacts.where.not(fullname: nil).where.not(fullname: &quot;&quot;) # only show contact who has complete their profile (fullname not nil)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="144">
          
          
          <code class="ruby">          contacts = contacts.order(fullname: :asc)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="146">
          
          
          <code class="ruby">          total = contacts.count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby">          # pagination only when exist</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="149">
          
          
          <code class="ruby">          if page.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="150">
          
          
          <code class="ruby">            contacts = contacts.page(page)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby">          # if limit and page present, then use kaminari pagination</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="154">
          
          
          <code class="ruby">          if limit.present? &amp;&amp; page.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="155">
          
          
          <code class="ruby">            contacts = contacts.per(limit)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="156">
          
          
          <code class="ruby">          # else use limit from ActiveRecord</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="157">
          
          
          <code class="ruby">          elsif limit.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="158">
          
          
          <code class="ruby">            contacts = contacts.limit(limit)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="160">
          
          
          <code class="ruby">            limit = 25</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="161">
          
          
          <code class="ruby">            contacts = contacts.limit(25)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="164">
          
          
          <code class="ruby">          total_page = (total / limit.to_f).ceil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="165">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="166">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="167">
          
          
          <code class="ruby">          # for backward compatible, limit = total</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="168">
          <span class="hits">1</span>
          
          <code class="ruby">          contact_id = @current_user.contacts.pluck(:contact_id)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="169">
          <span class="hits">1</span>
          
          <code class="ruby">          contacts = User.includes([:roles, :application]).where(&quot;users.id IN (?)&quot;, contact_id)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="170">
          <span class="hits">1</span>
          
          <code class="ruby">          contacts = contacts.where.not(fullname: nil).where.not(fullname: &quot;&quot;) # only show contact who has complete their profile (fullname not nil)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="171">
          <span class="hits">1</span>
          
          <code class="ruby">          contacts = contacts.order(fullname: :asc)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="172">
          <span class="hits">1</span>
          
          <code class="ruby">          total = contacts.count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="173">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="174">
          <span class="hits">1</span>
          
          <code class="ruby">          only = params[:only]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="175">
          <span class="hits">1</span>
          
          <code class="ruby">          if only.present? &amp;&amp; only != &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="176">
          
          
          <code class="ruby">            if only == &#39;official&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="177">
          
          
          <code class="ruby">              contact_id = @current_user.contacts.where(&quot;contact_id IN (select user_id from user_roles where role_id = ?)&quot;, Role.official.id).pluck(:contact_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="178">
          
          
          <code class="ruby">              contacts = User.includes([:roles, :application]).where(&quot;application_id = ?&quot;, @current_user.application_id).where(&quot;users.id IN (?)&quot;, contact_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="179">
          
          
          <code class="ruby">              contacts = contacts.where.not(fullname: nil).where.not(fullname: &quot;&quot;) # only show contact who has complete their profile (fullname not nil)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="180">
          
          
          <code class="ruby">              contacts = contacts.order(fullname: :asc)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="181">
          
          
          <code class="ruby">              total = contacts.count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="182">
          
          
          <code class="ruby">              if !page.present? &amp;&amp; !limit.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="183">
          
          
          <code class="ruby">                limit = total</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="184">
          
          
          <code class="ruby">              end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="185">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="186">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="187">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="188">
          <span class="hits">1</span>
          
          <code class="ruby">          exclude = params[:exclude]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="189">
          <span class="hits">1</span>
          
          <code class="ruby">          if exclude.present? &amp;&amp; exclude != &quot;&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="190">
          <span class="hits">1</span>
          
          <code class="ruby">            if exclude == &#39;official&#39;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="191">
          <span class="hits">1</span>
          
          <code class="ruby">              contact_id = @current_user.contacts.where.not(&quot;contact_id IN (select user_id from user_roles where role_id = ?)&quot;, Role.official.id).pluck(:contact_id)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="192">
          <span class="hits">1</span>
          
          <code class="ruby">              contacts = User.includes([:roles, :application]).where(&quot;application_id = ?&quot;, @current_user.application_id).where(&quot;users.id IN (?)&quot;, contact_id)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="193">
          <span class="hits">1</span>
          
          <code class="ruby">              contacts = contacts.where.not(fullname: nil).where.not(fullname: &quot;&quot;) # only show contact who has complete their profile (fullname not nil)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="194">
          <span class="hits">1</span>
          
          <code class="ruby">              contacts = contacts.order(fullname: :asc)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="195">
          <span class="hits">1</span>
          
          <code class="ruby">              total = contacts.count</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="196">
          <span class="hits">1</span>
          
          <code class="ruby">              if !page.present? &amp;&amp; !limit.present?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="197">
          <span class="hits">1</span>
          
          <code class="ruby">                limit = total</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="198">
          
          
          <code class="ruby">              end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="199">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="200">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="201">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="202">
          
          
          <code class="ruby">          # pagination only when exist</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="203">
          <span class="hits">1</span>
          
          <code class="ruby">          if page.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="204">
          
          
          <code class="ruby">            contacts = contacts.page(page)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="205">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="206">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="207">
          
          
          <code class="ruby">          # if limit and page present, then use kaminari pagination</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="208">
          <span class="hits">1</span>
          
          <code class="ruby">          if limit.present? &amp;&amp; page.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="209">
          
          
          <code class="ruby">            contacts = contacts.per(limit)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="210">
          
          
          <code class="ruby">          # else use limit from ActiveRecord</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="211">
          <span class="hits">1</span>
          
          <code class="ruby">          elsif limit.present?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="212">
          <span class="hits">1</span>
          
          <code class="ruby">            contacts = contacts.limit(limit)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="213">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="214">
          
          
          <code class="ruby">            limit = total</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="215">
          
          
          <code class="ruby">            contacts = contacts.limit(limit)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="216">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="217">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="218">
          <span class="hits">1</span>
          
          <code class="ruby">          if limit == 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="219">
          
          
          <code class="ruby">            total_page = 0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="220">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="221">
          <span class="hits">1</span>
          
          <code class="ruby">            total_page = (total / limit.to_f).ceil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="222">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="223">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="224">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="225">
          <span class="hits">1</span>
          
          <code class="ruby">        contacts = contacts.map(&amp;:as_contact_json)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="226">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="227">
          <span class="hits">1</span>
          
          <code class="ruby">        contact_id = @current_user.contacts.pluck(:contact_id)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="228">
          <span class="hits">1</span>
          
          <code class="ruby">        favored_status = @current_user.contacts.pluck(:contact_id, :is_favored)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="229">
          <span class="hits">1</span>
          
          <code class="ruby">        contacts = contacts.map do |e|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="230">
          
          
          <code class="ruby">          # is contact is always true since this will only load contact of this user</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="231">
          <span class="hits">1</span>
          
          <code class="ruby">          is_contact = contact_id.include?(e[&quot;id&quot;])</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="232">
          <span class="hits">1</span>
          
          <code class="ruby">          is_favored = favored_status.to_h[ e[&quot;id&quot;] ] == nil ? false : favored_status.to_h[ e[&quot;id&quot;] ]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="233">
          <span class="hits">1</span>
          
          <code class="ruby">          e.merge!(&#39;is_favored&#39; =&gt; is_favored, &#39;is_contact&#39; =&gt; is_contact )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="234">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="235">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="236">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="237">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="238">
          <span class="hits">1</span>
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="239">
          
          
          <code class="ruby">        meta: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="240">
          
          
          <code class="ruby">          limit: limit.to_i,</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="241">
          <span class="hits">1</span>
          
          <code class="ruby">          page: page == nil || page.to_i &lt; 0 ? 0 : page.to_i,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="242">
          
          
          <code class="ruby">          total_page: total_page,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="243">
          
          
          <code class="ruby">          total: total,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="244">
          
          
          <code class="ruby">        },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="245">
          
          
          <code class="ruby">        data: contacts</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="246">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="247">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="248">
          
          
          <code class="ruby">    rescue ActiveRecord::RecordInvalid =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="249">
          
          
          <code class="ruby">      msg = &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="250">
          
          
          <code class="ruby">      e.record.errors.map do |k, v|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="251">
          
          
          <code class="ruby">        key = k.to_s.humanize</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="252">
          
          
          <code class="ruby">        msg = msg + &quot;#{key} #{v}, &quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="253">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="254">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="255">
          
          
          <code class="ruby">      msg = msg.chomp(&quot;, &quot;) + &quot;.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="256">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="257">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="258">
          
          
          <code class="ruby">          message: msg</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="259">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="260">
          
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="261">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="262">
          
          
          <code class="ruby">    rescue Exception =&gt; e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="263">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="264">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="265">
          
          
          <code class="ruby">          message: e.message</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="266">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="267">
          
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="268">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="269">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="270">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="271">
          
          
          <code class="ruby">  # =begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="272">
          
          
          <code class="ruby">  # @apiVersion 1.0.0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="273">
          
          
          <code class="ruby">  # @api {post} /api/v1/contacts Add Contact</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="274">
          
          
          <code class="ruby">  # @apiDescription Add new contact</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="275">
          
          
          <code class="ruby">  # @apiName AddContact</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="276">
          
          
          <code class="ruby">  # @apiGroup Contact</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="277">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="278">
          
          
          <code class="ruby">  # @apiParam {String} access_token User access token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="279">
          
          
          <code class="ruby">  # @apiParam {Number} contact_id User id to be add as contact</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="280">
          
          
          <code class="ruby">  # =end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="281">
          <span class="hits">1</span>
          
          <code class="ruby">  def create</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="282">
          <span class="hits">5</span>
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="283">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="284">
          <span class="hits">5</span>
          
          <code class="ruby">      if !params[:contact_id].present? || params[:contact_id] == &quot;&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="285">
          <span class="hits">1</span>
          
          <code class="ruby">        raise Exception.new(&quot;Contact id must be present.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="286">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="287">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="288">
          <span class="hits">4</span>
          
          <code class="ruby">      if params[:contact_id].to_s == @current_user.id.to_s</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="289">
          <span class="hits">1</span>
          
          <code class="ruby">        raise Exception.new(&quot;You can not add your self as contact.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="290">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="291">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="292">
          <span class="hits">3</span>
          
          <code class="ruby">      user = nil</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="293">
          <span class="hits">3</span>
          
          <code class="ruby">      ActiveRecord::Base.transaction do</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="294">
          <span class="hits">3</span>
          
          <code class="ruby">        contact_id = User.find_by(id: params[:contact_id], application_id: @current_user.application.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="295">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="296">
          <span class="hits">3</span>
          
          <code class="ruby">        if contact_id.nil?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="297">
          <span class="hits">1</span>
          
          <code class="ruby">          raise Exception.new(&quot;Contact id is not found.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="298">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="299">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="300">
          <span class="hits">2</span>
          
          <code class="ruby">        contact = Contact.find_by(user_id: @current_user.id, contact_id: contact_id.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="301">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="302">
          <span class="hits">2</span>
          
          <code class="ruby">        if contact.nil?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="303">
          <span class="hits">1</span>
          
          <code class="ruby">          contact = Contact.new</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="304">
          <span class="hits">1</span>
          
          <code class="ruby">          contact.user_id = @current_user.id</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="305">
          <span class="hits">1</span>
          
          <code class="ruby">          contact.contact_id = contact_id.id</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="306">
          <span class="hits">1</span>
          
          <code class="ruby">          contact.save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="307">
          
          
          <code class="ruby">          # send new contact push notification</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="308">
          <span class="hits">1</span>
          
          <code class="ruby">          new_contacts_pn = [[@current_user.id, contact_id.id]]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="309">
          <span class="hits">1</span>
          
          <code class="ruby">          ContactPushNotificationJob.perform_later(new_contacts_pn)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="310">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="311">
          <span class="hits">1</span>
          
          <code class="ruby">          raise Exception.new(&quot;User already in your contact.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="312">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="313">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="314">
          
          
          <code class="ruby">        # make added contact as adder&#39;s contact</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="315">
          
          
          <code class="ruby">        # if A add B as contact, A will be added as contact to B. A (add)-&gt; B = A &lt;-&gt; B</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="316">
          
          
          <code class="ruby">        # delete this block</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="317">
          <span class="hits">1</span>
          
          <code class="ruby">        added_contact = Contact.find_by(user_id: contact_id.id, contact_id: @current_user.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="318">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="319">
          <span class="hits">1</span>
          
          <code class="ruby">        if added_contact.nil?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="320">
          <span class="hits">1</span>
          
          <code class="ruby">          added_contact = Contact.new</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="321">
          <span class="hits">1</span>
          
          <code class="ruby">          added_contact.user_id = contact_id.id</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="322">
          <span class="hits">1</span>
          
          <code class="ruby">          added_contact.contact_id = @current_user.id</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="323">
          <span class="hits">1</span>
          
          <code class="ruby">          added_contact.save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="324">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="325">
          
          
          <code class="ruby">        # till this block to remove dependent contact invitation</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="326">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="327">
          
          
          <code class="ruby">        # get the user detail</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="328">
          <span class="hits">1</span>
          
          <code class="ruby">        user = User.find(contact.contact_id)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="329">
          <span class="hits">1</span>
          
          <code class="ruby">        user = user.as_contact_json({:show_profile =&gt; false})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="330">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="331">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="332">
          
          
          <code class="ruby">      # render user detail</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="333">
          <span class="hits">1</span>
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="334">
          
          
          <code class="ruby">        data: user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="335">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="336">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="337">
          <span class="hits">4</span>
          
          <code class="ruby">    rescue ActiveRecord::RecordInvalid =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="338">
          
          
          <code class="ruby">      msg = &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="339">
          
          
          <code class="ruby">      e.record.errors.map do |k, v|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="340">
          
          
          <code class="ruby">        key = k.to_s.humanize</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="341">
          
          
          <code class="ruby">        msg = msg + &quot;#{key} #{v}, &quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="342">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="343">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="344">
          
          
          <code class="ruby">      msg = msg.chomp(&quot;, &quot;) + &quot;.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="345">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="346">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="347">
          
          
          <code class="ruby">          message: msg</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="348">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="349">
          
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="350">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="351">
          
          
          <code class="ruby">    rescue Exception =&gt; e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="352">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="353">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="354">
          
          
          <code class="ruby">          message: e.message</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="355">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="356">
          <span class="hits">4</span>
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="357">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="358">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="359">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="360">
          
          
          <code class="ruby">  # =begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="361">
          
          
          <code class="ruby">  # @apiVersion 1.0.0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="362">
          
          
          <code class="ruby">  # @api {delete} /api/v1/contacts/delete_contact Delete Contact</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="363">
          
          
          <code class="ruby">  # @apiDescription Delete contact</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="364">
          
          
          <code class="ruby">  # @apiName DeleteContact</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="365">
          
          
          <code class="ruby">  # @apiGroup Contact</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="366">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="367">
          
          
          <code class="ruby">  # @apiParam {String} access_token User access token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="368">
          
          
          <code class="ruby">  # @apiParam {Number} contact_id User id to be deleted as contact</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="369">
          
          
          <code class="ruby">  # =end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="370">
          <span class="hits">1</span>
          
          <code class="ruby">  def delete_contact</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="371">
          <span class="hits">2</span>
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="372">
          <span class="hits">2</span>
          
          <code class="ruby">      if !params[:contact_id].present? || params[:contact_id] == &quot;&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="373">
          <span class="hits">1</span>
          
          <code class="ruby">        raise Exception.new(&quot;Contact id can not be empty string.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="374">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="375">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="376">
          <span class="hits">1</span>
          
          <code class="ruby">      contact_user = nil</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="377">
          <span class="hits">1</span>
          
          <code class="ruby">      ActiveRecord::Base.transaction do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="378">
          <span class="hits">1</span>
          
          <code class="ruby">        current_user_id = @current_user.id</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="379">
          <span class="hits">1</span>
          
          <code class="ruby">        contact_user = User.find(params[:contact_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="380">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="381">
          <span class="hits">1</span>
          
          <code class="ruby">        contact = Contact.find_by(user_id: current_user_id, contact_id: contact_user.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="382">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="383">
          <span class="hits">1</span>
          
          <code class="ruby">        if contact.nil? == false</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="384">
          <span class="hits">1</span>
          
          <code class="ruby">          contact.destroy</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="385">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="386">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="387">
          <span class="hits">1</span>
          
          <code class="ruby">        contact_user = contact_user.as_contact_json({:show_profile =&gt; false})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="388">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="389">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="390">
          <span class="hits">1</span>
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="391">
          
          
          <code class="ruby">        data: contact_user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="392">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="393">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="394">
          <span class="hits">1</span>
          
          <code class="ruby">    rescue ActiveRecord::RecordInvalid =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="395">
          
          
          <code class="ruby">      msg = &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="396">
          
          
          <code class="ruby">      e.record.errors.map do |k, v|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="397">
          
          
          <code class="ruby">        key = k.to_s.humanize</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="398">
          
          
          <code class="ruby">        msg = msg + &quot;#{key} #{v}, &quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="399">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="400">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="401">
          
          
          <code class="ruby">      msg = msg.chomp(&quot;, &quot;) + &quot;.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="402">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="403">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="404">
          
          
          <code class="ruby">          message: msg</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="405">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="406">
          
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="407">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="408">
          
          
          <code class="ruby">    rescue Exception =&gt; e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="409">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="410">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="411">
          
          
          <code class="ruby">          message: e.message</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="412">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="413">
          <span class="hits">1</span>
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="414">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="415">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="416">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="417">
          
          
          <code class="ruby">  # =begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="418">
          
          
          <code class="ruby">  # @apiVersion 1.0.0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="419">
          
          
          <code class="ruby">  # @api {post} /api/v1/contacts/search Search User</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="420">
          
          
          <code class="ruby">  # @apiDescription Search user to be added as contact</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="421">
          
          
          <code class="ruby">  # @apiName SearchUser</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="422">
          
          
          <code class="ruby">  # @apiGroup Contact</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="423">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="424">
          
          
          <code class="ruby">  # @apiParam {String} access_token User access token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="425">
          
          
          <code class="ruby">  # @apiParam {String} phone_number Registered phone number (must be include country code)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="426">
          
          
          <code class="ruby">  # =end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="427">
          <span class="hits">1</span>
          
          <code class="ruby">  def search</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="428">
          <span class="hits">4</span>
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="429">
          <span class="hits">4</span>
          
          <code class="ruby">      phone_number = params[:phone_number].delete(&#39; &#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="430">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="431">
          <span class="hits">4</span>
          
          <code class="ruby">      if !phone_number.present? || phone_number == &quot;&quot; || phone_number.length &lt; 9</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="432">
          <span class="hits">1</span>
          
          <code class="ruby">        raise Exception.new(&quot;Minimum phone number is 9&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="433">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="434">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="435">
          
          
          <code class="ruby">      # valid_phone_number = Phony.plausible?(phone_number)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="436">
          
          
          <code class="ruby">      # if valid_phone_number == false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="437">
          
          
          <code class="ruby">      #   raise Exception.new(&quot;Phone number format is invalid.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="438">
          
          
          <code class="ruby">      # end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="439">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="440">
          <span class="hits">3</span>
          
          <code class="ruby">      user = nil</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="441">
          <span class="hits">3</span>
          
          <code class="ruby">      ActiveRecord::Base.transaction do</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="442">
          <span class="hits">3</span>
          
          <code class="ruby">        application = @current_user.application</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="443">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="444">
          
          
          <code class="ruby">        # search using phone_number</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="445">
          <span class="hits">3</span>
          
          <code class="ruby">        user1 = User.where(application_id: application.id, phone_number: phone_number)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="446">
          
          
          <code class="ruby">        # search using secondary_phone_number</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="447">
          <span class="hits">3</span>
          
          <code class="ruby">        user2 = User.where(application_id: application.id, secondary_phone_number: phone_number)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="448">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="449">
          <span class="hits">3</span>
          
          <code class="ruby">        user = user1 + user2</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="450">
          <span class="hits">3</span>
          
          <code class="ruby">        user = user.uniq</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="451">
          <span class="hits">3</span>
          
          <code class="ruby">        user = user.first # only return first user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="452">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="453">
          <span class="hits">3</span>
          
          <code class="ruby">        if user.nil? == false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="454">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="455">
          
          
          <code class="ruby">          # if user has not complete their profile, then return error</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="456">
          
          
          <code class="ruby">          # disable, user can be found even they has not complete their fullname</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="457">
          
          
          <code class="ruby">          # if user.fullname.nil? || user.fullname == &quot;&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="458">
          
          
          <code class="ruby">          #   raise Exception.new(&quot;User has not complete their profile yet.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="459">
          
          
          <code class="ruby">          # end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="460">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="461">
          <span class="hits">2</span>
          
          <code class="ruby">          exist_contact = Contact.find_by(user_id: @current_user.id, contact_id: user.id)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="462">
          <span class="hits">2</span>
          
          <code class="ruby">          if exist_contact.nil? == false # already in contact</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="463">
          <span class="hits">1</span>
          
          <code class="ruby">            raise Exception.new(&quot;User already in your contact.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="464">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="465">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="466">
          
          
          <code class="ruby">          # raise Exception.new(&quot;User not found.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="467">
          
          
          <code class="ruby">          render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="468">
          
          
          <code class="ruby">            error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="469">
          
          
          <code class="ruby">              message: &quot;User not found.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="470">
          
          
          <code class="ruby">            }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="471">
          <span class="hits">1</span>
          
          <code class="ruby">          }, status: 404 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="472">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="473">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="474">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="475">
          <span class="hits">1</span>
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="476">
          
          
          <code class="ruby">        data: user.as_contact_json({:show_profile =&gt; false})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="477">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="478">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="479">
          <span class="hits">2</span>
          
          <code class="ruby">    rescue ActiveRecord::RecordInvalid =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="480">
          
          
          <code class="ruby">      msg = &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="481">
          
          
          <code class="ruby">      e.record.errors.map do |k, v|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="482">
          
          
          <code class="ruby">        key = k.to_s.humanize</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="483">
          
          
          <code class="ruby">        msg = msg + &quot;#{key} #{v}, &quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="484">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="485">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="486">
          
          
          <code class="ruby">      msg = msg.chomp(&quot;, &quot;) + &quot;.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="487">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="488">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="489">
          
          
          <code class="ruby">          message: msg</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="490">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="491">
          
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="492">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="493">
          
          
          <code class="ruby">    rescue Exception =&gt; e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="494">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="495">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="496">
          
          
          <code class="ruby">          message: e.message</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="497">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="498">
          <span class="hits">2</span>
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="499">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="500">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="501">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="502">
          
          
          <code class="ruby">  # =begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="503">
          
          
          <code class="ruby">  # @apiVersion 1.0.0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="504">
          
          
          <code class="ruby">  # @api {post} /api/v1/contacts/search_by_qiscus_email Search User by Qiscus Email</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="505">
          
          
          <code class="ruby">  # @apiDescription Search user to be added as contact using qiscus email, only used in particular condition, not for adding contact</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="506">
          
          
          <code class="ruby">  # @apiName SearchUserByQiscusEmail</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="507">
          
          
          <code class="ruby">  # @apiGroup Contact</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="508">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="509">
          
          
          <code class="ruby">  # @apiParam {String} access_token User access token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="510">
          
          
          <code class="ruby">  # @apiParam {String} qiscus_email User qiscus email</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="511">
          
          
          <code class="ruby">  # =end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="512">
          <span class="hits">1</span>
          
          <code class="ruby">  def search_by_qiscus_email</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="513">
          <span class="hits">3</span>
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="514">
          <span class="hits">3</span>
          
          <code class="ruby">      qiscus_email = params[:qiscus_email].delete(&#39; &#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="515">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="516">
          <span class="hits">3</span>
          
          <code class="ruby">      if !qiscus_email.present? || qiscus_email == &quot;&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="517">
          <span class="hits">1</span>
          
          <code class="ruby">        raise Exception.new(&quot;Qiscus email can&#39;t be empty.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="518">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="519">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="520">
          <span class="hits">2</span>
          
          <code class="ruby">      user = nil</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="521">
          <span class="hits">2</span>
          
          <code class="ruby">      ActiveRecord::Base.transaction do</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="522">
          <span class="hits">2</span>
          
          <code class="ruby">        application = @current_user.application</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="523">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="524">
          <span class="hits">2</span>
          
          <code class="ruby">        user = User.find_by(application_id: application.id, qiscus_email: qiscus_email)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="525">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="526">
          <span class="hits">2</span>
          
          <code class="ruby">        if user.nil?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="527">
          <span class="hits">1</span>
          
          <code class="ruby">          raise Exception.new(&quot;User not found.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="528">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="529">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="530">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="531">
          <span class="hits">1</span>
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="532">
          
          
          <code class="ruby">        data: user.as_contact_json({:show_profile =&gt; false})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="533">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="534">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="535">
          <span class="hits">2</span>
          
          <code class="ruby">    rescue ActiveRecord::RecordInvalid =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="536">
          
          
          <code class="ruby">      msg = &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="537">
          
          
          <code class="ruby">      e.record.errors.map do |k, v|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="538">
          
          
          <code class="ruby">        key = k.to_s.humanize</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="539">
          
          
          <code class="ruby">        msg = msg + &quot;#{key} #{v}, &quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="540">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="541">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="542">
          
          
          <code class="ruby">      msg = msg.chomp(&quot;, &quot;) + &quot;.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="543">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="544">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="545">
          
          
          <code class="ruby">          message: msg</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="546">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="547">
          
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="548">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="549">
          
          
          <code class="ruby">    rescue Exception =&gt; e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="550">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="551">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="552">
          
          
          <code class="ruby">          message: e.message</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="553">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="554">
          <span class="hits">2</span>
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="555">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="556">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="557">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="558">
          
          
          <code class="ruby">  # =begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="559">
          
          
          <code class="ruby">  # @apiVersion 1.0.0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="560">
          
          
          <code class="ruby">  # @api {post} /api/v1/contacts/search_by_email Search User by Email</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="561">
          
          
          <code class="ruby">  # @apiDescription Search user by registered email to be added as contact</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="562">
          
          
          <code class="ruby">  # @apiName SearchUserByEmail</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="563">
          
          
          <code class="ruby">  # @apiGroup Contact</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="564">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="565">
          
          
          <code class="ruby">  # @apiParam {String} access_token User access token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="566">
          
          
          <code class="ruby">  # @apiParam {String} email Registered email</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="567">
          
          
          <code class="ruby">  # =end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="568">
          <span class="hits">1</span>
          
          <code class="ruby">  def search_by_email</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="569">
          <span class="hits">3</span>
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="570">
          <span class="hits">3</span>
          
          <code class="ruby">      email = params[:email].delete(&#39; &#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="571">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="572">
          <span class="hits">3</span>
          
          <code class="ruby">      if !email.present? || email == &quot;&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="573">
          <span class="hits">1</span>
          
          <code class="ruby">        raise Exception.new(&quot;Email can&#39;t be empty.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="574">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="575">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="576">
          <span class="hits">2</span>
          
          <code class="ruby">      user = nil</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="577">
          <span class="hits">2</span>
          
          <code class="ruby">      ActiveRecord::Base.transaction do</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="578">
          <span class="hits">2</span>
          
          <code class="ruby">        application = @current_user.application</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="579">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="580">
          <span class="hits">2</span>
          
          <code class="ruby">        user = User.find_by(application_id: application.id, email: email)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="581">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="582">
          <span class="hits">2</span>
          
          <code class="ruby">        if user.nil? == false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="583">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="584">
          
          
          <code class="ruby">          # if user has not complete their profile, then return error</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="585">
          
          
          <code class="ruby">          # disable, user can be found even they has not complete their fullname</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="586">
          
          
          <code class="ruby">          # if user.fullname.nil? || user.fullname == &quot;&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="587">
          
          
          <code class="ruby">          #   raise Exception.new(&quot;User has not complete their profile yet.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="588">
          
          
          <code class="ruby">          # end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="589">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="590">
          <span class="hits">1</span>
          
          <code class="ruby">          exist_contact = Contact.find_by(user_id: @current_user.id, contact_id: user.id)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="591">
          <span class="hits">1</span>
          
          <code class="ruby">          if exist_contact.nil? == false # already in contact</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="592">
          
          
          <code class="ruby">            raise Exception.new(&quot;User already in your contact.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="593">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="594">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="595">
          <span class="hits">1</span>
          
          <code class="ruby">          raise Exception.new(&quot;User not found.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="596">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="597">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="598">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="599">
          <span class="hits">1</span>
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="600">
          
          
          <code class="ruby">        data: user.as_contact_json({:show_profile =&gt; false})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="601">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="602">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="603">
          <span class="hits">2</span>
          
          <code class="ruby">    rescue ActiveRecord::RecordInvalid =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="604">
          
          
          <code class="ruby">      msg = &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="605">
          
          
          <code class="ruby">      e.record.errors.map do |k, v|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="606">
          
          
          <code class="ruby">        key = k.to_s.humanize</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="607">
          
          
          <code class="ruby">        msg = msg + &quot;#{key} #{v}, &quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="608">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="609">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="610">
          
          
          <code class="ruby">      msg = msg.chomp(&quot;, &quot;) + &quot;.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="611">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="612">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="613">
          
          
          <code class="ruby">          message: msg</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="614">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="615">
          
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="616">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="617">
          
          
          <code class="ruby">    rescue Exception =&gt; e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="618">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="619">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="620">
          
          
          <code class="ruby">          message: e.message</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="621">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="622">
          <span class="hits">2</span>
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="623">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="624">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="625">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="626">
          
          
          <code class="ruby">  # =begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="627">
          
          
          <code class="ruby">  # @apiVersion 1.0.0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="628">
          
          
          <code class="ruby">  # @api {post} /api/v1/contacts/search_by_all_field Search User by All Field</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="629">
          
          
          <code class="ruby">  # @apiDescription Search user by all field such as fullname, phone_number, qiscus,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="630">
          
          
          <code class="ruby">  # qiscus_email and existing additional_infos</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="631">
          
          
          <code class="ruby">  # @apiName SearchUserByAllField</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="632">
          
          
          <code class="ruby">  # @apiGroup Contact</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="633">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="634">
          
          
          <code class="ruby">  # @apiParam {String} access_token User access token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="635">
          
          
          <code class="ruby">  # @apiParam {String} query Search query. Support multiple value that separated by space. If query is nil, it&#39;ll show all users in application and filtered by &quot;show&quot; parameter used.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="636">
          
          
          <code class="ruby">  # Example = Heru Bisma</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="637">
          
          
          <code class="ruby">  # @apiParam {String} show Possible value is: `all` to show all user within this application in search results, `contact` to show only their contact in search results, `not_contact` to show users thats not in contact in search results.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="638">
          
          
          <code class="ruby">  # If you don&#39;t send any parameter, it will be use previous logic, where `only` and `exclude` parameter stills work, otherwise that two parameter will not work.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="639">
          
          
          <code class="ruby">  # @apiParam {Number} page Page number</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="640">
          
          
          <code class="ruby">  # @apiParam {Number} limit Limit</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="641">
          
          
          <code class="ruby">  # =end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="642">
          <span class="hits">1</span>
          
          <code class="ruby">  def search_by_all_field</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="643">
          <span class="hits">3</span>
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="644">
          <span class="hits">3</span>
          
          <code class="ruby">      total_page = 0</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="645">
          <span class="hits">3</span>
          
          <code class="ruby">      total = 0</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="646">
          <span class="hits">3</span>
          
          <code class="ruby">      limit = params[:limit]</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="647">
          <span class="hits">3</span>
          
          <code class="ruby">      page = params[:page]</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="648">
          <span class="hits">3</span>
          
          <code class="ruby">      users = nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="649">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="650">
          <span class="hits">3</span>
          
          <code class="ruby">      query = params[:query]</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="651">
          <span class="hits">3</span>
          
          <code class="ruby">      ActiveRecord::Base.transaction do</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="652">
          <span class="hits">3</span>
          
          <code class="ruby">        application = @current_user.application</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="653">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="654">
          <span class="hits">3</span>
          
          <code class="ruby">        if !query.present? || query == &quot;&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="655">
          
          
          <code class="ruby">          # if query is nil, show all users in the @current_user application</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="656">
          <span class="hits">1</span>
          
          <code class="ruby">          users = User.where(application_id: application.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="657">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="658">
          
          
          <code class="ruby">          # split query by space because this api can search user by multiple value</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="659">
          <span class="hits">2</span>
          
          <code class="ruby">          queries = query.split(&quot; &quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="660">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="661">
          <span class="hits">2</span>
          
          <code class="ruby">          queries.each do |query|</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="662">
          <span class="hits">6</span>
          
          <code class="ruby">            query.replace(&quot;%#{query}%&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="663">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="664">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="665">
          <span class="hits">2</span>
          
          <code class="ruby">          user_ids = UserAdditionalInfo.where(&quot;user_additional_infos.value ILIKE ANY (array[?])&quot;, queries).pluck(:user_id)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="666">
          <span class="hits">2</span>
          
          <code class="ruby">          application_users = application.users</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="667">
          <span class="hits">2</span>
          
          <code class="ruby">          users = application_users.where(&quot;phone_number ILIKE ANY (array[?])&quot;, queries)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="668">
          <span class="hits">2</span>
          
          <code class="ruby">          users = users.or(application_users.where(&quot;fullname ILIKE ANY (array[?])&quot;, queries))</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="669">
          <span class="hits">2</span>
          
          <code class="ruby">          users = users.or(application_users.where(&quot;email ILIKE ANY (array[?])&quot;, queries))</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="670">
          <span class="hits">2</span>
          
          <code class="ruby">          users = users.or(application_users.where(&quot;qiscus_email ILIKE ANY (array[?])&quot;, queries))</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="671">
          <span class="hits">2</span>
          
          <code class="ruby">          users = users.or(application_users.where(id: user_ids))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="672">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="673">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="674">
          
          
          <code class="ruby">        # exclude @current_user on search result</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="675">
          <span class="hits">3</span>
          
          <code class="ruby">        users = users.where.not(id: @current_user.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="676">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="677">
          <span class="hits">3</span>
          
          <code class="ruby">        show = params[:show]</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="678">
          <span class="hits">3</span>
          
          <code class="ruby">        if show == &#39;all&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="679">
          
          
          <code class="ruby">          # show all users including official users</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="680">
          
          
          <code class="ruby">          users = users</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="681">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="682">
          <span class="hits">3</span>
          
          <code class="ruby">        elsif show == &#39;contact&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="683">
          
          
          <code class="ruby">          # show @current_user contact excluding @current_user and official users</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="684">
          
          
          <code class="ruby">          # show user_ids and contact_ids. and do users_ids - contact_ids</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="685">
          
          
          <code class="ruby">          user_ids = users.pluck(:id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="686">
          
          
          <code class="ruby">          # show all users in the apps except official users and @current_user</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="687">
          
          
          <code class="ruby">          all_users_ids = User.where(application_id: @current_user.application_id).pluck(:id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="688">
          
          
          <code class="ruby">          # show user contact</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="689">
          
          
          <code class="ruby">          contact_ids = @current_user.contacts.where(&quot;contacts.contact_id NOT IN (select user_id from user_roles where role_id = ?)&quot;, Role.official.id).pluck(:contact_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="690">
          
          
          <code class="ruby">          not_contact_ids = all_users_ids - contact_ids</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="691">
          
          
          <code class="ruby">          user_ids = user_ids - not_contact_ids</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="692">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="693">
          
          
          <code class="ruby">          # show the users detail that has been substracted before</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="694">
          
          
          <code class="ruby">          users = User.includes([:roles, :application]).where(&quot;users.application_id = ?&quot;, @current_user.application_id).where(&quot;users.id IN (?)&quot;, user_ids)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="695">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="696">
          <span class="hits">3</span>
          
          <code class="ruby">        elsif show == &#39;not_contact&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="697">
          
          
          <code class="ruby">          # show @current_user that&#39;s not_contact, excluding @current_user and official users</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="698">
          
          
          <code class="ruby">          # show user_ids and contact_ids. and do users_ids - contact_ids</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="699">
          
          
          <code class="ruby">          user_ids = users.pluck(:id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="700">
          
          
          <code class="ruby">          # contact_ids = @current_user.contacts.where(&quot;contact_id NOT IN (select user_id from user_roles where role_id = ?)&quot;, Role.official.id).pluck(:contact_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="701">
          
          
          <code class="ruby">          contact_ids = @current_user.contacts.pluck(:contact_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="702">
          
          
          <code class="ruby">          user_ids = user_ids - contact_ids</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="703">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="704">
          
          
          <code class="ruby">          # show the users detail that has been substracted before</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="705">
          
          
          <code class="ruby">          users = User.includes([:roles, :application]).where(&quot;users.application_id = ?&quot;, @current_user.application_id).where(&quot;users.id IN (?)&quot;, user_ids)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="706">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="707">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="708">
          
          
          <code class="ruby">          # show all users</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="709">
          <span class="hits">3</span>
          
          <code class="ruby">          users = users</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="710">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="711">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="712">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="713">
          <span class="hits">3</span>
          
          <code class="ruby">        users = users.where.not(fullname: nil).where.not(fullname: &quot;&quot;) # only show contact who has complete their profile (fullname not nil)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="714">
          <span class="hits">3</span>
          
          <code class="ruby">        users = users.order(fullname: :asc)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="715">
          <span class="hits">3</span>
          
          <code class="ruby">        total = users.count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="716">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="717">
          
          
          <code class="ruby">        # pagination only when exist</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="718">
          <span class="hits">3</span>
          
          <code class="ruby">        if page.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="719">
          
          
          <code class="ruby">          users = users.page(page)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="720">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="721">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="722">
          
          
          <code class="ruby">        # if limit and page present, then use kaminari pagination</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="723">
          <span class="hits">3</span>
          
          <code class="ruby">        if limit.present? &amp;&amp; page.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="724">
          
          
          <code class="ruby">          users = users.per(limit)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="725">
          
          
          <code class="ruby">        # else use limit from ActiveRecord</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="726">
          <span class="hits">3</span>
          
          <code class="ruby">        elsif limit.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="727">
          
          
          <code class="ruby">          users = users.limit(limit)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="728">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="729">
          <span class="hits">3</span>
          
          <code class="ruby">          limit = 25</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="730">
          <span class="hits">3</span>
          
          <code class="ruby">          users = users.limit(25)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="731">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="732">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="733">
          <span class="hits">3</span>
          
          <code class="ruby">        total_page = (total / limit.to_f).ceil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="734">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="735">
          <span class="hits">3</span>
          
          <code class="ruby">        users = users.map(&amp;:as_contact_json)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="736">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="737">
          <span class="hits">3</span>
          
          <code class="ruby">        contact_id = @current_user.contacts.pluck(:contact_id)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="738">
          <span class="hits">3</span>
          
          <code class="ruby">        favored_status = @current_user.contacts.pluck(:contact_id, :is_favored)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="739">
          <span class="hits">3</span>
          
          <code class="ruby">        users = users.map do |e|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="740">
          
          
          <code class="ruby">          # is contact is always true since this will only load contact of this user</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="741">
          <span class="hits">6</span>
          
          <code class="ruby">          is_contact = contact_id.include?(e[&quot;id&quot;])</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="742">
          <span class="hits">6</span>
          
          <code class="ruby">          is_favored = favored_status.to_h[ e[&quot;id&quot;] ] == nil ? false : favored_status.to_h[ e[&quot;id&quot;] ]</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="743">
          <span class="hits">6</span>
          
          <code class="ruby">          e.merge!(&#39;is_favored&#39; =&gt; is_favored, &#39;is_contact&#39; =&gt; is_contact )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="744">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="745">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="746">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="747">
          <span class="hits">3</span>
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="748">
          
          
          <code class="ruby">        meta: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="749">
          
          
          <code class="ruby">          limit: limit.to_i,</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="750">
          <span class="hits">3</span>
          
          <code class="ruby">          page: page == nil || page.to_i &lt; 0 ? 0 : page.to_i,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="751">
          
          
          <code class="ruby">          total_page: total_page,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="752">
          
          
          <code class="ruby">          total: total,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="753">
          
          
          <code class="ruby">        },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="754">
          
          
          <code class="ruby">        data: users</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="755">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="756">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="757">
          
          
          <code class="ruby">    rescue ActiveRecord::RecordInvalid =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="758">
          
          
          <code class="ruby">      msg = &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="759">
          
          
          <code class="ruby">      e.record.errors.map do |k, v|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="760">
          
          
          <code class="ruby">        key = k.to_s.humanize</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="761">
          
          
          <code class="ruby">        msg = msg + &quot;#{key} #{v}, &quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="762">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="763">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="764">
          
          
          <code class="ruby">      msg = msg.chomp(&quot;, &quot;) + &quot;.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="765">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="766">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="767">
          
          
          <code class="ruby">          message: msg</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="768">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="769">
          
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="770">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="771">
          
          
          <code class="ruby">    rescue Exception =&gt; e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="772">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="773">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="774">
          
          
          <code class="ruby">          message: e.message</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="775">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="776">
          
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="777">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="778">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="779">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="780">
          <span class="hits">1</span>
          
          <code class="ruby">  def search_bot</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="781">
          
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="782">
          
          
          <code class="ruby">      username = params[:username].delete(&#39; &#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="783">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="784">
          
          
          <code class="ruby">      if !username.present? || username == &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="785">
          
          
          <code class="ruby">        raise Exception.new(&quot;Username can&#39;t be empty.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="786">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="787">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="788">
          
          
          <code class="ruby">      user = nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="789">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="790">
          
          
          <code class="ruby">      ActiveRecord::Base.transaction do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="791">
          
          
          <code class="ruby">        user = User.joins(:bot)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="792">
          
          
          <code class="ruby">          .where(&quot;bots.username = ? &quot;, username)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="793">
          
          
          <code class="ruby">          .first()</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="794">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="795">
          
          
          <code class="ruby">        if user.nil? == false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="796">
          
          
          <code class="ruby">          exist_contact = Contact.find_by(user_id: @current_user.id, contact_id: user.id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="797">
          
          
          <code class="ruby">          if exist_contact.nil? == false # already in contact</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="798">
          
          
          <code class="ruby">            raise Exception.new(&quot;Bot already in your contact.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="799">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="800">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="801">
          
          
          <code class="ruby">          raise Exception.new(&quot;Bot not found.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="802">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="803">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="804">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="805">
          
          
          <code class="ruby">      # bot username inside phone_number</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="806">
          
          
          <code class="ruby">      # because bot not used phone_number</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="807">
          
          
          <code class="ruby">      user[:phone_number] = user.bot.username</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="808">
          
          
          <code class="ruby">      </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="809">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="810">
          
          
          <code class="ruby">        data: user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="811">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="812">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="813">
          
          
          <code class="ruby">    rescue ActiveRecord::RecordInvalid =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="814">
          
          
          <code class="ruby">      msg = &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="815">
          
          
          <code class="ruby">      e.record.errors.map do |k, v|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="816">
          
          
          <code class="ruby">        key = k.to_s.humanize</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="817">
          
          
          <code class="ruby">        msg = msg + &quot;#{key} #{v}, &quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="818">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="819">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="820">
          
          
          <code class="ruby">      msg = msg.chomp(&quot;, &quot;) + &quot;.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="821">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="822">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="823">
          
          
          <code class="ruby">          message: msg</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="824">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="825">
          
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="826">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="827">
          
          
          <code class="ruby">    rescue Exception =&gt; e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="828">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="829">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="830">
          
          
          <code class="ruby">          message: e.message</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="831">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="832">
          
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="833">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="834">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="835">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="836">
          <span class="hits">1</span>
          
          <code class="ruby">  def bot</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="837">
          
          
          <code class="ruby">    # @current_user = User.where(id: 61).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="838">
          
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="839">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="840">
          
          
          <code class="ruby">      if !params[:contact_id].present? || params[:contact_id] == &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="841">
          
          
          <code class="ruby">        raise Exception.new(&quot;Contact id must be present.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="842">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="843">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="844">
          
          
          <code class="ruby">      if params[:contact_id].to_s == @current_user.id.to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="845">
          
          
          <code class="ruby">        raise Exception.new(&quot;You can not add your self as contact.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="846">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="847">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="848">
          
          
          <code class="ruby">      if !params[:password].present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="849">
          
          
          <code class="ruby">        raise Exception.new(&quot;Password must be present.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="850">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="851">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="852">
          
          
          <code class="ruby">      user = nil</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="853">
          
          
          <code class="ruby">      ActiveRecord::Base.transaction do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="854">
          
          
          <code class="ruby">        contact_id = User.find_by(id: params[:contact_id], application_id: @current_user.application.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="855">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="856">
          
          
          <code class="ruby">        if contact_id.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="857">
          
          
          <code class="ruby">          raise Exception.new(&quot;Contact id is not found.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="858">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="859">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="860">
          
          
          <code class="ruby">        contact = Contact.find_by(user_id: @current_user.id, contact_id: contact_id.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="861">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="862">
          
          
          <code class="ruby">        if contact.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="863">
          
          
          <code class="ruby">          contact = Contact.new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="864">
          
          
          <code class="ruby">          contact.user_id = @current_user.id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="865">
          
          
          <code class="ruby">          contact.contact_id = contact_id.id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="866">
          
          
          <code class="ruby">          contact.save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="867">
          
          
          <code class="ruby">          # send new contact push notification</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="868">
          
          
          <code class="ruby">          new_contacts_pn = [[@current_user.id, contact_id.id]]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="869">
          
          
          <code class="ruby">          ContactPushNotificationJob.perform_later(new_contacts_pn)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="870">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="871">
          
          
          <code class="ruby">          raise Exception.new(&quot;User already in your contact.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="872">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="873">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="874">
          
          
          <code class="ruby">        # make added contact as adder&#39;s contact</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="875">
          
          
          <code class="ruby">        # if A add B as contact, A will be added as contact to B. A (add)-&gt; B = A &lt;-&gt; B</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="876">
          
          
          <code class="ruby">        # delete this block</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="877">
          
          
          <code class="ruby">        added_contact = Contact.find_by(user_id: contact_id.id, contact_id: @current_user.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="878">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="879">
          
          
          <code class="ruby">        if added_contact.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="880">
          
          
          <code class="ruby">          added_contact = Contact.new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="881">
          
          
          <code class="ruby">          added_contact.user_id = contact_id.id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="882">
          
          
          <code class="ruby">          added_contact.contact_id = @current_user.id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="883">
          
          
          <code class="ruby">          added_contact.save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="884">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="885">
          
          
          <code class="ruby">        # till this block to remove dependent contact invitation</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="886">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="887">
          
          
          <code class="ruby">        # get the user detail</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="888">
          
          
          <code class="ruby">        user = User.find(contact.contact_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="889">
          
          
          <code class="ruby">        bot = Bot.where(user_id: user.id).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="890">
          
          
          <code class="ruby">        if bot.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="891">
          
          
          <code class="ruby">          raise Exception.new(&quot;Bot not found!&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="892">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="893">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="894">
          
          
          <code class="ruby">        creator = User.where(id: bot.user_id_creator).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="895">
          
          
          <code class="ruby">        if creator.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="896">
          
          
          <code class="ruby">          raise Exception.new(&quot;Bot creator not found!&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="897">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="898">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="899">
          
          
          <code class="ruby">        check_password = Bot.check_password(params, bot.password_digest)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="900">
          
          
          <code class="ruby">        if check_password == true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="901">
          
          
          <code class="ruby">          user = user.as_contact_json({:show_profile =&gt; false})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="902">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="903">
          
          
          <code class="ruby">          raise Exception.new(&quot;Wrong Password!, for password information please contact #{user.fullname} creator : #{creator.fullname}&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="904">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="905">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="906">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="907">
          
          
          <code class="ruby">      # render user detail</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="908">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="909">
          
          
          <code class="ruby">        data: user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="910">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="911">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="912">
          
          
          <code class="ruby">    rescue ActiveRecord::RecordInvalid =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="913">
          
          
          <code class="ruby">      msg = &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="914">
          
          
          <code class="ruby">      e.record.errors.map do |k, v|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="915">
          
          
          <code class="ruby">        key = k.to_s.humanize</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="916">
          
          
          <code class="ruby">        msg = msg + &quot;#{key} #{v}, &quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="917">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="918">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="919">
          
          
          <code class="ruby">      msg = msg.chomp(&quot;, &quot;) + &quot;.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="920">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="921">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="922">
          
          
          <code class="ruby">          message: msg</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="923">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="924">
          
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="925">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="926">
          
          
          <code class="ruby">    rescue Exception =&gt; e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="927">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="928">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="929">
          
          
          <code class="ruby">          message: e.message</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="930">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="931">
          
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="932">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="933">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="934">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="935">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="0c74c6837a5de4f6b8eb0bc2e3be006bfe09f0d7">
  <div class="header">
    <h3>app/controllers/api/v1/me_controller.rb</h3>
    <h4><span class="red">36.42 %</span> covered</h4>
    <div>
      <b>173</b> relevant lines. 
      <span class="green"><b>63</b> lines covered</span> and
      <span class="red"><b>110</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class Api::V1::MeController &lt; ProtectedController</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  before_action :authorize_user</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  before_action :ensure_update_profile_params, only: [:update_profile]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  before_action :ensure_update_avatar_params, only: [:update_avatar]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">  # =begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">  # @apiVersion 1.0.0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">  # @api {get} /api/v1/me My Profile</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">  # @apiName Me</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">  # @apiGroup Profile</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">  # @apiParam {String} access_token User access token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">  # =end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">  def index</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">    render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">      data: @current_user.as_json({:show_profile =&gt; true})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">  # =begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">  # @apiVersion 1.0.0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">  # @api {post} /api/v1/me/update_profile Update Profile</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">  # @apiName UpdateProfile</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">  # @apiGroup Profile</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">  # @apiDescription Before updating user&#39;s email or phone number, system will check whether there are no another user who have same email/phone number except current user. Why this should be considered? For example there are 2 user: A and B registered in same application (id). A register using phone number, let say 123. B register using email, let say b@mail.com.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">  # Now, image if we don&#39;t check anything about data existense and let A to update his profile email to b@mail.com and let B to update their phone number to 123 (actually it can&#39;t be done because of db validation). It will be result strange behaviour in login method, since it just using one parameter, either email or phone number.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">  # Now, A have: 123, b@mail.com and B have: 123, b@mail.com It&#39;s the same data, and please forget about how it can be B know A&#39;s phone number or how it can A know B&#39;s email? The point is, it will led system have duplicate data (even it can&#39;t be done because of database validation). As we expected, when B try to login he will get authentication using id A. And when A try to login it will be A.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">  # @apiParam {String} access_token User access token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">  # @apiParam {String} user[fullname] Minimum 4 char maximum 20 char (as mentioned in specification [https://quip.com/EafhASIYmym3](https://quip.com/EafhASIYmym3))</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">  # @apiParam {String} user[email] Valid email</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">  # @apiParam {String} user[gender] `male` or `female`</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">  # @apiParam {String} user[date_of_birth] Date of birth, format `yyyy-mm-dd`</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">  # @apiParam {Boolean} user[is_public] Profile information is public or not</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">  # @apiParam {Text} user[description] Profile description (this is a profile status)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">  # @apiParam {Text} user[country_name] Country (this is for buddygo support)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">  # @apiParam {Text} user[secondary_phone_number] Secondary phone number (this is for buddygo support)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">  # @apiParam {Text} user[additional_infos][key] You can fill anything in [key]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">  # =end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="43">
          <span class="hits">1</span>
          
          <code class="ruby">  def update_profile</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="44">
          <span class="hits">5</span>
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="45">
          <span class="hits">5</span>
          
          <code class="ruby">      user = @current_user</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="46">
          <span class="hits">5</span>
          
          <code class="ruby">      application = user.application</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="47">
          <span class="hits">5</span>
          
          <code class="ruby">      user_params = params[:user].permit!</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="48">
          <span class="hits">5</span>
          
          <code class="ruby">      additional_infos = nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="50">
          <span class="hits">5</span>
          
          <code class="ruby">      ActiveRecord::Base.transaction do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">      # use if clause to update phone_number, fullname, email, gender, date of birth and is public only</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">      # this will avoid user to update another unpermitted column such as qiscus email or qiscus token</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="54">
          <span class="hits">5</span>
          
          <code class="ruby">      phone_number = user_params[:phone_number]</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="55">
          <span class="hits">5</span>
          
          <code class="ruby">      if phone_number.present? &amp;&amp; !phone_number.nil? &amp;&amp; phone_number != &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="56">
          
          
          <code class="ruby">        phone_number = phone_number.strip().delete(&#39; &#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">        # phone_number = PhonyRails.normalize_number(phone_number, default_country_code: &#39;ID&#39;) # normalize phone number</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">        # before updating user&#39;s email or phone number, check if there are no another user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">        # who have same email/phone number except current user</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">        if User.where.not(id: user.id).where(application_id: @current_user.application.id).exists?(phone_number: phone_number)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">          raise Exception.new(&quot;Your submitted phone number already used by another user. Please use another phone number.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="65">
          
          
          <code class="ruby">        user.phone_number = phone_number</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="68">
          <span class="hits">5</span>
          
          <code class="ruby">      fullname = user_params[:fullname]</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="69">
          <span class="hits">5</span>
          
          <code class="ruby">      if fullname.present? &amp;&amp; !fullname.nil? &amp;&amp; fullname != &quot;&quot;</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="70">
          <span class="hits">5</span>
          
          <code class="ruby">        user.fullname = (fullname.nil? || fullname == &quot;&quot;) ? &quot;&quot; : fullname.strip().gsub(/\s+/, &quot; &quot;) # to remove multi space to single space</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">        # Change username in SDK</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="73">
          <span class="hits">5</span>
          
          <code class="ruby">        qiscus_sdk = QiscusSdk.new(application.app_id, application.qiscus_sdk_secret)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="74">
          <span class="hits">5</span>
          
          <code class="ruby">        qiscus_token = qiscus_sdk.update_profile(user.qiscus_email, fullname)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="76">
          
          
          <code class="ruby">        raise Exception.new(&quot;Fullname minimum character is 4.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="79">
          <span class="hits">5</span>
          
          <code class="ruby">      email = user_params[:email]</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="80">
          <span class="hits">5</span>
          
          <code class="ruby">      if email.present? &amp;&amp; !email.nil? &amp;&amp; email != &quot;&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">        # before updating user&#39;s email or phone number, check if there are no another user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">        # who have same email/phone number except current user</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="83">
          <span class="hits">3</span>
          
          <code class="ruby">        if User.where.not(id: user.id).where(application_id: @current_user.application.id).exists?(email: email)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="84">
          <span class="hits">1</span>
          
          <code class="ruby">          raise Exception.new(&quot;Your submitted email already used by another user. Please use another email.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="87">
          <span class="hits">2</span>
          
          <code class="ruby">        user.email = (email.nil? || email == &quot;&quot;) ? &quot;&quot; : email.strip().delete(&#39; &#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="90">
          <span class="hits">4</span>
          
          <code class="ruby">      gender = user_params[:gender]</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="91">
          <span class="hits">4</span>
          
          <code class="ruby">      if gender.present? &amp;&amp; !gender.nil? &amp;&amp; gender != &quot;&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="92">
          <span class="hits">1</span>
          
          <code class="ruby">        user.gender = gender</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="95">
          <span class="hits">4</span>
          
          <code class="ruby">      date_of_birth = user_params[:date_of_birth]</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="96">
          <span class="hits">4</span>
          
          <code class="ruby">      if date_of_birth.present? &amp;&amp; !date_of_birth.nil? &amp;&amp; date_of_birth != &quot;&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="97">
          <span class="hits">1</span>
          
          <code class="ruby">        user.date_of_birth = date_of_birth</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="100">
          <span class="hits">4</span>
          
          <code class="ruby">      is_public = user_params[:is_public]</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="101">
          <span class="hits">4</span>
          
          <code class="ruby">      if is_public.present? &amp;&amp; !is_public.nil? &amp;&amp; is_public != &quot;&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="102">
          <span class="hits">1</span>
          
          <code class="ruby">        user.is_public = (is_public.nil? || is_public == &quot;&quot; || is_public != &quot;true&quot;) ? false : is_public</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="105">
          <span class="hits">4</span>
          
          <code class="ruby">      description = user_params[:description]</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="106">
          <span class="hits">4</span>
          
          <code class="ruby">      if description.present? &amp;&amp; !description.nil? &amp;&amp; description != &quot;&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="107">
          <span class="hits">1</span>
          
          <code class="ruby">        user.description = description</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="110">
          <span class="hits">4</span>
          
          <code class="ruby">      country_name = user_params[:country_name]</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="111">
          <span class="hits">4</span>
          
          <code class="ruby">      if country_name.present? &amp;&amp; !country_name.nil? &amp;&amp; country_name != &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="112">
          
          
          <code class="ruby">        user.country_name = country_name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="115">
          <span class="hits">4</span>
          
          <code class="ruby">      secondary_phone_number = user_params[:secondary_phone_number]</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="116">
          <span class="hits">4</span>
          
          <code class="ruby">      if secondary_phone_number.present? &amp;&amp; !secondary_phone_number.nil? &amp;&amp; secondary_phone_number != &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="117">
          
          
          <code class="ruby">        user.secondary_phone_number = secondary_phone_number</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="120">
          <span class="hits">4</span>
          
          <code class="ruby">      user.save!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="122">
          <span class="hits">3</span>
          
          <code class="ruby">      additional_infos = user_params[:additional_infos]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">      # Save or update user additional infos</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="125">
          <span class="hits">3</span>
          
          <code class="ruby">      if !additional_infos.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="126">
          
          
          <code class="ruby">        new_additional_infos = Array.new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="127">
          
          
          <code class="ruby">        additional_infos.each do |key, value|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="128">
          
          
          <code class="ruby">          info = UserAdditionalInfo.find_by(user_id: user.id, key: key)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="130">
          
          
          <code class="ruby">          if info.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby">            # if additional info with spesific key doesn&#39;t exist then create it</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="132">
          
          
          <code class="ruby">            new_additional_infos.push({:user_id =&gt; user.id, :key =&gt; key, :value =&gt; value})</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="133">
          
          
          <code class="ruby">          elsif info.value != value</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby">            # if additional info with spesific key exist but with different value then update it</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="135">
          
          
          <code class="ruby">            info.update_attributes(:value =&gt; value)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby">        # add new additional infos</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="140">
          
          
          <code class="ruby">        UserAdditionalInfo.create(new_additional_infos)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="142">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="145">
          <span class="hits">3</span>
          
          <code class="ruby">    render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby">      data: user.as_json({:show_profile =&gt; true})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="149">
          <span class="hits">2</span>
          
          <code class="ruby">  rescue ActiveRecord::RecordInvalid =&gt; e</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="150">
          <span class="hits">1</span>
          
          <code class="ruby">    msg = &quot;&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="151">
          <span class="hits">1</span>
          
          <code class="ruby">    e.record.errors.map do |k, v|</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="152">
          <span class="hits">1</span>
          
          <code class="ruby">      key = k.to_s.humanize</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="153">
          <span class="hits">1</span>
          
          <code class="ruby">      msg = msg + &quot;#{key} #{v}, &quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="154">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="156">
          <span class="hits">1</span>
          
          <code class="ruby">    msg = msg.chomp(&quot;, &quot;) + &quot;.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby">    render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="158">
          
          
          <code class="ruby">      error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby">        message: msg</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="160">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="161">
          <span class="hits">1</span>
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby">    rescue Exception =&gt; e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="164">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="165">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="166">
          
          
          <code class="ruby">          message: e.message</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="167">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="168">
          <span class="hits">1</span>
          
          <code class="ruby">        }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="169">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="170">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="171">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="172">
          
          
          <code class="ruby">  # =begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="173">
          
          
          <code class="ruby">  # @apiVersion 1.0.0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="174">
          
          
          <code class="ruby">  # @api {post} /api/v1/me/update_avatar Update Profile Avatar</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="175">
          
          
          <code class="ruby">  # @apiName UpdateAvatarProfile</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="176">
          
          
          <code class="ruby">  # @apiGroup Profile</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="177">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="178">
          
          
          <code class="ruby">  # @apiParam {String} access_token User access token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="179">
          
          
          <code class="ruby">  # @apiParam {File} avatar_file Image file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="180">
          
          
          <code class="ruby">  # =end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="181">
          <span class="hits">1</span>
          
          <code class="ruby">  def update_avatar</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="182">
          
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="183">
          
          
          <code class="ruby">      ActiveRecord::Base.transaction do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="184">
          
          
          <code class="ruby">        qiscus_sdk = QiscusSdk.new(@current_user.application.app_id, @current_user.application.qiscus_sdk_secret)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="185">
          
          
          <code class="ruby">        url = qiscus_sdk.upload_file(@current_user.qiscus_token, @avatar_file) # upload file</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="186">
          
          
          <code class="ruby">        @current_user.update!(avatar_url: url) # update avatar_url in qisme</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="187">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="188">
          
          
          <code class="ruby">        # Change avatar_url in SDK</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="189">
          
          
          <code class="ruby">        qiscus_sdk.update_profile(@current_user.qiscus_email, nil, url)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="190">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="191">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="192">
          
          
          <code class="ruby">        data: @current_user.as_json({:show_profile =&gt; true})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="193">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="194">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="195">
          
          
          <code class="ruby">    rescue ActiveRecord::RecordInvalid =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="196">
          
          
          <code class="ruby">      msg = &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="197">
          
          
          <code class="ruby">      e.record.errors.map do |k, v|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="198">
          
          
          <code class="ruby">        key = k.to_s.humanize</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="199">
          
          
          <code class="ruby">        msg = msg + &quot;#{key} #{v}, &quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="200">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="201">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="202">
          
          
          <code class="ruby">      msg = msg.chomp(&quot;, &quot;) + &quot;.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="203">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="204">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="205">
          
          
          <code class="ruby">          message: msg</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="206">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="207">
          
          
          <code class="ruby">        }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="208">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="209">
          
          
          <code class="ruby">      rescue Exception =&gt; e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="210">
          
          
          <code class="ruby">        render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="211">
          
          
          <code class="ruby">          error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="212">
          
          
          <code class="ruby">            message: e.message</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="213">
          
          
          <code class="ruby">          }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="214">
          
          
          <code class="ruby">          }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="215">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="216">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="217">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="218">
          
          
          <code class="ruby">  # =begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="219">
          
          
          <code class="ruby">  # @apiVersion 1.0.0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="220">
          
          
          <code class="ruby">  # @api {post} /api/v1/me/logout Logout session</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="221">
          
          
          <code class="ruby">  # @apiDescription This endpoint to ensure there are not trash data in auth_sessions table,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="222">
          
          
          <code class="ruby">  # since all jwt token are now saved in database, it better to delete it manually</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="223">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="224">
          
          
          <code class="ruby">  # @apiName LogoutSession</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="225">
          
          
          <code class="ruby">  # @apiGroup Profile</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="226">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="227">
          
          
          <code class="ruby">  # @apiParam {String} access_token User access token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="228">
          
          
          <code class="ruby">  # @apiParam {String} devicetoken Device token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="229">
          
          
          <code class="ruby">  # =end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="230">
          <span class="hits">1</span>
          
          <code class="ruby">  def logout</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="231">
          
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="232">
          
          
          <code class="ruby">      devicetoken = params[:devicetoken]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="233">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="234">
          
          
          <code class="ruby">      if !devicetoken.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="235">
          
          
          <code class="ruby">        raise Exception.new(&quot;User device token must be present.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="236">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="237">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="238">
          
          
          <code class="ruby">      session = AuthSession.find_by(jwt_token: @current_jwt_token, user_id: @current_user.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="239">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="240">
          
          
          <code class="ruby">      if !session.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="241">
          
          
          <code class="ruby">        session.destroy</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="242">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="243">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="244">
          
          
          <code class="ruby">      userdevicetoken = UserDeviceToken.find_by(devicetoken: devicetoken, user_id: @current_user.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="245">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="246">
          
          
          <code class="ruby">      if !userdevicetoken.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="247">
          
          
          <code class="ruby">        userdevicetoken.destroy</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="248">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="249">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="250">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="251">
          
          
          <code class="ruby">        data: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="252">
          
          
          <code class="ruby">          message: &#39;Logout success.&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="253">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="254">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="255">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="256">
          
          
          <code class="ruby">    rescue ActiveRecord::RecordInvalid =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="257">
          
          
          <code class="ruby">      msg = &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="258">
          
          
          <code class="ruby">      e.record.errors.map do |k, v|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="259">
          
          
          <code class="ruby">        key = k.to_s.humanize</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="260">
          
          
          <code class="ruby">        msg = msg + &quot;#{key} #{v}, &quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="261">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="262">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="263">
          
          
          <code class="ruby">      msg = msg.chomp(&quot;, &quot;) + &quot;.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="264">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="265">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="266">
          
          
          <code class="ruby">          message: msg</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="267">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="268">
          
          
          <code class="ruby">        }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="269">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="270">
          
          
          <code class="ruby">      rescue Exception =&gt; e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="271">
          
          
          <code class="ruby">        render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="272">
          
          
          <code class="ruby">          error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="273">
          
          
          <code class="ruby">            message: e.message</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="274">
          
          
          <code class="ruby">          }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="275">
          
          
          <code class="ruby">          }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="276">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="277">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="278">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="279">
          
          
          <code class="ruby">  # =begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="280">
          
          
          <code class="ruby">  # @apiVersion 1.0.0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="281">
          
          
          <code class="ruby">  # @api {get} /api/v1/me/features My Active Features</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="282">
          
          
          <code class="ruby">  # @apiName My Active Features</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="283">
          
          
          <code class="ruby">  # @apiGroup Profile</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="284">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="285">
          
          
          <code class="ruby">  # @apiParam {String} access_token User access token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="286">
          
          
          <code class="ruby">  # =end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="287">
          <span class="hits">1</span>
          
          <code class="ruby">  def features</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="288">
          
          
          <code class="ruby">    user = @current_user</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="289">
          
          
          <code class="ruby">    user_features = user.features.pluck(:feature_id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="290">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="291">
          
          
          <code class="ruby">    # Looking for features that have been rolled out to production</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="292">
          
          
          <code class="ruby">    features = Feature.where(application_id: user.application_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="293">
          
          
          <code class="ruby">    features = features.where(is_rolled_out: true).pluck(:feature_id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="294">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="295">
          
          
          <code class="ruby">    user_features = features + user_features</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="296">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="297">
          
          
          <code class="ruby">    user_features = user_features.uniq</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="298">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="299">
          
          
          <code class="ruby">    render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="300">
          
          
          <code class="ruby">      status: &#39;success&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="301">
          
          
          <code class="ruby">      data: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="302">
          
          
          <code class="ruby">        features: user_features</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="303">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="304">
          
          
          <code class="ruby">    }, status: 200</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="305">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="306">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="307">
          
          
          <code class="ruby">  # =begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="308">
          
          
          <code class="ruby">  # @apiVersion 1.0.0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="309">
          
          
          <code class="ruby">  # @api {post} /api/v1/me/register_device_token Register Device Token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="310">
          
          
          <code class="ruby">  # @apiName Register Device Token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="311">
          
          
          <code class="ruby">  # @apiGroup Profile</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="312">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="313">
          
          
          <code class="ruby">  # @apiParam {String} access_token User access token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="314">
          
          
          <code class="ruby">  # @apiParam {String} devicetoken Device token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="315">
          
          
          <code class="ruby">  # @apiParam {String} user_type Device platform : &#39;android&#39; or &#39;ios&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="316">
          
          
          <code class="ruby">  # =end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="317">
          <span class="hits">1</span>
          
          <code class="ruby">  def register_device_token</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="318">
          
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="319">
          
          
          <code class="ruby">      if params[:user_type].nil? || !params[:user_type].present? || params[:user_type] == &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="320">
          
          
          <code class="ruby">        raise Exception.new(&quot;User type can&#39;t be empty.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="321">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="322">
          
          
          <code class="ruby">        if params[:user_type].downcase.delete(&#39; &#39;) != &quot;android&quot; &amp;&amp; params[:user_type].downcase.delete(&#39; &#39;) != &quot;ios&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="323">
          
          
          <code class="ruby">          raise Exception.new(&quot;Permitted user_type is &#39;android&#39; or &#39;ios&#39;.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="324">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="325">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="326">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="327">
          
          
          <code class="ruby">      if params[:devicetoken].nil? || !params[:devicetoken].present? || params[:devicetoken] == &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="328">
          
          
          <code class="ruby">        raise Exception.new(&quot;Device token can&#39;t be empty. Your user_type is #{params[:user_type]}&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="329">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="330">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="331">
          
          
          <code class="ruby">      userdevicetoken = UserDeviceToken.find_by(devicetoken: params[:devicetoken])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="332">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="333">
          
          
          <code class="ruby">      if userdevicetoken.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="334">
          
          
          <code class="ruby">        userdevicetoken = UserDeviceToken.new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="335">
          
          
          <code class="ruby">        userdevicetoken.devicetoken = params[:devicetoken]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="336">
          
          
          <code class="ruby">        userdevicetoken.user_type = params[:user_type]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="337">
          
          
          <code class="ruby">        userdevicetoken.user_id = @current_user.id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="338">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="339">
          
          
          <code class="ruby">        save_status = true if userdevicetoken.save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="340">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="341">
          
          
          <code class="ruby">        # if devicetoken is exist but with different user_id then update it with current user_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="342">
          
          
          <code class="ruby">        if userdevicetoken.user_id != @current_user.id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="343">
          
          
          <code class="ruby">          userdevicetoken.update_attribute(:user_id, @current_user.id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="344">
          
          
          <code class="ruby">          save_status = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="345">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="346">
          
          
          <code class="ruby">          # do nothing, because devicetoken already exist</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="347">
          
          
          <code class="ruby">          save_status = false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="348">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="349">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="350">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="351">
          
          
          <code class="ruby">      if save_status</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="352">
          
          
          <code class="ruby">        render :json =&gt; {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="353">
          
          
          <code class="ruby">          status: &quot;success&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="354">
          
          
          <code class="ruby">        }, status: 200</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="355">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="356">
          
          
          <code class="ruby">        render :json =&gt; {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="357">
          
          
          <code class="ruby">          status: &quot;already exists&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="358">
          
          
          <code class="ruby">        }, status: 200</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="359">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="360">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="361">
          
          
          <code class="ruby">    rescue Exception =&gt; e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="362">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="363">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="364">
          
          
          <code class="ruby">          message: e.message</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="365">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="366">
          
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="367">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="368">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="369">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="370">
          
          
          <code class="ruby">  # =begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="371">
          
          
          <code class="ruby">  # @apiVersion 1.0.0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="372">
          
          
          <code class="ruby">  # @api {post} /api/v1/me/delete_device_token Delete Device Token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="373">
          
          
          <code class="ruby">  # @apiName Delete Device Token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="374">
          
          
          <code class="ruby">  # @apiGroup Profile</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="375">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="376">
          
          
          <code class="ruby">  # @apiParam {String} access_token User access token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="377">
          
          
          <code class="ruby">  # @apiParam {String} devicetoken Device token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="378">
          
          
          <code class="ruby">  # =end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="379">
          <span class="hits">1</span>
          
          <code class="ruby">  def delete_device_token</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="380">
          
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="381">
          
          
          <code class="ruby">      if params[:devicetoken].nil? || !params[:devicetoken].present? || params[:devicetoken] == &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="382">
          
          
          <code class="ruby">        raise Exception.new(&quot;Please specify your device token.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="383">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="384">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="385">
          
          
          <code class="ruby">      userdevicetoken = UserDeviceToken.find_by(devicetoken: params[:devicetoken], user_id: @current_user.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="386">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="387">
          
          
          <code class="ruby">      if !userdevicetoken.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="388">
          
          
          <code class="ruby">        userdevicetoken.destroy</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="389">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="390">
          
          
          <code class="ruby">        raise Exception.new(&quot;User device token is not found.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="391">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="392">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="393">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="394">
          
          
          <code class="ruby">        status: &#39;success&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="395">
          
          
          <code class="ruby">        data: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="396">
          
          
          <code class="ruby">          devicetoken: userdevicetoken</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="397">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="398">
          
          
          <code class="ruby">      }, status: 200</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="399">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="400">
          
          
          <code class="ruby">    rescue Exception =&gt; e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="401">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="402">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="403">
          
          
          <code class="ruby">          message: e.message</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="404">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="405">
          
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="406">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="407">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="408">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="409">
          
          
          <code class="ruby">  # =begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="410">
          
          
          <code class="ruby">  # @apiVersion 1.0.0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="411">
          
          
          <code class="ruby">  # @api {post} /api/v1/me/identity_token Get Identity Token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="412">
          
          
          <code class="ruby">  # @apiName Get Identity Token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="413">
          
          
          <code class="ruby">  # @apiGroup Profile</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="414">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="415">
          
          
          <code class="ruby">  # @apiParam {String} access_token User access token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="416">
          
          
          <code class="ruby">  # @apiParam {String} nonce Nonce from SDK</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="417">
          
          
          <code class="ruby">  # =end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="418">
          <span class="hits">1</span>
          
          <code class="ruby">  def identity_token</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="419">
          
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="420">
          
          
          <code class="ruby">      nonce = params[:nonce]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="421">
          
          
          <code class="ruby">      if nonce.nil? || !nonce.present? || nonce == &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="422">
          
          
          <code class="ruby">        raise Exception.new(&quot;Nonce can&#39;t be empty.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="423">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="424">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="425">
          
          
          <code class="ruby">      user = @current_user</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="426">
          
          
          <code class="ruby">      application = user.application</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="427">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="428">
          
          
          <code class="ruby">      email_sdk = user.qiscus_email</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="429">
          
          
          <code class="ruby">      username = user.fullname</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="430">
          
          
          <code class="ruby">      if username.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="431">
          
          
          <code class="ruby">        username = params[:user][:phone_number]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="432">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="433">
          
          
          <code class="ruby">      avatar_url = user.avatar_url</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="434">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="435">
          
          
          <code class="ruby">      payload = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="436">
          
          
          <code class="ruby">        &quot;iss&quot;: application.app_id, # your qiscus app id, can obtained from dashboard</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="437">
          
          
          <code class="ruby">        &quot;iat&quot;: Time.now.to_i, # current timestamp in unix</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="438">
          
          
          <code class="ruby">        &quot;exp&quot;: (Time.now + 2*60).to_i, # An arbitrary time in the future when this token should expire. In epoch/unix time. We encourage you to limit 2 minutes</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="439">
          
          
          <code class="ruby">        &quot;nbf&quot;: Time.now.to_i, # current timestamp in unix</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="440">
          
          
          <code class="ruby">        &quot;nce&quot;: nonce, # nonce string from nonce API</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="441">
          
          
          <code class="ruby">        &quot;prn&quot;: email_sdk, # your user identity such as email</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="442">
          
          
          <code class="ruby">        &quot;name&quot;: &quot;&quot;, # optional, string for user name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="443">
          
          
          <code class="ruby">        &quot;avatar_url&quot;: &quot;&quot; # optional, string url of user avatar</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="444">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="445">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="446">
          
          
          <code class="ruby">      header = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="447">
          
          
          <code class="ruby">        &quot;alg&quot;: &quot;HS256&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="448">
          
          
          <code class="ruby">        &quot;typ&quot;: &quot;JWT&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="449">
          
          
          <code class="ruby">        &quot;ver&quot;: &quot;v2&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="450">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="451">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="452">
          
          
          <code class="ruby">      # generate identity_token using nonce</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="453">
          
          
          <code class="ruby">      identity_token = JWT.encode(payload, application.qiscus_sdk_secret, &#39;HS256&#39;, header)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="454">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="455">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="456">
          
          
          <code class="ruby">        data: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="457">
          
          
          <code class="ruby">          identity_token: identity_token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="458">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="459">
          
          
          <code class="ruby">      } and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="460">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="461">
          
          
          <code class="ruby">    rescue Exception =&gt; e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="462">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="463">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="464">
          
          
          <code class="ruby">          message: e.message</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="465">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="466">
          
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="467">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="468">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="469">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="470">
          <span class="hits">1</span>
          
          <code class="ruby">      private</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="471">
          <span class="hits">1</span>
          
          <code class="ruby">      def ensure_update_profile_params</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="472">
          <span class="hits">5</span>
          
          <code class="ruby">        params.require(:user).permit(:fullname, :email, :gender, :date_of_birth, :is_public, :description)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="473">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="474">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="475">
          <span class="hits">1</span>
          
          <code class="ruby">      def ensure_update_avatar_params</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="476">
          
          
          <code class="ruby">        @avatar_file = params[:avatar_file]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="477">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="478">
          
          
          <code class="ruby">        render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="479">
          
          
          <code class="ruby">          status: &#39;fail&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="480">
          
          
          <code class="ruby">          message: &#39;invalid avatar file&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="481">
          
          
          <code class="ruby">          }, status: 422 unless @avatar_file</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="482">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="483">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="484">
          
          
          <code class="ruby">      end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="a31cf0fe144ba12633de4c3d543684c7fb0c71c8">
  <div class="header">
    <h3>app/controllers/api/v1/posts/comments_controller.rb</h3>
    <h4><span class="red">53.54 %</span> covered</h4>
    <div>
      <b>99</b> relevant lines. 
      <span class="green"><b>53</b> lines covered</span> and
      <span class="red"><b>46</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class Api::V1::Posts::CommentsController &lt; ProtectedController</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  before_action :authorize_user</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  before_action :media_params, only: [:create]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">  # =begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">  # @apiVersion 1.0.0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">  # @api {get} /api/v1/posts/:post_id/comments Get Post Comments</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">  # @apiDescription Get Post Comments</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">  # @apiName GetPostComments</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">  # @apiGroup Post</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">  # @apiParam {String} access_token User access token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">  # @apiParam {Number} post_id Post id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">  # @apiParam {Number} [page=1] Pagination. Per page is 25 record.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">  # =end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  def index</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">      post = Post.find(params[:post_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">      if post.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">        raise Exception.new(&#39;Post not found.&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">      per_page = 25</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">      comments = post.comments.includes(:comment_media, :user).where(comment_id: nil).order(created_at: :asc)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">      total_comments = comments.count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">      total_page = (total_comments/per_page.to_f).ceil</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">      total_page = ((total_comments / per_page) &lt;= 0) ? 1 : (total_page)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">      # if page is empty then it will display last page</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">      if params[:page].nil? || params[:page] == &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">        page = total_page</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">        page = params[:page]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">      comments = comments.page(page)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">        meta: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">          current_page: page,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">          per_page: per_page,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">          total_page: total_page,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">          total_comments: total_comments</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">        },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">        data: comments</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">    rescue Exception =&gt; e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">          message: e.message,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">          backtrace: e.backtrace</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">  # =begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">  # @apiVersion 1.0.0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">  # @api {post} /api/v1/posts/:post_id/comments Create New Comments</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">  # @apiDescription Create Post Comments</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">  # @apiName CreatePostComments</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">  # @apiGroup Post</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">  # @apiParam {String} access_token User access token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">  # @apiParam {Number} post_id Post id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">  # @apiParam {String} content Comment text content. Maximum length of comment is 400 character</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">  # @apiParam {Array} media[] Comment media, must be an array of file. This is optional.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">  # @apiParam {Number} [parent_comment_id=null] Parent comment id.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">  # @apiParam {String} [show_media_list_as] You can show media as an object (will return first media), or as an array (will retun array of media).</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">  # Default is return object. Possible value is `array` or `object`.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">  # =end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="74">
          <span class="hits">1</span>
          
          <code class="ruby">  def create</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="75">
          <span class="hits">3</span>
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="76">
          <span class="hits">3</span>
          
          <code class="ruby">      post = Post.find_by(id: params[:post_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="78">
          <span class="hits">3</span>
          
          <code class="ruby">      if post.nil?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="79">
          <span class="hits">1</span>
          
          <code class="ruby">        raise Exception.new(&#39;Post not found.&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="82">
          <span class="hits">2</span>
          
          <code class="ruby">      if params[:content].nil? || params[:content] == &quot;&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="83">
          <span class="hits">1</span>
          
          <code class="ruby">        raise Exception.new(&quot;Comment content cannot be empty.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="86">
          <span class="hits">1</span>
          
          <code class="ruby">      media = []</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="87">
          <span class="hits">1</span>
          
          <code class="ruby">      comment = Comment.new</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="88">
          <span class="hits">1</span>
          
          <code class="ruby">      ActiveRecord::Base.transaction do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="89">
          <span class="hits">1</span>
          
          <code class="ruby">        comment.user_id = @current_user.id</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="90">
          <span class="hits">1</span>
          
          <code class="ruby">        comment.post_id = post.id</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="91">
          <span class="hits">1</span>
          
          <code class="ruby">        comment.content = params[:content]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">        # In nested comment, check whether comment parent is really parrent or not.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">        # If it is child comment, then raise an error</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="95">
          <span class="hits">1</span>
          
          <code class="ruby">        if !params[:parent_comment_id].nil? &amp;&amp; params[:parent_comment_id] != &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="96">
          
          
          <code class="ruby">          parent_comment = Comment.find(params[:parent_comment_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="97">
          
          
          <code class="ruby">          if parent_comment.comment_id.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="98">
          
          
          <code class="ruby">            comment.comment_id = parent_comment.id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="100">
          
          
          <code class="ruby">            raise Exception.new(&quot;Cannot comment in child comment section.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="104">
          <span class="hits">1</span>
          
          <code class="ruby">        save = comment.save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="106">
          <span class="hits">1</span>
          
          <code class="ruby">        raise Exception.new(&quot;Comment maximum character is 400.&quot;) unless save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="108">
          <span class="hits">1</span>
          
          <code class="ruby">        media_params = @media_params</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="109">
          <span class="hits">1</span>
          
          <code class="ruby">        qiscus_sdk = QiscusSdk.new(@current_user.application.app_id, @current_user.application.qiscus_sdk_secret)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby">        # iterate over media params</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="111">
          <span class="hits">1</span>
          
          <code class="ruby">        media_params.each do | medium |</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby">          # comment media inside transaction</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby">          # this ensure all media successfully saved in another service then save it to db</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="114">
          
          
          <code class="ruby">          url = qiscus_sdk.upload_file(@current_user.qiscus_token, medium)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby">          # tmp = MimeMagic.by_magic(medium) # caused &#39;closed stream problem&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="117">
          
          
          <code class="ruby">          tmp = MimeMagic.by_path(url)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="118">
          
          
          <code class="ruby">          tmp = JSON.parse(tmp.to_json) # will return hash</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="119">
          
          
          <code class="ruby">          tmp = tmp.merge({ content_type: tmp[&quot;type&quot;] })</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="120">
          
          
          <code class="ruby">          tmp = tmp.merge({ media_type: tmp[&quot;mediatype&quot;] })</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="121">
          
          
          <code class="ruby">          tmp = tmp.merge({ sub_type: tmp[&quot;subtype&quot;] })</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby">          # The single-table inheritance mechanism failed to locate the subclass: &#39;image/png&#39;.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">          # This error is raised because the column &#39;type&#39; is reserved for storing the class in case of inheritance.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby">          # Please rename this column if you didn&#39;t intend it to be used for storing the inheritance class or overwrite</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby">          # PostMedia.inheritance_column to use another column for that information.</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="127">
          
          
          <code class="ruby">          tmp.delete(&quot;type&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="128">
          
          
          <code class="ruby">          tmp.delete(&quot;mediatype&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="129">
          
          
          <code class="ruby">          tmp.delete(&quot;subtype&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="130">
          
          
          <code class="ruby">          tmp = tmp.merge({ size: medium.size, original_filename: medium.original_filename })</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby">          # 60 compressed</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="133">
          
          
          <code class="ruby">          split_url = url.split(&quot;/upload/&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="134">
          
          
          <code class="ruby">          compressed_link = split_url[0] + &quot;/upload/q_60/&quot; + split_url[1]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="135">
          
          
          <code class="ruby">          tmp = tmp.merge({ link: url, compressed_link: compressed_link })</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby">          # add comment id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="138">
          
          
          <code class="ruby">          tmp = tmp.merge({ comment_id: comment.id })</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="139">
          
          
          <code class="ruby">          tmp = tmp.merge({ additional_info: {} }) # since using qiscus uploaderi there is no addtional info</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="141">
          
          
          <code class="ruby">          media.push(tmp)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="142">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby">        # insert comment media</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="145">
          <span class="hits">1</span>
          
          <code class="ruby">        CommentMedia.create(media)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="148">
          <span class="hits">1</span>
          
          <code class="ruby">      post_id = post.id</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="149">
          <span class="hits">1</span>
          
          <code class="ruby">			post_owner_id = post.user_id</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="150">
          <span class="hits">1</span>
          
          <code class="ruby">      post_commenter_id = @current_user.id</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="151">
          <span class="hits">1</span>
          
          <code class="ruby">      user_ids = post.comments.pluck(:user_id) # get all user who was commented</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="152">
          <span class="hits">1</span>
          
          <code class="ruby">			user_ids = user_ids &lt;&lt; post_owner_id</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="153">
          <span class="hits">1</span>
          
          <code class="ruby">      user_ids = user_ids.uniq</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="154">
          <span class="hits">1</span>
          
          <code class="ruby">      user_ids -= [post_commenter_id] # no need to send PN to his self</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="156">
          <span class="hits">1</span>
          
          <code class="ruby">      show_media_list_as = params[:show_media_list_as]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="157">
          <span class="hits">1</span>
          
          <code class="ruby">      if show_media_list_as == &quot;array&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="158">
          
          
          <code class="ruby">        post = post.as_post_list_json</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="160">
          <span class="hits">1</span>
          
          <code class="ruby">        post = post.as_json</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="161">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="163">
          <span class="hits">1</span>
          
          <code class="ruby">      CommentPushNotificationJob.perform_later(post_id, post_commenter_id, user_ids, show_media_list_as)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="164">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="165">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="166">
          
          
          <code class="ruby">        data: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="167">
          
          
          <code class="ruby">          post: post,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="168">
          
          
          <code class="ruby">          comments: comment</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="169">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="170">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="171">
          <span class="hits">1</span>
          
          <code class="ruby">      }, status: 200 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="172">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="173">
          <span class="hits">2</span>
          
          <code class="ruby">    rescue ActiveRecord::RecordInvalid =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="174">
          
          
          <code class="ruby">      msg = &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="175">
          
          
          <code class="ruby">      e.record.errors.map do |k, v|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="176">
          
          
          <code class="ruby">        key = k.to_s.humanize</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="177">
          
          
          <code class="ruby">        msg = msg + &quot;#{key} #{v}, &quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="178">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="179">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="180">
          
          
          <code class="ruby">      msg = msg.chomp(&quot;, &quot;) + &quot;.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="181">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="182">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="183">
          
          
          <code class="ruby">          message: msg</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="184">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="185">
          
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="186">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="187">
          
          
          <code class="ruby">    rescue Exception =&gt; e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="188">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="189">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="190">
          
          
          <code class="ruby">          message: e.message</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="191">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="192">
          <span class="hits">2</span>
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="193">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="194">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="195">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="196">
          
          
          <code class="ruby">  # =begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="197">
          
          
          <code class="ruby">  # @apiVersion 1.0.0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="198">
          
          
          <code class="ruby">  # @api {delete} /api/v1/posts/:post_id/comments/:comment_id Delete Own Comment</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="199">
          
          
          <code class="ruby">  # @apiDescription Only Own Comment and Own Post Can Delete Comment</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="200">
          
          
          <code class="ruby">  # @apiName DeleteComment</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="201">
          
          
          <code class="ruby">  # @apiGroup Post</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="202">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="203">
          
          
          <code class="ruby">  # @apiParam {String} access_token User access token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="204">
          
          
          <code class="ruby">  # @apiParam {Number} post_id Post id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="205">
          
          
          <code class="ruby">  # @apiParam {Number} comment_id Comment id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="206">
          
          
          <code class="ruby">  # =end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="207">
          <span class="hits">1</span>
          
          <code class="ruby">  def destroy</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="208">
          <span class="hits">3</span>
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="209">
          <span class="hits">3</span>
          
          <code class="ruby">      comment = Comment.find_by(id: params[:id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="210">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="211">
          <span class="hits">3</span>
          
          <code class="ruby">      if comment.nil?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="212">
          <span class="hits">1</span>
          
          <code class="ruby">        raise Exception.new(&quot;Comment not found.&quot;)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="213">
          <span class="hits">2</span>
          
          <code class="ruby">      elsif comment.post.user_id == @current_user.id || comment.user_id == @current_user.id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="214">
          
          
          <code class="ruby">        # delete by post owner or comment owner</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="215">
          <span class="hits">1</span>
          
          <code class="ruby">        comment.delete</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="216">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="217">
          <span class="hits">1</span>
          
          <code class="ruby">        raise Exception.new(&quot;Not post owner or comment owner.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="218">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="219">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="220">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="221">
          
          
          <code class="ruby">        data: comment</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="222">
          <span class="hits">1</span>
          
          <code class="ruby">      } and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="223">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="224">
          <span class="hits">2</span>
          
          <code class="ruby">    rescue Exception =&gt; e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="225">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="226">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="227">
          
          
          <code class="ruby">          message: e.message</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="228">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="229">
          <span class="hits">2</span>
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="230">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="231">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="232">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="233">
          <span class="hits">1</span>
          
          <code class="ruby">  private</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="234">
          <span class="hits">1</span>
          
          <code class="ruby">    def media_params</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="235">
          <span class="hits">3</span>
          
          <code class="ruby">      if params[:media].present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="236">
          
          
          <code class="ruby">        if params[:media].is_a?(Array)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="237">
          
          
          <code class="ruby">          @media_params = params[:media]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="238">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="239">
          
          
          <code class="ruby">          render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="240">
          
          
          <code class="ruby">            error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="241">
          
          
          <code class="ruby">              message: &#39;Media must be an array of file.&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="242">
          
          
          <code class="ruby">            }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="243">
          
          
          <code class="ruby">          }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="244">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="245">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="246">
          <span class="hits">3</span>
          
          <code class="ruby">        @media_params = []</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="247">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="248">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="249">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="250">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="20e582a7b9f7255ec203ecabd747a005550e2d78">
  <div class="header">
    <h3>app/controllers/api/v1/posts_controller.rb</h3>
    <h4><span class="red">43.24 %</span> covered</h4>
    <div>
      <b>148</b> relevant lines. 
      <span class="green"><b>64</b> lines covered</span> and
      <span class="red"><b>84</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class Api::V1::PostsController &lt; ProtectedController</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  before_action :authorize_user</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  before_action :media_params, only: [:create]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">  # =begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">  # @apiVersion 1.0.0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">  # @api {get} /api/v1/posts Get Posts</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">  # @apiDescription Get Post</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">  # @apiName GetPost</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">  # @apiGroup Post</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">  # @apiParam {String} access_token User access token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">  # @apiParam {Number} [page=1] Pagination. Per page is 25 record.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">  # @apiParam {String} [show_media_list_as] You can show media as an object (will return first media), or as an array (will retun array of media).</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">  # Default is return object. Possible value is `array` or `object`.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">  # =end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">  def index</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">    # get post from user contact, own self and official account</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="19">
          <span class="hits">2</span>
          
          <code class="ruby">    user_ids = @current_user.contacts.pluck(:contact_id).to_a + [@current_user.id]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">    # official account inclusion</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="22">
          <span class="hits">2</span>
          
          <code class="ruby">    role_official_user = Role.official</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="23">
          <span class="hits">2</span>
          
          <code class="ruby">    user_role_ids = UserRole.where(role_id: role_official_user.id).pluck(:user_id).to_a</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="24">
          <span class="hits">2</span>
          
          <code class="ruby">    official_account = User.where(&quot;id IN (?)&quot;, user_role_ids).where(application_id: @current_user.application_id)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="25">
          <span class="hits">2</span>
          
          <code class="ruby">    official_account = official_account.where.not(id: @current_user.id)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="26">
          <span class="hits">2</span>
          
          <code class="ruby">    official_account = official_account.pluck(:id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="28">
          <span class="hits">2</span>
          
          <code class="ruby">		user_ids = user_ids + official_account</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="29">
          <span class="hits">4</span>
          
          <code class="ruby">    user_ids = user_ids.uniq{|item| item}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="31">
          <span class="hits">2</span>
          
          <code class="ruby">    total_posts = Post.where(&quot;posts.user_id IN (?)&quot;, user_ids).count</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="32">
          <span class="hits">2</span>
          
          <code class="ruby">    posts = Post.where(&quot;posts.user_id IN (?)&quot;, user_ids).order(created_at: :desc).page(params[:page])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="34">
          <span class="hits">2</span>
          
          <code class="ruby">    show_media_list_as = params[:show_media_list_as]</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="35">
          <span class="hits">2</span>
          
          <code class="ruby">    if show_media_list_as == &quot;array&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">      posts = posts.map do | post |</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">        post.as_post_list_json</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="40">
          <span class="hits">2</span>
          
          <code class="ruby">      posts = posts.as_json</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="43">
          <span class="hits">2</span>
          
          <code class="ruby">    posts = posts.map do |e|</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="44">
          <span class="hits">2</span>
          
          <code class="ruby">      liked_post = Like.find_by(user_id: @current_user.id, post_id: e[&quot;id&quot;])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">      # default value is_liked_post = false</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="47">
          <span class="hits">2</span>
          
          <code class="ruby">      is_liked_post = false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="49">
          <span class="hits">2</span>
          
          <code class="ruby">      is_liked_post = true unless liked_post.nil?</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="50">
          <span class="hits">2</span>
          
          <code class="ruby">      e.merge!(&#39;is_liked_post&#39; =&gt; is_liked_post )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="53">
          <span class="hits">2</span>
          
          <code class="ruby">    render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">      meta: {</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="55">
          <span class="hits">2</span>
          
          <code class="ruby">        current_page: (params[:page].to_i &lt;= 0) ? 1 : params[:page].to_i,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">        per_page: 25,</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="57">
          <span class="hits">2</span>
          
          <code class="ruby">        total_page: ((total_posts / 25) &lt;= 0 ) ? 1 : (total_posts / 25),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">        total_posts: total_posts</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">      },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">      data: posts</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">  # =begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">  # @apiVersion 1.0.0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">  # @api {post} /api/v1/posts Create or Share A Post</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">  # @apiDescription Create post or sharing a post</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">  # @apiName CreateOrSharePost</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">  # @apiGroup Post</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">  # @apiParam {String} access_token User access token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">  # @apiParam {String} content Post text content</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">  # @apiParam {Array} media[] Post media, must be an array of file. This is optional.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">  # @apiParam {Number} [share_post_id=null] Post to share. This is optional.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">  # @apiParam {String} [link=null] Url media to share or included in post media. This is optional.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">  # @apiParam {String} [link_meta=null] Link meta should contain pre-fetch data such as title or caption. This must be valid JSON string, otherwise will return error</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">  # @apiParam {String} [show_media_list_as] You can show media as an object (will return first media), or as an array (will retun array of media).</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">  # Default is return object. Possible value is `array` or `object`.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">  # =end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="80">
          <span class="hits">1</span>
          
          <code class="ruby">  def create</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="81">
          <span class="hits">2</span>
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="82">
          <span class="hits">2</span>
          
          <code class="ruby">      media = []</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="83">
          <span class="hits">2</span>
          
          <code class="ruby">      post = Post.new</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="84">
          <span class="hits">2</span>
          
          <code class="ruby">      post.user_id = @current_user.id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">      # if user share a post than the content and media can be empty</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="87">
          <span class="hits">2</span>
          
          <code class="ruby">      if !params[:share_post_id].present? || params[:share_post_id].nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">        # if user create a new post then content or media cannot be empty</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="89">
          <span class="hits">2</span>
          
          <code class="ruby">        if !params[:content].present? &amp;&amp; @media_params.empty?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="90">
          <span class="hits">1</span>
          
          <code class="ruby">          raise Exception.new(&quot;Post content or media cannot be empty.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="94">
          <span class="hits">1</span>
          
          <code class="ruby">      ActiveRecord::Base.transaction do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">        # create post</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="96">
          <span class="hits">1</span>
          
          <code class="ruby">        post.content = params[:content]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">        # In sharing mode, we must check whether the post that will be share is parent post or not.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">        # To check it, look if post_id on that post is null (if null = parent, if not null = shared post).</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby">        # If not parent post, then post_id is marked as post_id to shared post.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">        # This to avoid recursive shared post.</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="102">
          <span class="hits">1</span>
          
          <code class="ruby">        if !params[:share_post_id].nil? &amp;&amp; params[:share_post_id] != &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="103">
          
          
          <code class="ruby">          shared_post = Post.find(params[:share_post_id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="104">
          
          
          <code class="ruby">          if shared_post.post_id.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="105">
          
          
          <code class="ruby">            post.post_id = shared_post.id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="107">
          
          
          <code class="ruby">            post.post_id = shared_post.post_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="110">
          
          
          <code class="ruby">          post.is_shared_post = true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="111">
          
          
          <code class="ruby">          post.share_referrer_id = shared_post.user_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="114">
          <span class="hits">1</span>
          
          <code class="ruby">        post.save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="116">
          <span class="hits">1</span>
          
          <code class="ruby">        media_params = @media_params</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="117">
          <span class="hits">1</span>
          
          <code class="ruby">        qiscus_sdk = QiscusSdk.new(@current_user.application.app_id, @current_user.application.qiscus_sdk_secret)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">        # iterate over media params</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="119">
          <span class="hits">1</span>
          
          <code class="ruby">        media_params.each do | medium |</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby">          # post media inside transaction</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby">          # this ensure all media successfully saved in another service then save it to db</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="122">
          
          
          <code class="ruby">          url = qiscus_sdk.upload_file(@current_user.qiscus_token, medium)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">          # tmp = MimeMagic.by_magic(medium) # caused &#39;closed stream problem&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="125">
          
          
          <code class="ruby">          tmp = MimeMagic.by_path(url)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="126">
          
          
          <code class="ruby">          tmp = JSON.parse(tmp.to_json) # will return hash</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="127">
          
          
          <code class="ruby">          tmp = tmp.merge({ content_type: tmp[&quot;type&quot;] })</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="128">
          
          
          <code class="ruby">          tmp = tmp.merge({ media_type: tmp[&quot;mediatype&quot;] })</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="129">
          
          
          <code class="ruby">          tmp = tmp.merge({ sub_type: tmp[&quot;subtype&quot;] })</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="130">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby">          # The single-table inheritance mechanism failed to locate the subclass: &#39;image/png&#39;.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby">          # This error is raised because the column &#39;type&#39; is reserved for storing the class in case of inheritance.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby">          # Please rename this column if you didn&#39;t intend it to be used for storing the inheritance class or overwrite</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby">          # PostMedia.inheritance_column to use another column for that information.</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="135">
          
          
          <code class="ruby">          tmp.delete(&quot;type&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="136">
          
          
          <code class="ruby">          tmp.delete(&quot;mediatype&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="137">
          
          
          <code class="ruby">          tmp.delete(&quot;subtype&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="138">
          
          
          <code class="ruby">          tmp = tmp.merge({ size: medium.size, original_filename: medium.original_filename })</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby">          # 60 compressed</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby">          # split url</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="142">
          
          
          <code class="ruby">          split_url = url.split(&quot;/upload/&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="143">
          
          
          <code class="ruby">          compressed_link = split_url[0] + &quot;/upload/q_60/&quot; + split_url[1]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="144">
          
          
          <code class="ruby">          tmp = tmp.merge({ link: url, compressed_link: compressed_link })</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby">          # add post id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="147">
          
          
          <code class="ruby">          tmp = tmp.merge({ post_id: post.id })</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="148">
          
          
          <code class="ruby">          tmp = tmp.merge({ additional_info: {} }) # since using qiscus uploaderi there is no addtional info</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="150">
          
          
          <code class="ruby">          media.push(tmp)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby">        # add link media to post media</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="154">
          <span class="hits">1</span>
          
          <code class="ruby">        if params[:link] != &quot;&quot; &amp;&amp; params[:link].present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="155">
          
          
          <code class="ruby">          link_meta = {}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="156">
          
          
          <code class="ruby">          if params[:link_meta].present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="157">
          
          
          <code class="ruby">            if params[:link_meta].is_a?(String)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="158">
          
          
          <code class="ruby">              begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="159">
          
          
          <code class="ruby">                link_meta = JSON.parse(params[:link_meta])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="160">
          
          
          <code class="ruby">              rescue Exception =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="161">
          
          
          <code class="ruby">                raise Exception.new(&#39;Link meta params is malformed JSON string.&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby">              end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby">            else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="164">
          
          
          <code class="ruby">              raise Exception.new(&#39;Link meta params must be string.&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="165">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="166">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="167">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="168">
          
          
          <code class="ruby">          link_media = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="169">
          
          
          <code class="ruby">            content_type: &#39;text/plain&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="170">
          
          
          <code class="ruby">            media_type: &#39;url&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="171">
          
          
          <code class="ruby">            sub_type: &#39;http&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="172">
          
          
          <code class="ruby">            size: params[:link].size,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="173">
          
          
          <code class="ruby">            original_filename: params[:link],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="174">
          
          
          <code class="ruby">            compressed_link: params[:link],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="175">
          
          
          <code class="ruby">            link: params[:link],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="176">
          
          
          <code class="ruby">            post_id: post.id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="177">
          
          
          <code class="ruby">            additional_info: link_meta</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="178">
          
          
          <code class="ruby">          }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="179">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="180">
          
          
          <code class="ruby">          media.push(link_media)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="181">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="182">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="183">
          
          
          <code class="ruby">        # add post media</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="184">
          <span class="hits">1</span>
          
          <code class="ruby">        PostMedia.create(media)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="185">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="186">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="187">
          <span class="hits">1</span>
          
          <code class="ruby">      if params[:show_media_list_as] == &quot;array&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="188">
          
          
          <code class="ruby">        post = post.as_post_list_json</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="189">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="190">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="191">
          <span class="hits">1</span>
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="192">
          
          
          <code class="ruby">        data: post</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="193">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="194">
          <span class="hits">1</span>
          
          <code class="ruby">    rescue ActiveRecord::RecordInvalid =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="195">
          
          
          <code class="ruby">      msg = &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="196">
          
          
          <code class="ruby">      e.record.errors.map do |k, v|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="197">
          
          
          <code class="ruby">        key = k.to_s.humanize</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="198">
          
          
          <code class="ruby">        msg = msg + &quot;#{key} #{v}, &quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="199">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="200">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="201">
          
          
          <code class="ruby">      msg = msg.chomp(&quot;, &quot;) + &quot;.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="202">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="203">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="204">
          
          
          <code class="ruby">          message: msg</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="205">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="206">
          
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="207">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="208">
          
          
          <code class="ruby">    rescue Exception =&gt; e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="209">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="210">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="211">
          
          
          <code class="ruby">          message: e.message</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="212">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="213">
          <span class="hits">1</span>
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="214">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="215">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="216">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="217">
          
          
          <code class="ruby">  # =begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="218">
          
          
          <code class="ruby">  # @apiVersion 1.0.0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="219">
          
          
          <code class="ruby">  # @api {delete} /api/v1/posts/:post_id Delete Posts</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="220">
          
          
          <code class="ruby">  # @apiDescription Delete Post, only post owner can delete a post. This is alias for delete `/api/v1/me/post/:post_id `</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="221">
          
          
          <code class="ruby">  # @apiName DeletePost</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="222">
          
          
          <code class="ruby">  # @apiGroup Post</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="223">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="224">
          
          
          <code class="ruby">  # @apiParam {String} access_token User access token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="225">
          
          
          <code class="ruby">  # @apiParam {Number} post_id Post id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="226">
          
          
          <code class="ruby">  # @apiParam {String} [show_media_list_as] You can show media as an object (will return first media), or as an array (will retun array of media).</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="227">
          
          
          <code class="ruby">  # =end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="228">
          <span class="hits">1</span>
          
          <code class="ruby">  def destroy</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="229">
          <span class="hits">2</span>
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="230">
          <span class="hits">2</span>
          
          <code class="ruby">      post = Post.where(user_id: @current_user.id).where(id: params[:id]).first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="231">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="232">
          <span class="hits">2</span>
          
          <code class="ruby">      if post.nil?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="233">
          <span class="hits">1</span>
          
          <code class="ruby">        raise Exception.new(&quot;Post not found&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="234">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="235">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="236">
          <span class="hits">1</span>
          
          <code class="ruby">      post.delete</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="237">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="238">
          <span class="hits">1</span>
          
          <code class="ruby">      show_media_list_as = params[:show_media_list_as]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="239">
          <span class="hits">1</span>
          
          <code class="ruby">      if show_media_list_as == &quot;array&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="240">
          
          
          <code class="ruby">        post = post.as_post_list_json</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="241">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="242">
          <span class="hits">1</span>
          
          <code class="ruby">        post = post.as_json</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="243">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="244">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="245">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="246">
          
          
          <code class="ruby">        data: post</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="247">
          <span class="hits">1</span>
          
          <code class="ruby">      } and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="248">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="249">
          <span class="hits">1</span>
          
          <code class="ruby">    rescue Exception =&gt; e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="250">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="251">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="252">
          
          
          <code class="ruby">          message: e.message</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="253">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="254">
          <span class="hits">1</span>
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="255">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="256">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="257">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="258">
          
          
          <code class="ruby">  # =begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="259">
          
          
          <code class="ruby">  # @apiVersion 1.0.0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="260">
          
          
          <code class="ruby">  # @api {patch} /api/v1/posts/:post_id Update Post</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="261">
          
          
          <code class="ruby">  # @apiDescription Update Post</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="262">
          
          
          <code class="ruby">  # @apiName UpdatePost</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="263">
          
          
          <code class="ruby">  # @apiGroup Post</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="264">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="265">
          
          
          <code class="ruby">  # @apiParam {String} access_token User access token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="266">
          
          
          <code class="ruby">  # @apiParam {String} content New content</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="267">
          
          
          <code class="ruby">  # @apiParam {String} [show_media_list_as] You can show media as an object (will return first media), or as an array (will retun array of media).</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="268">
          
          
          <code class="ruby">  # =end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="269">
          <span class="hits">1</span>
          
          <code class="ruby">  def update</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="270">
          
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="271">
          
          
          <code class="ruby">      if !params[:content].present? || params[:content] == &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="272">
          
          
          <code class="ruby">        raise Exception.new(&quot;Post content cannot be empty.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="273">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="274">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="275">
          
          
          <code class="ruby">      post = Post.find(params[:id])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="276">
          
          
          <code class="ruby">      if post.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="277">
          
          
          <code class="ruby">        raise Exception.new(&quot;Post not found.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="278">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="279">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="280">
          
          
          <code class="ruby">      # only post owner that can update post</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="281">
          
          
          <code class="ruby">      if post.user_id != @current_user.id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="282">
          
          
          <code class="ruby">        raise Exception.new(&quot;Only post owner that can update post.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="283">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="284">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="285">
          
          
          <code class="ruby">      ActiveRecord::Base.transaction do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="286">
          
          
          <code class="ruby">        # only update when old content and new content is different</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="287">
          
          
          <code class="ruby">        if params[:content] != post.content</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="288">
          
          
          <code class="ruby">          # update post</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="289">
          
          
          <code class="ruby">          old_content = post.content # get old content and then save it to post_history table</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="290">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="291">
          
          
          <code class="ruby">          post.content = params[:content]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="292">
          
          
          <code class="ruby">          post.is_updated_post = true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="293">
          
          
          <code class="ruby">          post.save!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="294">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="295">
          
          
          <code class="ruby">          # save old_content to</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="296">
          
          
          <code class="ruby">          post_history = PostHistory.new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="297">
          
          
          <code class="ruby">          post_history.user_id = @current_user.id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="298">
          
          
          <code class="ruby">          post_history.content = old_content</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="299">
          
          
          <code class="ruby">          post_history.post_id = post.id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="300">
          
          
          <code class="ruby">          post_history.save!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="301">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="302">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="303">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="304">
          
          
          <code class="ruby">      show_media_list_as = params[:show_media_list_as]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="305">
          
          
          <code class="ruby">      if show_media_list_as == &quot;array&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="306">
          
          
          <code class="ruby">        post = post.as_post_list_json</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="307">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="308">
          
          
          <code class="ruby">        post = post.as_json</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="309">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="310">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="311">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="312">
          
          
          <code class="ruby">        data: post</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="313">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="314">
          
          
          <code class="ruby">    rescue ActiveRecord::RecordInvalid =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="315">
          
          
          <code class="ruby">      msg = &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="316">
          
          
          <code class="ruby">      e.record.errors.map do |k, v|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="317">
          
          
          <code class="ruby">        key = k.to_s.humanize</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="318">
          
          
          <code class="ruby">        msg = msg + &quot;#{key} #{v}, &quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="319">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="320">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="321">
          
          
          <code class="ruby">      msg = msg.chomp(&quot;, &quot;) + &quot;.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="322">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="323">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="324">
          
          
          <code class="ruby">          message: msg</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="325">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="326">
          
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="327">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="328">
          
          
          <code class="ruby">    rescue Exception =&gt; e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="329">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="330">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="331">
          
          
          <code class="ruby">          message: e.message</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="332">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="333">
          
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="334">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="335">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="336">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="337">
          
          
          <code class="ruby">  # =begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="338">
          
          
          <code class="ruby">  # @apiVersion 1.0.0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="339">
          
          
          <code class="ruby">  # @api {get} /api/v1/posts/:post_id Get Updated Post History</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="340">
          
          
          <code class="ruby">  # @apiDescription Get Updated Post History</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="341">
          
          
          <code class="ruby">  # @apiName GetUpdatedPostHistory</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="342">
          
          
          <code class="ruby">  # @apiGroup Post</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="343">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="344">
          
          
          <code class="ruby">  # @apiParam {String} access_token User access token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="345">
          
          
          <code class="ruby">  # =end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="346">
          <span class="hits">1</span>
          
          <code class="ruby">  def show</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="347">
          
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="348">
          
          
          <code class="ruby">      post = Post.find(params[:id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="349">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="350">
          
          
          <code class="ruby">      if post.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="351">
          
          
          <code class="ruby">        raise Exception.new(&#39;Post not found.&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="352">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="353">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="354">
          
          
          <code class="ruby">      post_history = post.post_history.order(created_at: :desc)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="355">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="356">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="357">
          
          
          <code class="ruby">        data: post_history</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="358">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="359">
          
          
          <code class="ruby">    rescue Exception =&gt; e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="360">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="361">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="362">
          
          
          <code class="ruby">          message: e.message</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="363">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="364">
          
          
          <code class="ruby">      }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="365">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="366">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="367">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="368">
          <span class="hits">1</span>
          
          <code class="ruby">  private</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="369">
          <span class="hits">1</span>
          
          <code class="ruby">    def media_params</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="370">
          <span class="hits">2</span>
          
          <code class="ruby">      if params[:media].present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="371">
          
          
          <code class="ruby">        if params[:media].is_a?(Array)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="372">
          
          
          <code class="ruby">          @media_params = params[:media]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="373">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="374">
          
          
          <code class="ruby">          render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="375">
          
          
          <code class="ruby">            error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="376">
          
          
          <code class="ruby">              message: &#39;Media must be an array of file.&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="377">
          
          
          <code class="ruby">            }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="378">
          
          
          <code class="ruby">          }, status: 422 and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="379">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="380">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="381">
          <span class="hits">2</span>
          
          <code class="ruby">        @media_params = []</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="382">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="383">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="384">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="385">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="5b7d7c3d1474188d380188650149ab82c29b5fc4">
  <div class="header">
    <h3>app/controllers/application_controller.rb</h3>
    <h4><span class="yellow">83.02 %</span> covered</h4>
    <div>
      <b>53</b> relevant lines. 
      <span class="green"><b>44</b> lines covered</span> and
      <span class="red"><b>9</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="2" data-linenumber="1">
          <span class="hits">2</span>
          
          <code class="ruby">class ApplicationController &lt; ActionController::Base</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="2">
          <span class="hits">2</span>
          
          <code class="ruby">  protect_from_forgery with: :null_session</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="3">
          <span class="hits">2</span>
          
          <code class="ruby">  around_action :log_headers</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="5">
          <span class="hits">2</span>
          
          <code class="ruby">  include ExceptionHandlingHelper</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="7">
          <span class="hits">2</span>
          
          <code class="ruby">  rescue_from ActiveRecord::RecordNotFound,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">    with: :record_not_found</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="9">
          <span class="hits">2</span>
          
          <code class="ruby">  rescue_from ActionController::ParameterMissing,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">    with: :parameter_missing</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="11">
          <span class="hits">2</span>
          
          <code class="ruby">  rescue_from ArgumentError,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">    with: :invalid_argument</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="13">
          <span class="hits">2</span>
          
          <code class="ruby">  rescue_from TypeError,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">    with: :invalid_type</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="15">
          <span class="hits">2</span>
          
          <code class="ruby">  rescue_from ActionController::UnpermittedParameters,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">    with: :parameter_missing</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="17">
          <span class="hits">2</span>
          
          <code class="ruby">  rescue_from ActiveModel::UnknownAttributeError,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">    with: :parameter_missing</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="19">
          <span class="hits">2</span>
          
          <code class="ruby">  rescue_from ActiveRecord::RecordInvalid,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">    with: :parameter_missing</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="22">
          <span class="hits">2</span>
          
          <code class="ruby">  def log_headers</code>
        </li>
      
        <li class="covered" data-hits="142" data-linenumber="23">
          <span class="hits">142</span>
          
          <code class="ruby">    http_envs = {}.tap do |envs|</code>
        </li>
      
        <li class="covered" data-hits="142" data-linenumber="24">
          <span class="hits">142</span>
          
          <code class="ruby">      request.headers.each do |key, value|</code>
        </li>
      
        <li class="covered" data-hits="9184" data-linenumber="25">
          <span class="hits">9184</span>
          
          <code class="ruby">        envs[key] = value</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="142" data-linenumber="29">
          <span class="hits">142</span>
          
          <code class="ruby">    if ENV[&quot;HTTP_DEBUG_LOG&quot;] == true || ENV[&quot;HTTP_DEBUG_LOG&quot;] == &quot;true&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">      Rails.logger.debug &quot;*&quot; * 60</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">      Rails.logger.debug &quot;Request Headers: #{http_envs.inspect}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">      Rails.logger.debug &quot;Request Params: #{params.inspect}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">      Rails.logger.debug &quot;*&quot; * 60</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">      Rails.logger.debug &quot; &quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">      Rails.logger.debug &quot; &quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="142" data-linenumber="38">
          <span class="hits">142</span>
          
          <code class="ruby">    access_token = &quot;&quot;</code>
        </li>
      
        <li class="covered" data-hits="142" data-linenumber="39">
          <span class="hits">142</span>
          
          <code class="ruby">    authenticate_with_http_token do |token, options|</code>
        </li>
      
        <li class="covered" data-hits="94" data-linenumber="40">
          <span class="hits">94</span>
          
          <code class="ruby">      access_token = token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="142" data-linenumber="43">
          <span class="hits">142</span>
          
          <code class="ruby">    if access_token == &quot;&quot;</code>
        </li>
      
        <li class="covered" data-hits="48" data-linenumber="44">
          <span class="hits">48</span>
          
          <code class="ruby">      access_token = params[:access_token]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">    # using qiscus email because it always exist in all user</code>
        </li>
      
        <li class="covered" data-hits="142" data-linenumber="48">
          <span class="hits">142</span>
          
          <code class="ruby">    user_qiscus_email = &quot;&quot;</code>
        </li>
      
        <li class="covered" data-hits="142" data-linenumber="49">
          <span class="hits">142</span>
          
          <code class="ruby">    user_id = -1</code>
        </li>
      
        <li class="covered" data-hits="142" data-linenumber="50">
          <span class="hits">142</span>
          
          <code class="ruby">    app_id = &quot;No Application&quot;</code>
        </li>
      
        <li class="covered" data-hits="142" data-linenumber="51">
          <span class="hits">142</span>
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="covered" data-hits="142" data-linenumber="52">
          <span class="hits">142</span>
          
          <code class="ruby">      begin</code>
        </li>
      
        <li class="covered" data-hits="142" data-linenumber="53">
          <span class="hits">142</span>
          
          <code class="ruby">        decoded_token = JWT.decode(access_token, ENV[&#39;JWT_KEY&#39;], true, { :algorithm =&gt; &#39;HS256&#39; })</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="94" data-linenumber="55">
          <span class="hits">94</span>
          
          <code class="ruby">        if decoded_token.nil? == false</code>
        </li>
      
        <li class="covered" data-hits="94" data-linenumber="56">
          <span class="hits">94</span>
          
          <code class="ruby">          user = User.find(decoded_token.first[&quot;user_id&quot;])</code>
        </li>
      
        <li class="covered" data-hits="94" data-linenumber="57">
          <span class="hits">94</span>
          
          <code class="ruby">          if user.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">            user_qiscus_email = &quot;Anonymous&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="59">
          
          
          <code class="ruby">            user_id = 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">            app_id = &quot;No Application&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="covered" data-hits="94" data-linenumber="62">
          <span class="hits">94</span>
          
          <code class="ruby">            user_qiscus_email = user.qiscus_email</code>
        </li>
      
        <li class="covered" data-hits="94" data-linenumber="63">
          <span class="hits">94</span>
          
          <code class="ruby">            user_id = user.id</code>
        </li>
      
        <li class="covered" data-hits="94" data-linenumber="64">
          <span class="hits">94</span>
          
          <code class="ruby">            app_id = user.application.app_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">      rescue Exception =&gt; error</code>
        </li>
      
        <li class="covered" data-hits="48" data-linenumber="69">
          <span class="hits">48</span>
          
          <code class="ruby">        raise Exception.new(error.message)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">    rescue Exception =&gt; e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">      # do nothing</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="142" data-linenumber="76">
          <span class="hits">142</span>
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="covered" data-hits="142" data-linenumber="77">
          <span class="hits">142</span>
          
          <code class="ruby">      yield</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">    ensure</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">      # send to sentry</code>
        </li>
      
        <li class="covered" data-hits="142" data-linenumber="80">
          <span class="hits">142</span>
          
          <code class="ruby">      if response.status != 200 &amp;&amp; response.status != 401</code>
        </li>
      
        <li class="covered" data-hits="77" data-linenumber="81">
          <span class="hits">77</span>
          
          <code class="ruby">        error_message = &quot;&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="77" data-linenumber="83">
          <span class="hits">77</span>
          
          <code class="ruby">        begin</code>
        </li>
      
        <li class="covered" data-hits="77" data-linenumber="84">
          <span class="hits">77</span>
          
          <code class="ruby">          error_message = JSON.parse(response.body)[&#39;error&#39;][&#39;message&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">        rescue Exception =&gt; e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="77" data-linenumber="89">
          <span class="hits">77</span>
          
          <code class="ruby">        extra = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">            parameters: params.inspect,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">            http_request_header: http_envs,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">            access_token: access_token,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">            http_code_response: response.status,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">            response_body: response.body</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby">        # bind the logged in user</code>
        </li>
      
        <li class="covered" data-hits="77" data-linenumber="98">
          <span class="hits">77</span>
          
          <code class="ruby">        Raven.user_context(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">          email: user_qiscus_email, # the actor&#39;s email address, if available</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby">          ip_address: request.ip # &#39;127.0.0.1&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">        )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="77" data-linenumber="103">
          <span class="hits">77</span>
          
          <code class="ruby">        Raven.capture_message(&quot;#{user_qiscus_email} #{error_message}&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby">          level: &quot;error&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby">          logger: &quot;#{user_qiscus_email}&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby">          extra: extra,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">          tags: {&#39;app_id&#39; =&gt; app_id}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby">        )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="77" data-linenumber="110">
          <span class="hits">77</span>
          
          <code class="ruby">        Raven::Context.clear!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="7318f6ca0ebe6be6957f8e50e109e4c759a51821">
  <div class="header">
    <h3>app/controllers/protected_controller.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>2</b> relevant lines. 
      <span class="green"><b>2</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class ProtectedController &lt; ApplicationController</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  include MemberSessionHelper</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="ed2ac1537b11681fa6383a33456d2790191eb973">
  <div class="header">
    <h3>app/helpers/admin_session_helper.rb</h3>
    <h4><span class="red">30.0 %</span> covered</h4>
    <div>
      <b>10</b> relevant lines. 
      <span class="green"><b>3</b> lines covered</span> and
      <span class="red"><b>7</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="2" data-linenumber="1">
          <span class="hits">2</span>
          
          <code class="ruby">require &#39;jwt&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="3">
          <span class="hits">2</span>
          
          <code class="ruby">module AdminSessionHelper</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="5">
          <span class="hits">2</span>
          
          <code class="ruby">  def authorize_admin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">      @current_admin = User.find_by(id: session[:current_user_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">      if @current_admin.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">        redirect_back fallback_location: &quot;&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">      return true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">    rescue Exception =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">      redirect_back fallback_location: &quot;&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="df474f898901ca15cc59ef27bad9f4e018a35c35">
  <div class="header">
    <h3>app/helpers/application_helper.rb</h3>
    <h4><span class="red">4.0 %</span> covered</h4>
    <div>
      <b>50</b> relevant lines. 
      <span class="green"><b>2</b> lines covered</span> and
      <span class="red"><b>48</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="2" data-linenumber="1">
          <span class="hits">2</span>
          
          <code class="ruby">module ApplicationHelper</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="3">
          <span class="hits">2</span>
          
          <code class="ruby">  def self.create_jwt_token(user, request = nil)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">      if user.kind_of?(Integer)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">        user_id = user</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">      elsif user.kind_of?(User)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">        user_id = user.id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">      else </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">        raise Exception.new(&quot;Parameter must be an user or user id.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">      if User.exists?(user_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">        jwt = JWT.encode({user_id: user_id, timestamp: Time.now}, ENV[&#39;JWT_KEY&#39;], &#39;HS256&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">        # save auth session</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">        auth_session = AuthSession.new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">        auth_session.user_id = user_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">        auth_session.jwt_token = jwt</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">        # save request detail</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">        if !request.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">          auth_session.ip_address = request.ip</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">          auth_session.user_agent = request.user_agent</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">        # try to search user location</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">        begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">          if !request.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">            geocoder = Geocoder.search(request.ip)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">            city = &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">            region_code = &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">            region_name = &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">            zipcode = &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">            latitude = 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">            longitude = 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">            country_name = &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">            country_code = &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">            if !geocoder.empty?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">              geocoder = geocoder.first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">              city = geocoder.data[&#39;city&#39;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">              region_code = geocoder.data[&#39;region_code&#39;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">              region_name = geocoder.data[&#39;region_name&#39;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">              zipcode = geocoder.data[&#39;zipcode&#39;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">              latitude = geocoder.data[&#39;latitude&#39;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">              longitude = geocoder.data[&#39;longitude&#39;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">              country_name = geocoder.data[&#39;country_name&#39;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">              country_code = geocoder.data[&#39;country_code&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">              auth_session.city = city if !city.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">              auth_session.region_code = region_code if !region_code.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">              auth_session.region_name = region_name if !region_name.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">              auth_session.zipcode = zipcode if !zipcode.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="56">
          
          
          <code class="ruby">              auth_session.latitude = latitude if !latitude.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="57">
          
          
          <code class="ruby">              auth_session.longitude = longitude if !longitude.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">              auth_session.country_name = country_name if !country_name.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="59">
          
          
          <code class="ruby">              auth_session.country_code = country_code if !country_code.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">        rescue Exception =&gt; e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">          # do nothing</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">        # save auth session</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="67">
          
          
          <code class="ruby">        auth_session.save()</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="69">
          
          
          <code class="ruby">        return jwt</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="71">
          
          
          <code class="ruby">        raise Exception.new(&quot;User with id #{user_id} is not found.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">      </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="74">
          
          
          <code class="ruby">    rescue Exception =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="75">
          
          
          <code class="ruby">      raise Exception.new(e.message)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="d3bf5a0e72e6e37918cdc06f4f8a314f6adb061d">
  <div class="header">
    <h3>app/helpers/chat_room_helper.rb</h3>
    <h4><span class="red">60.68 %</span> covered</h4>
    <div>
      <b>117</b> relevant lines. 
      <span class="green"><b>71</b> lines covered</span> and
      <span class="red"><b>46</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="2" data-linenumber="1">
          <span class="hits">2</span>
          
          <code class="ruby">require &#39;kaminari&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="3">
          <span class="hits">2</span>
          
          <code class="ruby">module ChatRoomHelper</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="5">
          <span class="hits">2</span>
          
          <code class="ruby">  PREFIX_KEY = &quot;chat_room_user_&quot;</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="6">
          <span class="hits">2</span>
          
          <code class="ruby">  TTL = 3.hour.to_i</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">  # =begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">  # This is for loading user chat room, so if there are complex query</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">  # can be edited in single place without make controller dirty</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">  # @params object user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">  # @params array chat_room_sdk_info</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">  # @params int page_number</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">  # @params int per_page page number</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">  # @return array</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">  # =end</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="19">
          <span class="hits">2</span>
          
          <code class="ruby">  def self.load_for(current_user, chat_room_sdk_info = [], page = 1, per_page)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="20">
          <span class="hits">2</span>
          
          <code class="ruby">    chat_rooms = []</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="22">
          <span class="hits">2</span>
          
          <code class="ruby">    is_redis_cache_active = ENV[&#39;REDIS_CACHE&#39;] == &quot;true&quot; || ENV[&#39;REDIS_CACHE&#39;] == true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">    # is_redis_cache_active = true # for testing enable this</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="24">
          <span class="hits">2</span>
          
          <code class="ruby">    if is_redis_cache_active</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">      chat_rooms = ChatRoomHelper.get_chat_room_cache_for_user(current_user)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="27">
          <span class="hits">2</span>
          
          <code class="ruby">      chat_rooms =  ChatRoomHelper.get_chat_room_for_user(current_user)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="30">
          <span class="hits">2</span>
          
          <code class="ruby">    chat_rooms =  ChatRoomHelper.merge_chat_room_sdk_info(chat_rooms, chat_room_sdk_info)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">    # pagination using kaminari, because all data sorted by sdk info, so it can&#39;t be</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">    # cached to redis using pagination</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="34">
          <span class="hits">2</span>
          
          <code class="ruby">    chat_count = chat_rooms.count</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="35">
          <span class="hits">2</span>
          
          <code class="ruby">    chat_rooms = Kaminari.paginate_array(chat_rooms).page(page).per(per_page)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="36">
          <span class="hits">2</span>
          
          <code class="ruby">    return chat_count, chat_rooms</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">  # =begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">  # @static @function get_chat_room_for_user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">  # @description Get chat room (conversation) list for a user.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">  # @params current_user - A user to load</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">  # @returns Array of hash of conversation</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">  # =end</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="47">
          <span class="hits">2</span>
          
          <code class="ruby">  def self.get_chat_room_for_user(current_user)</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="48">
          <span class="hits">2</span>
          
          <code class="ruby">    chat_rooms = current_user.chat_rooms.includes([</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">      :user =&gt; [],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">      :chat_users =&gt; [],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">      :users =&gt; [:roles, :application],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">      :target =&gt; [:roles, :application]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">    ])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="55">
          <span class="hits">2</span>
          
          <code class="ruby">    chat_rooms = chat_rooms.as_json({:me =&gt; current_user})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="57">
          <span class="hits">3</span>
          
          <code class="ruby">    chat_rooms = chat_rooms.sort { |a1, a2| a2[&quot;last_message_timestamps&quot;] &lt;=&gt; a1[&quot;last_message_timestamps&quot;] }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">    # for mapping is favorite status</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="60">
          <span class="hits">2</span>
          
          <code class="ruby">    favored_status = current_user.contacts.pluck(:contact_id, :is_favored)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="62">
          <span class="hits">2</span>
          
          <code class="ruby">    chat_rooms.map do |chat_room|</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="63">
          <span class="hits">3</span>
          
          <code class="ruby">      chat_room[&#39;users&#39;].map do |user|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">        # if user id included in contact id list, then return true, otherwise return false</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="65">
          <span class="hits">6</span>
          
          <code class="ruby">        is_contact = favored_status.flatten.include?(user[&#39;id&#39;])</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="66">
          <span class="hits">6</span>
          
          <code class="ruby">        user.merge!(&#39;is_contact&#39; =&gt; is_contact)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="68">
          <span class="hits">6</span>
          
          <code class="ruby">        is_favored = (favored_status.to_h[ user[&quot;id&quot;] ] == nil) ? false : favored_status.to_h[ user[&quot;id&quot;] ]</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="69">
          <span class="hits">6</span>
          
          <code class="ruby">        user.merge!(&#39;is_favored&#39; =&gt; is_favored)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">        # add is is_group_admin payload in user</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="72">
          <span class="hits">6</span>
          
          <code class="ruby">        is_group_admin = ChatUser.where(chat_room_id: chat_room[&quot;id&quot;], user_id: user[&quot;id&quot;]).pluck(:is_group_admin).first</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="73">
          <span class="hits">6</span>
          
          <code class="ruby">        user.merge!(&#39;is_group_admin&#39; =&gt; is_group_admin)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">      # for mapping is_pin_chat</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="77">
          <span class="hits">3</span>
          
          <code class="ruby">      pin_chat_room = current_user.pin_chat_rooms.find_by(chat_room_id: chat_room[&#39;id&#39;])</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="78">
          <span class="hits">3</span>
          
          <code class="ruby">      is_pin_chat = !pin_chat_room.nil?</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="79">
          <span class="hits">3</span>
          
          <code class="ruby">      chat_room.merge!(&#39;is_pin_chat&#39; =&gt; is_pin_chat)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">      # for mapping pin_chat_room_id</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="82">
          <span class="hits">3</span>
          
          <code class="ruby">      if !pin_chat_room.nil?</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="83">
          <span class="hits">2</span>
          
          <code class="ruby">        chat_room.merge!(&#39;pin_chat_room_id&#39; =&gt; pin_chat_room.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="85">
          <span class="hits">1</span>
          
          <code class="ruby">        chat_room.merge!(&#39;pin_chat_room_id&#39; =&gt; nil)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">      # show user_id that assigned as group_admin</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="89">
          <span class="hits">3</span>
          
          <code class="ruby">      if chat_room[&#39;is_group_chat&#39;] == true &amp;&amp; chat_room[&#39;is_official_chat&#39;] == false</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="90">
          <span class="hits">1</span>
          
          <code class="ruby">        group_admin_ids = ChatUser.where(chat_room_id: chat_room[&#39;id&#39;]).where(is_group_admin: true).pluck(:user_id)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="91">
          <span class="hits">1</span>
          
          <code class="ruby">        group_admins = User.where(&quot;id IN (?)&quot;, group_admin_ids).pluck(:id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="93">
          <span class="hits">1</span>
          
          <code class="ruby">        chat_room.merge!(&#39;group_admins&#39; =&gt; group_admins)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="95">
          <span class="hits">2</span>
          
          <code class="ruby">        chat_room.merge!(&#39;group_admins&#39; =&gt; nil)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">      # for mapping is_mute_chat</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="99">
          <span class="hits">3</span>
          
          <code class="ruby">      mute_chat_room = current_user.mute_chat_rooms.find_by(chat_room_id: chat_room[&#39;id&#39;])</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="100">
          <span class="hits">3</span>
          
          <code class="ruby">      is_mute_chat = !mute_chat_room.nil?</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="101">
          <span class="hits">3</span>
          
          <code class="ruby">      chat_room.merge!(&#39;is_mute_chat&#39; =&gt; is_mute_chat)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby">    # don&#39;t show chat room where it is single chat and user is just one user</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="105">
          <span class="hits">5</span>
          
          <code class="ruby">    chat_rooms = chat_rooms.select { |h| (h[&#39;users&#39;].count &gt; 1 &amp;&amp; h[&#39;is_group_chat&#39;] == false) || h[&#39;is_group_chat&#39;] == true }</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="106">
          <span class="hits">2</span>
          
          <code class="ruby">    return chat_rooms</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby">  # =begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby">  # @static @function get_chat_rooms</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby">  # @description Get chat room (conversation) list for a user.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby">  # @params current_user - A user to load</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">  # @returns Array of hash of conversation</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby">  # =end</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="117">
          <span class="hits">2</span>
          
          <code class="ruby">  def self.get_user_of_chat_rooms(chat_rooms)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="119">
          
          
          <code class="ruby">    chat_rooms = chat_rooms.as_json</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="121">
          
          
          <code class="ruby">    chat_rooms = chat_rooms.sort { |a1, a2| a2[&quot;last_message_timestamps&quot;] &lt;=&gt; a1[&quot;last_message_timestamps&quot;] }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="123">
          
          
          <code class="ruby">    chat_rooms.map do |chat_room|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="124">
          
          
          <code class="ruby">      chat_room[&#39;users&#39;].map do |user|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby">        # add is is_group_admin payload in user</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="126">
          
          
          <code class="ruby">        is_group_admin = ChatUser.where(chat_room_id: chat_room[&quot;id&quot;], user_id: user[&quot;id&quot;]).pluck(:is_group_admin).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="127">
          
          
          <code class="ruby">        user.merge!(&#39;is_group_admin&#39; =&gt; is_group_admin)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="130">
          
          
          <code class="ruby">      # show user_id that assigned as group_admin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="131">
          
          
          <code class="ruby">      if chat_room[&#39;is_group_chat&#39;] == true &amp;&amp; chat_room[&#39;is_official_chat&#39;] == false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="132">
          
          
          <code class="ruby">        group_admin_ids = ChatUser.where(chat_room_id: chat_room[&#39;id&#39;]).where(is_group_admin: true).pluck(:user_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="133">
          
          
          <code class="ruby">        group_admins = User.where(&quot;id IN (?)&quot;, group_admin_ids).pluck(:id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="135">
          
          
          <code class="ruby">        chat_room.merge!(&#39;group_admins&#39; =&gt; group_admins)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="137">
          
          
          <code class="ruby">        chat_room.merge!(&#39;group_admins&#39; =&gt; nil)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby">    # don&#39;t show chat room where it is single chat and user is just one user</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="142">
          
          
          <code class="ruby">    chat_rooms = chat_rooms.select { |h| (h[&#39;users&#39;].count &gt; 1 &amp;&amp; h[&#39;is_group_chat&#39;] == false) || h[&#39;is_group_chat&#39;] == true }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="143">
          
          
          <code class="ruby">    return chat_rooms</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby">  # =begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby">  # @static @function merge_chat_room_sdk_info</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby">  # @description Will merge a chat list using info from SDK</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="150">
          
          
          <code class="ruby">  # @params chat_room_hash - Chat room hash</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby">  # @params chat_room_sdk_info - SDK info</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby">  # @returns Array of hash of conversation</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="154">
          
          
          <code class="ruby">  # =end</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="155">
          <span class="hits">2</span>
          
          <code class="ruby">  def self.merge_chat_room_sdk_info(chat_room_hash, chat_room_sdk_info = [])</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="156">
          <span class="hits">2</span>
          
          <code class="ruby">    chat_room_hash.map do | chat_room |</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="157">
          <span class="hits">3</span>
          
          <code class="ruby">      qiscus_room_id = chat_room[&#39;qiscus_room_id&#39;].to_i</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="158">
          <span class="hits">3</span>
          
          <code class="ruby">      if chat_room_sdk_info[qiscus_room_id] != nil</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="159">
          
          
          <code class="ruby">        room_info = chat_room_sdk_info[qiscus_room_id]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="160">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="161">
          
          
          <code class="ruby">        last_comment_message = room_info[&quot;last_comment_message&quot;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby">        # Handle if the last_comment_message is a reply comment</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="164">
          
          
          <code class="ruby">        split_last_comment_message = last_comment_message.split(&quot;` \n&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="165">
          
          
          <code class="ruby">        if split_last_comment_message.size == 2</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="166">
          
          
          <code class="ruby">          last_comment_message = split_last_comment_message[1]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="167">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="168">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="169">
          
          
          <code class="ruby">        # Handle if the last_comment_message is file attachment</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="170">
          
          
          <code class="ruby">				if last_comment_message.start_with?&quot;[file]&quot; and last_comment_message.end_with?&quot;[/file]&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="171">
          
          
          <code class="ruby">          last_comment_message = &quot;File attached.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="172">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="173">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="174">
          
          
          <code class="ruby">        chat_room[&quot;chat_name_sdk&quot;] = room_info[&quot;room_name&quot;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="175">
          
          
          <code class="ruby">        chat_room[&quot;unread_count&quot;] = room_info[&quot;unread_count&quot;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="176">
          
          
          <code class="ruby">        chat_room[&quot;last_message&quot;] = last_comment_message</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="177">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="178">
          
          
          <code class="ruby">        if room_info[&quot;last_comment_timestamp&quot;].include?(&quot;0001-01-01T00:00:00Z&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="179">
          
          
          <code class="ruby">          timestamp = Time.parse(chat_room[&quot;created_at&quot;].to_s)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="180">
          
          
          <code class="ruby">          chat_room[&quot;last_message_timestamps&quot;] = timestamp.strftime(&quot;%Y-%m-%dT%TZ&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="181">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="182">
          
          
          <code class="ruby">          chat_room[&quot;last_message_timestamps&quot;] = room_info[&quot;last_comment_timestamp&quot;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="183">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="184">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="185">
          
          
          <code class="ruby">        chat_room[&quot;group_avatar_url_sdk&quot;] = room_info[&quot;room_avatar_url&quot;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="186">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="187">
          
          
          <code class="ruby">        chat_room[&quot;last_message_timestamps_int&quot;] = Time.parse(chat_room[&quot;last_message_timestamps&quot;]).to_i</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="188">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="189">
          
          
          <code class="ruby">        # use chat_avatar_url from sdk when chat_room_sdk_info assigned</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="190">
          
          
          <code class="ruby">        # only use avatar from SDK if it&#39;s a group chat (because latest group avatar is only in SDK [client only update group avatar in SDK])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="191">
          
          
          <code class="ruby">        # if chat_room[&quot;is_group_chat&quot;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="192">
          
          
          <code class="ruby">        #   chat_room[&quot;chat_avatar_url&quot;] = room_info[&quot;room_avatar_url&quot;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="193">
          
          
          <code class="ruby">        # end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="194">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="195">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="196">
          
          
          <code class="ruby">        # default value</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="197">
          <span class="hits">3</span>
          
          <code class="ruby">        chat_room[&quot;chat_name_sdk&quot;] = &quot;&quot;</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="198">
          <span class="hits">3</span>
          
          <code class="ruby">        chat_room[&quot;unread_count&quot;] = 0</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="199">
          <span class="hits">3</span>
          
          <code class="ruby">        chat_room[&quot;last_message&quot;] = &quot;&quot;</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="200">
          <span class="hits">3</span>
          
          <code class="ruby">        chat_room[&quot;last_message_timestamps&quot;] = &quot;1960-01-01T01:01:01Z&quot;</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="201">
          <span class="hits">3</span>
          
          <code class="ruby">        chat_room[&quot;group_avatar_url_sdk&quot;] = &quot;&quot;</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="202">
          <span class="hits">3</span>
          
          <code class="ruby">        chat_room[&quot;last_message_timestamps_int&quot;] = Time.parse(chat_room[&quot;last_message_timestamps&quot;]).to_i</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="203">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="204">
          
          
          <code class="ruby">        # only use avatar from SDK if it&#39;s a group chat (because latest group avatar is only in SDK [client only update group avatar in SDK])</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="205">
          <span class="hits">3</span>
          
          <code class="ruby">        if chat_room[&quot;is_group_chat&quot;]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="206">
          <span class="hits">1</span>
          
          <code class="ruby">          chat_room[&quot;chat_avatar_url&quot;] = &quot;&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="207">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="208">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="209">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="210">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="211">
          <span class="hits">3</span>
          
          <code class="ruby">    chat_room_hash = chat_room_hash.sort { |a1, a2| a2[&quot;last_message_timestamps&quot;] &lt;=&gt; a1[&quot;last_message_timestamps&quot;] }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="212">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="213">
          
          
          <code class="ruby">    # is_pin_chat = true, is always in the top position.</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="214">
          <span class="hits">2</span>
          
          <code class="ruby">    chat_room_hash = chat_room_hash.sort do |a1, a2|</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="215">
          <span class="hits">1</span>
          
          <code class="ruby">      if a1[&quot;is_pin_chat&quot;] == a2[&quot;is_pin_chat&quot;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="216">
          
          
          <code class="ruby">        0</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="217">
          
          
          <code class="ruby">        # The order based on pin_chat_room_id in descending order. For example i have pin chat room with id 19, 30, 40. So the order is 40, 30, 19</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="218">
          
          
          <code class="ruby">        if a1[&quot;pin_chat_room_id&quot;] == a2[&quot;pin_chat_room_id&quot;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="219">
          
          
          <code class="ruby">          0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="220">
          
          
          <code class="ruby">        elsif a1[&quot;pin_chat_room_id&quot;] &gt; a2[&quot;pin_chat_room_id&quot;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="221">
          
          
          <code class="ruby">          -1</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="222">
          
          
          <code class="ruby">        elsif a1[&quot;pin_chat_room_id&quot;] &lt; a2[&quot;pin_chat_room_id&quot;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="223">
          
          
          <code class="ruby">          1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="224">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="225">
          <span class="hits">1</span>
          
          <code class="ruby">      elsif a1[&quot;is_pin_chat&quot;] == true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="226">
          
          
          <code class="ruby">        -1</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="227">
          <span class="hits">1</span>
          
          <code class="ruby">      elsif a1[&quot;is_pin_chat&quot;] == false</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="228">
          <span class="hits">1</span>
          
          <code class="ruby">        1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="229">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="230">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="231">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="232">
          <span class="hits">2</span>
          
          <code class="ruby">    return chat_room_hash</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="233">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="234">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="235">
          
          
          <code class="ruby">  # =begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="236">
          
          
          <code class="ruby">  # @static @function get_chat_room_cache_for_user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="237">
          
          
          <code class="ruby">  # @description Get or set chat room for a user from redis</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="238">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="239">
          
          
          <code class="ruby">  # @params current_user - A user to load</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="240">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="241">
          
          
          <code class="ruby">  # @returns Array of hash of conversation</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="242">
          
          
          <code class="ruby">  # =end</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="243">
          <span class="hits">2</span>
          
          <code class="ruby">  def self.get_chat_room_cache_for_user(current_user)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="244">
          
          
          <code class="ruby">    keys = &quot;#{PREFIX_KEY}#{current_user.id}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="245">
          
          
          <code class="ruby">    chat_rooms = $redis.get(keys)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="246">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="247">
          
          
          <code class="ruby">    # cache is not exist</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="248">
          
          
          <code class="ruby">    if chat_rooms.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="249">
          
          
          <code class="ruby">      chat_rooms =  ChatRoomHelper.get_chat_room_for_user(current_user)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="250">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="251">
          
          
          <code class="ruby">      # set to redis and expire every 3 hours</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="252">
          
          
          <code class="ruby">      $redis.set(keys, chat_rooms.to_json)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="253">
          
          
          <code class="ruby">      $redis.expire(keys, TTL)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="254">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="255">
          
          
          <code class="ruby">      return chat_rooms</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="256">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="257">
          
          
          <code class="ruby">      chat_rooms = JSON.parse(chat_rooms)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="258">
          
          
          <code class="ruby">      return chat_rooms</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="259">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="260">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="261">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="262">
          
          
          <code class="ruby">  # =begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="263">
          
          
          <code class="ruby">  # @static @function reset_chat_room_cache_for_users</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="264">
          
          
          <code class="ruby">  # @description Delete a redis cache if in that chat room contains this user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="265">
          
          
          <code class="ruby">  # and set a new one record to redis.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="266">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="267">
          
          
          <code class="ruby">  # @params current_user - A user to look</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="268">
          
          
          <code class="ruby">  #</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="269">
          
          
          <code class="ruby">  # @returns void</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="270">
          
          
          <code class="ruby">  # =end</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="271">
          <span class="hits">2</span>
          
          <code class="ruby">  def self.reset_chat_room_cache_for_users(user_ids)</code>
        </li>
      
        <li class="covered" data-hits="47" data-linenumber="272">
          <span class="hits">47</span>
          
          <code class="ruby">    user_ids = user_ids.uniq</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="273">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="47" data-linenumber="274">
          <span class="hits">47</span>
          
          <code class="ruby">    keys = []</code>
        </li>
      
        <li class="covered" data-hits="47" data-linenumber="275">
          <span class="hits">47</span>
          
          <code class="ruby">    user_ids.each do |uid|</code>
        </li>
      
        <li class="covered" data-hits="52" data-linenumber="276">
          <span class="hits">52</span>
          
          <code class="ruby">      k = &quot;#{PREFIX_KEY}#{uid}&quot;</code>
        </li>
      
        <li class="covered" data-hits="52" data-linenumber="277">
          <span class="hits">52</span>
          
          <code class="ruby">      keys.push(k)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="278">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="279">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="280">
          
          
          <code class="ruby">    # Redis SET, GET and DEL is atomic.</code>
        </li>
      
        <li class="covered" data-hits="47" data-linenumber="281">
          <span class="hits">47</span>
          
          <code class="ruby">    if !keys.empty?</code>
        </li>
      
        <li class="covered" data-hits="27" data-linenumber="282">
          <span class="hits">27</span>
          
          <code class="ruby">      $redis.del(keys)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="283">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="284">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="285">
          
          
          <code class="ruby">    # Now try to insert a new one cache for each user id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="286">
          
          
          <code class="ruby">    # Since this is should be a long process (must get chat room for each user)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="287">
          
          
          <code class="ruby">    # it must work in background to prevent user delays</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="288">
          
          
          <code class="ruby">    # ResetChatRoomCacheJob.perform_later(user_ids)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="289">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="290">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="291">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="292">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="9049a71cd4015dddc8006fef97c3ecfa45ba233f">
  <div class="header">
    <h3>app/helpers/exception_handling_helper.rb</h3>
    <h4><span class="red">55.56 %</span> covered</h4>
    <div>
      <b>9</b> relevant lines. 
      <span class="green"><b>5</b> lines covered</span> and
      <span class="red"><b>4</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="2" data-linenumber="1">
          <span class="hits">2</span>
          
          <code class="ruby">module ExceptionHandlingHelper</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby">  # use 400 error The server cannot or will not process the request due to an apparent client error </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby">  # (e.g., malformed request syntax, too large size, invalid request message framing, or deceptive request routing)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">  # 404 not found</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">  # 422 if request is well-formed but was unable to be followed due to semantic errors</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="7">
          <span class="hits">2</span>
          
          <code class="ruby">  def record_not_found(error)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">    render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">      error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">        message: &#39;Not Found&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">    }, status: 404</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">  end </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="15">
          <span class="hits">2</span>
          
          <code class="ruby">  def parameter_missing(error)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">    render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">      error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">        message: error.message</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">    }, status: 400</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">  end </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="23">
          <span class="hits">2</span>
          
          <code class="ruby">  def invalid_argument(error)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">    render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">      error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">        message: error.message</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">    }, status: 400</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">  end </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="31">
          <span class="hits">2</span>
          
          <code class="ruby">  def invalid_type(error)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">    render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">      error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">        message: error.message</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">    }, status: 400</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">  end </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="d333c1120b11e95c5d8cfcb0519c82ab55e42999">
  <div class="header">
    <h3>app/helpers/member_session_helper.rb</h3>
    <h4><span class="red">68.18 %</span> covered</h4>
    <div>
      <b>44</b> relevant lines. 
      <span class="green"><b>30</b> lines covered</span> and
      <span class="red"><b>14</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="2" data-linenumber="1">
          <span class="hits">2</span>
          
          <code class="ruby">require &#39;jwt&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="3">
          <span class="hits">2</span>
          
          <code class="ruby">module MemberSessionHelper</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="5">
          <span class="hits">2</span>
          
          <code class="ruby">  def authorize_admin</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="6">
          <span class="hits">4</span>
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="7">
          <span class="hits">4</span>
          
          <code class="ruby">      if authorized_user</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="8">
          <span class="hits">3</span>
          
          <code class="ruby">        if @current_user.is_admin</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="9">
          <span class="hits">2</span>
          
          <code class="ruby">          return true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">          render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">            error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">              message: &#39;Unauthorized Access. User is not admin.&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">            }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">          }, status: 401</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">        render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">          error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">            message: &#39;Unauthorized Access&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">          }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">        }, status: 401</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">    rescue Exception =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">          message: e.message</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">      }, status: 401</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="33">
          <span class="hits">2</span>
          
          <code class="ruby">  def authorize_user</code>
        </li>
      
        <li class="covered" data-hits="94" data-linenumber="34">
          <span class="hits">94</span>
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="covered" data-hits="94" data-linenumber="35">
          <span class="hits">94</span>
          
          <code class="ruby">      if authorized_user</code>
        </li>
      
        <li class="covered" data-hits="91" data-linenumber="36">
          <span class="hits">91</span>
          
          <code class="ruby">        return true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="38">
          <span class="hits">3</span>
          
          <code class="ruby">        render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">          error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">            message: &#39;Unauthorized Access&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">          }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">        }, status: 401</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">    rescue Exception =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">      render json: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">        error: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">          message: e.message</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">      }, status: 401</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="53">
          <span class="hits">2</span>
          
          <code class="ruby">  def authorized_user</code>
        </li>
      
        <li class="covered" data-hits="98" data-linenumber="54">
          <span class="hits">98</span>
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">      # access token via post or get parameter</code>
        </li>
      
        <li class="covered" data-hits="98" data-linenumber="56">
          <span class="hits">98</span>
          
          <code class="ruby">      if params[:access_token] != &quot;&quot; &amp;&amp; !params[:access_token].nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="57">
          
          
          <code class="ruby">        @current_user = MemberSessionHelper.lookup_token(params[:access_token])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">        @current_jwt_token = params[:access_token]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="59">
          
          
          <code class="ruby">        return true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">        # try using header</code>
        </li>
      
        <li class="covered" data-hits="98" data-linenumber="62">
          <span class="hits">98</span>
          
          <code class="ruby">        authenticate_with_http_token do |token, options|</code>
        </li>
      
        <li class="covered" data-hits="94" data-linenumber="63">
          <span class="hits">94</span>
          
          <code class="ruby">          @current_user = MemberSessionHelper.lookup_token(token)</code>
        </li>
      
        <li class="covered" data-hits="94" data-linenumber="64">
          <span class="hits">94</span>
          
          <code class="ruby">          @current_jwt_token = token</code>
        </li>
      
        <li class="covered" data-hits="94" data-linenumber="65">
          <span class="hits">94</span>
          
          <code class="ruby">          return true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="68">
          
          
          <code class="ruby">    rescue Exception =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="69">
          
          
          <code class="ruby">      raise Exception.new(e.message)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">  # Validate access token</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="74">
          <span class="hits">2</span>
          
          <code class="ruby">  def self.lookup_token(jwt_token)</code>
        </li>
      
        <li class="covered" data-hits="94" data-linenumber="75">
          <span class="hits">94</span>
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="covered" data-hits="94" data-linenumber="76">
          <span class="hits">94</span>
          
          <code class="ruby">      decoded_token = JWT.decode(jwt_token, ENV[&#39;JWT_KEY&#39;], true, { :algorithm =&gt; &#39;HS256&#39; })</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">      # decoded token must be success</code>
        </li>
      
        <li class="covered" data-hits="94" data-linenumber="79">
          <span class="hits">94</span>
          
          <code class="ruby">      if !decoded_token.nil?</code>
        </li>
      
        <li class="covered" data-hits="94" data-linenumber="80">
          <span class="hits">94</span>
          
          <code class="ruby">        auth_session = AuthSession.find_by(jwt_token: jwt_token, user_id: decoded_token.first[&quot;user_id&quot;])</code>
        </li>
      
        <li class="covered" data-hits="94" data-linenumber="81">
          <span class="hits">94</span>
          
          <code class="ruby">        if !auth_session.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">          # update last active session</code>
        </li>
      
        <li class="covered" data-hits="94" data-linenumber="83">
          <span class="hits">94</span>
          
          <code class="ruby">          auth_session.updated_at = Time.now</code>
        </li>
      
        <li class="covered" data-hits="94" data-linenumber="84">
          <span class="hits">94</span>
          
          <code class="ruby">          auth_session.save()</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">          # return current user</code>
        </li>
      
        <li class="covered" data-hits="94" data-linenumber="87">
          <span class="hits">94</span>
          
          <code class="ruby">          return auth_session.user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="89">
          
          
          <code class="ruby">          raise Exception.new(&#39;Session is compromised, you enforced to logout from this application because of invalid token.&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">      </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="93">
          
          
          <code class="ruby">    rescue JWT::ExpiredSignature =&gt; e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">      # Handle expired token, e.g. logout user or deny access</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="95">
          
          
          <code class="ruby">      raise Exception.new(e.message)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby">    rescue JWT::VerificationError =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="97">
          
          
          <code class="ruby">      raise Exception.new(e.message)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">    rescue Exception =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="99">
          
          
          <code class="ruby">      raise Exception.new(e.message)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">  end # end of lookup_token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="5d1c610d6bd7d590d84405e194a5b66e0e692357">
  <div class="header">
    <h3>app/helpers/qiscus_sdk.rb</h3>
    <h4><span class="red">22.01 %</span> covered</h4>
    <div>
      <b>318</b> relevant lines. 
      <span class="green"><b>70</b> lines covered</span> and
      <span class="red"><b>248</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="2" data-linenumber="1">
          <span class="hits">2</span>
          
          <code class="ruby">require &#39;net/http&#39;</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="2">
          <span class="hits">2</span>
          
          <code class="ruby">require &#39;curb&#39;</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="3">
          <span class="hits">2</span>
          
          <code class="ruby">require &#39;net/http/post/multipart&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="5">
          <span class="hits">2</span>
          
          <code class="ruby">class QiscusSdk</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="6">
          <span class="hits">2</span>
          
          <code class="ruby">  def initialize(app_name = &quot;qisme&quot;, qiscus_sdk_secret = &quot;qisme-123&quot;)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="7">
          <span class="hits">5</span>
          
          <code class="ruby">    @BASE_URL = ENV[&quot;QISCUS_SDK_URL&quot;] || &quot;https://api.qiscus.com&quot;</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="8">
          <span class="hits">5</span>
          
          <code class="ruby">    @QISCUS_SDK_APP_ID = app_name</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="9">
          <span class="hits">5</span>
          
          <code class="ruby">    @QISCUS_SDK_SECRET = qiscus_sdk_secret</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="12">
          <span class="hits">2</span>
          
          <code class="ruby">  def login_or_register(email, password, username, avatar_url = nil)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">    if email =~ /\A([^@^+\s]+)@((?:[-a-z0-9]+\.)+[a-z]{2,})\z/i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">      login_or_register_url = &quot;#{@BASE_URL}/api/v2/mobile/login_or_register&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">      params = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">        &quot;email&quot; =&gt; email,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">        &quot;password&quot; =&gt; password,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">        &quot;username&quot; =&gt; username,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">        &quot;avatar_url&quot; =&gt; avatar_url</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">      res = request(&quot;POST&quot;, login_or_register_url, params)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">      token = res[&quot;results&quot;][&quot;user&quot;][&quot;token&quot;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">      if token.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">        raise Exception.new(&quot;Qiscus token is null.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">        return token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">      raise Exception.new(&quot;Email is not valid.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="36">
          <span class="hits">2</span>
          
          <code class="ruby">  def login_or_register_rest(email, password, username, avatar_url = nil)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">    if email =~ /\A([^@^+\s]+)@((?:[-a-z0-9]+\.)+[a-z]{2,})\z/i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">      login_or_register_url = &quot;#{@BASE_URL}/api/v2/rest/login_or_register&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">      params = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">        &quot;email&quot; =&gt; email,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">        &quot;password&quot; =&gt; password,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">        &quot;username&quot; =&gt; username,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">        &quot;avatar_url&quot; =&gt; avatar_url</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">      res = request(&quot;POST&quot;, login_or_register_url, params)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">      token = res[&quot;results&quot;][&quot;user&quot;][&quot;token&quot;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">      if token.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">        raise Exception.new(&quot;Qiscus token is null.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">        return token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="56">
          
          
          <code class="ruby">      raise Exception.new(&quot;Email is not valid.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="60">
          <span class="hits">2</span>
          
          <code class="ruby">  def get_or_create_room_with_target(token, emails, distinct_id = nil, options = nil)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="61">
          <span class="hits">1</span>
          
          <code class="ruby">    if token.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">      raise Exception.new(&quot;Token is empty.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="65">
          <span class="hits">1</span>
          
          <code class="ruby">    if emails.kind_of?(String)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="66">
          
          
          <code class="ruby">      emails = [emails.to_s]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="69">
          <span class="hits">1</span>
          
          <code class="ruby">    url = &quot;#{@BASE_URL}/api/v2/mobile/get_or_create_room_with_target&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="70">
          <span class="hits">1</span>
          
          <code class="ruby">    params = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">      &quot;token&quot; =&gt; token,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">      &quot;emails&quot; =&gt; emails.to_a,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">      &quot;distinct_id&quot; =&gt; distinct_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">      &quot;options&quot; =&gt; options</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="77">
          <span class="hits">1</span>
          
          <code class="ruby">    res = request(&quot;POST&quot;, url, params)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="79">
          
          
          <code class="ruby">    room_name = res[&quot;results&quot;][&quot;room&quot;][&quot;room_name&quot;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="80">
          
          
          <code class="ruby">    room_id = res[&quot;results&quot;][&quot;room&quot;][&quot;id&quot;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="81">
          
          
          <code class="ruby">    topic_id = res[&quot;results&quot;][&quot;room&quot;][&quot;last_topic_id&quot;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="82">
          
          
          <code class="ruby">    chat_type = res[&quot;results&quot;][&quot;room&quot;][&quot;chat_type&quot;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="84">
          
          
          <code class="ruby">    if room_name.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="85">
          
          
          <code class="ruby">      raise Exception.new(&quot;Qiscus room name is null.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="88">
          
          
          <code class="ruby">    if room_id.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="89">
          
          
          <code class="ruby">      raise Exception.new(&quot;Qiscus room id is null.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="92">
          
          
          <code class="ruby">    if topic_id.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="93">
          
          
          <code class="ruby">      raise Exception.new(&quot;Qiscus topic id is null.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="96">
          
          
          <code class="ruby">    is_group_chat = false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="97">
          
          
          <code class="ruby">    if chat_type.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="98">
          
          
          <code class="ruby">      raise Exception.new(&quot;Qiscus chat type is null.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="100">
          
          
          <code class="ruby">      if chat_type != &quot;single&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="101">
          
          
          <code class="ruby">        is_group_chat = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="105">
          
          
          <code class="ruby">    response = OpenStruct.new(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby">    {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">      :name =&gt; room_name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby">      :id =&gt; room_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby">      :topic_id =&gt; topic_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby">      :is_group_chat =&gt; is_group_chat</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby">    })</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="113">
          
          
          <code class="ruby">    return response</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="116">
          <span class="hits">2</span>
          
          <code class="ruby">  def load_comments(token, topic_id, last_comment_id = nil, timestamp = nil, after = nil)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="117">
          
          
          <code class="ruby">    url = &quot;#{@BASE_URL}/api/v2/mobile/load_comments&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="118">
          
          
          <code class="ruby">    params = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby">      &quot;token&quot; =&gt; token,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby">      &quot;topic_id&quot; =&gt; topic_id.to_i,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby">      &quot;last_comment_id&quot; =&gt; last_comment_id.to_i,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby">      &quot;timestamp&quot; =&gt; timestamp,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby">      &quot;after&quot; =&gt; after</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="126">
          
          
          <code class="ruby">    res = request(&quot;GET&quot;, url, params)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="127">
          
          
          <code class="ruby">    res = res[&quot;results&quot;][&quot;comments&quot;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="128">
          
          
          <code class="ruby">    return res.to_a</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="130">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="131">
          <span class="hits">2</span>
          
          <code class="ruby">  def post_comment(token, topic_id, comment, type=&quot;text&quot;, payload=&quot;&quot;, unique_temp_id = nil)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="132">
          
          
          <code class="ruby">    url = &quot;#{@BASE_URL}/api/v2/mobile/post_comment&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="133">
          
          
          <code class="ruby">    params = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby">      &quot;token&quot; =&gt; token,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby">      &quot;topic_id&quot; =&gt; topic_id.to_i,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby">      &quot;comment&quot; =&gt; comment,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby">      &quot;type&quot; =&gt; type,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby">      &quot;payload&quot; =&gt; payload,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby">      &quot;unique_temp_id&quot; =&gt; unique_temp_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="142">
          
          
          <code class="ruby">    res = request(&quot;POST&quot;, url, params)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="143">
          
          
          <code class="ruby">    res = res[&quot;results&quot;][&quot;comment&quot;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="144">
          
          
          <code class="ruby">    return res</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="147">
          <span class="hits">2</span>
          
          <code class="ruby">  def get_room_by_id(token, id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="148">
          
          
          <code class="ruby">    url = &quot;#{@BASE_URL}/api/v2/mobile/get_room_by_id&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="149">
          
          
          <code class="ruby">    params = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="150">
          
          
          <code class="ruby">      &quot;token&quot; =&gt; token,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby">      &quot;id&quot; =&gt; id.to_i</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="154">
          
          
          <code class="ruby">    res = request(&quot;GET&quot;, url, params)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="155">
          
          
          <code class="ruby">    res = res[&quot;results&quot;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="156">
          
          
          <code class="ruby">    return res</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="158">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="159">
          <span class="hits">2</span>
          
          <code class="ruby">  def sync(token, last_received_comment_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="160">
          
          
          <code class="ruby">    url = &quot;#{@BASE_URL}/api/v2/mobile/sync&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="161">
          
          
          <code class="ruby">    params = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby">      &quot;token&quot; =&gt; token,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby">      &quot;last_received_comment_id&quot; =&gt; last_received_comment_id.to_i</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="164">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="165">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="166">
          
          
          <code class="ruby">    res = request(&quot;GET&quot;, url, params)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="167">
          
          
          <code class="ruby">    res = res[&quot;results&quot;][&quot;comments&quot;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="168">
          
          
          <code class="ruby">    return res.to_a</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="169">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="170">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="171">
          <span class="hits">2</span>
          
          <code class="ruby">  def get_rooms_info(user_email, room_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="172">
          
          
          <code class="ruby">    if !user_email.kind_of?(String) || user_email.nil? || user_email == &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="173">
          
          
          <code class="ruby">      raise Exception.new(&quot;User email is not string or nil.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="174">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="175">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="176">
          
          
          <code class="ruby">    if !room_id.kind_of?(Array) || room_id.nil? || room_id == &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="177">
          
          
          <code class="ruby">      raise Exception.new(&quot;Room is not array or nil.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="178">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="179">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="180">
          
          
          <code class="ruby">    url = &quot;#{@BASE_URL}/api/v2/rest/get_rooms_info&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="181">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="182">
          
          
          <code class="ruby">    # params = &quot;&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="183">
          
          
          <code class="ruby">    # room_id = room_id.uniq</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="184">
          
          
          <code class="ruby">    # room_id.to_a.each do |rid|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="185">
          
          
          <code class="ruby">    #   params += &quot;room_id[]=#{rid}&amp;&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="186">
          
          
          <code class="ruby">    # end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="187">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="188">
          
          
          <code class="ruby">    # params += &quot;user_email=#{user_email}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="189">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="190">
          
          
          <code class="ruby">    # url = url + &quot;?&quot; + params</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="191">
          
          
          <code class="ruby">    params = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="192">
          
          
          <code class="ruby">      &quot;user_email&quot; =&gt; user_email,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="193">
          
          
          <code class="ruby">      &quot;room_id[]&quot; =&gt; room_id.to_a,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="194">
          
          
          <code class="ruby">      &quot;room_id&quot; =&gt; room_id.to_a,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="195">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="196">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="197">
          
          
          <code class="ruby">    status, res = curb_post(&quot;POST&quot;, url, params)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="198">
          
          
          <code class="ruby">    # status, res = faraday_post(&#39;/api/v2/rest/get_rooms_info&#39;, params)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="199">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="200">
          
          
          <code class="ruby">    if status == 200</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="201">
          
          
          <code class="ruby">      responses = Hash.new</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="202">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="203">
          
          
          <code class="ruby">      rooms_info = res[&quot;results&quot;][&quot;rooms_info&quot;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="204">
          
          
          <code class="ruby">      rooms_info.to_a.each do |ri|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="205">
          
          
          <code class="ruby">        tmp = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="206">
          
          
          <code class="ruby">          &quot;last_comment_message&quot; =&gt; ri[&quot;last_comment_message&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="207">
          
          
          <code class="ruby">          &quot;last_comment_timestamp&quot; =&gt; ri[&quot;last_comment_timestamp&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="208">
          
          
          <code class="ruby">          &quot;room_id&quot; =&gt; ri[&quot;room_id&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="209">
          
          
          <code class="ruby">          &quot;room_name&quot; =&gt; ri[&quot;room_name&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="210">
          
          
          <code class="ruby">          &quot;room_type&quot; =&gt; ri[&quot;room_type&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="211">
          
          
          <code class="ruby">          &quot;last_comment_id&quot; =&gt; ri[&quot;last_comment_id&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="212">
          
          
          <code class="ruby">          &quot;unread_count&quot; =&gt; ri[&quot;unread_count&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="213">
          
          
          <code class="ruby">          &quot;room_avatar_url&quot; =&gt; ri[&quot;room_avatar_url&quot;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="214">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="215">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="216">
          
          
          <code class="ruby">        # make room id as index for easy access in chat room model</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="217">
          
          
          <code class="ruby">        responses[ri[&quot;room_id&quot;].to_i] = tmp</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="218">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="219">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="220">
          
          
          <code class="ruby">      return status, responses</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="221">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="222">
          
          
          <code class="ruby">      return status, res</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="223">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="224">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="225">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="226">
          <span class="hits">2</span>
          
          <code class="ruby">  def create_room(name_, participants, creator, avatar_url = nil)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="227">
          <span class="hits">1</span>
          
          <code class="ruby">    if !name_.kind_of?(String) || name_.nil? || name_ == &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="228">
          
          
          <code class="ruby">      raise Exception.new(&quot;Name is not string or nil.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="229">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="230">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="231">
          <span class="hits">1</span>
          
          <code class="ruby">    if !participants.kind_of?(Array) || participants.nil? || participants == &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="232">
          
          
          <code class="ruby">      raise Exception.new(&quot;Participants is not array or nil.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="233">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="234">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="235">
          <span class="hits">1</span>
          
          <code class="ruby">    if !creator.kind_of?(String) || creator.nil? || creator == &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="236">
          
          
          <code class="ruby">      raise Exception.new(&quot;Creator is not string or nil.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="237">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="238">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="239">
          <span class="hits">1</span>
          
          <code class="ruby">    url = &quot;#{@BASE_URL}/api/v2/rest/create_room&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="240">
          <span class="hits">1</span>
          
          <code class="ruby">    params = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="241">
          
          
          <code class="ruby">      &quot;name&quot; =&gt; name_,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="242">
          
          
          <code class="ruby">      &quot;participants[]&quot; =&gt; participants.to_a,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="243">
          
          
          <code class="ruby">      &quot;creator&quot; =&gt; creator,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="244">
          
          
          <code class="ruby">      &quot;avatar_url&quot; =&gt; avatar_url</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="245">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="246">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="247">
          <span class="hits">1</span>
          
          <code class="ruby">    res = request(&quot;POST&quot;, url, params)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="248">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="249">
          
          
          <code class="ruby">    response = OpenStruct.new(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="250">
          
          
          <code class="ruby">    {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="251">
          
          
          <code class="ruby">      :name =&gt; res[&quot;results&quot;][&quot;room_name&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="252">
          
          
          <code class="ruby">      :id =&gt; res[&quot;results&quot;][&quot;room_id&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="253">
          
          
          <code class="ruby">      :topic_id =&gt; res[&quot;results&quot;][&quot;room_id&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="254">
          
          
          <code class="ruby">      :is_group_chat =&gt; true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="255">
          
          
          <code class="ruby">    })</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="256">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="257">
          
          
          <code class="ruby">    return response</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="258">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="259">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="260">
          <span class="hits">2</span>
          
          <code class="ruby">  def add_room_participants(emails, room_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="261">
          
          
          <code class="ruby">    if !room_id.kind_of?(Integer) || room_id.nil? || room_id == &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="262">
          
          
          <code class="ruby">      raise Exception.new(&quot;Room id is not integer or nil.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="263">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="264">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="265">
          
          
          <code class="ruby">    if !emails.kind_of?(Array) || emails.empty? || emails == &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="266">
          
          
          <code class="ruby">      raise Exception.new(&quot;Emails is not array or nil.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="267">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="268">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="269">
          
          
          <code class="ruby">    url = &quot;#{@BASE_URL}/api/v2/rest/add_room_participants&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="270">
          
          
          <code class="ruby">    params = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="271">
          
          
          <code class="ruby">      &quot;emails[]&quot; =&gt; emails.to_a,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="272">
          
          
          <code class="ruby">      &quot;room_id&quot; =&gt; room_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="273">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="274">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="275">
          
          
          <code class="ruby">    res = request(&quot;POST&quot;, url, params)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="276">
          
          
          <code class="ruby">    return res</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="277">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="278">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="279">
          <span class="hits">2</span>
          
          <code class="ruby">  def remove_room_participants(emails, room_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="280">
          
          
          <code class="ruby">    if !room_id.kind_of?(Integer) || room_id.nil? || room_id == &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="281">
          
          
          <code class="ruby">      raise Exception.new(&quot;Room id is not integer or nil.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="282">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="283">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="284">
          
          
          <code class="ruby">    if !emails.kind_of?(Array) || emails.empty? || emails == &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="285">
          
          
          <code class="ruby">      raise Exception.new(&quot;Emails is not array or nil.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="286">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="287">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="288">
          
          
          <code class="ruby">    url = &quot;#{@BASE_URL}/api/v2/rest/remove_room_participants&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="289">
          
          
          <code class="ruby">    params = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="290">
          
          
          <code class="ruby">      &quot;emails[]&quot; =&gt; emails.to_a,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="291">
          
          
          <code class="ruby">      &quot;room_id&quot; =&gt; room_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="292">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="293">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="294">
          
          
          <code class="ruby">    res = request(&quot;POST&quot;, url, params)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="295">
          
          
          <code class="ruby">    return res</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="296">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="297">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="298">
          <span class="hits">2</span>
          
          <code class="ruby">  def update_room(token, room_id, room_name, avatar_url, options = {})</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="299">
          
          
          <code class="ruby">    url = &quot;#{@BASE_URL}/api/v2/mobile/update_room&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="300">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="301">
          
          
          <code class="ruby">    params = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="302">
          
          
          <code class="ruby">      token: token,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="303">
          
          
          <code class="ruby">      id: room_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="304">
          
          
          <code class="ruby">      room_name: room_name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="305">
          
          
          <code class="ruby">      avatar_url: avatar_url,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="306">
          
          
          <code class="ruby">      options: options</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="307">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="308">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="309">
          
          
          <code class="ruby">    res = request(&quot;POST&quot;, url, params)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="310">
          
          
          <code class="ruby">    return res</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="311">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="312">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="313">
          <span class="hits">2</span>
          
          <code class="ruby">  def post_system_event_message(system_event_type, room_id, subject_email, object_email = [], updated_room_name = nil, payload = {}, message = &quot;&quot;, extras = {})</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="314">
          
          
          <code class="ruby">    url = &quot;#{@BASE_URL}/api/v2/rest/post_system_event_message&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="315">
          
          
          <code class="ruby">    params = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="316">
          
          
          <code class="ruby">      &quot;system_event_type&quot; =&gt; system_event_type,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="317">
          
          
          <code class="ruby">      &quot;room_id&quot; =&gt; room_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="318">
          
          
          <code class="ruby">      &quot;subject_email&quot; =&gt; subject_email,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="319">
          
          
          <code class="ruby">      &quot;object_email[]&quot; =&gt; object_email.to_a.uniq, # only required when system event type is add_member or remove_member</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="320">
          
          
          <code class="ruby">      &quot;updated_room_name&quot; =&gt; updated_room_name, # only required when system event message type is change_room_name or create_room</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="321">
          
          
          <code class="ruby">      &quot;payload&quot; =&gt; payload, # only required when system event message type is custom</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="322">
          
          
          <code class="ruby">      &quot;message&quot; =&gt; message,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="323">
          
          
          <code class="ruby">      &quot;extras&quot; =&gt; extras</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="324">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="325">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="326">
          
          
          <code class="ruby">    res = request(&quot;POST&quot;, url, params)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="327">
          
          
          <code class="ruby">    res = res[&quot;results&quot;][&quot;comment&quot;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="328">
          
          
          <code class="ruby">    return res</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="329">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="330">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="331">
          <span class="hits">2</span>
          
          <code class="ruby">  def get_or_create_room_with_target_rest(emails, avatar_url = nil)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="332">
          
          
          <code class="ruby">    # url = &quot;#{@BASE_URL}/api/v2/rest/get_or_create_room_with_target&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="333">
          
          
          <code class="ruby">    # Its to accommodate params array in GET</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="334">
          
          
          <code class="ruby">    url = &quot;#{@BASE_URL}/api/v2/rest/get_or_create_room_with_target?emails[]=#{emails[0]}&amp;emails[]=#{emails[1]}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="335">
          
          
          <code class="ruby">    params = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="336">
          
          
          <code class="ruby">      &quot;emails[]&quot; =&gt; emails.to_a,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="337">
          
          
          <code class="ruby">      &quot;avatar_url&quot; =&gt; avatar_url</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="338">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="339">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="340">
          
          
          <code class="ruby">    res = request(&quot;GET&quot;, url, params)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="341">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="342">
          
          
          <code class="ruby">    room_name = res[&quot;results&quot;][&quot;room&quot;][&quot;room_name&quot;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="343">
          
          
          <code class="ruby">    room_id = res[&quot;results&quot;][&quot;room&quot;][&quot;id&quot;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="344">
          
          
          <code class="ruby">    topic_id = res[&quot;results&quot;][&quot;room&quot;][&quot;last_topic_id&quot;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="345">
          
          
          <code class="ruby">    chat_type = res[&quot;results&quot;][&quot;room&quot;][&quot;chat_type&quot;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="346">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="347">
          
          
          <code class="ruby">    if room_id.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="348">
          
          
          <code class="ruby">      raise Exception.new(&quot;Qiscus room id is null.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="349">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="350">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="351">
          
          
          <code class="ruby">    if topic_id.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="352">
          
          
          <code class="ruby">      raise Exception.new(&quot;Qiscus topic id is null.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="353">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="354">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="355">
          
          
          <code class="ruby">    is_group_chat = false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="356">
          
          
          <code class="ruby">    if chat_type.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="357">
          
          
          <code class="ruby">      raise Exception.new(&quot;Qiscus chat type is null.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="358">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="359">
          
          
          <code class="ruby">      if chat_type != &quot;single&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="360">
          
          
          <code class="ruby">        is_group_chat = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="361">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="362">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="363">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="364">
          
          
          <code class="ruby">    response = OpenStruct.new(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="365">
          
          
          <code class="ruby">    {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="366">
          
          
          <code class="ruby">      :name =&gt; room_name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="367">
          
          
          <code class="ruby">      :id =&gt; room_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="368">
          
          
          <code class="ruby">      :topic_id =&gt; topic_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="369">
          
          
          <code class="ruby">      :is_group_chat =&gt; is_group_chat</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="370">
          
          
          <code class="ruby">    })</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="371">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="372">
          
          
          <code class="ruby">    return response</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="373">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="374">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="375">
          <span class="hits">2</span>
          
          <code class="ruby">  def get_or_create_room_with_unique_id(token, unique_id, chat_name = nil, avatar_url = nil)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="376">
          
          
          <code class="ruby">    if token.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="377">
          
          
          <code class="ruby">      raise Exception.new(&quot;Token is empty.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="378">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="379">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="380">
          
          
          <code class="ruby">    if unique_id.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="381">
          
          
          <code class="ruby">      raise Exception.new(&quot;Unique id is empty.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="382">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="383">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="384">
          
          
          <code class="ruby">    url = &quot;#{@BASE_URL}/api/v2/mobile/get_or_create_room_with_unique_id&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="385">
          
          
          <code class="ruby">    params = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="386">
          
          
          <code class="ruby">      &quot;token&quot; =&gt; token,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="387">
          
          
          <code class="ruby">      &quot;unique_id&quot; =&gt; unique_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="388">
          
          
          <code class="ruby">      &quot;name&quot; =&gt; chat_name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="389">
          
          
          <code class="ruby">      &quot;avatar_url&quot; =&gt; avatar_url</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="390">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="391">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="392">
          
          
          <code class="ruby">    res = request(&quot;POST&quot;, url, params)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="393">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="394">
          
          
          <code class="ruby">    room_name = res[&quot;results&quot;][&quot;room&quot;][&quot;room_name&quot;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="395">
          
          
          <code class="ruby">    room_id = res[&quot;results&quot;][&quot;room&quot;][&quot;id&quot;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="396">
          
          
          <code class="ruby">    unique_id = res[&quot;results&quot;][&quot;room&quot;][&quot;unique_id&quot;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="397">
          
          
          <code class="ruby">    chat_type = res[&quot;results&quot;][&quot;room&quot;][&quot;chat_type&quot;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="398">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="399">
          
          
          <code class="ruby">    if room_name.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="400">
          
          
          <code class="ruby">      raise Exception.new(&quot;Qiscus room name is null.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="401">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="402">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="403">
          
          
          <code class="ruby">    if room_id.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="404">
          
          
          <code class="ruby">      raise Exception.new(&quot;Qiscus room id is null.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="405">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="406">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="407">
          
          
          <code class="ruby">    if unique_id.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="408">
          
          
          <code class="ruby">      raise Exception.new(&quot;Qiscus unique_id id is null.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="409">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="410">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="411">
          
          
          <code class="ruby">    is_group_chat = false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="412">
          
          
          <code class="ruby">    if chat_type.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="413">
          
          
          <code class="ruby">      raise Exception.new(&quot;Qiscus chat type is null.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="414">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="415">
          
          
          <code class="ruby">      if chat_type != &quot;single&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="416">
          
          
          <code class="ruby">        is_group_chat = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="417">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="418">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="419">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="420">
          
          
          <code class="ruby">    response = OpenStruct.new(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="421">
          
          
          <code class="ruby">    {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="422">
          
          
          <code class="ruby">      :name =&gt; room_name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="423">
          
          
          <code class="ruby">      :id =&gt; room_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="424">
          
          
          <code class="ruby">      :unique_id =&gt; unique_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="425">
          
          
          <code class="ruby">      :is_group_chat =&gt; is_group_chat</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="426">
          
          
          <code class="ruby">    })</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="427">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="428">
          
          
          <code class="ruby">    return response</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="429">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="430">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="431">
          <span class="hits">2</span>
          
          <code class="ruby">  def get_user_rooms(user_email, page = 1, limit = 100, show_participants = false)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="432">
          
          
          <code class="ruby">    if !user_email.kind_of?(String) || user_email.nil? || user_email == &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="433">
          
          
          <code class="ruby">      raise Exception.new(&quot;User email is not string or nil.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="434">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="435">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="436">
          
          
          <code class="ruby">    url = &quot;#{@BASE_URL}/api/v2/rest/get_user_rooms?user_email=#{user_email}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="437">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="438">
          
          
          <code class="ruby">    params = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="439">
          
          
          <code class="ruby">      &quot;user_email&quot; =&gt; user_email,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="440">
          
          
          <code class="ruby">      &quot;page&quot; =&gt; page,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="441">
          
          
          <code class="ruby">      &quot;limit&quot; =&gt; limit,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="442">
          
          
          <code class="ruby">      &quot;show_participants&quot; =&gt; show_participants,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="443">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="444">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="445">
          
          
          <code class="ruby">    res = request(&quot;GET&quot;, url, params)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="446">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="447">
          
          
          <code class="ruby">    if res[&quot;status&quot;] == 200</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="448">
          
          
          <code class="ruby">      responses = Hash.new</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="449">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="450">
          
          
          <code class="ruby">      rooms_info = res[&quot;results&quot;][&quot;rooms_info&quot;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="451">
          
          
          <code class="ruby">      rooms_info.to_a.each do |ri|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="452">
          
          
          <code class="ruby">        tmp = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="453">
          
          
          <code class="ruby">          &quot;last_comment_message&quot; =&gt; ri[&quot;last_comment_message&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="454">
          
          
          <code class="ruby">          &quot;last_comment_timestamp&quot; =&gt; ri[&quot;last_comment_timestamp&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="455">
          
          
          <code class="ruby">          &quot;room_id&quot; =&gt; ri[&quot;room_id&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="456">
          
          
          <code class="ruby">          &quot;room_name&quot; =&gt; ri[&quot;room_name&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="457">
          
          
          <code class="ruby">          &quot;room_type&quot; =&gt; ri[&quot;room_type&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="458">
          
          
          <code class="ruby">          &quot;last_comment_id&quot; =&gt; ri[&quot;last_comment_id&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="459">
          
          
          <code class="ruby">          &quot;unread_count&quot; =&gt; ri[&quot;unread_count&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="460">
          
          
          <code class="ruby">          &quot;room_avatar_url&quot; =&gt; ri[&quot;room_avatar_url&quot;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="461">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="462">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="463">
          
          
          <code class="ruby">        # make room id as index for easy access in chat room model</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="464">
          
          
          <code class="ruby">        responses[ri[&quot;room_id&quot;].to_i] = tmp</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="465">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="466">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="467">
          
          
          <code class="ruby">      return res[&quot;status&quot;], responses</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="468">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="469">
          
          
          <code class="ruby">      return status, res</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="470">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="471">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="472">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="473">
          <span class="hits">2</span>
          
          <code class="ruby">  def upload_file(token, file)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="474">
          
          
          <code class="ruby">      if !defined?(file.content_type) || !defined?(file.original_filename)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="475">
          
          
          <code class="ruby">        raise Exception.new(&quot;Invalid file.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="476">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="477">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="478">
          
          
          <code class="ruby">      user = User.find_by(qiscus_token: token)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="479">
          
          
          <code class="ruby">      if user</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="480">
          
          
          <code class="ruby">        app_id = user.application.app_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="481">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="482">
          
          
          <code class="ruby">        raise Exception.new(&quot;User not found&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="483">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="484">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="485">
          
          
          <code class="ruby">      upload_url = &quot;#{@BASE_URL}/api/v2/mobile/upload&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="486">
          
          
          <code class="ruby">      uri = URI.parse(upload_url)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="487">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="488">
          
          
          <code class="ruby">      req = Net::HTTP::Post::Multipart.new uri.path,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="489">
          
          
          <code class="ruby">        &quot;file&quot; =&gt; UploadIO.new(file, file.content_type, file.original_filename),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="490">
          
          
          <code class="ruby">        &quot;token&quot; =&gt; token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="491">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="492">
          
          
          <code class="ruby">      req.add_field(&quot;QISCUS_SDK_APP_ID&quot;, app_id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="493">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="494">
          
          
          <code class="ruby">      http = Net::HTTP.new(uri.host, uri.port)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="495">
          
          
          <code class="ruby">      http.use_ssl = true if uri.scheme == &#39;https&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="496">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="497">
          
          
          <code class="ruby">      res = http.start do |h|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="498">
          
          
          <code class="ruby">        h.use_ssl = (uri.scheme == &quot;https&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="499">
          
          
          <code class="ruby">        h.request(req)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="500">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="501">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="502">
          
          
          <code class="ruby">      res = JSON.parse(res.body)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="503">
          
          
          <code class="ruby">      puts &quot;RESPONSE #{res}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="504">
          
          
          <code class="ruby">      res = res[&quot;results&quot;][&quot;file&quot;][&quot;url&quot;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="505">
          
          
          <code class="ruby">      return res</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="506">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="507">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="508">
          <span class="hits">2</span>
          
          <code class="ruby">  def update_profile(email, name = nil, avatar_url = nil, password =nil)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="509">
          
          
          <code class="ruby">    update_profile_url = &quot;#{@BASE_URL}/api/v2/rest/update_profile&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="510">
          
          
          <code class="ruby">    params = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="511">
          
          
          <code class="ruby">      &quot;email&quot; =&gt; email,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="512">
          
          
          <code class="ruby">      &quot;name&quot; =&gt; name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="513">
          
          
          <code class="ruby">      &quot;avatar_url&quot; =&gt; avatar_url,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="514">
          
          
          <code class="ruby">      &quot;password&quot; =&gt; password</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="515">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="516">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="517">
          
          
          <code class="ruby">    res = request(&quot;POST&quot;, update_profile_url, params)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="518">
          
          
          <code class="ruby">    token = res[&quot;results&quot;][&quot;user&quot;][&quot;token&quot;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="519">
          
          
          <code class="ruby">    if token.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="520">
          
          
          <code class="ruby">      raise Exception.new(&quot;Qiscus token is null.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="521">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="522">
          
          
          <code class="ruby">      return token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="523">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="524">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="525">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="526">
          <span class="hits">2</span>
          
          <code class="ruby">  def broadcast(sender_email, emails, message, type = &quot;text&quot;, payload = nil, extras = nil)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="527">
          
          
          <code class="ruby">    url = &quot;#{@BASE_URL}/api/v2/rest/broadcast&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="528">
          
          
          <code class="ruby">    params = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="529">
          
          
          <code class="ruby">      &quot;sender_email&quot; =&gt; sender_email,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="530">
          
          
          <code class="ruby">      &quot;emails[]&quot; =&gt; emails,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="531">
          
          
          <code class="ruby">      &quot;message&quot; =&gt; message,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="532">
          
          
          <code class="ruby">      &quot;type&quot; =&gt; type,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="533">
          
          
          <code class="ruby">      &quot;payload&quot; =&gt; payload,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="534">
          
          
          <code class="ruby">      &quot;extras&quot; =&gt; extras,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="535">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="536">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="537">
          
          
          <code class="ruby">    res = request(&quot;POST&quot;, url, params)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="538">
          
          
          <code class="ruby">    res = res[&quot;results&quot;][&quot;comments&quot;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="539">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="540">
          
          
          <code class="ruby">    return res</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="541">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="542">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="543">
          <span class="hits">2</span>
          
          <code class="ruby">  def broadcast_v21(sender_email, emails, message, type = &quot;text&quot;, payload = nil, extras = nil)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="544">
          
          
          <code class="ruby">    url = &quot;#{@BASE_URL}/api/v2.1/rest/broadcast&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="545">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="546">
          
          
          <code class="ruby">    params = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="547">
          
          
          <code class="ruby">      &quot;sender_user_id&quot; =&gt; sender_email,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="548">
          
          
          <code class="ruby">      &quot;target_user_ids[]&quot; =&gt; emails,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="549">
          
          
          <code class="ruby">      &quot;message&quot; =&gt; message,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="550">
          
          
          <code class="ruby">      &quot;type&quot; =&gt; type,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="551">
          
          
          <code class="ruby">      &quot;payload&quot; =&gt; payload,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="552">
          
          
          <code class="ruby">      &quot;extras&quot; =&gt; extras,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="553">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="554">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="555">
          
          
          <code class="ruby">    res = request(&quot;POST&quot;, url, params)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="556">
          
          
          <code class="ruby">    res = res[&quot;results&quot;][&quot;comments&quot;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="557">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="558">
          
          
          <code class="ruby">    return res</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="559">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="560">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="561">
          <span class="hits">2</span>
          
          <code class="ruby">  def get_or_create_channel(chat_name, unique_id, participants, room_avatar_url=nil)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="562">
          <span class="hits">1</span>
          
          <code class="ruby">    if !participants.kind_of?(Array) || participants.nil? || participants == &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="563">
          
          
          <code class="ruby">      raise Exception.new(&quot;Participants is not array or nil.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="564">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="565">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="566">
          <span class="hits">1</span>
          
          <code class="ruby">    url = &quot;#{@BASE_URL}/api/v2.1/rest/get_or_create_channel&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="567">
          <span class="hits">1</span>
          
          <code class="ruby">    params = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="568">
          
          
          <code class="ruby">      &quot;unique_id&quot; =&gt; unique_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="569">
          
          
          <code class="ruby">      &quot;chat_name&quot; =&gt; chat_name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="570">
          
          
          <code class="ruby">      &quot;participants[]&quot; =&gt; participants.to_a,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="571">
          
          
          <code class="ruby">      &quot;room_avatar_url&quot; =&gt; room_avatar_url</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="572">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="573">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="574">
          <span class="hits">1</span>
          
          <code class="ruby">    res = request(&quot;POST&quot;, url, params)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="575">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="576">
          
          
          <code class="ruby">    response = OpenStruct.new(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="577">
          
          
          <code class="ruby">    {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="578">
          
          
          <code class="ruby">      :name =&gt; res[&quot;results&quot;][&quot;room_name&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="579">
          
          
          <code class="ruby">      :id =&gt; res[&quot;results&quot;][&quot;room&quot;][&quot;room_id&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="580">
          
          
          <code class="ruby">      :is_group_chat =&gt; true,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="581">
          
          
          <code class="ruby">      :is_channel =&gt; true,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="582">
          
          
          <code class="ruby">    })</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="583">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="584">
          
          
          <code class="ruby">    return response</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="585">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="586">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="587">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="588">
          <span class="hits">2</span>
          
          <code class="ruby">  private</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="589">
          <span class="hits">2</span>
          
          <code class="ruby">    def request(req_method, url, params = {})</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="590">
          <span class="hits">3</span>
          
          <code class="ruby">      return net_http(req_method, url, params)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="591">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="592">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="593">
          
          
          <code class="ruby">    # request using net/http</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="594">
          <span class="hits">2</span>
          
          <code class="ruby">    def net_http(req_method, url, params = {})</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="595">
          <span class="hits">3</span>
          
          <code class="ruby">      begin</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="596">
          <span class="hits">3</span>
          
          <code class="ruby">        uri = URI.parse(url)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="597">
          <span class="hits">3</span>
          
          <code class="ruby">        https = Net::HTTP.new(uri.host, uri.port)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="598">
          <span class="hits">3</span>
          
          <code class="ruby">        https.use_ssl = (uri.scheme == &quot;https&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="599">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="600">
          <span class="hits">3</span>
          
          <code class="ruby">        Rails.logger.debug &quot;#{req_method} #{url} with params #{params}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="601">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="602">
          <span class="hits">3</span>
          
          <code class="ruby">        _headers = {}</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="603">
          <span class="hits">3</span>
          
          <code class="ruby">        _headers[&quot;QISCUS_SDK_APP_ID&quot;] = @QISCUS_SDK_APP_ID</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="604">
          <span class="hits">3</span>
          
          <code class="ruby">        _headers[&quot;QISCUS_SDK_SECRET&quot;] = @QISCUS_SDK_SECRET</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="605">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="606">
          <span class="hits">3</span>
          
          <code class="ruby">        if req_method == &quot;POST&quot;</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="607">
          <span class="hits">3</span>
          
          <code class="ruby">          req = Net::HTTP::Post.new(uri.path, _headers)</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="608">
          <span class="hits">3</span>
          
          <code class="ruby">          req.set_form_data(params)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="609">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="610">
          <span class="hits">3</span>
          
          <code class="ruby">          Rails.logger.debug &quot;#{req_method} #{url} with headers #{req}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="611">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="612">
          <span class="hits">3</span>
          
          <code class="ruby">          res = https.request(req)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="613">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="614">
          <span class="hits">3</span>
          
          <code class="ruby">          if res.is_a?(Net::HTTPSuccess)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="615">
          
          
          <code class="ruby">            res = JSON.parse(res.body)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="616">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="617">
          
          
          <code class="ruby">            Rails.logger.debug &quot;#{req_method} #{url} response #{res}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="618">
          
          
          <code class="ruby">            return res</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="619">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="620">
          <span class="hits">3</span>
          
          <code class="ruby">            if res.content_type == &quot;application/json&quot;</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="621">
          <span class="hits">3</span>
          
          <code class="ruby">              Rails.logger.debug &quot;#{req_method} #{url} response #{JSON.parse(res.body)}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="622">
          
          
          <code class="ruby">            else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="623">
          
          
          <code class="ruby">              Rails.logger.debug &quot;#{req_method} #{url} response #{res.body}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="624">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="625">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="626">
          <span class="hits">3</span>
          
          <code class="ruby">            Raven.capture_message(&quot;Error while calling QiscusSdk&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="627">
          
          
          <code class="ruby">              level: &quot;error&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="628">
          
          
          <code class="ruby">              extra: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="629">
          
          
          <code class="ruby">                url: url,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="630">
          
          
          <code class="ruby">                request_parameter: params,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="631">
          
          
          <code class="ruby">                response_body: res.body</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="632">
          
          
          <code class="ruby">              }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="633">
          
          
          <code class="ruby">            )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="634">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="635">
          <span class="hits">3</span>
          
          <code class="ruby">            raise Exception.new(&quot;Error while calling Qiscus SDK #{uri.host} return HTTP status code #{res.code} (#{res.message})&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="636">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="637">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="638">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="639">
          
          
          <code class="ruby">          # GET</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="640">
          
          
          <code class="ruby">          req = Net::HTTP::Get.new(uri, _headers)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="641">
          
          
          <code class="ruby">          req.set_form_data(params)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="642">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="643">
          
          
          <code class="ruby">          Rails.logger.debug &quot;#{req_method} #{url} with headers #{req}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="644">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="645">
          
          
          <code class="ruby">          res = https.request(req)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="646">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="647">
          
          
          <code class="ruby">          if res.is_a?(Net::HTTPSuccess)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="648">
          
          
          <code class="ruby">            res = JSON.parse(res.body)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="649">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="650">
          
          
          <code class="ruby">            Rails.logger.debug &quot;#{req_method} #{url} response #{res}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="651">
          
          
          <code class="ruby">            return res</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="652">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="653">
          
          
          <code class="ruby">            if res.content_type == &quot;application/json&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="654">
          
          
          <code class="ruby">              Rails.logger.debug &quot;#{req_method} #{url} response #{JSON.parse(res.body)}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="655">
          
          
          <code class="ruby">            else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="656">
          
          
          <code class="ruby">              Rails.logger.debug &quot;#{req_method} #{url} response #{res.body}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="657">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="658">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="659">
          
          
          <code class="ruby">            Raven.capture_message(&quot;Error while calling QiscusSdk&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="660">
          
          
          <code class="ruby">              level: &quot;error&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="661">
          
          
          <code class="ruby">              extra: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="662">
          
          
          <code class="ruby">                url: url,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="663">
          
          
          <code class="ruby">                request_parameter: params,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="664">
          
          
          <code class="ruby">                response_body: res.body</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="665">
          
          
          <code class="ruby">              }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="666">
          
          
          <code class="ruby">            )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="667">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="668">
          
          
          <code class="ruby">            raise Exception.new(&quot;Error while calling Qiscus SDK #{uri.host} return HTTP status code #{res.code} (#{res.message})&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="669">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="670">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="671">
          <span class="hits">3</span>
          
          <code class="ruby">      rescue Exception =&gt; e</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="672">
          <span class="hits">3</span>
          
          <code class="ruby">        raise Exception.new(e.message)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="673">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="674">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="675">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="676">
          
          
          <code class="ruby">    # request using curb</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="677">
          <span class="hits">2</span>
          
          <code class="ruby">    def curb_post(req_method, url, params = {})</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="678">
          
          
          <code class="ruby">      begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="679">
          
          
          <code class="ruby">        res = Curl.post(url, params) do |curl|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="680">
          
          
          <code class="ruby">          curl.headers[&quot;QISCUS_SDK_APP_ID&quot;] = @QISCUS_SDK_APP_ID</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="681">
          
          
          <code class="ruby">          curl.headers[&quot;QISCUS_SDK_SECRET&quot;] = @QISCUS_SDK_SECRET</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="682">
          
          
          <code class="ruby">          # curl.verbose = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="683">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="684">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="685">
          
          
          <code class="ruby">        Rails.logger.debug &quot;#{req_method} #{url} with params #{params}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="686">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="687">
          
          
          <code class="ruby">        if res.content_type.include?(&#39;application/json&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="688">
          
          
          <code class="ruby">          # should be 200 OK</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="689">
          
          
          <code class="ruby">          if res.response_code == 200</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="690">
          
          
          <code class="ruby">            return 200, JSON.parse(res.body_str)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="691">
          
          
          <code class="ruby">          else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="692">
          
          
          <code class="ruby">            error = JSON.parse(res.body_str)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="693">
          
          
          <code class="ruby">            message = error[&#39;error&#39;][&#39;detailed_messages&#39;].to_a.join(&quot;, &quot;).capitalize</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="694">
          
          
          <code class="ruby">            message = &quot;Error while calling Qiscus SDK #{url} return HTTP status code #{res.response_code}. #{message}.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="695">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="696">
          
          
          <code class="ruby">            Raven.capture_message(message,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="697">
          
          
          <code class="ruby">              level: &quot;error&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="698">
          
          
          <code class="ruby">              extra: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="699">
          
          
          <code class="ruby">              url: url,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="700">
          
          
          <code class="ruby">                request_parameter: params,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="701">
          
          
          <code class="ruby">                response_body: JSON.parse(res.body_str)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="702">
          
          
          <code class="ruby">              }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="703">
          
          
          <code class="ruby">            )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="704">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="705">
          
          
          <code class="ruby">            return res.response_code, error</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="706">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="707">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="708">
          
          
          <code class="ruby">          raise Exception.new(&quot;Qiscus SDK return HTTP status code #{res.response_code}.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="709">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="710">
          
          
          <code class="ruby">      rescue Exception =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="711">
          
          
          <code class="ruby">        raise Exception.new(e.message)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="712">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="713">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="714">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="715">
          <span class="hits">2</span>
          
          <code class="ruby">    def faraday_post(url, params = {})</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="716">
          
          
          <code class="ruby">      begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="717">
          
          
          <code class="ruby">        conn = Faraday.new @BASE_URL do |con|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="718">
          
          
          <code class="ruby">          con.request :url_encoded</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="719">
          
          
          <code class="ruby">          con.adapter :net_http</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="720">
          
          
          <code class="ruby">          con.headers[&quot;QISCUS_SDK_APP_ID&quot;] = @QISCUS_SDK_APP_ID</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="721">
          
          
          <code class="ruby">          con.headers[&quot;QISCUS_SDK_SECRET&quot;] = @QISCUS_SDK_SECRET</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="722">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="723">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="724">
          
          
          <code class="ruby">        resp = conn.post url, params</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="725">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="726">
          
          
          <code class="ruby">        Rails.logger.debug &quot;POST #{@BASE_URL}#{url} with params #{params}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="727">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="728">
          
          
          <code class="ruby">        if resp.status == 200</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="729">
          
          
          <code class="ruby">          res = resp.body</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="730">
          
          
          <code class="ruby">          return resp.status, JSON.parse(res)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="731">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="732">
          
          
          <code class="ruby">          error = JSON.parse(resp.body)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="733">
          
          
          <code class="ruby">          message = error[&#39;error&#39;][&#39;detailed_messages&#39;].to_a.join(&quot;, &quot;).capitalize</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="734">
          
          
          <code class="ruby">          message = &quot;Error while calling Qiscus SDK #{@BASE_URL}#{url} return HTTP status code #{resp.status}. #{message}.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="735">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="736">
          
          
          <code class="ruby">          Raven.capture_message(message,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="737">
          
          
          <code class="ruby">            level: &quot;error&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="738">
          
          
          <code class="ruby">            extra: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="739">
          
          
          <code class="ruby">              url: url,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="740">
          
          
          <code class="ruby">              request_parameter: params,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="741">
          
          
          <code class="ruby">              response_body: error</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="742">
          
          
          <code class="ruby">            }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="743">
          
          
          <code class="ruby">          )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="744">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="745">
          
          
          <code class="ruby">          return resp.status, error</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="746">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="747">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="748">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="749">
          
          
          <code class="ruby">      rescue Exception =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="750">
          
          
          <code class="ruby">        Raven.capture_message(e.message,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="751">
          
          
          <code class="ruby">          level: &quot;error&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="752">
          
          
          <code class="ruby">          extra: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="753">
          
          
          <code class="ruby">            url: url</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="754">
          
          
          <code class="ruby">          }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="755">
          
          
          <code class="ruby">        )</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="756">
          
          
          <code class="ruby">        raise Exception.new(e.message)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="757">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="758">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="759">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="ec7a00560c72c620b0b88d520ce5f70c63a4e922">
  <div class="header">
    <h3>app/helpers/sms_verification.rb</h3>
    <h4><span class="red">22.46 %</span> covered</h4>
    <div>
      <b>138</b> relevant lines. 
      <span class="green"><b>31</b> lines covered</span> and
      <span class="red"><b>107</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="2" data-linenumber="1">
          <span class="hits">2</span>
          
          <code class="ruby">require &#39;nexmo&#39;</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="2">
          <span class="hits">2</span>
          
          <code class="ruby">require &#39;twilio-ruby&#39;</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="3">
          <span class="hits">2</span>
          
          <code class="ruby">require &#39;base64&#39;</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="4">
          <span class="hits">2</span>
          
          <code class="ruby">require &#39;net/http&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="6">
          <span class="hits">2</span>
          
          <code class="ruby">class SmsVerification</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="7">
          <span class="hits">2</span>
          
          <code class="ruby">  SMS_SENDER = ENV[&quot;SMS_SENDER&quot;] || &quot;Kiwari&quot;</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="8">
          <span class="hits">2</span>
          
          <code class="ruby">  NEXMO_API_KEY = ENV[&#39;NEXMO_API_KEY&#39;] || &quot;DUMMY_OR_DEVELOPMENT_API_KEY&quot;</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="9">
          <span class="hits">2</span>
          
          <code class="ruby">  NEXMO_API_SECRET = ENV[&#39;NEXMO_API_SECRET&#39;] || &quot;DUMMY_SECRET_API_KEY&quot;</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="10">
          <span class="hits">2</span>
          
          <code class="ruby">  TWILIO_SID_KEY = ENV[&#39;TWILIO_SID_KEY&#39;] || &quot;AC1f0a135ab58088f504d06cac63477238&quot;</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="11">
          <span class="hits">2</span>
          
          <code class="ruby">  TWILIO_TOKEN_KEY = ENV[&#39;TWILIO_TOKEN_KEY&#39;] || &quot;7cf5dbe93359d02e572e62bd9fcefa0c&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="13">
          <span class="hits">2</span>
          
          <code class="ruby">  INFOBIP_USERNAME = ENV[&#39;INFOBIP_USERNAME&#39;] || &quot;QiscusTekno&quot;</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="14">
          <span class="hits">2</span>
          
          <code class="ruby">  INFOBIP_PASSWORD = ENV[&#39;INFOBIP_PASSWORD&#39;] || &quot;Test1234&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">  # this must be base64 encode string from &quot;username:password&quot;</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="16">
          <span class="hits">2</span>
          
          <code class="ruby">  INFOBIP_AUTHORIZATION_KEY = Base64.encode64(&quot;#{INFOBIP_USERNAME}:#{INFOBIP_PASSWORD}&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="18">
          <span class="hits">2</span>
          
          <code class="ruby">  MAINAPI_CLIENT_ID = ENV[&#39;MAINAPI_CLIENT_ID&#39;]</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="19">
          <span class="hits">2</span>
          
          <code class="ruby">  MAINAPI_CLIENT_SECRET = ENV[&#39;MAINAPI_CLIENT_SECRET&#39;]</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="20">
          <span class="hits">2</span>
          
          <code class="ruby">  MAINAPI_GRANT_TYPE = ENV[&#39;MAINAPI_GRANT_TYPE&#39;]</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="21">
          <span class="hits">2</span>
          
          <code class="ruby">  MAINAPI_USERNAME = ENV[&#39;MAINAPI_USERNAME&#39;]</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="22">
          <span class="hits">2</span>
          
          <code class="ruby">  MAINAPI_PASSWORD = ENV[&#39;MAINAPI_PASSWORD&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="24">
          <span class="hits">2</span>
          
          <code class="ruby">  def self.request(user, code)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">    phone_no = user.phone_number</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">    attempt = user.verification_attempts</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">    application_id = user.application_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">		sms_sender = user.application.sms_sender</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">    verify_text = &quot;Your passcode for #{user.application.app_name} is #{code}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">    provider_setting = ProviderSetting.find_by(application_id: application_id, attempt: attempt)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">    # prevent provider setting null error when no one provider setting in db</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">    if provider_setting.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">      raise Exception.new(&quot;Provider setting is not exists, you may not receive your passcode.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">    provider_name = provider_setting.provider.provider_name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">    provider_id = provider_setting.provider_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">    content = send(provider_name, phone_no, verify_text, user.application.sms_sender)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">    # Save sms verification log</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">    sms_verification_log = SmsVerificationLog.new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">    sms_verification_log.user_id = user.id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">    sms_verification_log.provider_id = provider_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">    sms_verification_log.content = content</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">    # sms_verification_log.status = true # Skip this field because for now only need the response from sms provider</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">    sms_verification_log.save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">    if attempt == 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">      user.update_columns(verification_attempts: 1)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="53">
          
          
          <code class="ruby">    elsif attempt == 1</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">      user.update_columns(verification_attempts: 2)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">    elsif attempt == 2</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="56">
          
          
          <code class="ruby">      user.update_columns(verification_attempts: 0)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="60">
          <span class="hits">2</span>
          
          <code class="ruby">  def self.send(provider, phone_no, verify_text, sms_sender)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">    if provider == &quot;twilio&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">      send_using_twilio(phone_no, verify_text, sms_sender)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="63">
          
          
          <code class="ruby">    elsif provider == &quot;infobip&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="64">
          
          
          <code class="ruby">      send_using_infobip(phone_no, verify_text, sms_sender)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="65">
          
          
          <code class="ruby">    elsif provider == &quot;nexmo&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="66">
          
          
          <code class="ruby">      send_using_nexmo(phone_no, verify_text, sms_sender)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="67">
          
          
          <code class="ruby">    elsif provider == &quot;mainapi&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="68">
          
          
          <code class="ruby">      send_using_mainapi(phone_no, verify_text, sms_sender)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="72">
          <span class="hits">2</span>
          
          <code class="ruby">  def self.confirm(secret_code, secret_code2)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="73">
          
          
          <code class="ruby">    return (secret_code == secret_code2) ? true : false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="76">
          <span class="hits">2</span>
          
          <code class="ruby">  def self.nexmo_client</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="77">
          
          
          <code class="ruby">    Nexmo::Client.new(key: NEXMO_API_KEY, secret: NEXMO_API_SECRET)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="80">
          <span class="hits">2</span>
          
          <code class="ruby">  def self.send_using_twilio(phone_no, verify_text, sms_sender)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="81">
          
          
          <code class="ruby">    @client = Twilio::REST::Client.new(TWILIO_SID_KEY, TWILIO_TOKEN_KEY)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="82">
          
          
          <code class="ruby">      begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="83">
          
          
          <code class="ruby">        message = @client.api.account.messages.create(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">          from: sms_sender,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">          to: phone_no,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">          body: verify_text</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">        )</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="88">
          
          
          <code class="ruby">      rescue Twilio::REST::RestError =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="89">
          
          
          <code class="ruby">          puts e.message</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="93">
          <span class="hits">2</span>
          
          <code class="ruby">  def self.send_using_nexmo(phone_no, verify_text, sms_sender)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="94">
          
          
          <code class="ruby">    message = nexmo_client.sms.send(to: phone_no, from: sms_sender, text: verify_text)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="97">
          <span class="hits">2</span>
          
          <code class="ruby">  def self.generate_code(phone_number, application_id)</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="98">
          <span class="hits">7</span>
          
          <code class="ruby">    user = User.find_by(phone_number: phone_number, application_id: application_id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="100">
          <span class="hits">7</span>
          
          <code class="ruby">    if user.nil?</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="101">
          <span class="hits">7</span>
          
          <code class="ruby">      rand(1000..9999).to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="103">
          
          
          <code class="ruby">      user_dedicated_passcode = UserDedicatedPasscode.find_by(user_id: user.id, application_id: application_id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="105">
          
          
          <code class="ruby">      if user_dedicated_passcode.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="106">
          
          
          <code class="ruby">        rand(1000..9999).to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="108">
          
          
          <code class="ruby">        user_dedicated_passcode.passcode</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="113">
          <span class="hits">2</span>
          
          <code class="ruby">  def self.send_using_infobip(phone_number, verify_text, sms_sender)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="114">
          
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">      # infobip url api for sending single text message</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="116">
          
          
          <code class="ruby">      uri = URI.parse(&#39;http://107.20.199.106/restapi/sms/1/text/single&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="117">
          
          
          <code class="ruby">      https = Net::HTTP.new(uri.host, uri.port)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="119">
          
          
          <code class="ruby">      _headers = {}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="120">
          
          
          <code class="ruby">      _headers[&quot;Authorization&quot;] = &quot;Basic #{INFOBIP_AUTHORIZATION_KEY}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="121">
          
          
          <code class="ruby">      _headers[&quot;Content-Type&quot;]  = &quot;application/json&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="122">
          
          
          <code class="ruby">      _headers[&quot;Accept&quot;]        = &quot;application/json&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="124">
          
          
          <code class="ruby">      params = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby">        &quot;from&quot;: sms_sender,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby">        &quot;to&quot;: phone_number,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby">        &quot;text&quot;: verify_text</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="130">
          
          
          <code class="ruby">      req = Net::HTTP::Post.new(uri.path, _headers)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="131">
          
          
          <code class="ruby">      req.body = params.to_json</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="133">
          
          
          <code class="ruby">      res = https.request(req)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="135">
          
          
          <code class="ruby">      if res.is_a?(Net::HTTPSuccess)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="136">
          
          
          <code class="ruby">        res = JSON.parse(res.body)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="138">
          
          
          <code class="ruby">        Rails.logger.debug &quot;POST #{uri} response #{res}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="139">
          
          
          <code class="ruby">        return res</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="141">
          
          
          <code class="ruby">        if res.content_type == &quot;application/json&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="142">
          
          
          <code class="ruby">          Rails.logger.debug &quot;POST #{uri} response #{JSON.parse(res.body)}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="144">
          
          
          <code class="ruby">          Rails.logger.debug &quot;POST #{uri} response #{res.body}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="147">
          
          
          <code class="ruby">        raise Exception.new(&quot;Error while calling InfoBip API with HTTP status #{res.code} (#{res.message})&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="150">
          
          
          <code class="ruby">    rescue Exception =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="151">
          
          
          <code class="ruby">      Rails.logger.debug e.message</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="154">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="155">
          <span class="hits">2</span>
          
          <code class="ruby">  def self.send_using_mainapi(phone_number, verify_text, sms_sender)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="156">
          
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby">      # get mainapi access token</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="158">
          
          
          <code class="ruby">      access_token = get_mainapi_token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="160">
          
          
          <code class="ruby">      # mainapi url api for sending single text message</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="161">
          
          
          <code class="ruby">      uri = URI.parse(&#39;http://api.mainapi.net/smsnotification/1.0.0/messages&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="162">
          
          
          <code class="ruby">      https = Net::HTTP.new(uri.host, uri.port)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="164">
          
          
          <code class="ruby">      _headers = {}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="165">
          
          
          <code class="ruby">      _headers[&quot;Authorization&quot;] = &quot;Bearer #{access_token}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="166">
          
          
          <code class="ruby">      _headers[&quot;Content-Type&quot;]  = &quot;application/x-www-form-urlencoded&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="167">
          
          
          <code class="ruby">      _headers[&quot;X-MainAPI-Senderid&quot;]  = sms_sender</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="168">
          
          
          <code class="ruby">      _headers[&quot;X-MainAPI-Username&quot;]  = MAINAPI_USERNAME</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="169">
          
          
          <code class="ruby">      _headers[&quot;X-MainAPI-Password&quot;]  = MAINAPI_PASSWORD</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="170">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="171">
          
          
          <code class="ruby">      params = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="172">
          
          
          <code class="ruby">        &quot;msisdn&quot;: phone_number,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="173">
          
          
          <code class="ruby">        &quot;content&quot;: verify_text</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="174">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="175">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="176">
          
          
          <code class="ruby">      req = Net::HTTP::Post.new(uri.path, _headers)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="177">
          
          
          <code class="ruby">      req.set_form_data(params)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="178">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="179">
          
          
          <code class="ruby">      res = https.request(req)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="180">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="181">
          
          
          <code class="ruby">      if res.is_a?(Net::HTTPSuccess)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="182">
          
          
          <code class="ruby">        res = JSON.parse(res.body)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="183">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="184">
          
          
          <code class="ruby">        Rails.logger.debug &quot;POST #{uri} response #{res}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="185">
          
          
          <code class="ruby">        return res</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="186">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="187">
          
          
          <code class="ruby">        if res.content_type == &quot;application/json&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="188">
          
          
          <code class="ruby">          Rails.logger.debug &quot;POST #{uri} response #{JSON.parse(res.body)}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="189">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="190">
          
          
          <code class="ruby">          Rails.logger.debug &quot;POST #{uri} response #{res.body}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="191">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="192">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="193">
          
          
          <code class="ruby">        raise Exception.new(&quot;Error while calling Mainapi API with HTTP status #{res.code} (#{res.message})&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="194">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="195">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="196">
          
          
          <code class="ruby">    rescue Exception =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="197">
          
          
          <code class="ruby">      Rails.logger.debug e.message</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="198">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="199">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="200">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="201">
          <span class="hits">2</span>
          
          <code class="ruby">  def self.get_mainapi_token()</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="202">
          
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="203">
          
          
          <code class="ruby">      # mainapi url api for getting access token</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="204">
          
          
          <code class="ruby">      uri = URI.parse(&#39;http://api.mainapi.net/token&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="205">
          
          
          <code class="ruby">      https = Net::HTTP.new(uri.host, uri.port)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="206">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="207">
          
          
          <code class="ruby">      _headers = {}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="208">
          
          
          <code class="ruby">      _headers[&quot;Content-Type&quot;]  = &quot;application/x-www-form-urlencoded&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="209">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="210">
          
          
          <code class="ruby">      params = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="211">
          
          
          <code class="ruby">        &quot;client_id&quot;: MAINAPI_CLIENT_ID,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="212">
          
          
          <code class="ruby">        &quot;client_secret&quot;: MAINAPI_CLIENT_SECRET,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="213">
          
          
          <code class="ruby">        &quot;grant_type&quot;: MAINAPI_GRANT_TYPE</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="214">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="215">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="216">
          
          
          <code class="ruby">      req = Net::HTTP::Post.new(uri.path, _headers)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="217">
          
          
          <code class="ruby">      req.set_form_data(params)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="218">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="219">
          
          
          <code class="ruby">      res = https.request(req)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="220">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="221">
          
          
          <code class="ruby">      if res.is_a?(Net::HTTPSuccess)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="222">
          
          
          <code class="ruby">        res = JSON.parse(res.body)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="223">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="224">
          
          
          <code class="ruby">        Rails.logger.debug &quot;POST #{uri} response #{res}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="225">
          
          
          <code class="ruby">        access_token = res[&quot;access_token&quot;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="226">
          
          
          <code class="ruby">        return access_token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="227">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="228">
          
          
          <code class="ruby">        if res.content_type == &quot;application/json&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="229">
          
          
          <code class="ruby">          Rails.logger.debug &quot;POST #{uri} response #{JSON.parse(res.body)}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="230">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="231">
          
          
          <code class="ruby">          Rails.logger.debug &quot;POST #{uri} response #{res.body}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="232">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="233">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="234">
          
          
          <code class="ruby">        raise Exception.new(&quot;Error while calling Mainapi API with HTTP status #{res.code} (#{res.message})&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="235">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="236">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="237">
          
          
          <code class="ruby">    rescue Exception =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="238">
          
          
          <code class="ruby">      Rails.logger.debug e.message</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="239">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="240">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="241">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="242">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="857f908ba6e2abc1268153388ecd0eb6f27867de">
  <div class="header">
    <h3>app/helpers/super_admin_session_helper.rb</h3>
    <h4><span class="red">33.33 %</span> covered</h4>
    <div>
      <b>9</b> relevant lines. 
      <span class="green"><b>3</b> lines covered</span> and
      <span class="red"><b>6</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="2" data-linenumber="1">
          <span class="hits">2</span>
          
          <code class="ruby">require &#39;jwt&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="3">
          <span class="hits">2</span>
          
          <code class="ruby">module SuperAdminSessionHelper</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="5">
          <span class="hits">2</span>
          
          <code class="ruby">  def authorize_super_admin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">      if session[:superuser] == &#39;super&#39;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">        return true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">        redirect_to dashboard_auth_index_path and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">    rescue Exception =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">      redirect_to dashboard_auth_index_path and return</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="b64377d6b6e6e9a3b61e12834caf00f7be33e8ae">
  <div class="header">
    <h3>app/helpers/user_session_helper.rb</h3>
    <h4><span class="red">30.0 %</span> covered</h4>
    <div>
      <b>10</b> relevant lines. 
      <span class="green"><b>3</b> lines covered</span> and
      <span class="red"><b>7</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="2" data-linenumber="1">
          <span class="hits">2</span>
          
          <code class="ruby">require &#39;jwt&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="3">
          <span class="hits">2</span>
          
          <code class="ruby">module UserSessionHelper</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="5">
          <span class="hits">2</span>
          
          <code class="ruby">  def authorize_user</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">      @current_user = User.find_by(id: session[:user_id])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">      if @current_user.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">        redirect_back fallback_location: &quot;&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">      return true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">    rescue Exception =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">      redirect_back fallback_location: &quot;&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="6aecada08a3870bab61fe6ec35f896836bea2635">
  <div class="header">
    <h3>app/jobs/comment_push_notification_job.rb</h3>
    <h4><span class="red">10.34 %</span> covered</h4>
    <div>
      <b>29</b> relevant lines. 
      <span class="green"><b>3</b> lines covered</span> and
      <span class="red"><b>26</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class CommentPushNotificationJob &lt; ActiveJob::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  queue_as :push_notifications</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  def perform(post_id, post_commenter_id, user_ids, show_media_list_as)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">    post = Post.find(post_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">    post_commenter = User.find(post_commenter_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">    application = post_commenter.application</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">    post_commenter_name = post_commenter.fullname</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">    if post_commenter_name.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">      post_commenter_name = post_commenter.phone_number</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">    # find fcm_key that store in applications table</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">    fcm_key = post_commenter.application.fcm_key</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">    # alert is used for ios pop up</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">    alert = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">      title: &quot;New Comment&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">      body: &quot;#{post_commenter_name} commented in a post.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">    sound = &quot;bells.wav&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">    if show_media_list_as == &quot;array&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">      post_android = post.as_post_list_json</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">      post_ios = post.as_post_list_json(job: true)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">      post_android = post.as_json</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">      post_ios = post.as_json(job: true)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">    # payload for android</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">    android_payload = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">      data: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">        title:              &quot;New Comment&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">        body:               &quot;#{post_commenter_name} commented in a post.&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">        post:               post_android,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">        post_commenter:     post_commenter.as_json,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">        pn_type:            &quot;timeline_comment_post&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">    # payload for ios</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="45">
          
          
          <code class="ruby">    ios_payload = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">      payload: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">        title:              &quot;New Comment&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">        body:               &quot;#{post_commenter_name} commented in a post.&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">        post:               post_ios,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">        post_commenter:     post_commenter.as_json(job: true),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">        pn_type:            &quot;timeline_comment_post&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="55">
          
          
          <code class="ruby">    registration_ids = Array.new</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="57">
          
          
          <code class="ruby">    user_ids.each do |id|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">      user = User.find(id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="59">
          
          
          <code class="ruby">      userdevicetokens = user.user_device_tokens # get user device token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">      userdevicetokens.each do | u |</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">        # send push notification to ios using apnotic</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="63">
          
          
          <code class="ruby">        if u.user_type == &quot;ios&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">          # ApnoticClient.send(alert, u.devicetoken, ios_payload, sound)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="65">
          
          
          <code class="ruby">          SendApnsJob.perform_later(application, alert, u.devicetoken, ios_payload, sound)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">        # collect android devicetoken into array</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="69">
          
          
          <code class="ruby">        if u.user_type == &quot;android&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="70">
          
          
          <code class="ruby">          registration_ids.push(u.devicetoken)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">    # send push notification to android using fcm</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="76">
          
          
          <code class="ruby">    FcmClient.send(fcm_key, registration_ids, android_payload)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="d281b49d5f7b74f657c084dde044e32ed664beaa">
  <div class="header">
    <h3>app/jobs/contact_push_notification_job.rb</h3>
    <h4><span class="red">10.34 %</span> covered</h4>
    <div>
      <b>29</b> relevant lines. 
      <span class="green"><b>3</b> lines covered</span> and
      <span class="red"><b>26</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class ContactPushNotificationJob &lt; ActiveJob::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  queue_as :push_notifications</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  def perform(new_contacts)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">    new_contacts.each do |c|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="6">
          
          
          <code class="ruby">      from_user = User.find(c[0]) # get detail from_user</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">      to_user = User.find(c[1]) # get detail to_user</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">      application = from_user.application</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">      contact = Contact.find_by(user_id: c[0], contact_id: c[1])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">      # find fcm_key that store in applications table</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">      fcm_key = from_user.application.fcm_key</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">      # avoid send push notification from/to official account</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">      if from_user.is_official == false and to_user.is_official == false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">        # build up payload for ios push notification</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">        adder_user = from_user.fullname</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">        if adder_user.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">          adder_user = from_user.phone_number</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">        alert = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">          title: &quot;New Contact&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">          body: &quot;#{adder_user} added you as a friend.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">        sound = &quot;bells.wav&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">        ios_payload = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">          payload: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">            from_user:      from_user.as_json(job: true),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">            sender:         from_user.qiscus_email,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">            AppID:          from_user.application.app_id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">            pn_type:        &#39;new_contact&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">          }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">        # check is_contact or not for android payload</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">				contact_ids = to_user.contacts.pluck(:contact_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">				is_contact = contact_ids.include?(from_user.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">				# insert is_contact key and value to from_user</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">				from_user_json = from_user.as_json</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">				from_user_json[&quot;is_contact&quot;] = is_contact</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">        # build up payload for android push notification</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">        android_payload = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">          data: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">            from_user:			      from_user_json,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">            sound:                &quot;default&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">            title:                &quot;New Contact&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">            body:                 &quot;#{adder_user} added you as a friend.&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">            avatar_from_user:     from_user.avatar_url,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">						pn_type:              &quot;new_contact&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">          }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">      	# get target user device token</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="59">
          
          
          <code class="ruby">        userdevicetokens = UserDeviceToken.where(user_id: to_user.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="61">
          
          
          <code class="ruby">        registration_ids = Array.new</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="63">
          
          
          <code class="ruby">        userdevicetokens.each do | u |</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">          # send push notification to ios using apnotic</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="65">
          
          
          <code class="ruby">          if u.user_type == &#39;ios&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">            # ApnoticClient.send(alert, u.devicetoken, custom_payload, sound)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="67">
          
          
          <code class="ruby">            SendApnsJob.perform_later(application, alert, u.devicetoken, ios_payload, sound)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">          # collect android devicetoken into array</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="71">
          
          
          <code class="ruby">          if u.user_type == &quot;android&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="72">
          
          
          <code class="ruby">            registration_ids.push(u.devicetoken)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">        # send push notification to android using fcm</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="77">
          
          
          <code class="ruby">        FcmClient.send(fcm_key, registration_ids, android_payload)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="6e41a57be3503d08c83ed7aef5fb949a6ecc2a92">
  <div class="header">
    <h3>app/jobs/contact_sync_smarter_worker.rb</h3>
    <h4><span class="red">16.67 %</span> covered</h4>
    <div>
      <b>24</b> relevant lines. 
      <span class="green"><b>4</b> lines covered</span> and
      <span class="red"><b>20</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;net/http&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">class ContactSyncSmarterWorker &lt; ActiveJob::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  queue_as :default</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  def perform(new_participant_ids, group_participant_ids, application_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">    new_participant_ids.each  do |new_participant_id|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">        contacts = nil</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">        ActiveRecord::Base.transaction do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">          users = User.where(&quot;id IN (?)&quot;, group_participant_ids)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">          users = users.where.not(fullname: nil).where.not(fullname: &quot;&quot;) # only show contact who has complete their profile (fullname not nil)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">          users = users.where(application_id: application_id) # only looking for user where has same application id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">          users = users.where.not(id: new_participant_id) # exclude ownself to be added</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">          users = users.pluck(:id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">          # now looking for user where not in contact</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">          current_user = User.find(new_participant_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">          already_been_in_contacts = current_user.contacts.where(&quot;contacts.contact_id IN (?)&quot;, users).pluck(:contact_id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">          # contact to be added is only user where not in contact list</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">          new_contacts_to_be_added = users - already_been_in_contacts</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">          # now add to the contact</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">          new_contacts = Array.new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">          new_contacts_pn = Array.new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">          new_contacts_to_be_added.each do |id|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">            # double check if user already been in contact.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">            # maybe in race condition it throw error if user already been in contact and then breaks all</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">            # transaction</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">            if Contact.find_by(user_id: current_user.id, contact_id: id).nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">              new_contacts.push({:user_id =&gt; current_user.id, :contact_id =&gt; id})</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">              new_contacts_pn.push([current_user.id, id]) # only for push notification</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">            # now, make sure that they are friends, if A add B, then A must be in B&#39;s contact too</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">            if Contact.find_by(user_id: id, contact_id: current_user.id).nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">              new_contacts.push({:user_id =&gt; id, :contact_id =&gt; current_user.id})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">          # add new contact</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">          Contact.create(new_contacts)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">          # send new contact push notification</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">					# if !new_contacts_pn.empty?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">					# 	ContactPushNotificationJob.perform_later(new_contacts_pn)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">					# end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="543683efd95d159f30e8def8c42f5fe6439c6a48">
  <div class="header">
    <h3>app/models/application.rb</h3>
    <h4><span class="yellow">81.25 %</span> covered</h4>
    <div>
      <b>16</b> relevant lines. 
      <span class="green"><b>13</b> lines covered</span> and
      <span class="red"><b>3</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="2" data-linenumber="1">
          <span class="hits">2</span>
          
          <code class="ruby">class Application &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="2">
          <span class="hits">2</span>
          
          <code class="ruby">  validates :app_id, presence: true, uniqueness: { case_sensitive: false }</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="3">
          <span class="hits">2</span>
          
          <code class="ruby">  validates :app_name, presence: true</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="4">
          <span class="hits">2</span>
          
          <code class="ruby">  validates :qiscus_sdk_url, presence: true</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="5">
          <span class="hits">2</span>
          
          <code class="ruby">  validates :qiscus_sdk_secret, presence: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="7">
          <span class="hits">2</span>
          
          <code class="ruby">  has_many :users</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="8">
          <span class="hits">2</span>
          
          <code class="ruby">  has_many :announcements</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="9">
          <span class="hits">2</span>
          
          <code class="ruby">  has_many :features</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="10">
          <span class="hits">2</span>
          
          <code class="ruby">  has_many :provider_settings</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="11">
          <span class="hits">2</span>
          
          <code class="ruby">  has_many :custom_menus</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="12">
          <span class="hits">2</span>
          
          <code class="ruby">  has_many :call_logs</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="14">
          <span class="hits">2</span>
          
          <code class="ruby">  def save_and_add_provider_setting_data(application)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">    application.save!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">    add_provider_setting_data</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="19">
          <span class="hits">2</span>
          
          <code class="ruby">  def add_provider_setting_data</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">    ProviderSetting.insert_provider_setting_data_into_spesific_application(id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="189c6339241cdb47565e58690876644ea7639c0a">
  <div class="header">
    <h3>app/models/application_record.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>2</b> relevant lines. 
      <span class="green"><b>2</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="2" data-linenumber="1">
          <span class="hits">2</span>
          
          <code class="ruby">class ApplicationRecord &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="2">
          <span class="hits">2</span>
          
          <code class="ruby">  self.abstract_class = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="d115f7d72589884984fd21f4684ef649c5305482">
  <div class="header">
    <h3>app/models/auth_session.rb</h3>
    <h4><span class="red">75.0 %</span> covered</h4>
    <div>
      <b>8</b> relevant lines. 
      <span class="green"><b>6</b> lines covered</span> and
      <span class="red"><b>2</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="2" data-linenumber="1">
          <span class="hits">2</span>
          
          <code class="ruby">class AuthSession &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="2">
          <span class="hits">2</span>
          
          <code class="ruby">  validates :user_id, presence: true</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="3">
          <span class="hits">2</span>
          
          <code class="ruby">  validates :jwt_token, presence: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="5">
          <span class="hits">2</span>
          
          <code class="ruby">  belongs_to :user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="116" data-linenumber="7">
          <span class="hits">116</span>
          
          <code class="ruby">  default_scope { joins(:user)}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="9">
          <span class="hits">2</span>
          
          <code class="ruby">  def as_json(options = {})</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">    h = super({</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">      :except =&gt; [:jwt_token, :user_id]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">    })</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">    return h</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="49295fc41208b2c2ea1f6485c696a28bf78999c2">
  <div class="header">
    <h3>app/models/bot.rb</h3>
    <h4><span class="red">11.33 %</span> covered</h4>
    <div>
      <b>256</b> relevant lines. 
      <span class="green"><b>29</b> lines covered</span> and
      <span class="red"><b>227</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="2" data-linenumber="1">
          <span class="hits">2</span>
          
          <code class="ruby">class Bot &lt; ApplicationRecord</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="2">
          <span class="hits">2</span>
          
          <code class="ruby">    belongs_to :user</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="3">
          <span class="hits">2</span>
          
          <code class="ruby">    has_secure_password</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="5">
          <span class="hits">2</span>
          
          <code class="ruby">    def self.create_botbuilder(params={})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">        #stag: Bot.create_botbuilder(params={&quot;application_id&quot; =&gt; 1})</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">        #prod: Bot.create_botbuilder(params={&quot;application_id&quot; =&gt; 3})</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="8">
          
          
          <code class="ruby">        response = {}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">        username = params[&quot;username&quot;] || &quot;abah_bot&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">        fullname = params[&quot;fullname&quot;] || &quot;Abah Bot&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">        description = params[&quot;description&quot;] || &quot;dokumentasi : https://github.com/kiwari-engineering/bot-sdk-php&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">        qiscus_token = params[&quot;qiscus_token&quot;] || &quot;qiscus token&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">        application_id = params[&quot;application_id&quot;] || 3</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">        avatar_url = params[&quot;avatar_url&quot;] || &quot;https://d1edrlpyc25xu0.cloudfront.net/kiwari-stag/image/upload/F4xLTnAYtj/shutterstock_677646532-992x558.jpg&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">        application = Application.where(id: application_id).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">        bot_phone_number = username</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">        qiscus_email = &quot;#{bot_phone_number}@#{application.app_id}.com&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">        phone_number = &quot;#{bot_phone_number}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">        email = &quot;#{username}@#{application.app_id}.com&quot;        </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">        user = User.new(fullname: fullname, description: description, qiscus_email: qiscus_email, application_id: application_id, qiscus_token: qiscus_token, phone_number: phone_number, email: email, avatar_url: avatar_url)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">        Bot.transaction do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="23">
          
          
          <code class="ruby">            user.save!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">            response[:user_save_success] = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">        if response[:user_save_success] == true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">            qiscus_email = &quot;userid_#{user.id}_#{bot_phone_number}@#{application.app_id}.com&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">            qiscus_sdk = QiscusSdk.new(application.app_id, application.qiscus_sdk_secret)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">            qiscus_token = qiscus_sdk.login_or_register_rest(qiscus_email, &quot;password&quot;, user.fullname, avatar_url)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">            user.update_attributes!(qiscus_email: qiscus_email, qiscus_token: qiscus_token)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">            official = Bot.set_official_account(user)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">            if official[:success] == true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">                response[:message] = &quot;successfully save bot builder!&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">                response[:success] = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">            else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">                Bot.hard_delete(user)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">        response[:message] = response[:message] || &quot;failed to save bot builder!&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">        response[:success] = response[:success] || false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">        return response</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="45">
          <span class="hits">2</span>
          
          <code class="ruby">    def self.phone_number_to_username</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">        role = Role.where(name: &quot;Bot&quot;).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">        if !role.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">            user_ids = UserRole.where(role_id: role.id).pluck(:user_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">            users = User.where(id: user_ids)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">            users.each do |user|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">                user.update_attributes!(phone_number: user.bot.username)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="56">
          <span class="hits">2</span>
          
          <code class="ruby">    def self.set_official_account(user = nil)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="57">
          
          
          <code class="ruby">        response = {}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="58">
          
          
          <code class="ruby">        role = Role.where(name: &quot;Official Account&quot;).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="59">
          
          
          <code class="ruby">        if !role.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="60">
          
          
          <code class="ruby">            role_id = role.id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="62">
          
          
          <code class="ruby">        if !user.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="63">
          
          
          <code class="ruby">            user_role = UserRole.new(user_id: user.id, role_id: role_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="64">
          
          
          <code class="ruby">            Bot.transaction do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="65">
          
          
          <code class="ruby">                user_role.save!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="66">
          
          
          <code class="ruby">                response[:success] = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="69">
          
          
          <code class="ruby">        return response</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="72">
          <span class="hits">2</span>
          
          <code class="ruby">    def self.lowercase</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="73">
          
          
          <code class="ruby">        lowercase = &quot;abcdefghijklmnopqrstuvwxyz&quot;.split(&quot;&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="74">
          
          
          <code class="ruby">        return lowercase</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="77">
          <span class="hits">2</span>
          
          <code class="ruby">    def self.numbers</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="78">
          
          
          <code class="ruby">        numbers = &quot;0123456789&quot;.split(&quot;&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="79">
          
          
          <code class="ruby">        return numbers</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="82">
          <span class="hits">2</span>
          
          <code class="ruby">    def self.symbols</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="83">
          
          
          <code class="ruby">        symbols = &quot;_.&quot;.split(&quot;&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="84">
          
          
          <code class="ruby">        return symbols</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="87">
          <span class="hits">2</span>
          
          <code class="ruby">    def self.check_username(params, leng=9)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="88">
          
          
          <code class="ruby">        response = {}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="89">
          
          
          <code class="ruby">        username = params[&quot;username&quot;] || &quot;nil&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="91">
          
          
          <code class="ruby">        if ((username.split(&quot;&quot;) - Bot.lowercase - Bot.numbers - Bot.symbols) == []) &amp;&amp; (username.split(&quot;&quot;).length &gt;= leng)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="92">
          
          
          <code class="ruby">            bot = Bot.where(username: username).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="93">
          
          
          <code class="ruby">            if bot.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="94">
          
          
          <code class="ruby">                response = {&quot;message&quot;: &quot;masukkan fullname bot anda&quot;, &quot;send_now&quot;: false}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">            else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="96">
          
          
          <code class="ruby">                response = {&quot;message&quot;: &quot;username #{username} sudah terpakai!\nmasukkan username lain!&quot;, &quot;send_now&quot;: true}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="99">
          
          
          <code class="ruby">            response[:message] = &quot;format username salah!\nharap ulangi.\n#{Bot.message(&quot;format_username&quot;)}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="100">
          
          
          <code class="ruby">            response[:send_now] = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="102">
          
          
          <code class="ruby">        return response</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="105">
          <span class="hits">2</span>
          
          <code class="ruby">    def self.check_password_format(password)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="106">
          
          
          <code class="ruby">        response = {}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="107">
          
          
          <code class="ruby">        if (password.include? &quot; &quot;) || (password.length &lt; 5)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="108">
          
          
          <code class="ruby">            response[:send_now] = true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="109">
          
          
          <code class="ruby">            response[:message] = &quot;format password salah!\nharap ulangi.\n#{Bot.message(&quot;format_password&quot;)}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="111">
          
          
          <code class="ruby">            response[:send_now] = false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="112">
          
          
          <code class="ruby">            response[:message] = &quot;masukkan konfirmasi password bot anda&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="114">
          
          
          <code class="ruby">        return response</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="117">
          <span class="hits">2</span>
          
          <code class="ruby">    def self.check_password(params, password_digest)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="118">
          
          
          <code class="ruby">        value = BCrypt::Engine.hash_secret(params[:password], password_digest) == password_digest</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="119">
          
          
          <code class="ruby">        return value</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="122">
          <span class="hits">2</span>
          
          <code class="ruby">    def self.create_bot(params)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="123">
          
          
          <code class="ruby">        response = {}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="124">
          
          
          <code class="ruby">        fullname = params[&quot;fullname&quot;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="125">
          
          
          <code class="ruby">        username = params[&quot;username&quot;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="126">
          
          
          <code class="ruby">        user_id_creator = params[&quot;user_id_creator&quot;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="127">
          
          
          <code class="ruby">        password = params[&quot;password&quot;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="128">
          
          
          <code class="ruby">        description = params[&quot;description&quot;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="129">
          
          
          <code class="ruby">        qiscus_token = params[&quot;qiscus_token&quot;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="130">
          
          
          <code class="ruby">        application_id = params[&quot;application_id&quot;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="131">
          
          
          <code class="ruby">        avatar_url = params[&quot;avatar_url&quot;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="132">
          
          
          <code class="ruby">        application = Application.where(id: application_id).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="133">
          
          
          <code class="ruby">        bot_phone_number = username</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="134">
          
          
          <code class="ruby">        qiscus_email = &quot;#{bot_phone_number}@#{application.app_id}.com&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="135">
          
          
          <code class="ruby">        phone_number = &quot;#{bot_phone_number}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="136">
          
          
          <code class="ruby">        email = &quot;#{username}@#{application.app_id}.com&quot;        </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="138">
          
          
          <code class="ruby">        bot = Bot.where(username: username).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="139">
          
          
          <code class="ruby">        if bot.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="140">
          
          
          <code class="ruby">            user = User.new(fullname: fullname, description: description, qiscus_email: qiscus_email, application_id: application_id, qiscus_token: qiscus_token, phone_number: phone_number, email: email, avatar_url: avatar_url)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="141">
          
          
          <code class="ruby">            Bot.transaction do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="142">
          
          
          <code class="ruby">                user.save!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="143">
          
          
          <code class="ruby">                response[:user_save_success] = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="145">
          
          
          <code class="ruby">            if response[:user_save_success] == true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="146">
          
          
          <code class="ruby">                qiscus_email = &quot;userid_#{user.id}_#{bot_phone_number}@#{application.app_id}.com&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="147">
          
          
          <code class="ruby">                qiscus_sdk = QiscusSdk.new(application.app_id, application.qiscus_sdk_secret)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="148">
          
          
          <code class="ruby">                qiscus_token = qiscus_sdk.login_or_register_rest(qiscus_email, password, user.fullname, avatar_url)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="149">
          
          
          <code class="ruby">                user.update_attributes!(qiscus_email: qiscus_email, qiscus_token: qiscus_token)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="150">
          
          
          <code class="ruby">                bot = Bot.new(username: username, user_id: user.id, user_id_creator: user_id_creator, password: password, description: description)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="151">
          
          
          <code class="ruby">                Bot.transaction do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="152">
          
          
          <code class="ruby">                    bot.save!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="153">
          
          
          <code class="ruby">                    response[:bot_save_success] = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="154">
          
          
          <code class="ruby">                end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="155">
          
          
          <code class="ruby">                if response[:bot_save_success] == true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="156">
          
          
          <code class="ruby">                    token = Bot.create_token(bot.user_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="157">
          
          
          <code class="ruby">                    response[:message] = &quot;bot telah dibuat, \ntoken anda : \n#{token}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="158">
          
          
          <code class="ruby">                    response[:bot] = bot</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="159">
          
          
          <code class="ruby">                    response[:user] = user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="160">
          
          
          <code class="ruby">                else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="161">
          
          
          <code class="ruby">                    Bot.hard_delete(user)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="162">
          
          
          <code class="ruby">                    response[:message] = &quot;gagal menyimpan bot&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby">                end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="164">
          
          
          <code class="ruby">            else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="165">
          
          
          <code class="ruby">                response[:message] = &quot;gagal menyimpan bot&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="166">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="167">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="168">
          
          
          <code class="ruby">            response[:message] = &quot;username sudah terpakai!, harap masukkan username lain&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="169">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="170">
          
          
          <code class="ruby">        return response</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="171">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="172">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="173">
          <span class="hits">2</span>
          
          <code class="ruby">    def self.hard_delete(table)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="174">
          
          
          <code class="ruby">        table.delete</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="175">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="176">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="177">
          <span class="hits">2</span>
          
          <code class="ruby">    def self.generate_bot_phone_number(digits=12)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="178">
          
          
          <code class="ruby">        numbers = [0,1,2,3,4,5,6,7,8,9]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="179">
          
          
          <code class="ruby">        bot_phone_number = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="180">
          
          
          <code class="ruby">        digit_loop = digits</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="181">
          
          
          <code class="ruby">        while digit_loop &gt; 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="182">
          
          
          <code class="ruby">            bot_phone_number = bot_phone_number.push(numbers.shuffle.first)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="183">
          
          
          <code class="ruby">            digit_loop = digit_loop - 1</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="184">
          
          
          <code class="ruby">            if digit_loop == 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="185">
          
          
          <code class="ruby">                bot_phone_number = bot_phone_number.join(&quot;&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="186">
          
          
          <code class="ruby">                user = User.where(phone_number: &quot;+627872#{bot_phone_number}&quot;).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="187">
          
          
          <code class="ruby">                if !user.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="188">
          
          
          <code class="ruby">                    digit_loop = digits</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="189">
          
          
          <code class="ruby">                    bot_phone_number = []</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="190">
          
          
          <code class="ruby">                end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="191">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="192">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="193">
          
          
          <code class="ruby">        return bot_phone_number</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="194">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="195">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="196">
          <span class="hits">2</span>
          
          <code class="ruby">    def self.show_all(params)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="197">
          
          
          <code class="ruby">        user_ids = Bot.pluck(:user_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="198">
          
          
          <code class="ruby">        users = User.where(id: user_ids, deleted: false)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="199">
          
          
          <code class="ruby">        if users.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="200">
          
          
          <code class="ruby">            return &quot;successfully show all users&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="201">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="202">
          
          
          <code class="ruby">            return &quot;failed show all users&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="203">
          
          
          <code class="ruby">        end        </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="204">
          
          
          <code class="ruby">    end  </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="205">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="206">
          <span class="hits">2</span>
          
          <code class="ruby">    def self.create_token(params)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="207">
          
          
          <code class="ruby">        user = User.find(params)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="208">
          
          
          <code class="ruby">        if !user.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="209">
          
          
          <code class="ruby">            jwt = ApplicationHelper.create_jwt_token(user)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="210">
          
          
          <code class="ruby">            return jwt</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="211">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="212">
          
          
          <code class="ruby">            return &quot;failed create token, user not found&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="213">
          
          
          <code class="ruby">        end        </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="214">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="215">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="216">
          <span class="hits">2</span>
          
          <code class="ruby">    def self.get_token(params)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="217">
          
          
          <code class="ruby">        access_token = AuthSession.where(params).last</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="218">
          
          
          <code class="ruby">        if !access_token.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="219">
          
          
          <code class="ruby">            access_token = access_token.jwt_token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="220">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="221">
          
          
          <code class="ruby">            access_token = &quot;empty&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="222">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="223">
          
          
          <code class="ruby">        return access_token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="224">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="225">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="226">
          <span class="hits">2</span>
          
          <code class="ruby">    def self.delete_bot(username, user_id_creator, bot_session)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="227">
          
          
          <code class="ruby">        bot = Bot.where(username: username, user_id_creator: user_id_creator).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="228">
          
          
          <code class="ruby">        user = nil</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="229">
          
          
          <code class="ruby">        if !bot.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="230">
          
          
          <code class="ruby">            bot.destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="231">
          
          
          <code class="ruby">            user = User.where(id: bot.user_id, deleted: false).first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="232">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="233">
          
          
          <code class="ruby">        if !user.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="234">
          
          
          <code class="ruby">            user.destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="235">
          
          
          <code class="ruby">            message = &quot;bot berhasil dihapus&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="236">
          
          
          <code class="ruby">            $redis.del(bot_session)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="237">
          
          
          <code class="ruby">            send_now = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="238">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="239">
          
          
          <code class="ruby">            message = &quot;bot tidak ditemukan&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="240">
          
          
          <code class="ruby">            send_now = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="241">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="242">
          
          
          <code class="ruby">        response = {}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="243">
          
          
          <code class="ruby">        response[:message] = message</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="244">
          
          
          <code class="ruby">        response[:send_now] = send_now</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="245">
          
          
          <code class="ruby">        return response</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="246">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="247">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="248">
          <span class="hits">2</span>
          
          <code class="ruby">    def self.select_bot(params)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="249">
          
          
          <code class="ruby">        response = {}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="250">
          
          
          <code class="ruby">        bot = Bot.where(params).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="251">
          
          
          <code class="ruby">        if !bot.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="252">
          
          
          <code class="ruby">            user = User.where(id: bot.user_id, deleted: false).first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="253">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="254">
          
          
          <code class="ruby">            user = nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="255">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="256">
          
          
          <code class="ruby">        if !user.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="257">
          
          
          <code class="ruby">            response[:bot] = bot</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="258">
          
          
          <code class="ruby">            response[:user] = user</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="259">
          
          
          <code class="ruby">            response[:message] = &quot;bot ditemukan&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="260">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="261">
          
          
          <code class="ruby">            response[:message] = &quot;bot tidak ditemukan&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="262">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="263">
          
          
          <code class="ruby">        return response</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="264">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="265">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="266">
          <span class="hits">2</span>
          
          <code class="ruby">    def self.update_bot(user, attributes)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="267">
          
          
          <code class="ruby">        bot = Bot.where(user).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="268">
          
          
          <code class="ruby">        bot.update_attributes!(attributes)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="269">
          
          
          <code class="ruby">        return &quot;edit berhasil&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="270">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="271">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="272">
          <span class="hits">2</span>
          
          <code class="ruby">    def self.update_user(user, attributes)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="273">
          
          
          <code class="ruby">        user = User.where(user).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="274">
          
          
          <code class="ruby">        user.update_attributes!(attributes)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="275">
          
          
          <code class="ruby">        qiscus_sdk = QiscusSdk.new(user.application.app_id, user.application.qiscus_sdk_secret)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="276">
          
          
          <code class="ruby">        qiscus_token = qiscus_sdk.update_profile(user.qiscus_email, user.fullname, user.avatar_url)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="277">
          
          
          <code class="ruby">        user.update_attributes!(qiscus_token: qiscus_token)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="278">
          
          
          <code class="ruby">        return &quot;edit berhasil!&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="279">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="280">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="281">
          <span class="hits">2</span>
          
          <code class="ruby">    def self.message(type=&quot;unknown&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="282">
          
          
          <code class="ruby">        message = &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="283">
          
          
          <code class="ruby">        if type == &quot;list&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="284">
          
          
          <code class="ruby">            message = &quot;pilih bot anda&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="285">
          
          
          <code class="ruby">        elsif type == &quot;tidak&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="286">
          
          
          <code class="ruby">            message = &quot;silahkan tulis ulang&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="287">
          
          
          <code class="ruby">        elsif type == &quot;cancel&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="288">
          
          
          <code class="ruby">            message = &quot;tekan /cancel untuk membatalkan proses&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="289">
          
          
          <code class="ruby">        elsif type == &quot;determination&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="290">
          
          
          <code class="ruby">            message = &quot;apakah anda yakin?&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="291">
          
          
          <code class="ruby">        elsif type == &quot;upload&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="292">
          
          
          <code class="ruby">            message = &quot;silahkan unggah foto baru&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="293">
          
          
          <code class="ruby">        elsif type == &quot;format_username&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="294">
          
          
          <code class="ruby">            message = &quot;username hanya boleh berisikan :\n- huruf kecil\n- angka\n- underscore (_)\n- titik (.) \n- tanpa menggunakan spasi\n- minimal 5 digit&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="295">
          
          
          <code class="ruby">        elsif type == &quot;format_password&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="296">
          
          
          <code class="ruby">            message = &quot;- password minimal 5 digit\n- tanpa menggunakan spasi&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="297">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="298">
          
          
          <code class="ruby">            message = &quot;permintaan tidak diketahui&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="299">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="300">
          
          
          <code class="ruby">        return message</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="301">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="302">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="303">
          <span class="hits">2</span>
          
          <code class="ruby">    def self.create_buttons(params)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="304">
          
          
          <code class="ruby">        buttons = []</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="305">
          
          
          <code class="ruby">        params[:buttons].each do |username|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="306">
          
          
          <code class="ruby">            buttons.push({</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="307">
          
          
          <code class="ruby">                &quot;label&quot;: username,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="308">
          
          
          <code class="ruby">                &quot;type&quot;: &quot;postback&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="309">
          
          
          <code class="ruby">                &quot;payload&quot;: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="310">
          
          
          <code class="ruby">                    &quot;url&quot;: &quot;www.kiwari.chat&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="311">
          
          
          <code class="ruby">                    &quot;method&quot;: &quot;get&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="312">
          
          
          <code class="ruby">                    &quot;payload&quot;: nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="313">
          
          
          <code class="ruby">                }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="314">
          
          
          <code class="ruby">            })</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="315">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="316">
          
          
          <code class="ruby">        return buttons</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="317">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="318">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="319">
          <span class="hits">2</span>
          
          <code class="ruby">    def self.create_button(params)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="320">
          
          
          <code class="ruby">            button = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="321">
          
          
          <code class="ruby">                &quot;label&quot;: params[:label],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="322">
          
          
          <code class="ruby">                &quot;type&quot;: &quot;postback&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="323">
          
          
          <code class="ruby">                &quot;postback_text&quot;: params[:postback_text],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="324">
          
          
          <code class="ruby">                &quot;payload&quot;: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="325">
          
          
          <code class="ruby">                    &quot;url&quot;: params[:url] || &quot;https://www.kiwari.chat&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="326">
          
          
          <code class="ruby">                    &quot;method&quot;: &quot;get&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="327">
          
          
          <code class="ruby">                    &quot;payload&quot;: nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="328">
          
          
          <code class="ruby">                }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="329">
          
          
          <code class="ruby">            }</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="330">
          
          
          <code class="ruby">        return button</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="331">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="332">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="333">
          <span class="hits">2</span>
          
          <code class="ruby">    def self.create_contact(user1_id, user2_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="334">
          
          
          <code class="ruby">        response = {}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="335">
          
          
          <code class="ruby">        contact1 = Contact.new(user_id: user1_id, contact_id: user2_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="336">
          
          
          <code class="ruby">        contact2 = Contact.new(user_id: user2_id, contact_id: user1_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="337">
          
          
          <code class="ruby">        Contact.transaction do</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="338">
          
          
          <code class="ruby">            contact1.save!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="339">
          
          
          <code class="ruby">            contact2.save!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="340">
          
          
          <code class="ruby">            response[:message] = &quot;berhasil menyimpan kontak&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="341">
          
          
          <code class="ruby">            response[:success] = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="342">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="343">
          
          
          <code class="ruby">        return response</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="344">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="345">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="346">
          <span class="hits">2</span>
          
          <code class="ruby">    def self.create_bot_role(bot_user_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="347">
          
          
          <code class="ruby">        response = {}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="348">
          
          
          <code class="ruby">        role = Role.where(name: &quot;Bot&quot;).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="349">
          
          
          <code class="ruby">        if role.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="350">
          
          
          <code class="ruby">            role = Role.create!(name: &quot;Bot&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="351">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="352">
          
          
          <code class="ruby">        role = UserRole.new(user_id: bot_user_id, role_id: role.id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="353">
          
          
          <code class="ruby">        if role.save!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="354">
          
          
          <code class="ruby">            response[:success] = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="355">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="356">
          
          
          <code class="ruby">        return response</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="357">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="358">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="359">
          <span class="hits">2</span>
          
          <code class="ruby">    def self.create_profile(params, user2_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="360">
          
          
          <code class="ruby">        response = {}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="361">
          
          
          <code class="ruby">        bot = Bot.create_bot(params)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="362">
          
          
          <code class="ruby">        if !bot[:bot].nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="363">
          
          
          <code class="ruby">            user1_id = bot[:user].id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="364">
          
          
          <code class="ruby">            contact = Bot.create_contact(user1_id, user2_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="365">
          
          
          <code class="ruby">            if contact[:success] == true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="366">
          
          
          <code class="ruby">                role = Bot.create_bot_role(bot[:user].id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="367">
          
          
          <code class="ruby">                if role[:success] == true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="368">
          
          
          <code class="ruby">                    response[:message] = bot[:message]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="369">
          
          
          <code class="ruby">                end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="370">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="371">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="372">
          
          
          <code class="ruby">        response[:message] = response[:message] || &quot;bot gagal dibuat!&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="373">
          
          
          <code class="ruby">        return response</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="374">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="375">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="376">
          <span class="hits">2</span>
          
          <code class="ruby">    def destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="377">
          
          
          <code class="ruby">        self.username = &quot;userid_&quot; + self.id.to_s + &quot;_&quot; + self.username + &quot;_deleted_#{Time.now.to_i}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="378">
          
          
          <code class="ruby">        self.save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="379">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="380">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="22e2961a486fc0a3045ac43e150fbb0f48789fd5">
  <div class="header">
    <h3>app/models/call_log.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>19</b> relevant lines. 
      <span class="green"><b>19</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="2" data-linenumber="1">
          <span class="hits">2</span>
          
          <code class="ruby">class CallLog &lt; ApplicationRecord</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="2">
          <span class="hits">2</span>
          
          <code class="ruby">  validates :call_event, presence: true</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="3">
          <span class="hits">2</span>
          
          <code class="ruby">  validates :caller_user_id, presence: true</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="4">
          <span class="hits">2</span>
          
          <code class="ruby">  validates :callee_user_id, presence: true</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="5">
          <span class="hits">2</span>
          
          <code class="ruby">  validates :call_room_id, presence: true</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="6">
          <span class="hits">2</span>
          
          <code class="ruby">  validates :application_id, presence: true</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="7">
          <span class="hits">2</span>
          
          <code class="ruby">  validates :duration, presence: true, allow_nil: true, allow_blank: false</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="8">
          <span class="hits">2</span>
          
          <code class="ruby">  validates :connected_at, presence: true, allow_nil: true, allow_blank: false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="10">
          <span class="hits">2</span>
          
          <code class="ruby">  enum status: [ :unknown, :missed, :connected ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="12">
          <span class="hits">2</span>
          
          <code class="ruby">  belongs_to :user</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="13">
          <span class="hits">2</span>
          
          <code class="ruby">  belongs_to :application</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">  # because caller and calle user id table refer to user table,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">  # we cant override the json format (as_json) before defining the FK one by one</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="17">
          <span class="hits">2</span>
          
          <code class="ruby">  belongs_to :callee, :class_name =&gt; :User, :foreign_key =&gt; &quot;callee_user_id&quot;</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="18">
          <span class="hits">2</span>
          
          <code class="ruby">  belongs_to :caller, :class_name =&gt; :User, :foreign_key =&gt; &quot;caller_user_id&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="20">
          <span class="hits">2</span>
          
          <code class="ruby">  def as_json(options={})</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="21">
          <span class="hits">16</span>
          
          <code class="ruby">    super.except(&quot;caller_user_id&quot;, &quot;callee_user_id&quot;, &quot;created_at&quot;, &quot;updated_at&quot;).tap do |h|</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="22">
          <span class="hits">16</span>
          
          <code class="ruby">      h[&quot;caller_user&quot;] = caller.as_json</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="23">
          <span class="hits">16</span>
          
          <code class="ruby">      h[&quot;callee_user&quot;] = callee.as_json</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="24">
          <span class="hits">16</span>
          
          <code class="ruby">      h[&quot;created_at&quot;] = created_at.iso8601</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="25">
          <span class="hits">16</span>
          
          <code class="ruby">      h[&quot;updated_at&quot;] = updated_at.iso8601</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="e82aa130f3ca6650a3af4ff6148f78480ba5e92f">
  <div class="header">
    <h3>app/models/chat_room.rb</h3>
    <h4><span class="red">39.86 %</span> covered</h4>
    <div>
      <b>148</b> relevant lines. 
      <span class="green"><b>59</b> lines covered</span> and
      <span class="red"><b>89</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="2" data-linenumber="1">
          <span class="hits">2</span>
          
          <code class="ruby">require &#39;time&#39;</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="2">
          <span class="hits">2</span>
          
          <code class="ruby">require &#39;securerandom&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="4">
          <span class="hits">2</span>
          
          <code class="ruby">class ChatRoom &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="5">
          <span class="hits">2</span>
          
          <code class="ruby">  validates :qiscus_room_name, presence: true</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="6">
          <span class="hits">2</span>
          
          <code class="ruby">  validates :qiscus_room_id, presence: true</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="7">
          <span class="hits">2</span>
          
          <code class="ruby">  validates :user_id, presence: true</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="8">
          <span class="hits">2</span>
          
          <code class="ruby">  validates :application_id, presence: true</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="9">
          <span class="hits">2</span>
          
          <code class="ruby">  validates :target_user_id, presence: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="11">
          <span class="hits">2</span>
          
          <code class="ruby">  belongs_to :application</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="12">
          <span class="hits">2</span>
          
          <code class="ruby">  belongs_to :user</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="13">
          <span class="hits">2</span>
          
          <code class="ruby">  has_many :chat_users</code>
        </li>
      
        <li class="covered" data-hits="45" data-linenumber="14">
          <span class="hits">45</span>
          
          <code class="ruby">  has_many :users, -&gt;{ order &#39;users.fullname asc&#39; }, through: :chat_users</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="16">
          <span class="hits">2</span>
          
          <code class="ruby">  belongs_to :target, :class_name =&gt; :User, :foreign_key =&gt; &quot;target_user_id&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="18">
          <span class="hits">2</span>
          
          <code class="ruby">  has_many :pin_chat_rooms</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="19">
          <span class="hits">2</span>
          
          <code class="ruby">  has_many :mute_chat_rooms</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="46" data-linenumber="21">
          <span class="hits">46</span>
          
          <code class="ruby">  default_scope { joins(:user)}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">  # Hooks</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="24">
          <span class="hits">2</span>
          
          <code class="ruby">  after_save :update_sdk_room_info</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">  # Update redis cache after create, update and delete</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">  # after save hooks will called both when Creating or Updating an Object</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="28">
          <span class="hits">2</span>
          
          <code class="ruby">  after_save :update_redis_cache</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="29">
          <span class="hits">2</span>
          
          <code class="ruby">  after_destroy :update_redis_cache</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="31">
          <span class="hits">2</span>
          
          <code class="ruby">  def as_json(options={})</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="32">
          <span class="hits">11</span>
          
          <code class="ruby">    h = super(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">      :include =&gt;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">        [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">          {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">            :users =&gt;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">            {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">              # :include =&gt; [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">              #   {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">              #     :roles =&gt;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">              #     {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">              #       :only =&gt; [:id, :name]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">              #     }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">              #   },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">              #   {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">              #     :application =&gt; { :only =&gt; [:app_name] }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">              #   }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">              # ],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">              :except =&gt; [:passcode, :application_id, :qiscus_token, :lock_version],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">              :methods =&gt; [ :is_admin, :is_official, :additional_infos ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">            } # end of user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">          },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">          {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">            :target =&gt;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">            {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">              # :include =&gt; [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">              #   {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">              #     :roles =&gt;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">              #     {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">              #       :only =&gt; [:id, :name]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">              #     }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">              #   },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">              #   {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">              #     :application =&gt; { :only =&gt; [:app_name] }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">              #   }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">              # ],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">              :except =&gt; [:passcode, :application_id, :qiscus_token, :lock_version],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">              :methods =&gt; [ :is_admin, :is_official, :additional_infos ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">            } # end of target</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">          }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">        ],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">        :except =&gt; [:user_id, :group_chat_name, :target_user_id]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">    )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">    # Overwrite json if has webhook key. This json use only in webhook payload</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="76">
          <span class="hits">11</span>
          
          <code class="ruby">    if options.has_key?(:webhook)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="77">
          
          
          <code class="ruby">      h = super(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">        :include =&gt;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">          [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">            {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">              :users =&gt;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">              {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">                :only =&gt; [:id, :phone_number, :fullname, :qiscus_email],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">              } # end of user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">            },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">          ],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">          :except =&gt; [:user_id, :group_chat_name]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">      )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">    # If has webhook key, doesn&#39;t need creator payload</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="92">
          <span class="hits">11</span>
          
          <code class="ruby">    if !options.has_key?(:webhook)</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="93">
          <span class="hits">11</span>
          
          <code class="ruby">      h[:creator] = user.as_json</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby">    # manipulate the chat name and private information</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="97">
          <span class="hits">11</span>
          
          <code class="ruby">    if options.has_key?(:me)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">      # if group chat then the group chat name is the group name</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="99">
          <span class="hits">8</span>
          
          <code class="ruby">      if is_group_chat</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="100">
          <span class="hits">6</span>
          
          <code class="ruby">        h[&quot;chat_name&quot;] = group_chat_name # need to be save in database, but must be hidden property</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">        # use default group avatar if it&#39;s a group chat or &#39;me&#39; parameter is not assigned</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="102">
          <span class="hits">6</span>
          
          <code class="ruby">        h[&quot;chat_avatar_url&quot;] = group_avatar_url</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby">        # the interlocutor name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby">        # if fullname is exist then show the fullname, if not show the phone number</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="106">
          <span class="hits">2</span>
          
          <code class="ruby">        interlocutor = users.where.not(id: options[:me].id).last</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">        # interlocutor must not be nil, but when it happen whe should prevent it</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="108">
          <span class="hits">2</span>
          
          <code class="ruby">        if interlocutor.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="109">
          
          
          <code class="ruby">          h[&quot;chat_name&quot;] = &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="110">
          
          
          <code class="ruby">          h[&quot;chat_avatar_url&quot;] = &quot;&quot; # blank if interlocutor is not found</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="111">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="112">
          <span class="hits">2</span>
          
          <code class="ruby">          h[&quot;chat_name&quot;] = (interlocutor.fullname != nil) ? interlocutor.fullname.to_s : interlocutor.phone_number.to_s</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="113">
          <span class="hits">2</span>
          
          <code class="ruby">          h[&quot;chat_avatar_url&quot;] = interlocutor.avatar_url # use user avatar in single chat</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">      # if is official chat, then using chat bot name</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="118">
          <span class="hits">8</span>
          
          <code class="ruby">      if is_official_chat</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby">        # if accessed by official account or helpdesk</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="120">
          
          
          <code class="ruby">        if options[:me].is_official || options[:me].is_helpdesk</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby">          # then use group creator name, since it always ordinary user (member)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="122">
          
          
          <code class="ruby">          h[&quot;chat_name&quot;] = user.fullname</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="123">
          
          
          <code class="ruby">          h[&quot;chat_avatar_url&quot;] = user.avatar_url</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby">          # else, use official account name (it must be one official account only per official group chat)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="126">
          
          
          <code class="ruby">          users.each do |u|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="127">
          
          
          <code class="ruby">            if u.is_official</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="128">
          
          
          <code class="ruby">              h[&quot;chat_name&quot;] = u.fullname</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="129">
          
          
          <code class="ruby">              h[&quot;chat_avatar_url&quot;] = u.avatar_url</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="130">
          
          
          <code class="ruby">            end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby">          end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby">        # use default group avatar if it&#39;s a group chat or &#39;me&#39; parameter is not assigned</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby">        # h[&quot;chat_avatar_url&quot;] = group_avatar_url</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby">      # override custom value for users email, gender and date_of_birth</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="139">
          <span class="hits">8</span>
          
          <code class="ruby">      h[&quot;users&quot;].each do |u|</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby">        # if current user, no need to override this information</code>
        </li>
      
        <li class="covered" data-hits="19" data-linenumber="141">
          <span class="hits">19</span>
          
          <code class="ruby">        if u[&quot;id&quot;] != options[:me].id &amp;&amp; u[&quot;is_public&quot;] == false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="142">
          
          
          <code class="ruby">          # hide this properties (just set it to empty string for consistent structure)</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="143">
          <span class="hits">11</span>
          
          <code class="ruby">          u[&quot;email&quot;] = &quot;&quot;</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="144">
          <span class="hits">11</span>
          
          <code class="ruby">          u[&quot;gender&quot;] = &quot;&quot;</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="145">
          <span class="hits">11</span>
          
          <code class="ruby">          u[&quot;date_of_birth&quot;] = &quot;&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="149">
          <span class="hits">3</span>
          
          <code class="ruby">      h[&quot;chat_name&quot;] = group_chat_name</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="150">
          
          
          <code class="ruby">      # use default group avatar if it&#39;s a group chat or &#39;me&#39; parameter is not assigned</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="151">
          <span class="hits">3</span>
          
          <code class="ruby">      h[&quot;chat_avatar_url&quot;] = group_avatar_url</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="154">
          <span class="hits">11</span>
          
          <code class="ruby">    if options.has_key?(:chat_room_sdk_info)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby">      # h[&quot;unread_count&quot;] = Faker::Number.between(0, 5)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="156">
          
          
          <code class="ruby">      if options[:chat_room_sdk_info][qiscus_room_id.to_i] != nil</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="157">
          
          
          <code class="ruby">        room_info = options[:chat_room_sdk_info][qiscus_room_id.to_i]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="158">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="159">
          
          
          <code class="ruby">        last_comment_message = room_info[&quot;last_comment_message&quot;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="160">
          
          
          <code class="ruby">        if last_comment_message.include?&quot;[file]&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="161">
          
          
          <code class="ruby">          last_comment_message = &quot;File attached.&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="164">
          
          
          <code class="ruby">        h[&quot;chat_name_sdk&quot;] = room_info[&quot;room_name&quot;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="165">
          
          
          <code class="ruby">        h[&quot;unread_count&quot;] = room_info[&quot;unread_count&quot;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="166">
          
          
          <code class="ruby">        h[&quot;last_message&quot;] = last_comment_message</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="167">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="168">
          
          
          <code class="ruby">        if room_info[&quot;last_comment_timestamp&quot;].include?(&quot;0001-01-01T00:00:00Z&quot;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="169">
          
          
          <code class="ruby">          timestamp = Time.parse(created_at.to_s)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="170">
          
          
          <code class="ruby">          h[&quot;last_message_timestamps&quot;] = timestamp.strftime(&quot;%Y-%m-%dT%TZ&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="171">
          
          
          <code class="ruby">        else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="172">
          
          
          <code class="ruby">          h[&quot;last_message_timestamps&quot;] = room_info[&quot;last_comment_timestamp&quot;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="173">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="174">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="175">
          
          
          <code class="ruby">        h[&quot;group_avatar_url_sdk&quot;] = room_info[&quot;room_avatar_url&quot;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="176">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="177">
          
          
          <code class="ruby">        # use chat_avatar_url from sdk when chat_room_sdk_info assigned</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="178">
          
          
          <code class="ruby">        # only use avatar from SDK if it&#39;s a group chat (because latest group avatar is only in SDK [client only update group avatar in SDK])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="179">
          
          
          <code class="ruby">        if is_group_chat</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="180">
          
          
          <code class="ruby">          h[&quot;chat_avatar_url&quot;] = room_info[&quot;room_avatar_url&quot;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="181">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="182">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="183">
          
          
          <code class="ruby">        # default value</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="184">
          
          
          <code class="ruby">        h[&quot;chat_name_sdk&quot;] = &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="185">
          
          
          <code class="ruby">        h[&quot;unread_count&quot;] = 0</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="186">
          
          
          <code class="ruby">        h[&quot;last_message&quot;] = &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="187">
          
          
          <code class="ruby">        h[&quot;last_message_timestamps&quot;] = &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="188">
          
          
          <code class="ruby">        h[&quot;group_avatar_url_sdk&quot;] = &quot;&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="189">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="190">
          
          
          <code class="ruby">        # only use avatar from SDK if it&#39;s a group chat (because latest group avatar is only in SDK [client only update group avatar in SDK])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="191">
          
          
          <code class="ruby">        if is_group_chat</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="192">
          
          
          <code class="ruby">          h[&quot;chat_avatar_url&quot;] = &quot;&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="193">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="194">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="195">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="196">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="197">
          <span class="hits">11</span>
          
          <code class="ruby">    return h</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="198">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="199">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="200">
          
          
          <code class="ruby">  # Updating all chat room name in SDK to chat room in backend.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="201">
          
          
          <code class="ruby">  # This is to make name in SDK is same with data in backend (when load conversation list).</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="202">
          
          
          <code class="ruby">  # This should called once before after save and after update hooks implemented.</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="203">
          <span class="hits">2</span>
          
          <code class="ruby">  def self.update_all_group_chat_room_sdk_name(application)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="204">
          
          
          <code class="ruby">    chat_rooms = ChatRoom.where(application_id: application.id).all</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="205">
          
          
          <code class="ruby">    chat_rooms.each do | chat_room |</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="206">
          
          
          <code class="ruby">      # update group name in sdk info from back-end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="207">
          
          
          <code class="ruby">      participants = chat_room.users.first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="208">
          
          
          <code class="ruby">      if !participants.nil? &amp;&amp; chat_room.is_group_chat == true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="209">
          
          
          <code class="ruby">        password = SecureRandom.hex # generate random password for security reason</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="210">
          
          
          <code class="ruby">        qiscus_sdk = QiscusSdk.new(participants.application.app_id, participants.application.qiscus_sdk_secret)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="211">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="212">
          
          
          <code class="ruby">        token = qiscus_sdk.login_or_register_rest(participants.qiscus_email, password, participants.fullname,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="213">
          
          
          <code class="ruby">          participants.avatar_url)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="214">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="215">
          
          
          <code class="ruby">        participants.update_attribute(:qiscus_token, token)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="216">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="217">
          
          
          <code class="ruby">        qiscus_sdk.update_room(token, chat_room.qiscus_room_id, chat_room.group_chat_name,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="218">
          
          
          <code class="ruby">          chat_room.group_avatar_url)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="219">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="220">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="221">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="222">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="223">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="224">
          <span class="hits">2</span>
          
          <code class="ruby">  def update_sdk_room_info</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="225">
          <span class="hits">5</span>
          
          <code class="ruby">    begin</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="226">
          <span class="hits">5</span>
          
          <code class="ruby">      Rails.logger.debug &quot;Update SDK Room Info&quot;</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="227">
          <span class="hits">5</span>
          
          <code class="ruby">      if is_group_chat</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="228">
          <span class="hits">5</span>
          
          <code class="ruby">        participants = users.first</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="229">
          <span class="hits">5</span>
          
          <code class="ruby">        password = SecureRandom.hex # generate random password for security reason</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="230">
          <span class="hits">5</span>
          
          <code class="ruby">        qiscus_sdk = QiscusSdk.new(participants.application.app_id, participants.application.qiscus_sdk_secret)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="231">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="232">
          
          
          <code class="ruby">        # to avoid error if user token changed in sdk</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="233">
          
          
          <code class="ruby">        token = qiscus_sdk.login_or_register_rest(participants.qiscus_email, password, participants.fullname,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="234">
          
          
          <code class="ruby">            participants.avatar_url)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="235">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="236">
          
          
          <code class="ruby">        participants.update_attribute(:qiscus_token, token)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="237">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="238">
          
          
          <code class="ruby">        qiscus_sdk.update_room(token, qiscus_room_id, group_chat_name, group_avatar_url)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="239">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="240">
          <span class="hits">5</span>
          
          <code class="ruby">    rescue Exception =&gt; e</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="241">
          <span class="hits">5</span>
          
          <code class="ruby">      Rails.logger.debug &quot;Fail when call SDK: #{e.message}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="242">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="243">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="244">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="245">
          
          
          <code class="ruby">  # Delete and update redis cache for conversation list to make all data sync after update</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="246">
          <span class="hits">2</span>
          
          <code class="ruby">  def update_redis_cache</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="247">
          <span class="hits">5</span>
          
          <code class="ruby">    user_ids = ChatUser.where(chat_room_id: id).pluck(:user_id)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="248">
          <span class="hits">5</span>
          
          <code class="ruby">    ChatRoomHelper.reset_chat_room_cache_for_users(user_ids)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="249">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="250">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="251">
          
          
          <code class="ruby">  # Update all avatar_url since it change to https</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="252">
          <span class="hits">2</span>
          
          <code class="ruby">  def self.update_all_avatar_url_to_https</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="253">
          
          
          <code class="ruby">    chat_rooms = ChatRoom.where(&#39;group_avatar_url LIKE ?&#39;, &#39;http://%&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="254">
          
          
          <code class="ruby">    chat_rooms.each do | c |</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="255">
          
          
          <code class="ruby">      old_group_avatar_url = c.group_avatar_url</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="256">
          
          
          <code class="ruby">      size = old_group_avatar_url.size</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="257">
          
          
          <code class="ruby">      raw_group_avatar_url = old_group_avatar_url[7...size]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="258">
          
          
          <code class="ruby">      new_group_avatar_url = &quot;https://&quot; + raw_group_avatar_url;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="259">
          
          
          <code class="ruby">      c.update_attribute(:group_avatar_url, new_group_avatar_url)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="260">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="261">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="262">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="263">
          <span class="hits">2</span>
          
          <code class="ruby">  def self.check_single_chat_room_which_contains_only_one_user</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="264">
          
          
          <code class="ruby">    chat_rooms = ChatRoom.where(is_group_chat: false).pluck(:id) # get all chat_room</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="265">
          
          
          <code class="ruby">    single_chat_user = Array.new</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="266">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="267">
          
          
          <code class="ruby">    chat_rooms.each do | c |</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="268">
          
          
          <code class="ruby">      chat_user_count = ChatUser.where(chat_room_id: c).count # count chat_room participants</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="269">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="270">
          
          
          <code class="ruby">      # Get chat_room which contains only one participant</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="271">
          
          
          <code class="ruby">      if chat_user_count == 1</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="272">
          
          
          <code class="ruby">        single_chat_user.push(c)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="273">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="274">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="275">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="276">
          
          
          <code class="ruby">    puts &quot;Single chat room which contains only one user : #{single_chat_user}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="277">
          
          
          <code class="ruby">    puts &quot;Total : #{single_chat_user.count}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="278">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="279">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="280">
          <span class="hits">2</span>
          
          <code class="ruby">  def self.insert_another_participant_into_single_chat_room_which_contains_only_one_user</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="281">
          
          
          <code class="ruby">    chat_rooms = ChatRoom.where(is_group_chat: false).pluck(:id, :user_id, :target_user_id) # get all chat_room</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="282">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="283">
          
          
          <code class="ruby">    chat_rooms.each do | c |</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="284">
          
          
          <code class="ruby">      chat_user = ChatUser.where(chat_room_id: c[0]) # c[0] mean chat_room_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="285">
          
          
          <code class="ruby">      chat_user_count = chat_user.count # count chat_room participants</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="286">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="287">
          
          
          <code class="ruby">      # Get chat_room which contains only one participant</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="288">
          
          
          <code class="ruby">      if chat_user_count == 1</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="289">
          
          
          <code class="ruby">        # get chat_room participant</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="290">
          
          
          <code class="ruby">        single_participant = chat_user.pluck(:user_id).first</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="291">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="292">
          
          
          <code class="ruby">        user_id = c[1] # c[1] mean user_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="293">
          
          
          <code class="ruby">        target_user_id = c[2] # c[2] mean target_user_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="294">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="295">
          
          
          <code class="ruby">        if single_participant == user_id and user_id != target_user_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="296">
          
          
          <code class="ruby">          chat_user = ChatUser.new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="297">
          
          
          <code class="ruby">          chat_user.user_id = target_user_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="298">
          
          
          <code class="ruby">          chat_user.chat_room_id = c[0]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="299">
          
          
          <code class="ruby">          chat_user.is_group_admin = false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="300">
          
          
          <code class="ruby">          chat_user.save!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="301">
          
          
          <code class="ruby">        elsif single_participant == target_user_id and user_id != target_user_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="302">
          
          
          <code class="ruby">          chat_user = ChatUser.new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="303">
          
          
          <code class="ruby">          chat_user.user_id = user_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="304">
          
          
          <code class="ruby">          chat_user.chat_room_id = c[0]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="305">
          
          
          <code class="ruby">          chat_user.is_group_admin = false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="306">
          
          
          <code class="ruby">          chat_user.save!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="307">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="308">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="309">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="310">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="311">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="312">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="313">
          <span class="hits">2</span>
          
          <code class="ruby">  def self.delete_single_chat_room_which_contains_only_one_user</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="314">
          
          
          <code class="ruby">    chat_rooms = ChatRoom.where(is_group_chat: false).pluck(:id) # get all chat_room</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="315">
          
          
          <code class="ruby">    single_chat_user = Array.new</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="316">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="317">
          
          
          <code class="ruby">    chat_rooms.each do | c |</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="318">
          
          
          <code class="ruby">      chat_user = ChatUser.where(chat_room_id: c)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="319">
          
          
          <code class="ruby">      chat_user_count = chat_user.count # count chat_room participants</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="320">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="321">
          
          
          <code class="ruby">      # Get chat_room which contains only one participant</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="322">
          
          
          <code class="ruby">      if chat_user_count == 1</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="323">
          
          
          <code class="ruby">        single_chat_user.push(c)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="324">
          
          
          <code class="ruby">        ChatRoom.find(c).destroy</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="325">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="326">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="327">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="328">
          
          
          <code class="ruby">    puts &quot;Single chat room which contains only one user : #{single_chat_user}&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="329">
          
          
          <code class="ruby">    puts &quot;Total : #{single_chat_user.count}&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="330">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="331">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="332">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="6ba280d9657af6bdf00537eab0711f409abd838d">
  <div class="header">
    <h3>app/models/chat_user.rb</h3>
    <h4><span class="red">76.0 %</span> covered</h4>
    <div>
      <b>25</b> relevant lines. 
      <span class="green"><b>19</b> lines covered</span> and
      <span class="red"><b>6</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="2" data-linenumber="1">
          <span class="hits">2</span>
          
          <code class="ruby">class ChatUser &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="2">
          <span class="hits">2</span>
          
          <code class="ruby">  validates :user_id, presence: true</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="3">
          <span class="hits">2</span>
          
          <code class="ruby">  validates :chat_room_id, presence: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">  # Relation info</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="6">
          <span class="hits">2</span>
          
          <code class="ruby">  belongs_to :user</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="7">
          <span class="hits">2</span>
          
          <code class="ruby">  belongs_to :chat_room</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="136" data-linenumber="9">
          <span class="hits">136</span>
          
          <code class="ruby">  default_scope { joins(:user)}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">  # Hooks</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">  # Update redis cache after create, update and delete</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">  # after save hooks will called both when Creating or Updating an Object</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">  # This should update cache after user removed or added to a chat room</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="15">
          <span class="hits">2</span>
          
          <code class="ruby">  after_save :update_redis_cache</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="16">
          <span class="hits">2</span>
          
          <code class="ruby">  after_destroy :update_redis_cache</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="17">
          <span class="hits">2</span>
          
          <code class="ruby">  after_destroy :delete_customized_chat_rooms</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">  # Delete and update redis cache for conversation list to make all data sync after update</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="20">
          <span class="hits">2</span>
          
          <code class="ruby">  def update_redis_cache</code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="21">
          <span class="hits">16</span>
          
          <code class="ruby">    user_ids = ChatUser.where(chat_room_id: chat_room_id).pluck(:user_id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">    # Add user_id to handle removed user_id in delete participants and leave group </code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="23">
          <span class="hits">16</span>
          
          <code class="ruby">    user_ids = user_ids &lt;&lt; user_id </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="25">
          <span class="hits">16</span>
          
          <code class="ruby">    ChatRoomHelper.reset_chat_room_cache_for_users(user_ids)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">  # For initialization, assign all group participants as group admin</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="29">
          <span class="hits">2</span>
          
          <code class="ruby">  def self.assign_all_group_participants_as_group_admin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">    # get all group chat room</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">    chat_room_ids = ChatRoom.where(is_group_chat: TRUE).where(is_official_chat: FALSE).pluck(:id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">    chat_users = ChatUser.where(&quot;chat_users.chat_room_id IN (?)&quot;, chat_room_ids)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">    chat_users.each do | c | </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">      c.update_attribute(:is_group_admin, TRUE)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="38">
          <span class="hits">2</span>
          
          <code class="ruby">  def delete_customized_chat_rooms</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="39">
          <span class="hits">1</span>
          
          <code class="ruby">    pin_chat = PinChatRoom.find_by(user_id: user_id, chat_room_id: chat_room_id)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="40">
          <span class="hits">1</span>
          
          <code class="ruby">    if !pin_chat.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">      pin_chat.destroy</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="44">
          <span class="hits">1</span>
          
          <code class="ruby">    mute_chat = MuteChatRoom.find_by(user_id: user_id, chat_room_id: chat_room_id)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="45">
          <span class="hits">1</span>
          
          <code class="ruby">    if !mute_chat.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="46">
          
          
          <code class="ruby">      mute_chat.destroy</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="dc6a28a96d44c2a4b0934f1d22b313fa9cc3781c">
  <div class="header">
    <h3>app/models/comment.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>15</b> relevant lines. 
      <span class="green"><b>15</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="2" data-linenumber="1">
          <span class="hits">2</span>
          
          <code class="ruby">class Comment &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="3">
          <span class="hits">2</span>
          
          <code class="ruby">  validates :user_id, presence: true</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="4">
          <span class="hits">2</span>
          
          <code class="ruby">  validates :post_id, presence: true</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="5">
          <span class="hits">2</span>
          
          <code class="ruby">  validates :content, presence: true, length: { maximum: 400}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="7">
          <span class="hits">2</span>
          
          <code class="ruby">  has_one :comment_media, class_name: &quot;CommentMedia&quot;</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="8">
          <span class="hits">2</span>
          
          <code class="ruby">  belongs_to :user</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="9">
          <span class="hits">2</span>
          
          <code class="ruby">  belongs_to :comment</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="10">
          <span class="hits">2</span>
          
          <code class="ruby">  belongs_to :post</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="24" data-linenumber="12">
          <span class="hits">24</span>
          
          <code class="ruby">  default_scope { joins(:user)}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="14">
          <span class="hits">2</span>
          
          <code class="ruby">  def as_json(options = {})</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="15">
          <span class="hits">2</span>
          
          <code class="ruby">    h = super()</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="17">
          <span class="hits">2</span>
          
          <code class="ruby">    h[:comment_media] = (comment_media == nil) ? {} : comment_media</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="18">
          <span class="hits">2</span>
          
          <code class="ruby">    h[:creator] = user.as_json</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="19">
          <span class="hits">2</span>
          
          <code class="ruby">    h[:comments] = Comment.where(comment_id: id).order(created_at: :desc).as_json</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">    </code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="21">
          <span class="hits">2</span>
          
          <code class="ruby">    return h</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="490181d6f2ea6a8ba15bf1d1e8b9a084fcc432a5">
  <div class="header">
    <h3>app/models/comment_media.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>10</b> relevant lines. 
      <span class="green"><b>10</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class CommentMedia &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby">  # &quot;media&quot; is already plural form</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  self.table_name = &quot;comment_media&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :content_type, presence: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :media_type, presence: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :sub_type, presence: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :size, presence: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :original_filename, presence: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :compressed_link, presence: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :link, presence: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :comment</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="fbf96fc2c8fd8fb908e44aae6bd7b12cee72f5f7">
  <div class="header">
    <h3>app/models/contact.rb</h3>
    <h4><span class="yellow">90.0 %</span> covered</h4>
    <div>
      <b>20</b> relevant lines. 
      <span class="green"><b>18</b> lines covered</span> and
      <span class="red"><b>2</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="2" data-linenumber="1">
          <span class="hits">2</span>
          
          <code class="ruby">class Contact &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="2">
          <span class="hits">2</span>
          
          <code class="ruby">  validates :user_id, presence: true</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="3">
          <span class="hits">2</span>
          
          <code class="ruby">  validates :contact_id, presence: true</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="4">
          <span class="hits">2</span>
          
          <code class="ruby">  validate  :different_user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">  # Relation info</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="7">
          <span class="hits">2</span>
          
          <code class="ruby">  belongs_to :user</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="8">
          <span class="hits">2</span>
          
          <code class="ruby">  belongs_to :contact, :class_name =&gt; :User, :foreign_key =&gt; &quot;contact_id&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="52" data-linenumber="10">
          <span class="hits">52</span>
          
          <code class="ruby">  default_scope { joins(:user)}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">  # Hooks</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">  # Update redis cache after create, update and delete</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">  # after save hooks will called both when Creating or Updating an Object</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">  # This should update cache after user removed or added to a chat room</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="16">
          <span class="hits">2</span>
          
          <code class="ruby">  after_save :update_redis_cache</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="17">
          <span class="hits">2</span>
          
          <code class="ruby">  after_destroy :update_redis_cache</code>
        </li>
      
        <li class="covered" data-hits="52" data-linenumber="18">
          <span class="hits">52</span>
          
          <code class="ruby">  default_scope  { where(&quot;contacts.user_id != contacts.contact_id&quot;)}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">  # Delete and update redis cache for conversation list to make all data sync after update</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="21">
          <span class="hits">2</span>
          
          <code class="ruby">  def update_redis_cache</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">    # for add, update or delete contact, the related changes is only between the user and its contact</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">    # for instance A has contact B (which mean that B has contact A too),</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">    # if A delete, update (mark or unmark as favorite) it only changes conversation list for user A and B.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">    # It does happen when A add C, it only change conversation list of A and C, since the property needed in </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">    # conversation list where come from this table is only is_contact and is_favored flag.</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="27">
          <span class="hits">6</span>
          
          <code class="ruby">    user_ids = [user_id, contact_id]</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="28">
          <span class="hits">6</span>
          
          <code class="ruby">    user_ids = user_ids.uniq</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="30">
          <span class="hits">6</span>
          
          <code class="ruby">    ChatRoomHelper.reset_chat_room_cache_for_users(user_ids)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="33">
          <span class="hits">2</span>
          
          <code class="ruby">  def as_json(options = {})</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">    h = super(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">      :include =&gt; [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">        {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">          :contact =&gt; {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">        }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">      ],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">      :except =&gt; [:user_id, :contact_id]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">    )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">    return h</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="47">
          <span class="hits">2</span>
          
          <code class="ruby">private</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="48">
          <span class="hits">2</span>
          
          <code class="ruby">  def different_user</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="49">
          <span class="hits">6</span>
          
          <code class="ruby">    errors.add(:contact_id, &quot;cannot be same as user id&quot;) if user_id == contact_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="26d79baaea4bc862a3f42f903979fdab6aa7b147">
  <div class="header">
    <h3>app/models/fcm_client.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>6</b> relevant lines. 
      <span class="green"><b>6</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;fcm&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">class FcmClient</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  def self.send(fcm_key, registration_ids, custom_payload)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">    fcm = FCM.new(fcm_key)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">    response = fcm.send(registration_ids, custom_payload)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">    return response</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="f492b5941f0c8cf07524d88daa0903d024253d6d">
  <div class="header">
    <h3>app/models/like.rb</h3>
    <h4><span class="red">70.0 %</span> covered</h4>
    <div>
      <b>10</b> relevant lines. 
      <span class="green"><b>7</b> lines covered</span> and
      <span class="red"><b>3</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class Like &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :user_id, presence: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :post_id, presence: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :user</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :post</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="9">
          <span class="hits">13</span>
          
          <code class="ruby">  default_scope { joins(:user)}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  def as_json(options = {})</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">    h = super()</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">    h[:creator] = user.as_json</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">    </code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">    return h</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="12c721a39717db7f5a4ca6b6a1b7b0ca0637bb7e">
  <div class="header">
    <h3>app/models/mute_chat_room.rb</h3>
    <h4><span class="yellow">81.82 %</span> covered</h4>
    <div>
      <b>11</b> relevant lines. 
      <span class="green"><b>9</b> lines covered</span> and
      <span class="red"><b>2</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class MuteChatRoom &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :chat_room_id, presence: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :user_id, presence: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :chat_room</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="8">
          <span class="hits">7</span>
          
          <code class="ruby">  default_scope { joins(:user)}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">  # Update redis cache after create, update and delete</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">  # after save hooks will called both when Creating or Updating an Object</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  after_save :update_redis_cache</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  after_destroy :update_redis_cache</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">  # Delete and update redis cache for conversation list to make all data sync after update</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  def update_redis_cache</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">    user_ids = [user_id]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">    ChatRoomHelper.reset_chat_room_cache_for_users(user_ids)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="405aec855758eb1fa58602eaa39040613a173696">
  <div class="header">
    <h3>app/models/pin_chat_room.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>11</b> relevant lines. 
      <span class="green"><b>11</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="2" data-linenumber="1">
          <span class="hits">2</span>
          
          <code class="ruby">class PinChatRoom &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="2">
          <span class="hits">2</span>
          
          <code class="ruby">  validates :chat_room_id, presence: true</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="3">
          <span class="hits">2</span>
          
          <code class="ruby">  validates :user_id, presence: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="5">
          <span class="hits">2</span>
          
          <code class="ruby">  belongs_to :chat_room</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="6">
          <span class="hits">2</span>
          
          <code class="ruby">  belongs_to :user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="16" data-linenumber="8">
          <span class="hits">16</span>
          
          <code class="ruby">  default_scope { joins(:user)}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">  # Update redis cache after create, update and delete</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">  # after save hooks will called both when Creating or Updating an Object</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="12">
          <span class="hits">2</span>
          
          <code class="ruby">  after_save :update_redis_cache</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="13">
          <span class="hits">2</span>
          
          <code class="ruby">  after_destroy :update_redis_cache</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">  # Delete and update redis cache for conversation list to make all data sync after update</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="16">
          <span class="hits">2</span>
          
          <code class="ruby">  def update_redis_cache</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="17">
          <span class="hits">2</span>
          
          <code class="ruby">    user_ids = [user_id]</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="18">
          <span class="hits">2</span>
          
          <code class="ruby">    ChatRoomHelper.reset_chat_room_cache_for_users(user_ids)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="ef9613b15bda0b87d1bb5742261821d260e4ccff">
  <div class="header">
    <h3>app/models/post.rb</h3>
    <h4><span class="red">50.0 %</span> covered</h4>
    <div>
      <b>40</b> relevant lines. 
      <span class="green"><b>20</b> lines covered</span> and
      <span class="red"><b>20</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="2" data-linenumber="1">
          <span class="hits">2</span>
          
          <code class="ruby">class Post &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="2">
          <span class="hits">2</span>
          
          <code class="ruby">  validates :user_id, presence: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="4">
          <span class="hits">2</span>
          
          <code class="ruby">  belongs_to :user</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="5">
          <span class="hits">2</span>
          
          <code class="ruby">  has_many :post_media, class_name: &quot;PostMedia&quot;</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="6">
          <span class="hits">2</span>
          
          <code class="ruby">  has_many :comments</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="7">
          <span class="hits">2</span>
          
          <code class="ruby">  belongs_to :post</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="8">
          <span class="hits">2</span>
          
          <code class="ruby">  has_many :likes</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="9">
          <span class="hits">2</span>
          
          <code class="ruby">  has_many :post_history, class_name: &quot;PostHistory&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="25" data-linenumber="11">
          <span class="hits">25</span>
          
          <code class="ruby">  default_scope { joins(:user)}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="13">
          <span class="hits">2</span>
          
          <code class="ruby">  def as_json(options = {})</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="14">
          <span class="hits">5</span>
          
          <code class="ruby">    h = super()</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="16">
          <span class="hits">5</span>
          
          <code class="ruby">    h[:post_media] = (post_media == []) ? {} : post_media.first.as_json</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="17">
          <span class="hits">5</span>
          
          <code class="ruby">    h[:shared_post] = post.as_json</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="18">
          <span class="hits">5</span>
          
          <code class="ruby">    h[:creator] = user.as_json</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="19">
          <span class="hits">5</span>
          
          <code class="ruby">    h[:shared_count] = Post.where(post_id: id).count</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="20">
          <span class="hits">5</span>
          
          <code class="ruby">    h[:comment_count] = comments.where(comment_id: nil).count</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="21">
          <span class="hits">5</span>
          
          <code class="ruby">    h[:like_count] = likes.count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">    # hide comments object in post, to avoid n+1 query in rails object</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">    # h[:comments] = comments.as_json</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="24">
          <span class="hits">5</span>
          
          <code class="ruby">    if options.has_key?(:job)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">      h[&quot;created_at&quot;] = created_at.iso8601.to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="26">
          
          
          <code class="ruby">      h[&quot;updated_at&quot;] = updated_at.iso8601.to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="27">
          
          
          <code class="ruby">      h[:creator] = user.as_json(job: true)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">      h[:post_media] = (post_media == []) ? {} : post_media.first.as_json(job: true)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">      h[:shared_post] = post.as_json(job: true)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="31">
          <span class="hits">5</span>
          
          <code class="ruby">    return h</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">  # this for show all media as an array</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="35">
          <span class="hits">2</span>
          
          <code class="ruby">  def as_post_list_json(options = {})</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="36">
          
          
          <code class="ruby">    h = as_json # this is method from this class</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="37">
          
          
          <code class="ruby">    h = as_json(job: true) if options.has_key?(:job)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="39">
          
          
          <code class="ruby">    h[:post_media] = (post_media == nil) ? [] : post_media.as_json</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="40">
          
          
          <code class="ruby">    h[:shared_post] = (post == nil) ? nil : post.as_post_list_json</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="41">
          
          
          <code class="ruby">    h[:creator] = user.as_json</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="42">
          
          
          <code class="ruby">    h[:shared_count] = Post.where(post_id: id).count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="43">
          
          
          <code class="ruby">    h[:comment_count] = comments.where(comment_id: nil).count</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="44">
          
          
          <code class="ruby">    h[:like_count] = likes.count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">    # hide comments object in post, to avoid n+1 query in rails object</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">    # h[:comments] = comments.as_json</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="47">
          
          
          <code class="ruby">    if options.has_key?(:job)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="48">
          
          
          <code class="ruby">      h[&quot;created_at&quot;] = created_at.iso8601.to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="49">
          
          
          <code class="ruby">      h[&quot;updated_at&quot;] = updated_at.iso8601.to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="50">
          
          
          <code class="ruby">      h[:creator] = user.as_json(job: true)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="51">
          
          
          <code class="ruby">      h[:post_media] = (post_media == []) ? {} : post_media.as_json(job: true)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="52">
          
          
          <code class="ruby">      h[:shared_post] = (post == nil) ? nil : post.as_post_list_json(job: true)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="54">
          
          
          <code class="ruby">    return h</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="fc230b8c160cd98f87f8fc8cef527e4cd2a91182">
  <div class="header">
    <h3>app/models/post_media.rb</h3>
    <h4><span class="red">73.33 %</span> covered</h4>
    <div>
      <b>15</b> relevant lines. 
      <span class="green"><b>11</b> lines covered</span> and
      <span class="red"><b>4</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class PostMedia &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby">  # &quot;media&quot; is already plural form</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  self.table_name = &quot;post_media&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="5">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :content_type, presence: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :media_type, presence: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :sub_type, presence: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :size, presence: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :original_filename, presence: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :compressed_link, presence: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :link, presence: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :post</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">  def as_json(options={})</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">    h = super()</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="17">
          
          
          <code class="ruby">    h[&quot;created_at&quot;] = created_at.iso8601.to_s if options.has_key?(:job)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">    h[&quot;updated_at&quot;] = updated_at.iso8601.to_s if options.has_key?(:job)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">    return h</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="63a9170e3e92491bd77fdfb01dbb4670247e3048">
  <div class="header">
    <h3>app/models/role.rb</h3>
    <h4><span class="red">60.0 %</span> covered</h4>
    <div>
      <b>20</b> relevant lines. 
      <span class="green"><b>12</b> lines covered</span> and
      <span class="red"><b>8</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="2" data-linenumber="1">
          <span class="hits">2</span>
          
          <code class="ruby">class Role &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="2">
          <span class="hits">2</span>
          
          <code class="ruby">  validates :name, presence: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="4">
          <span class="hits">2</span>
          
          <code class="ruby">  has_many :user_roles</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="5">
          <span class="hits">2</span>
          
          <code class="ruby">  has_many :users, through: :user_roles</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="7">
          <span class="hits">2</span>
          
          <code class="ruby">  def self.official</code>
        </li>
      
        <li class="covered" data-hits="14" data-linenumber="8">
          <span class="hits">14</span>
          
          <code class="ruby">    return Role.find_or_create_by(name: &#39;Official Account&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="11">
          <span class="hits">2</span>
          
          <code class="ruby">  def self.admin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">    return Role.find_or_create_by(name: &#39;Admin&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="15">
          <span class="hits">2</span>
          
          <code class="ruby">  def self.member</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="16">
          <span class="hits">5</span>
          
          <code class="ruby">    return Role.find_or_create_by(name: &#39;Member&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="19">
          <span class="hits">2</span>
          
          <code class="ruby">  def self.helpdesk</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">    return Role.find_or_create_by(name: &#39;Helpdesk&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="23">
          <span class="hits">2</span>
          
          <code class="ruby">  def self.bot</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="24">
          
          
          <code class="ruby">      return Role.find_or_create_by(name: &#39;Bot&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="27">
          <span class="hits">2</span>
          
          <code class="ruby">  def self.find_official</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="28">
          
          
          <code class="ruby">    official = Role.where(name: &quot;Official Account&quot;).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="29">
          
          
          <code class="ruby">    if !official.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="30">
          
          
          <code class="ruby">      official_id = official.id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">      off_id = nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">    return official_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="e0c8eb38ea0e946b12f078f0498931fb50f58959">
  <div class="header">
    <h3>app/models/user.rb</h3>
    <h4><span class="red">38.81 %</span> covered</h4>
    <div>
      <b>201</b> relevant lines. 
      <span class="green"><b>78</b> lines covered</span> and
      <span class="red"><b>123</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="2" data-linenumber="1">
          <span class="hits">2</span>
          
          <code class="ruby">require &#39;csv&#39;</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="2">
          <span class="hits">2</span>
          
          <code class="ruby">require &#39;securerandom&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="4">
          <span class="hits">2</span>
          
          <code class="ruby">class User &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">  # Validator</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">  # validates :phone_number, presence: true # change since phone number is null able</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="8">
          <span class="hits">2</span>
          
          <code class="ruby">  validates :fullname, length: { minimum: 4}, allow_nil: true, allow_blank: false, spaces_only: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">  # the default value</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="10">
          <span class="hits">2</span>
          
          <code class="ruby">  validates :email, length: { minimum: 1}, email: true, allow_nil: true, allow_blank: true</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="11">
          <span class="hits">2</span>
          
          <code class="ruby">  validates :qiscus_email, email: true, presence: true # email registered to Qiscus SDK</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">  # validates :phone_number, phony_plausible: { with: /\A\+\d+/ }, allow_nil: true, allow_blank: true</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="13">
          <span class="hits">2</span>
          
          <code class="ruby">  validates :phone_number, presence: true, allow_nil: true, allow_blank: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">  # phony_normalize :phone_number</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">  # validates_plausible_phone :phone_number, with: /\A\+\d+/</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="16">
          <span class="hits">2</span>
          
          <code class="ruby">  enum gender: [ :male, :female ]</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="17">
          <span class="hits">2</span>
          
          <code class="ruby">  validates :is_public, inclusion: { in: [ true, false, &quot;true&quot;, &quot;false&quot;] }</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="18">
          <span class="hits">2</span>
          
          <code class="ruby">  validates :callback_url, url: true, allow_nil: true, allow_blank: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">  # Relation info</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="21">
          <span class="hits">2</span>
          
          <code class="ruby">  belongs_to :application</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="22">
          <span class="hits">2</span>
          
          <code class="ruby">  has_many :user_roles</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="23">
          <span class="hits">2</span>
          
          <code class="ruby">  has_many :roles, through: :user_roles</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="25">
          <span class="hits">2</span>
          
          <code class="ruby">  has_many :contacts</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="26">
          <span class="hits">2</span>
          
          <code class="ruby">  has_many :users, through: :contacts</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="28">
          <span class="hits">2</span>
          
          <code class="ruby">  has_many :chat_users</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="29">
          <span class="hits">2</span>
          
          <code class="ruby">  has_many :chat_rooms, through: :chat_users</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="31">
          <span class="hits">2</span>
          
          <code class="ruby">  has_many :auth_sessions</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="33">
          <span class="hits">2</span>
          
          <code class="ruby">  has_many :posts</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="35">
          <span class="hits">2</span>
          
          <code class="ruby">  has_many :user_features</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="36">
          <span class="hits">2</span>
          
          <code class="ruby">  has_many :features, through: :user_features</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="38">
          <span class="hits">2</span>
          
          <code class="ruby">  has_many :user_device_tokens</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="40">
          <span class="hits">2</span>
          
          <code class="ruby">  has_many :pin_chat_rooms</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="41">
          <span class="hits">2</span>
          
          <code class="ruby">  has_many :mute_chat_rooms</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="43">
          <span class="hits">2</span>
          
          <code class="ruby">  has_many :likes</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="44">
          <span class="hits">2</span>
          
          <code class="ruby">  has_many :post_history, class_name: &quot;PostHistory&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="46">
          <span class="hits">2</span>
          
          <code class="ruby">  has_many :user_additional_infos</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="48">
          <span class="hits">2</span>
          
          <code class="ruby">  has_many :call_logs</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="50">
          <span class="hits">2</span>
          
          <code class="ruby">  has_one :user_dedicated_passcodes</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="51">
          <span class="hits">2</span>
          
          <code class="ruby">  has_one :bot</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby">  # Hooks</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="54">
          <span class="hits">2</span>
          
          <code class="ruby">  before_validation :strip_spaces</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">  # before_save :update_sdk_profile</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">  # Update redis cache after create, update and delete</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">  # after save hooks will called both when Creating or Updating an Object</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="59">
          <span class="hits">2</span>
          
          <code class="ruby">  after_save :update_redis_cache</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="60">
          <span class="hits">2</span>
          
          <code class="ruby">  after_destroy :update_redis_cache</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="61">
          <span class="hits">2</span>
          
          <code class="ruby">  after_commit :auto_add_contact, on: :create</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1148" data-linenumber="63">
          <span class="hits">1148</span>
          
          <code class="ruby">  default_scope { where(deleted: false) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="65">
          <span class="hits">2</span>
          
          <code class="ruby">  def strip_spaces</code>
        </li>
      
        <li class="covered" data-hits="10" data-linenumber="66">
          <span class="hits">10</span>
          
          <code class="ruby">    self.phone_number = (self.phone_number.nil? || self.phone_number == &quot;&quot;) ? &quot;&quot; : self.phone_number.strip()</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">  # additional attribute</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="70">
          <span class="hits">2</span>
          
          <code class="ruby">  def is_admin</code>
        </li>
      
        <li class="covered" data-hits="138" data-linenumber="71">
          <span class="hits">138</span>
          
          <code class="ruby">    self.roles.pluck(:name).include?(&#39;Admin&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="74">
          <span class="hits">2</span>
          
          <code class="ruby">  def is_official</code>
        </li>
      
        <li class="covered" data-hits="140" data-linenumber="75">
          <span class="hits">140</span>
          
          <code class="ruby">    self.roles.pluck(:name).include?(&#39;Official Account&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="78">
          <span class="hits">2</span>
          
          <code class="ruby">  def is_helpdesk</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="79">
          
          
          <code class="ruby">    self.roles.pluck(:name).include?(&#39;Helpdesk&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="82">
          <span class="hits">2</span>
          
          <code class="ruby">  def self.find_bot_id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="83">
          
          
          <code class="ruby">    bot = Role.where(name: &quot;Bot&quot;).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="84">
          
          
          <code class="ruby">    if bot.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="85">
          
          
          <code class="ruby">      bot_id = nil</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="87">
          
          
          <code class="ruby">      bot_id = bot.id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="89">
          
          
          <code class="ruby">    return bot_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="92">
          <span class="hits">2</span>
          
          <code class="ruby">  def self.find_user_bot(user_ids, bot_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="93">
          
          
          <code class="ruby">    user_bot = UserRole.where(user_id: user_ids, role_id: bot_id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="94">
          
          
          <code class="ruby">    if !user_bot.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="95">
          
          
          <code class="ruby">      user_bot = user_bot.pluck(:user_id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="97">
          
          
          <code class="ruby">      user_bot = []</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="99">
          
          
          <code class="ruby">    return user_bot</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="102">
          <span class="hits">2</span>
          
          <code class="ruby">  def is_bot</code>
        </li>
      
        <li class="covered" data-hits="98" data-linenumber="103">
          <span class="hits">98</span>
          
          <code class="ruby">    self.roles.pluck(:name).include?(&#39;Bot&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="106">
          <span class="hits">2</span>
          
          <code class="ruby">  def additional_infos</code>
        </li>
      
        <li class="covered" data-hits="135" data-linenumber="107">
          <span class="hits">135</span>
          
          <code class="ruby">    additional_infos = Hash.new</code>
        </li>
      
        <li class="covered" data-hits="135" data-linenumber="108">
          <span class="hits">135</span>
          
          <code class="ruby">    user_additional_infos.each do | user_additional_info |</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="109">
          
          
          <code class="ruby">      additional_infos[user_additional_info.key] = user_additional_info.value</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="110">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="covered" data-hits="135" data-linenumber="111">
          <span class="hits">135</span>
          
          <code class="ruby">    return additional_infos</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby">  # static function</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="115">
          <span class="hits">2</span>
          
          <code class="ruby">  def self.admin_import(file_path, application)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="116">
          
          
          <code class="ruby">    imported = Array.new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="117">
          
          
          <code class="ruby">    not_imported = Array.new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="118">
          
          
          <code class="ruby">    reasons = Array.new</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="120">
          
          
          <code class="ruby">    csv = CSV.new(file_path, :headers =&gt; true, :encoding =&gt; &#39;iso-8859-1:utf-8&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="121">
          
          
          <code class="ruby">    csv.each do |row|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="122">
          
          
          <code class="ruby">      data = row.to_hash</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="124">
          
          
          <code class="ruby">      phone_number = data[&quot;phone_number&quot;]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="125">
          
          
          <code class="ruby">      phone_number = phone_number.strip().delete(&#39; &#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby">      # phone_number = PhonyRails.normalize_number(phone_number, default_country_code: &#39;ID&#39;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="128">
          
          
          <code class="ruby">      email_sdk = data[&quot;phone_number&quot;].tr(&#39;+&#39;, &#39;&#39;).delete(&#39; &#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="129">
          
          
          <code class="ruby">      email_sdk = email_sdk.downcase.gsub(/[^a-z0-9_.]/i, &quot;&quot;) # only get alphanumeric and _ and . string only</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="130">
          
          
          <code class="ruby">      email_sdk = email_sdk + &quot;@&quot; + application.app_id + &quot;.com&quot; # will build string like 085868xxxxxx@app_id.com</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="132">
          
          
          <code class="ruby">      params = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby">        fullname: data[&quot;fullname&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby">        phone_number: phone_number,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby">        email: data[&quot;email&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby">        gender: data[&quot;gender&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby">        date_of_birth: data[&quot;date_of_birth&quot;],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby">        qiscus_email: email_sdk,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby">        application_id: application.id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby">        qiscus_token: &quot;qiscus_token&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby">      }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="142">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="143">
          
          
          <code class="ruby">      begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="144">
          
          
          <code class="ruby">        user = User.create!(params)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="146">
          
          
          <code class="ruby">        email_sdk = &quot;userid_&quot; + user.id.to_s + &quot;_&quot; + user.qiscus_email</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="147">
          
          
          <code class="ruby">        password = SecureRandom.hex # generate random password for security reason</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="148">
          
          
          <code class="ruby">        qiscus_sdk = QiscusSdk.new(application.app_id, application.qiscus_sdk_secret)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="149">
          
          
          <code class="ruby">        qiscus_token = qiscus_sdk.login_or_register_rest(email_sdk, password, email_sdk) # get qiscus token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="150">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby">        # this ensure qiscus email sdk to be unique</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="152">
          
          
          <code class="ruby">        user.update_attribute(:qiscus_email, email_sdk)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="153">
          
          
          <code class="ruby">        user.update_attribute(:qiscus_token, qiscus_token)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="154">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="155">
          
          
          <code class="ruby">        role = Role.member</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="156">
          
          
          <code class="ruby">        user_role = UserRole.new(user_id: user.id, role_id: role.id)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="157">
          
          
          <code class="ruby">        user_role.save!</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="158">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="159">
          
          
          <code class="ruby">        imported.push(user)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="160">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="161">
          
          
          <code class="ruby">      rescue ActiveRecord::RecordNotUnique =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="162">
          
          
          <code class="ruby">        not_imported.push(params)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="164">
          
          
          <code class="ruby">        reason = Hash.new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="165">
          
          
          <code class="ruby">        reason[:user] = params</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="166">
          
          
          <code class="ruby">        reason[:error_message] = &quot;User with phone number &#39;#{params[:phone_number]}&#39; and application &#39;#{application.app_id}&#39; already exist&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="167">
          
          
          <code class="ruby">        reasons.push(reason)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="168">
          
          
          <code class="ruby">      rescue Exception =&gt; e</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="169">
          
          
          <code class="ruby">        not_imported.push(params)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="170">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="171">
          
          
          <code class="ruby">        reason = Hash.new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="172">
          
          
          <code class="ruby">        reason[:user] = params</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="173">
          
          
          <code class="ruby">        reason[:error_message] = e.message</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="174">
          
          
          <code class="ruby">        reasons.push(reason)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="175">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="176">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="177">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="178">
          
          
          <code class="ruby">    response = OpenStruct.new(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="179">
          
          
          <code class="ruby">    {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="180">
          
          
          <code class="ruby">      :imported_total =&gt; imported.count,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="181">
          
          
          <code class="ruby">      :not_imported_total =&gt; not_imported.count,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="182">
          
          
          <code class="ruby">      :imported =&gt; imported,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="183">
          
          
          <code class="ruby">      :not_imported =&gt; not_imported,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="184">
          
          
          <code class="ruby">      :not_imported_reasons =&gt; reasons</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="185">
          
          
          <code class="ruby">    })</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="186">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="187">
          
          
          <code class="ruby">    return response.marshal_dump</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="188">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="189">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="190">
          
          
          <code class="ruby">  # json manipulation</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="191">
          <span class="hits">2</span>
          
          <code class="ruby">  def as_json(options={})</code>
        </li>
      
        <li class="covered" data-hits="98" data-linenumber="192">
          <span class="hits">98</span>
          
          <code class="ruby">    h = super(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="193">
          
          
          <code class="ruby">      # :include =&gt; [</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="194">
          
          
          <code class="ruby">      #   {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="195">
          
          
          <code class="ruby">      #     :roles =&gt;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="196">
          
          
          <code class="ruby">      #     {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="197">
          
          
          <code class="ruby">      #       :only =&gt; [:id, :name]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="198">
          
          
          <code class="ruby">      #     }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="199">
          
          
          <code class="ruby">      #   },</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="200">
          
          
          <code class="ruby">      #   {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="201">
          
          
          <code class="ruby">      #     :application =&gt; { :only =&gt; [:app_name] }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="202">
          
          
          <code class="ruby">      #   }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="203">
          
          
          <code class="ruby">      # ],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="204">
          
          
          <code class="ruby">      :except =&gt; [:passcode, :application_id, :qiscus_token, :lock_version],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="205">
          
          
          <code class="ruby">      :methods =&gt; [ :is_admin, :is_official, :is_bot, :additional_infos ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="206">
          
          
          <code class="ruby">    )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="207">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="208">
          
          
          <code class="ruby">    # Overwrite json if has key webhook. This json use only in webhook payload</code>
        </li>
      
        <li class="covered" data-hits="98" data-linenumber="209">
          <span class="hits">98</span>
          
          <code class="ruby">    if options.has_key?(:webhook)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="210">
          
          
          <code class="ruby">      h = super(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="211">
          
          
          <code class="ruby">        :only =&gt; [:id, :phone_number, :fullname, :qiscus_email]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="212">
          
          
          <code class="ruby">      )</code>
        </li>
      
        <li class="covered" data-hits="98" data-linenumber="213">
          <span class="hits">98</span>
          
          <code class="ruby">    elsif options.has_key?(:job)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="214">
          
          
          <code class="ruby">      h = super(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="215">
          
          
          <code class="ruby">        :except =&gt; [:passcode, :application_id, :qiscus_token, :lock_version, :updated_at, :created_at],</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="216">
          
          
          <code class="ruby">        :methods =&gt; [ :is_admin, :is_official, :is_bot, :additional_infos ]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="217">
          
          
          <code class="ruby">       )</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="218">
          
          
          <code class="ruby">      h[&quot;created_at&quot;] = created_at.iso8601.to_s</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="219">
          
          
          <code class="ruby">      h[&quot;updated_at&quot;] = updated_at.iso8601.to_s</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="220">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="221">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="222">
          
          
          <code class="ruby">    # replace fullname using phone number or email if the fullname is empty</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="223">
          
          
          <code class="ruby">    # if fullname.nil? || fullname == &quot;&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="224">
          
          
          <code class="ruby">    #   if phone_number.nil? || phone_number == &quot;&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="225">
          
          
          <code class="ruby">    #     h[&quot;fullname&quot;] = email</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="226">
          
          
          <code class="ruby">    #   else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="227">
          
          
          <code class="ruby">    #     h[&quot;fullname&quot;] = phone_number</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="228">
          
          
          <code class="ruby">    #   end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="229">
          
          
          <code class="ruby">    # end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="230">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="231">
          
          
          <code class="ruby">    # specification: Jika tidak ter-check berarti pengguna lain tidak bisa melihat email, gender, dan DOB.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="232">
          
          
          <code class="ruby">    # Hanya bisa melihat nama, nomor telepon, dan avatar</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="233">
          
          
          <code class="ruby">    # if has not me keys then it is another user, so it need to be hide</code>
        </li>
      
        <li class="covered" data-hits="98" data-linenumber="234">
          <span class="hits">98</span>
          
          <code class="ruby">    if options.has_key?(:show_profile)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="235">
          
          
          <code class="ruby">      # override custom value for users email, gender and date_of_birth</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="236">
          
          
          <code class="ruby">      # hide this properties (just set it to empty string for consistent structure)</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="237">
          <span class="hits">8</span>
          
          <code class="ruby">      if options[:show_profile] == false &amp;&amp; h[&quot;is_public&quot;] == false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="238">
          
          
          <code class="ruby">        h[&quot;email&quot;] = &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="239">
          
          
          <code class="ruby">        h[&quot;gender&quot;] = &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="240">
          
          
          <code class="ruby">        h[&quot;date_of_birth&quot;] = &quot;&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="241">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="242">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="243">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="244">
          
          
          <code class="ruby">    # too many query if using this approach</code>
        </li>
      
        <li class="covered" data-hits="98" data-linenumber="245">
          <span class="hits">98</span>
          
          <code class="ruby">    if options.has_key?(:contact_of)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="246">
          
          
          <code class="ruby">      contact_of = options[:contact_of]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="247">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="248">
          
          
          <code class="ruby">      contact_user = Contact.find_by(user_id: contact_of[&quot;id&quot;], contact_id: h[&quot;id&quot;])</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="249">
          
          
          <code class="ruby">      if contact_user.nil? == false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="250">
          
          
          <code class="ruby">        h[&quot;is_favored&quot;] = contact_user[&quot;is_favored&quot;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="251">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="252">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="253">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="254">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="255">
          
          
          <code class="ruby">    # h[&quot;is_admin&quot;] = is_admin</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="256">
          
          
          <code class="ruby">    # h[&quot;is_official&quot;] = is_official</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="257">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="258">
          
          
          <code class="ruby">    # h[&quot;additional_infos&quot;] = Hash.new # default additional info key is empty object</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="259">
          
          
          <code class="ruby">    # user_additional_infos = UserAdditionalInfo::where(user_id: h[&quot;id&quot;]).all</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="260">
          
          
          <code class="ruby">    # user_additional_infos.each do | user_additional_info |</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="261">
          
          
          <code class="ruby">    #   h[&quot;additional_infos&quot;][user_additional_info.key] = user_additional_info.value</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="262">
          
          
          <code class="ruby">    # end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="263">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="98" data-linenumber="264">
          <span class="hits">98</span>
          
          <code class="ruby">    return h</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="265">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="266">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="267">
          
          
          <code class="ruby">  # as contact json must replace fullname to phone number or email if fullname is nil or empty string</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="268">
          <span class="hits">2</span>
          
          <code class="ruby">  def as_contact_json(options={})</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="269">
          <span class="hits">12</span>
          
          <code class="ruby">    h = as_json # this is method from this class</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="270">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="271">
          
          
          <code class="ruby">    # replace fullname using phone number or email if the fullname is empty</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="272">
          <span class="hits">12</span>
          
          <code class="ruby">    if fullname.nil? || fullname == &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="273">
          
          
          <code class="ruby">      if phone_number.nil? || phone_number == &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="274">
          
          
          <code class="ruby">        h[&quot;fullname&quot;] = email</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="275">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="276">
          
          
          <code class="ruby">        h[&quot;fullname&quot;] = phone_number</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="277">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="278">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="279">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="280">
          <span class="hits">12</span>
          
          <code class="ruby">    return h</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="281">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="282">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="283">
          
          
          <code class="ruby">  # Updating all fullname in SDK to fullname in backend.</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="284">
          
          
          <code class="ruby">  # This is to make name in SDK is same with data in backend (when load conversation list).</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="285">
          
          
          <code class="ruby">  # This should called once before after save and after update hooks implemented.</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="286">
          <span class="hits">2</span>
          
          <code class="ruby">  def self.update_all_user_sdk_name</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="287">
          
          
          <code class="ruby">    users = User.all</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="288">
          
          
          <code class="ruby">    users.each do | u |</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="289">
          
          
          <code class="ruby">      password = SecureRandom.hex # generate random password for security reason</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="290">
          
          
          <code class="ruby">      qiscus_sdk = QiscusSdk.new(u.application.app_id, u.application.qiscus_sdk_secret)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="291">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="292">
          
          
          <code class="ruby">      username = u.fullname</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="293">
          
          
          <code class="ruby">      # some user may not set their fullname, so use phone number</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="294">
          
          
          <code class="ruby">      if username.nil? || username == &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="295">
          
          
          <code class="ruby">        username = u.phone_number</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="296">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="297">
          
          
          <code class="ruby">        # but some user may register using email instead phone number, so try to use it in third try</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="298">
          
          
          <code class="ruby">        if username.nil? || username == &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="299">
          
          
          <code class="ruby">          username = u.email</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="300">
          
          
          <code class="ruby">        end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="301">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="302">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="303">
          
          
          <code class="ruby">      qiscus_sdk.login_or_register_rest(u.qiscus_email, password, username, u.avatar_url) # will return sdk token when success</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="304">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="305">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="306">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="307">
          
          
          <code class="ruby">  # Update all avatar_url since it change to https</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="308">
          <span class="hits">2</span>
          
          <code class="ruby">  def self.update_all_avatar_url_to_https</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="309">
          
          
          <code class="ruby">    users = User.where(&#39;avatar_url LIKE ?&#39;, &#39;http://%&#39;)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="310">
          
          
          <code class="ruby">    users.each do | u |</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="311">
          
          
          <code class="ruby">      old_avatar_url = u.avatar_url</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="312">
          
          
          <code class="ruby">      size = old_avatar_url.size</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="313">
          
          
          <code class="ruby">      raw_avatar_url = old_avatar_url[7...size]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="314">
          
          
          <code class="ruby">      new_avatar_url = &quot;https://&quot; + raw_avatar_url;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="315">
          
          
          <code class="ruby">      u.update_attribute(:avatar_url, new_avatar_url)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="316">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="317">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="318">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="319">
          
          
          <code class="ruby">  # insert user country code, since country code store in  user</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="320">
          <span class="hits">2</span>
          
          <code class="ruby">  def self.insert_user_country_code</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="321">
          
          
          <code class="ruby">    users = User.all</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="322">
          
          
          <code class="ruby">    users.each do |u|</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="323">
          
          
          <code class="ruby">      if u.secondary_phone_number != &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="324">
          
          
          <code class="ruby">        country_code = u.secondary_phone_number.to_s.slice(0..2)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="325">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="326">
          
          
          <code class="ruby">        country_code = u.phone_number.to_s.slice(0..2)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="327">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="328">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="329">
          
          
          <code class="ruby">      u.update_attribute(:country_code, country_code)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="330">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="331">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="332">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="333">
          
          
          <code class="ruby">  # Update SDK profile if user change their fullname (sdk username) or avatar url</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="334">
          <span class="hits">2</span>
          
          <code class="ruby">  def update_sdk_profile</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="335">
          
          
          <code class="ruby">    if saved_change_to_attribute?(:fullname) || saved_change_to_attribute(:avatar_url)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="336">
          
          
          <code class="ruby">      # begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="337">
          
          
          <code class="ruby">        Rails.logger.debug &quot;Update SDK profile&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="338">
          
          
          <code class="ruby">        password = SecureRandom.hex # generate random password for security reason</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="339">
          
          
          <code class="ruby">        qiscus_sdk = QiscusSdk.new(application.app_id, application.qiscus_sdk_secret)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="340">
          
          
          <code class="ruby">        qiscus_sdk.login_or_register_rest(qiscus_email, password, fullname, avatar_url) # get qiscus token</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="341">
          
          
          <code class="ruby">      # rescue Exception =&gt; e</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="342">
          
          
          <code class="ruby">      #   message = &quot;Fail when call SDK in update user profile&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="343">
          
          
          <code class="ruby">      #   Raven.capture_message(message,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="344">
          
          
          <code class="ruby">      #     level: &quot;error&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="345">
          
          
          <code class="ruby">      #     extra: {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="346">
          
          
          <code class="ruby">      #       message: e.message</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="347">
          
          
          <code class="ruby">      #     }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="348">
          
          
          <code class="ruby">      #   )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="349">
          
          
          <code class="ruby">      # end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="350">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="351">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="352">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="353">
          
          
          <code class="ruby">  # because current avatar_url using transparent image</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="354">
          <span class="hits">2</span>
          
          <code class="ruby">  def self.update_user_avatar_url</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="355">
          
          
          <code class="ruby">    transparent_avatar_url = &quot;https://d1edrlpyc25xu0.cloudfront.net/kiwari-prod/image/upload/U6vHf34i6B/1510890598-ic_account_white_48dp.png&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="356">
          
          
          <code class="ruby">    new_avatar_url = &quot;https://d1edrlpyc25xu0.cloudfront.net/image/upload/t5XWp2PBRt/1510641299-default_user_avatar.png&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="357">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="358">
          
          
          <code class="ruby">    users = User.where(avatar_url: transparent_avatar_url)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="359">
          
          
          <code class="ruby">    users.each do | u |</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="360">
          
          
          <code class="ruby">      u.update_attribute(:avatar_url, new_avatar_url)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="361">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="362">
          
          
          <code class="ruby">      qiscus_sdk = QiscusSdk.new(u.application.app_id, u.application.qiscus_sdk_secret)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="363">
          
          
          <code class="ruby">      qiscus_sdk.update_profile(u.qiscus_email, u.fullname, u.avatar_url)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="364">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="365">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="366">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="367">
          
          
          <code class="ruby">  # Delete and update redis cache for conversation list to make all data sync after update</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="368">
          <span class="hits">2</span>
          
          <code class="ruby">  def update_redis_cache</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="369">
          <span class="hits">13</span>
          
          <code class="ruby">    chat_room_ids = ChatUser.where(user_id: id).pluck(:chat_room_id)</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="370">
          <span class="hits">13</span>
          
          <code class="ruby">    user_ids = ChatUser.where(&quot;chat_users.chat_room_id IN (?)&quot;, chat_room_ids).pluck(:user_id)</code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="371">
          <span class="hits">13</span>
          
          <code class="ruby">    user_ids = user_ids.uniq</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="372">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="13" data-linenumber="373">
          <span class="hits">13</span>
          
          <code class="ruby">    ChatRoomHelper.reset_chat_room_cache_for_users(user_ids)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="374">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="375">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="376">
          
          
          <code class="ruby">  # Background jobs to add contact automatically</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="377">
          <span class="hits">2</span>
          
          <code class="ruby">  def auto_add_contact</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="378">
          <span class="hits">5</span>
          
          <code class="ruby">    application = Application.find(application_id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="379">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="380">
          <span class="hits">5</span>
          
          <code class="ruby">    if application.is_auto_friend == true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="381">
          
          
          <code class="ruby">      users = application.users</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="382">
          
          
          <code class="ruby">      users = users.where.not(id: id) # exclude ownself to be added</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="383">
          
          
          <code class="ruby">      user_ids = users.pluck(:id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="384">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="385">
          
          
          <code class="ruby">      AutoAddContact.perform_later(user_ids, id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="386">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="387">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="388">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="389">
          
          
          <code class="ruby">  # Soft delete mechanism</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="390">
          <span class="hits">2</span>
          
          <code class="ruby">  def destroy</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="391">
          
          
          <code class="ruby">    unless self.deleted?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="392">
          
          
          <code class="ruby">      self.deleted = true</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="393">
          
          
          <code class="ruby">      self.deleted_at = Time.now</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="394">
          
          
          <code class="ruby">      if self.email.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="395">
          
          
          <code class="ruby">        email_local_part = self.email.split(&quot;@&quot;)[0]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="396">
          
          
          <code class="ruby">        email_domain = self.email.split(&quot;@&quot;)[1]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="397">
          
          
          <code class="ruby">        self.email = email_local_part.concat(&quot;_deleted_#{Time.now.to_i}_@&quot;).concat(email_domain)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="398">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="399">
          
          
          <code class="ruby">      self.phone_number += &quot;_deleted_#{Time.now.to_i}&quot; if self.phone_number.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="400">
          
          
          <code class="ruby">      self.save!</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="401">
          
          
          <code class="ruby">      update_redis_cache</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="402">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="403">
          
          
          <code class="ruby">      raise Exception.new(&quot;Already deleted&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="404">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="405">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="406">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="407">
          <span class="hits">2</span>
          
          <code class="ruby">  def restore</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="408">
          
          
          <code class="ruby">    if self.deleted?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="409">
          
          
          <code class="ruby">      self.deleted = false</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="410">
          
          
          <code class="ruby">      self.deleted_at = nil</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="411">
          
          
          <code class="ruby">      if self.email.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="412">
          
          
          <code class="ruby">        email_local_part = self.email.split(&quot;@&quot;)[0]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="413">
          
          
          <code class="ruby">        email_domain = self.email.split(&quot;@&quot;)[1]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="414">
          
          
          <code class="ruby">        email_local_part = email_local_part.split(&quot;_deleted&quot;)[0]</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="415">
          
          
          <code class="ruby">        self.email = email_local_part.concat(&quot;@&quot;).concat(email_domain)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="416">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="417">
          
          
          <code class="ruby">      self.phone_number = self.phone_number.split(&quot;_deleted&quot;)[0] if self.phone_number.present?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="418">
          
          
          <code class="ruby">      raise Exception.new(&quot;Another User already use same registration data&quot;) unless self.save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="419">
          
          
          <code class="ruby">    else</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="420">
          
          
          <code class="ruby">      raise Exception.new(&quot;Already restored&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="421">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="422">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="423">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="424">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="a41ca0f136c3c185a08e98ded8e137ed94d28d69">
  <div class="header">
    <h3>app/models/user_additional_info.rb</h3>
    <h4><span class="red">33.33 %</span> covered</h4>
    <div>
      <b>24</b> relevant lines. 
      <span class="green"><b>8</b> lines covered</span> and
      <span class="red"><b>16</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="2" data-linenumber="1">
          <span class="hits">2</span>
          
          <code class="ruby">class UserAdditionalInfo &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="2">
          <span class="hits">2</span>
          
          <code class="ruby">  validates :user_id, presence: true</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="3">
          <span class="hits">2</span>
          
          <code class="ruby">  validates :key, presence: true</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="4">
          <span class="hits">2</span>
          
          <code class="ruby">  validates :value, presence: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="6">
          <span class="hits">2</span>
          
          <code class="ruby">  belongs_to :user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="385" data-linenumber="8">
          <span class="hits">385</span>
          
          <code class="ruby">  default_scope { joins(:user)}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">  # Create user additional info</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="11">
          <span class="hits">2</span>
          
          <code class="ruby">  def self.create_or_update_user_additional_info(user_ids, additional_info_key, additional_info_value)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="12">
          
          
          <code class="ruby">    users = User.where(&quot;id IN (?)&quot;, user_ids)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="13">
          
          
          <code class="ruby">    users.each do | u |</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="14">
          
          
          <code class="ruby">      user_additional_info = UserAdditionalInfo.find_by(key: additional_info_key, user_id: u.id)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="16">
          
          
          <code class="ruby">      if user_additional_info.nil?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">        # create when value not exist</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="18">
          
          
          <code class="ruby">        user_additional_info = UserAdditionalInfo.new</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="19">
          
          
          <code class="ruby">        user_additional_info.key = additional_info_key</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="20">
          
          
          <code class="ruby">        user_additional_info.value = additional_info_value</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="21">
          
          
          <code class="ruby">        user_additional_info.user_id = u.id</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="22">
          
          
          <code class="ruby">        user_additional_info.save</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">      else</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">        # update when value was exist</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="25">
          
          
          <code class="ruby">        user_additional_info.update_attribute(:value, additional_info_value)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="30">
          <span class="hits">2</span>
          
          <code class="ruby">  def self.check_username(username=&quot;nil&quot;, leng=5)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="31">
          
          
          <code class="ruby">    response = {}</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="32">
          
          
          <code class="ruby">    if ((username.split(&quot;&quot;) - Bot.lowercase - Bot.numbers - Bot.symbols) == []) &amp;&amp; (username.split(&quot;&quot;).length &gt;= leng)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="33">
          
          
          <code class="ruby">      additional_info = UserAdditionalInfo.where(key: &quot;username&quot;, value: username).first</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="34">
          
          
          <code class="ruby">      if additional_info.nil?</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="35">
          
          
          <code class="ruby">        response[:success] = true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">      end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="38">
          
          
          <code class="ruby">    return response</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="bdcc2a080c9523b2ded2ceafb628565c098b9fe1">
  <div class="header">
    <h3>app/models/user_device_token.rb</h3>
    <h4><span class="red">77.78 %</span> covered</h4>
    <div>
      <b>9</b> relevant lines. 
      <span class="green"><b>7</b> lines covered</span> and
      <span class="red"><b>2</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">class UserDeviceToken &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="2">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :devicetoken, presence: true, :uniqueness =&gt; {:case_sensitive =&gt; false}</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :user_type, presence: true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  validates :user_id, presence: true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  belongs_to :user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="8">
          <span class="hits">4</span>
          
          <code class="ruby">  default_scope { joins(:user)}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  def as_json(options = {})</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="11">
          
          
          <code class="ruby">    h = super(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">      :except =&gt; [:user_id]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">    )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="15">
          
          
          <code class="ruby">    return h</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="9b3e4afd9ff1b5b751e6daaeb8aa146bfcbaa84e">
  <div class="header">
    <h3>app/models/user_role.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>10</b> relevant lines. 
      <span class="green"><b>10</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="2" data-linenumber="1">
          <span class="hits">2</span>
          
          <code class="ruby">class UserRole &lt; ActiveRecord::Base</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="2">
          <span class="hits">2</span>
          
          <code class="ruby">  belongs_to :user</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="3">
          <span class="hits">2</span>
          
          <code class="ruby">  belongs_to :role</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">  # Hooks</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">  # Update redis cache after create, update and delete</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">  # after save hooks will called both when Creating or Updating an Object</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">  # This should update cache after user removed or added to a chat room</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="9">
          <span class="hits">2</span>
          
          <code class="ruby">  after_save :update_redis_cache</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="10">
          <span class="hits">2</span>
          
          <code class="ruby">  after_destroy :update_redis_cache</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">  # Delete and update redis cache for conversation list to make all data sync after update</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="13">
          <span class="hits">2</span>
          
          <code class="ruby">  def update_redis_cache</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="14">
          <span class="hits">5</span>
          
          <code class="ruby">    chat_room_ids = ChatUser.where(user_id: user_id).pluck(:chat_room_id)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="15">
          <span class="hits">5</span>
          
          <code class="ruby">    user_ids = ChatUser.where(&quot;chat_users.chat_room_id IN (?)&quot;, chat_room_ids).pluck(:user_id)</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="16">
          <span class="hits">5</span>
          
          <code class="ruby">    user_ids = user_ids.uniq</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="18">
          <span class="hits">5</span>
          
          <code class="ruby">    ChatRoomHelper.reset_chat_room_cache_for_users(user_ids)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="a9177ca6145c6892baf98b5f7bb3c61a7a9186cb">
  <div class="header">
    <h3>app/validators/email_validator.rb</h3>
    <h4><span class="red">75.0 %</span> covered</h4>
    <div>
      <b>4</b> relevant lines. 
      <span class="green"><b>3</b> lines covered</span> and
      <span class="red"><b>1</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="2" data-linenumber="1">
          <span class="hits">2</span>
          
          <code class="ruby">class EmailValidator &lt; ActiveModel::EachValidator</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="2">
          <span class="hits">2</span>
          
          <code class="ruby">  def validate_each(record, attribute, value)</code>
        </li>
      
        <li class="covered" data-hits="15" data-linenumber="3">
          <span class="hits">15</span>
          
          <code class="ruby">    unless value =~ /\A([^@\s]+)@((?:[-a-z0-9]+\.)+[a-z]{2,})\z/i</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">      record.errors[attribute] &lt;&lt; (options[:message] || &quot;is not an email&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="161f6206fd712bae1eb47782303552fefafe8d4e">
  <div class="header">
    <h3>app/validators/spaces_only_validator.rb</h3>
    <h4><span class="red">75.0 %</span> covered</h4>
    <div>
      <b>4</b> relevant lines. 
      <span class="green"><b>3</b> lines covered</span> and
      <span class="red"><b>1</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="2" data-linenumber="1">
          <span class="hits">2</span>
          
          <code class="ruby">class SpacesOnlyValidator &lt; ActiveModel::EachValidator</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="2">
          <span class="hits">2</span>
          
          <code class="ruby">  def validate_each(record, attribute, value)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="3">
          
          
          <code class="ruby">    # if value is not just spaces</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="4">
          <span class="hits">5</span>
          
          <code class="ruby">    unless value.gsub(/\A\p{Space}*/, &#39;&#39;).strip() != &quot;&quot;</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">      record.errors[attribute] &lt;&lt; (options[:message] || &quot;is just blank spaces.&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="e18f249bcf9729e76c3ef2ebf58416b5929acad1">
  <div class="header">
    <h3>app/validators/url_validator.rb</h3>
    <h4><span class="red">28.57 %</span> covered</h4>
    <div>
      <b>7</b> relevant lines. 
      <span class="green"><b>2</b> lines covered</span> and
      <span class="red"><b>5</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="2" data-linenumber="1">
          <span class="hits">2</span>
          
          <code class="ruby">class UrlValidator &lt; ActiveModel::EachValidator</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="3">
          <span class="hits">2</span>
          
          <code class="ruby">  def validate_each(record, attribute, value)</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="4">
          
          
          <code class="ruby">    valid = begin</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="5">
          
          
          <code class="ruby">      URI.parse(value).kind_of?(URI::HTTP)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">    rescue URI::InvalidURIError</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="7">
          
          
          <code class="ruby">      false</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="9">
          
          
          <code class="ruby">    unless valid</code>
        </li>
      
        <li class="missed" data-hits="0" data-linenumber="10">
          
          
          <code class="ruby">      record.errors[attribute] &lt;&lt; (options[:message] || &quot;is an invalid URL&quot;)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">    end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="a4b279ad4df13e6920549e503f71707722dc2205">
  <div class="header">
    <h3>test/integration/api/v1/auth_test.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>84</b> relevant lines. 
      <span class="green"><b>84</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;test_helper&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">class API::V1::AuthTest&lt; ActionDispatch::IntegrationTest</code>
        </li>
      
        <li class="covered" data-hits="11" data-linenumber="4">
          <span class="hits">11</span>
          
          <code class="ruby">  setup { host! &#39;api.example.com&#39; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;attempt to login or register with invalid app_id&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">    application = applications(:qisme)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">    post &quot;/api/v1/auth&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">      params: {:user=&gt; {:app_id =&gt; application.app_id+&quot;wrong&quot;}}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 404, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal Mime[:json], response.content_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal &#39;Application id is not found.&#39;, response_data[&#39;error&#39;][&#39;message&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;attempt to login or register with empty phone_number&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">    application = applications(:qisme)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">    post &quot;/api/v1/auth&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">      params: {:user=&gt; {:app_id =&gt; application.app_id,:phone_number =&gt; &quot;&quot;}},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">      headers: {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 422, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal Mime[:json], response.content_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal &#39;Phone number is empty.&#39;, response_data[&#39;error&#39;][&#39;message&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;success to login&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">    application = applications(:qisme)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="33">
          <span class="hits">1</span>
          
          <code class="ruby">    user = users(:user1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">    </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="35">
          <span class="hits">1</span>
          
          <code class="ruby">    SmsVerification.expects(:request)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">    </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="37">
          <span class="hits">1</span>
          
          <code class="ruby">    qiscus_sdk = mock()</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="38">
          <span class="hits">1</span>
          
          <code class="ruby">    qiscus_sdk.expects(:login_or_register).returns(&#39;qiscus-token&#39;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="39">
          <span class="hits">1</span>
          
          <code class="ruby">    QiscusSdk.expects(:new).returns(qiscus_sdk)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="41">
          <span class="hits">1</span>
          
          <code class="ruby">    post &quot;/api/v1/auth&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">      params: {:user=&gt; {:app_id =&gt; application.app_id,:phone_number =&gt; user.phone_number}},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">      headers: {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="45">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 200, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="46">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal Mime[:json], response.content_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="48">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="51">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;success to register&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="52">
          <span class="hits">1</span>
          
          <code class="ruby">    application = applications(:qisme)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="54">
          <span class="hits">1</span>
          
          <code class="ruby">    qiscus_sdk = mock()</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="55">
          <span class="hits">1</span>
          
          <code class="ruby">    qiscus_sdk.expects(:login_or_register).returns(&#39;qiscus-token&#39;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="56">
          <span class="hits">1</span>
          
          <code class="ruby">    QiscusSdk.expects(:new).returns(qiscus_sdk)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">    </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="58">
          <span class="hits">1</span>
          
          <code class="ruby">    SmsVerification.expects(:request)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="60">
          <span class="hits">1</span>
          
          <code class="ruby">    post &quot;/api/v1/auth&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">      params: {:user=&gt; {:app_id =&gt; application.app_id,:phone_number =&gt; &quot;+6289987654321&quot;}},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">      headers: {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="64">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 200, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="65">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal Mime[:json], response.content_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="67">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="70">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;attempt to resend passcode with invalid app_id&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="71">
          <span class="hits">1</span>
          
          <code class="ruby">    application = applications(:qisme)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="72">
          <span class="hits">1</span>
          
          <code class="ruby">    user = users(:user1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="74">
          <span class="hits">1</span>
          
          <code class="ruby">    post &quot;/api/v1/auth/resend_passcode&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">      params: {:user=&gt; {:app_id =&gt; application.app_id+&quot;wrong&quot;}},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">      headers: {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="78">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 404, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="79">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal Mime[:json], response.content_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="81">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="82">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal &#39;Application id is not found.&#39;, response_data[&#39;error&#39;][&#39;message&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="85">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;attempt to resend passcode with invalid phone_number&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="86">
          <span class="hits">1</span>
          
          <code class="ruby">    application = applications(:qisme)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="87">
          <span class="hits">1</span>
          
          <code class="ruby">    user = users(:user1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="89">
          <span class="hits">1</span>
          
          <code class="ruby">    post &quot;/api/v1/auth/resend_passcode&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">      params: {:user=&gt; {:app_id =&gt; application.app_id,:phone_number =&gt; user.phone_number+&quot;0&quot;}},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">      headers: {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="93">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 404, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="94">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal Mime[:json], response.content_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="96">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="97">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal &#39;Can\&#39;t find user.&#39;, response_data[&#39;error&#39;][&#39;message&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="100">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;success to resend passcode&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="101">
          <span class="hits">1</span>
          
          <code class="ruby">    application = applications(:qisme)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="102">
          <span class="hits">1</span>
          
          <code class="ruby">    user = users(:user1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="104">
          <span class="hits">1</span>
          
          <code class="ruby">    SmsVerification.expects(:request)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="106">
          <span class="hits">1</span>
          
          <code class="ruby">    post &quot;/api/v1/auth/resend_passcode&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">      params: {:user=&gt; {:app_id =&gt; application.app_id,:phone_number =&gt; user.phone_number}},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby">      headers: {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="110">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 200, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="111">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal Mime[:json], response.content_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="115">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;attempt to verify with invalid app_id&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="116">
          <span class="hits">1</span>
          
          <code class="ruby">    application = applications(:qisme)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="117">
          <span class="hits">1</span>
          
          <code class="ruby">    user = users(:user1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="119">
          <span class="hits">1</span>
          
          <code class="ruby">    post &quot;/api/v1/auth/verify&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby">      params: {:user=&gt; {:app_id =&gt; application.app_id+&quot;wrong&quot;}},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby">      headers: {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="123">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 404, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="124">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal Mime[:json], response.content_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="126">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="127">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal &#39;Application id is not found.&#39;, response_data[&#39;error&#39;][&#39;message&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="130">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;attempt to verify with invalid passcode&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="131">
          <span class="hits">1</span>
          
          <code class="ruby">    application = applications(:qisme)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="132">
          <span class="hits">1</span>
          
          <code class="ruby">    user = users(:user1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="134">
          <span class="hits">1</span>
          
          <code class="ruby">    post &quot;/api/v1/auth/verify&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby">      params: {:user=&gt; {:app_id =&gt; application.app_id, :phone_number =&gt; user.phone_number, :passcode =&gt; &#39;9999&#39;}},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="136">
          
          
          <code class="ruby">      headers: {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="138">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 404, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="139">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal Mime[:json], response.content_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="141">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="142">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal &#39;Can\&#39;t find user or wrong passcode.&#39;, response_data[&#39;error&#39;][&#39;message&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="145">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;success to verify user with valid passcode&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="146">
          <span class="hits">1</span>
          
          <code class="ruby">    application = applications(:qisme)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="147">
          <span class="hits">1</span>
          
          <code class="ruby">    user = users(:user1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="149">
          <span class="hits">1</span>
          
          <code class="ruby">    ApplicationHelper.expects(:create_jwt_token)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="150">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="151">
          <span class="hits">1</span>
          
          <code class="ruby">    post &quot;/api/v1/auth/verify&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby">      params: {:user=&gt; {:app_id =&gt; application.app_id, :phone_number =&gt; user.phone_number, :passcode =&gt; user.passcode}},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby">      headers: {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="154">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="155">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 200, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="156">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal Mime[:json], response.content_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="157">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="158">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="a252bd6a8b6bb4eaab1928b357e246cc8625d310">
  <div class="header">
    <h3>test/integration/api/v1/calls_test.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>122</b> relevant lines. 
      <span class="green"><b>122</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;test_helper&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">class API::V1::CallsTest &lt; ActionDispatch::IntegrationTest</code>
        </li>
      
        <li class="covered" data-hits="17" data-linenumber="4">
          <span class="hits">17</span>
          
          <code class="ruby">  setup { host! &#39;api.example.com&#39; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">  # list of user call logs</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;user1 attempt to get list of call_logs without access_token&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">    get &quot;/api/v1/calls&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">      headers: {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 401, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal Mime[:json], response.content_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal &#39;Unauthorized Access&#39;, response_data[&#39;error&#39;][&#39;message&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;user1 attempt to get list of call_logs, success&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">    session1 = auth_sessions(:user1_session1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">    get &quot;/api/v1/calls&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session1.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 200, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal Mime[:json], response.content_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal &#39;Heru&#39;, response_data[&#39;data&#39;][0][&#39;caller_user&#39;][&#39;fullname&#39;]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal &#39;Setiawan&#39;, response_data[&#39;data&#39;][0][&#39;callee_user&#39;][&#39;fullname&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">  # post system event message</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="33">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;Unauthorized user attempt to post call system event message&quot; do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="35">
          <span class="hits">1</span>
          
          <code class="ruby">    body = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">      :user_email =&gt; &#39;userid_2_6285643123456@qisme.com&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">      :user_type =&gt; &#39;callee&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby">      :call_room_id =&gt; 212,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">      :is_video =&gt; false,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">      :call_event =&gt; &#39;incoming&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="43">
          <span class="hits">1</span>
          
          <code class="ruby">    post &quot;/api/v1/calls&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">      params: body,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">      headers: {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="47">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 401, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="48">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal Mime[:json], response.content_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="51">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;user1 attempt to post call system event message without parameter user_email&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="52">
          <span class="hits">1</span>
          
          <code class="ruby">    session1 = auth_sessions(:user1_session1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="54">
          <span class="hits">1</span>
          
          <code class="ruby">    body = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">      :user_email =&gt; &#39;&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">      :user_type =&gt; &#39;callee&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">      :call_room_id =&gt; 212,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">      :is_video =&gt; false,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">      :call_event =&gt; &#39;incoming&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="62">
          <span class="hits">1</span>
          
          <code class="ruby">    post &quot;/api/v1/calls&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">      params: body,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session1.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="66">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 422, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="67">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal Mime[:json], response.content_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="69">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="70">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal &#39;user_email cannot be empty.&#39;, response_data[&#39;error&#39;][&#39;message&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="73">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;user1 attempt to post call system event message without parameter user_type&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="74">
          <span class="hits">1</span>
          
          <code class="ruby">    session1 = auth_sessions(:user1_session1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="76">
          <span class="hits">1</span>
          
          <code class="ruby">    body = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">      :user_email =&gt; &#39;userid_2_6285643123456@qisme.com&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">      :user_type =&gt; &#39;&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">      :call_room_id =&gt; 212,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">      :is_video =&gt; false,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">      :call_event =&gt; &#39;incoming&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="84">
          <span class="hits">1</span>
          
          <code class="ruby">    post &quot;/api/v1/calls&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">      params: body,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session1.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="88">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 422, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="89">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal Mime[:json], response.content_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="91">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="92">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal &quot;user_type can&#39;t be empty.&quot;, response_data[&#39;error&#39;][&#39;message&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="95">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;user1 attempt to post call system event message without parameter call_room_id&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="96">
          <span class="hits">1</span>
          
          <code class="ruby">    session1 = auth_sessions(:user1_session1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="98">
          <span class="hits">1</span>
          
          <code class="ruby">    body = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">      :user_email =&gt; &#39;userid_2_6285643123456@qisme.com&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby">      :user_type =&gt; &#39;callee&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">      :call_room_id =&gt; nil,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">      :is_video =&gt; false,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby">      :call_event =&gt; &#39;incoming&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="106">
          <span class="hits">1</span>
          
          <code class="ruby">    post &quot;/api/v1/calls&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">      params: body,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session1.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="110">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 422, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="111">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal Mime[:json], response.content_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="113">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="114">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal &quot;call_room_id cannot be empty.&quot;, response_data[&#39;error&#39;][&#39;message&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="117">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;user1 attempt to post call system event message without parameter is_video&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="118">
          <span class="hits">1</span>
          
          <code class="ruby">    session1 = auth_sessions(:user1_session1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="120">
          <span class="hits">1</span>
          
          <code class="ruby">    body = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby">      :user_email =&gt; &#39;userid_2_6285643123456@qisme.com&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby">      :user_type =&gt; &#39;callee&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby">      :call_room_id =&gt; 54321,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">      :is_video =&gt; nil,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby">      :call_event =&gt; &#39;incoming&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="127">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="128">
          <span class="hits">1</span>
          
          <code class="ruby">    post &quot;/api/v1/calls&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby">      params: body,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="130">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session1.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="132">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 422, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="133">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal Mime[:json], response.content_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="135">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="136">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal &quot;is_video can&#39;t be empty.&quot;, response_data[&#39;error&#39;][&#39;message&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="137">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="139">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;user1 attempt to post call system event message without parameter call_event&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="140">
          <span class="hits">1</span>
          
          <code class="ruby">    session1 = auth_sessions(:user1_session1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="142">
          <span class="hits">1</span>
          
          <code class="ruby">    body = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby">      :user_email =&gt; &#39;userid_2_6285643123456@qisme.com&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby">      :user_type =&gt; &#39;callee&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby">      :call_room_id =&gt; 54321,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby">      :is_video =&gt; false,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby">      :call_event =&gt; &#39;&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="149">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="150">
          <span class="hits">1</span>
          
          <code class="ruby">    post &quot;/api/v1/calls&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby">      params: body,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session1.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="154">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 422, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="155">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal Mime[:json], response.content_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="156">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="157">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="158">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal &quot;Call event can&#39;t be empty.&quot;, response_data[&#39;error&#39;][&#39;message&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="160">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="161">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;user1 attempt to post call system event message, success&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="162">
          <span class="hits">1</span>
          
          <code class="ruby">    session1 = auth_sessions(:user1_session1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="164">
          <span class="hits">1</span>
          
          <code class="ruby">    body = {</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="165">
          
          
          <code class="ruby">      :user_email =&gt; &#39;userid_2_6285643123456@qisme.com&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="166">
          
          
          <code class="ruby">      :user_type =&gt; &#39;callee&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="167">
          
          
          <code class="ruby">      :call_room_id =&gt; 212,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="168">
          
          
          <code class="ruby">      :is_video =&gt; false,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="169">
          
          
          <code class="ruby">      :call_event =&gt; &#39;incoming&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="170">
          
          
          <code class="ruby">    }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="171">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="172">
          
          
          <code class="ruby">    # mock QiscusSdk#post_system_event_message</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="173">
          <span class="hits">1</span>
          
          <code class="ruby">    qiscus_sdk = mock(&#39;object&#39;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="174">
          <span class="hits">1</span>
          
          <code class="ruby">    qiscus_sdk.expects(:post_system_event_message).returns([200, {}])</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="175">
          <span class="hits">1</span>
          
          <code class="ruby">    QiscusSdk.expects(:new).returns(qiscus_sdk)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="176">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="177">
          <span class="hits">1</span>
          
          <code class="ruby">    post &quot;/api/v1/calls&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="178">
          
          
          <code class="ruby">      params: body,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="179">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session1.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="180">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="181">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 200, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="182">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal Mime[:json], response.content_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="183">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="184">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="185">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal &#39;call&#39;, response_data[&#39;data&#39;][&#39;system_event_type&#39;]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="186">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal &#39;Heru&#39;, response_data[&#39;data&#39;][&#39;caller_user&#39;][&#39;fullname&#39;]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="187">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal &#39;Setiawan&#39;, response_data[&#39;data&#39;][&#39;callee_user&#39;][&#39;fullname&#39;]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="188">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal &#39;Heru call Setiawan&#39;, response_data[&#39;data&#39;][&#39;message&#39;]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="189">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal &#39;incoming&#39;, response_data[&#39;data&#39;][&#39;call_event&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="190">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="191">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="192">
          
          
          <code class="ruby">  #admin list of user call logs</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="193">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;non admin user attempt to get list of call_logs admin level&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="194">
          <span class="hits">1</span>
          
          <code class="ruby">    session2 = auth_sessions(:user2_session2)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="195">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="196">
          <span class="hits">1</span>
          
          <code class="ruby">    get &quot;/api/v1/admin/calls&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="197">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session2.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="198">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="199">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 401, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="200">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal Mime[:json], response.content_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="201">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="202">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="203">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal &#39;Unauthorized Access. User is not admin.&#39;, response_data[&#39;error&#39;][&#39;message&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="204">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="205">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="206">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;Unauthorized user attempt to get list of call_logs admin level&quot; do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="207">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="208">
          <span class="hits">1</span>
          
          <code class="ruby">    get &quot;/api/v1/admin/calls&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="209">
          
          
          <code class="ruby">      headers: {}</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="210">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="211">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 401, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="212">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal Mime[:json], response.content_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="213">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="214">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="215">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal &#39;Unauthorized Access&#39;, response_data[&#39;error&#39;][&#39;message&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="216">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="217">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="218">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;admin attempt to get list of call_logs admin level, success&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="219">
          <span class="hits">1</span>
          
          <code class="ruby">    session1 = auth_sessions(:user1_session1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="220">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="221">
          <span class="hits">1</span>
          
          <code class="ruby">    get &quot;/api/v1/admin/calls&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="222">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session1.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="223">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="224">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 200, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="225">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal Mime[:json], response.content_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="226">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="227">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="228">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 4, response_data[&#39;meta&#39;][&#39;total&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="229">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="230">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="231">
          <span class="hits">1</span>
          
          <code class="ruby">	test &quot;admin attempt to get list of call_logs admin level by date range, success&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="232">
          <span class="hits">1</span>
          
          <code class="ruby">    session1 = auth_sessions(:user1_session1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="233">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="234">
          <span class="hits">1</span>
          
          <code class="ruby">    get &quot;/api/v1/admin/calls/?start_date=2018-03-28&amp;end_date=2018-03-28&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="235">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session1.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="236">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="237">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 200, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="238">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal Mime[:json], response.content_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="239">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="240">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="241">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 2, response_data[&#39;meta&#39;][&#39;total&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="242">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="243">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="244">
          <span class="hits">1</span>
          
          <code class="ruby">	test &quot;user, Heru, attempt to get list of call_logs by date range, success&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="245">
          <span class="hits">1</span>
          
          <code class="ruby">    session1 = auth_sessions(:user1_session1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="246">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="247">
          <span class="hits">1</span>
          
          <code class="ruby">    get &quot;/api/v1/calls/?start_date=2018-03-28&amp;end_date=2018-03-28&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="248">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session1.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="249">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="250">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 200, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="251">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal Mime[:json], response.content_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="252">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="253">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="254">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 2, response_data[&#39;meta&#39;][&#39;total&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="255">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="256">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="257">
          <span class="hits">1</span>
          
          <code class="ruby">	test &quot;user, Heru, attempt to get list of call_logs with only start date, success but not filter by date&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="258">
          <span class="hits">1</span>
          
          <code class="ruby">    session1 = auth_sessions(:user1_session1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="259">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="260">
          <span class="hits">1</span>
          
          <code class="ruby">    get &quot;/api/v1/calls/?start_date=2018-03-28&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="261">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session1.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="262">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="263">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 200, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="264">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal Mime[:json], response.content_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="265">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="266">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="267">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 4, response_data[&#39;meta&#39;][&#39;total&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="268">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="269">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="270">
          <span class="hits">1</span>
          
          <code class="ruby">	test &quot;user, Heru, attempt to get list of call_logs without auth, fail&quot; do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="271">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="272">
          <span class="hits">1</span>
          
          <code class="ruby">    get &quot;/api/v1/calls/?start_date=2018-03-28&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="273">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="274">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 401, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="275">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal Mime[:json], response.content_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="276">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="277">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="21fffdf1488c96270ec66b42701ff6af52e770b5">
  <div class="header">
    <h3>test/integration/api/v1/chat/admins_test.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>50</b> relevant lines. 
      <span class="green"><b>50</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;test_helper&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">class API::V1::Chat::AdminsTest &lt; ActionDispatch::IntegrationTest</code>
        </li>
      
        <li class="covered" data-hits="5" data-linenumber="4">
          <span class="hits">5</span>
          
          <code class="ruby">  setup { host! &#39;api.example.com&#39; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;admin candidates must be member of group&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">    session1 = auth_sessions(:user1_session1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">    user3 = users(:user3)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">    qiscus_room_id = &quot;2&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">    user_id = [user3.id]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">    post &quot;/api/v1/chat/conversations/#{qiscus_room_id}/admins&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">      params: {:user_id=&gt; user_id},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session1.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 422, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal &#39;You are not member of this group.&#39;, response_data[&#39;error&#39;][&#39;message&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;not admin user attempt to add admin&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">    session2 = auth_sessions(:user2_session2)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">    user4 = users(:user4)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">    qiscus_room_id = &quot;2&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">    user_id = [user4.id]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">    post &quot;/api/v1/chat/conversations/#{qiscus_room_id}/admins&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">      params: {:user_id=&gt; user_id},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session2.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 422, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="33">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal &#39;You are not admin of this group. Only admin can add new group admin.&#39;, response_data[&#39;error&#39;][&#39;message&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="36">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;user attempt to add admin without input user_id&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="37">
          <span class="hits">1</span>
          
          <code class="ruby">    session3 = auth_sessions(:user3_session3)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="38">
          <span class="hits">1</span>
          
          <code class="ruby">    qiscus_room_id = &quot;2&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="40">
          <span class="hits">1</span>
          
          <code class="ruby">    post &quot;/api/v1/chat/conversations/#{qiscus_room_id}/admins&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">      params: {:user_id=&gt; nil},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session3.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="44">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 422, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="45">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="46">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal &#39;Array of user id or qiscus email must be present.&#39;, response_data[&#39;error&#39;][&#39;message&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="49">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;user1 create group chat with valid target_user_id then add admin&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="50">
          <span class="hits">1</span>
          
          <code class="ruby">    session = auth_sessions(:user1_session1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="51">
          <span class="hits">1</span>
          
          <code class="ruby">    user1 = users(:user1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="52">
          <span class="hits">1</span>
          
          <code class="ruby">    user2 = users(:user2)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="53">
          <span class="hits">1</span>
          
          <code class="ruby">    target = [user2.id]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">    # mock QiscusSdk#post_system_event_message</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="56">
          <span class="hits">1</span>
          
          <code class="ruby">    qiscus_sdk = mock(&#39;object&#39;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="57">
          <span class="hits">1</span>
          
          <code class="ruby">    qiscus_sdk.expects(:post_system_event_message).returns([200, {}])</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="58">
          <span class="hits">1</span>
          
          <code class="ruby">    QiscusSdk.expects(:new).returns(qiscus_sdk)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="60">
          <span class="hits">1</span>
          
          <code class="ruby">    post &#39;/api/v1/chat/conversations/group_chat&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">      params: {:target_user_id=&gt; target, :qiscus_room_id =&gt; &#39;456&#39;},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="64">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="66">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal user1.fullname, response_data[&#39;data&#39;][&#39;creator&#39;][&#39;fullname&#39;] # ensure creator user</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="67">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal user2.fullname, response_data[&#39;data&#39;][&#39;users&#39;][1][&#39;fullname&#39;] # ensure target user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">    # Ensure that user1 and user2 are group participants</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="70">
          <span class="hits">1</span>
          
          <code class="ruby">    get &#39;/api/v1/chat/conversations/456/participants&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby">      params: {:target_user_id=&gt; target, :qiscus_room_id =&gt; &#39;456&#39;},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="74">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="76">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal user1.fullname, response_data[&#39;data&#39;][0][&#39;fullname&#39;]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="77">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal user2.fullname, response_data[&#39;data&#39;][1][&#39;fullname&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">    # mock QiscusSdk#post_system_event_message</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="80">
          <span class="hits">1</span>
          
          <code class="ruby">    qiscus_sdk.expects(:post_system_event_message).returns([200, {}])</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="81">
          <span class="hits">1</span>
          
          <code class="ruby">    QiscusSdk.expects(:new).returns(qiscus_sdk)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">    # user1 add user2 as admin</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="84">
          <span class="hits">1</span>
          
          <code class="ruby">    post &#39;/api/v1/chat/conversations/456/admins&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">      params: {:user_id =&gt; [user2.id], :qiscus_room_id =&gt; &#39;456&#39;},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="88">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 200, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="89">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="90">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal user2.fullname, response_data[&#39;data&#39;][0][&#39;fullname&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="77426e500b4bf2969feee552a4d118361ff44c60">
  <div class="header">
    <h3>test/integration/api/v1/chat/conversations/participants_test.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>45</b> relevant lines. 
      <span class="green"><b>45</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;test_helper&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">class API::V1::Chat::Conversations::ParticipansTest &lt; ActionDispatch::IntegrationTest</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="4">
          <span class="hits">3</span>
          
          <code class="ruby">  setup { host! &#39;api.example.com&#39; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;user1 create group chat with valid target_user_id then add participants&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">    session = auth_sessions(:user1_session1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">    user1 = users(:user1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">    user2 = users(:user2)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">    user3 = users(:user3)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">    target = [user2.id] </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">    # mock QiscusSdk#post_system_event_message</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">    qiscus_sdk = mock(&#39;object&#39;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">    qiscus_sdk.expects(:post_system_event_message).returns([200, {}])</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">    QiscusSdk.expects(:new).returns(qiscus_sdk)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">    post &#39;/api/v1/chat/conversations/group_chat&#39;, </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">      params: {:target_user_id=&gt; target, :qiscus_room_id =&gt; &#39;456&#39;},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal user1.fullname, response_data[&#39;data&#39;][&#39;creator&#39;][&#39;fullname&#39;] # ensure creator user</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal user2.fullname, response_data[&#39;data&#39;][&#39;users&#39;][1][&#39;fullname&#39;] # ensure target user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">    # Ensure that user1 and user2 are group participants</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">    get &#39;/api/v1/chat/conversations/456/participants&#39;, </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">      params: {:target_user_id=&gt; target, :qiscus_room_id =&gt; &#39;456&#39;},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal user1.fullname, response_data[&#39;data&#39;][0][&#39;fullname&#39;] </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="35">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal user2.fullname, response_data[&#39;data&#39;][1][&#39;fullname&#39;] </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">    # Then user1 add user3 as participants</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="38">
          <span class="hits">1</span>
          
          <code class="ruby">    qiscus_sdk = mock()</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="39">
          <span class="hits">1</span>
          
          <code class="ruby">    qiscus_sdk.expects(:add_room_participants)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">    # qiscus_sdk.expects(:post_comment)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="41">
          <span class="hits">1</span>
          
          <code class="ruby">    QiscusSdk.expects(:new).returns(qiscus_sdk)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">    # mock QiscusSdk#post_system_event_message</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="44">
          <span class="hits">1</span>
          
          <code class="ruby">    qiscus_sdk.expects(:post_system_event_message).returns([200, {}])</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="45">
          <span class="hits">1</span>
          
          <code class="ruby">    QiscusSdk.expects(:new).returns(qiscus_sdk)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="48">
          <span class="hits">1</span>
          
          <code class="ruby">    post &#39;/api/v1/chat/conversations/456/participants&#39;, </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">      params: {:user_id =&gt; [user3.id], :qiscus_room_id =&gt; &#39;456&#39;},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="52">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="53">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal user3.fullname, response_data[&#39;data&#39;][&#39;users&#39;][2][&#39;fullname&#39;] </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="56">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;user1 create group chat with valid target_user_id then delete participants&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="57">
          <span class="hits">1</span>
          
          <code class="ruby">    session = auth_sessions(:user1_session1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="58">
          <span class="hits">1</span>
          
          <code class="ruby">    user1 = users(:user1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="59">
          <span class="hits">1</span>
          
          <code class="ruby">    user2 = users(:user2)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="60">
          <span class="hits">1</span>
          
          <code class="ruby">    user3 = users(:user3)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="61">
          <span class="hits">1</span>
          
          <code class="ruby">    target = [user2.id, user3.id] </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">    # mock QiscusSdk#post_system_event_message</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="64">
          <span class="hits">1</span>
          
          <code class="ruby">    qiscus_sdk = mock(&#39;object&#39;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="65">
          <span class="hits">1</span>
          
          <code class="ruby">    qiscus_sdk.expects(:post_system_event_message).returns([200, {}])</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="66">
          <span class="hits">1</span>
          
          <code class="ruby">    QiscusSdk.expects(:new).returns(qiscus_sdk)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="68">
          <span class="hits">1</span>
          
          <code class="ruby">    post &#39;/api/v1/chat/conversations/group_chat&#39;, </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby">      params: {:target_user_id=&gt; target, :qiscus_room_id =&gt; &#39;456&#39;},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">    # Then user1 attempt to delete participant </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="73">
          <span class="hits">1</span>
          
          <code class="ruby">    qiscus_sdk = mock()</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby">    # mock QiscusSdk#post_system_event_message</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="75">
          <span class="hits">1</span>
          
          <code class="ruby">    qiscus_sdk.expects(:post_system_event_message).returns([200, {}])</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="77">
          <span class="hits">1</span>
          
          <code class="ruby">    qiscus_sdk.expects(:remove_room_participants).returns([200, {}])</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="78">
          <span class="hits">1</span>
          
          <code class="ruby">    QiscusSdk.expects(:new).returns(qiscus_sdk)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="80">
          <span class="hits">1</span>
          
          <code class="ruby">    delete &#39;/api/v1/chat/conversations/456/participants&#39;, </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">      params: {:user_id =&gt; [user2.id], :qiscus_room_id =&gt; &#39;456&#39;},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="84">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="85">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal user3.fullname, response_data[&#39;data&#39;][&#39;users&#39;][1][&#39;fullname&#39;] </code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="342cca6db48743684bf85be81a346808eb65d537">
  <div class="header">
    <h3>test/integration/api/v1/chat/conversations_test.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>97</b> relevant lines. 
      <span class="green"><b>97</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;test_helper&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">class API::V1::Chat::ConversationsTest &lt; ActionDispatch::IntegrationTest</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="4">
          <span class="hits">12</span>
          
          <code class="ruby">  setup { host! &#39;api.example.com&#39; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;conversation list should not be empty&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">    session = auth_sessions(:user1_session1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">    # mock QiscusSdk#get_rooms_info</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">    qiscus_sdk = mock(&#39;object&#39;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">    qiscus_sdk.expects(:get_rooms_info).returns([200, {}])</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">    QiscusSdk.expects(:new).returns(qiscus_sdk)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">    # Please note that this may return data from redis cache in second call and expires in certain time</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">    get &#39;/api/v1/chat/conversations&#39;, params: {},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 200, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal Mime[:json], response.content_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_not_equal [], response_data[&#39;data&#39;].to_a # should not empty chat room</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal response_data[&#39;meta&#39;][&#39;total&#39;], response_data[&#39;data&#39;].to_a.count # meta and data is must the same</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;user1 create single chat with blank target user id&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">    session = auth_sessions(:user1_session1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">    post &#39;/api/v1/chat/conversations&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">      params: {:target_user_id=&gt; &#39;&#39;}, # blank target_user_id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="33">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal &#39;Target user id can not be blank.&#39;, response_data[&#39;error&#39;][&#39;message&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="37">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;user1 create single chat with user1&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="38">
          <span class="hits">1</span>
          
          <code class="ruby">    session = auth_sessions(:user1_session1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="39">
          <span class="hits">1</span>
          
          <code class="ruby">    user1 = users(:user1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="41">
          <span class="hits">1</span>
          
          <code class="ruby">    post &#39;/api/v1/chat/conversations&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">      params: {:target_user_id=&gt; user1.id}, # user1 is creator and target</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="45">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="46">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal &#39;You can not chat only with yourself.&#39;, response_data[&#39;error&#39;][&#39;message&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="49">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;user1 create single chat with user2 but with empty qiscus_room_id&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="50">
          <span class="hits">1</span>
          
          <code class="ruby">    session = auth_sessions(:user1_session1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="51">
          <span class="hits">1</span>
          
          <code class="ruby">    user2 = users(:user2)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="53">
          <span class="hits">1</span>
          
          <code class="ruby">    post &#39;/api/v1/chat/conversations&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">      params: {:target_user_id=&gt; user2.id},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="57">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">    # assert_equal &#39;Qiscus room id can not be blank.&#39;, response_data[&#39;error&#39;][&#39;message&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="61">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;user1 create single chat with user2 and valid params&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="62">
          <span class="hits">1</span>
          
          <code class="ruby">    session = auth_sessions(:user1_session1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="63">
          <span class="hits">1</span>
          
          <code class="ruby">    user1 = users(:user1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="64">
          <span class="hits">1</span>
          
          <code class="ruby">    user2 = users(:user2)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">    # mock QiscusSdk#rest_get_or_create_room_with_target</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="67">
          <span class="hits">1</span>
          
          <code class="ruby">    qiscus_sdk = mock(&#39;object&#39;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="68">
          <span class="hits">1</span>
          
          <code class="ruby">    qiscus_sdk.expects(:get_or_create_room_with_target_rest).returns([200, {}])</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="69">
          <span class="hits">1</span>
          
          <code class="ruby">    QiscusSdk.expects(:new).returns(qiscus_sdk)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="71">
          <span class="hits">1</span>
          
          <code class="ruby">    post &#39;/api/v1/chat/conversations&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">      params: {:target_user_id=&gt; user2.id, :qiscus_room_id =&gt; &#39;123&#39;},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="75">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">    # Ensure user1 is creator</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">    # assert_equal  user1.fullname, response_data[&#39;data&#39;][&#39;creator&#39;][&#39;fullname&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby">    # Ensure user2 is target</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">    # assert_equal  user2.fullname, response_data[&#39;data&#39;][&#39;target&#39;][&#39;fullname&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="84">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;user1 create group chat with target_user not in array&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="85">
          <span class="hits">1</span>
          
          <code class="ruby">    session = auth_sessions(:user1_session1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="87">
          <span class="hits">1</span>
          
          <code class="ruby">    post &#39;/api/v1/chat/conversations/group_chat&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">      params: {:target_user_id=&gt; &#39;&#39;}, # Target_user_id not in array</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="91">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="92">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal  &#39;Target user id must be an array of user id.&#39;, response_data[&#39;error&#39;][&#39;message&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="95">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;user1 create group chat with blank qiscus room id&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="96">
          <span class="hits">1</span>
          
          <code class="ruby">    session = auth_sessions(:user1_session1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="97">
          <span class="hits">1</span>
          
          <code class="ruby">    user2 = users(:user2)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="98">
          <span class="hits">1</span>
          
          <code class="ruby">    target = [user2.id]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="100">
          <span class="hits">1</span>
          
          <code class="ruby">    post &#39;/api/v1/chat/conversations/group_chat&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">      params: {:target_user_id=&gt; target},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="104">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby">    # assert_equal  &#39;Qiscus room id can not be blank.&#39;, response_data[&#39;error&#39;][&#39;message&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="108">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;user1 create group chat with valid target_user_id&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="109">
          <span class="hits">1</span>
          
          <code class="ruby">    session = auth_sessions(:user1_session1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="110">
          <span class="hits">1</span>
          
          <code class="ruby">    user1 = users(:user1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="111">
          <span class="hits">1</span>
          
          <code class="ruby">    user2 = users(:user2)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="112">
          <span class="hits">1</span>
          
          <code class="ruby">    user3 = users(:user3)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="113">
          <span class="hits">1</span>
          
          <code class="ruby">    target = [user2.id, user3.id]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="115">
          
          
          <code class="ruby">    # mock QiscusSdk#post_system_event_message</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="116">
          <span class="hits">1</span>
          
          <code class="ruby">    qiscus_sdk = mock(&#39;object&#39;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="117">
          <span class="hits">1</span>
          
          <code class="ruby">    qiscus_sdk.expects(:post_system_event_message).returns([200, {}])</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="118">
          <span class="hits">1</span>
          
          <code class="ruby">    QiscusSdk.expects(:new).returns(qiscus_sdk)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="120">
          <span class="hits">1</span>
          
          <code class="ruby">    post &#39;/api/v1/chat/conversations/group_chat&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby">      params: {:target_user_id=&gt; target, :qiscus_room_id =&gt; &#39;456&#39;},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="123">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="124">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="126">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal user1.fullname, response_data[&#39;data&#39;][&#39;creator&#39;][&#39;fullname&#39;] # ensure creator user</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="127">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal user2.fullname, response_data[&#39;data&#39;][&#39;users&#39;][1][&#39;fullname&#39;] # ensure target user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby">    # Ensure that user1, user2, and user3 are participants</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="130">
          <span class="hits">1</span>
          
          <code class="ruby">    get &#39;/api/v1/chat/conversations/456/participants&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby">      params: {:target_user_id=&gt; target, :qiscus_room_id =&gt; &#39;456&#39;},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="134">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="135">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal user1.fullname, response_data[&#39;data&#39;][0][&#39;fullname&#39;]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="136">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal user2.fullname, response_data[&#39;data&#39;][1][&#39;fullname&#39;]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="137">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal user3.fullname, response_data[&#39;data&#39;][2][&#39;fullname&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="140">
          
          
          <code class="ruby">  # Channel</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="141">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;user1 create channel chat with target_user not in array&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="142">
          <span class="hits">1</span>
          
          <code class="ruby">    session = auth_sessions(:user1_session1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="143">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="144">
          <span class="hits">1</span>
          
          <code class="ruby">    post &#39;/api/v1/chat/conversations/channel&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="145">
          
          
          <code class="ruby">      params: {:target_user_id=&gt; &#39;&#39;}, # Target_user_id not in array</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="148">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="149">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal  &#39;Target user id must be an array of user id.&#39;, response_data[&#39;error&#39;][&#39;message&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="150">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="152">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;user1 create channel chat with blank qiscus room id&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="153">
          <span class="hits">1</span>
          
          <code class="ruby">    session = auth_sessions(:user1_session1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="154">
          <span class="hits">1</span>
          
          <code class="ruby">    user2 = users(:user2)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="155">
          <span class="hits">1</span>
          
          <code class="ruby">    target = [user2.id]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="156">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="157">
          <span class="hits">1</span>
          
          <code class="ruby">    post &#39;/api/v1/chat/conversations/channel&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="158">
          
          
          <code class="ruby">      params: {:target_user_id=&gt; target},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="160">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="161">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="162">
          
          
          <code class="ruby">    # assert_equal  &#39;Qiscus room id can not be blank.&#39;, response_data[&#39;error&#39;][&#39;message&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="164">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="165">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;user1 create channel with valid target_user_id&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="166">
          <span class="hits">1</span>
          
          <code class="ruby">    session = auth_sessions(:user1_session1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="167">
          <span class="hits">1</span>
          
          <code class="ruby">    user1 = users(:user1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="168">
          <span class="hits">1</span>
          
          <code class="ruby">    user2 = users(:user2)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="169">
          <span class="hits">1</span>
          
          <code class="ruby">    user3 = users(:user3)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="170">
          <span class="hits">1</span>
          
          <code class="ruby">    target = [user2.id, user3.id]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="171">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="172">
          
          
          <code class="ruby">    # mock QiscusSdk#post_system_event_message</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="173">
          <span class="hits">1</span>
          
          <code class="ruby">    qiscus_sdk = mock(&#39;object&#39;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="174">
          <span class="hits">1</span>
          
          <code class="ruby">    qiscus_sdk.expects(:post_system_event_message).returns([200, {}])</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="175">
          <span class="hits">1</span>
          
          <code class="ruby">    QiscusSdk.expects(:new).returns(qiscus_sdk)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="176">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="177">
          <span class="hits">1</span>
          
          <code class="ruby">    post &#39;/api/v1/chat/conversations/channel&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="178">
          
          
          <code class="ruby">      params: {:target_user_id=&gt; target, :qiscus_room_id =&gt; &#39;456&#39;},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="179">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="180">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="181">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="182">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="183">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal user1.fullname, response_data[&#39;data&#39;][&#39;creator&#39;][&#39;fullname&#39;] # ensure creator user</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="184">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal user2.fullname, response_data[&#39;data&#39;][&#39;users&#39;][1][&#39;fullname&#39;] # ensure target user</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="185">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="186">
          
          
          <code class="ruby">    # Ensure that user1, user2, and user3 are participants</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="187">
          <span class="hits">1</span>
          
          <code class="ruby">    get &#39;/api/v1/chat/conversations/456/participants&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="188">
          
          
          <code class="ruby">      params: {:target_user_id=&gt; target, :qiscus_room_id =&gt; &#39;456&#39;},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="189">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="190">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="191">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="192">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal user1.fullname, response_data[&#39;data&#39;][0][&#39;fullname&#39;]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="193">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal user2.fullname, response_data[&#39;data&#39;][1][&#39;fullname&#39;]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="194">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal user3.fullname, response_data[&#39;data&#39;][2][&#39;fullname&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="195">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="196">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="197">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="830bd208353f4b2196eb67516bd60e23600ef3d5">
  <div class="header">
    <h3>test/integration/api/v1/chat/pin_chats_test.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>83</b> relevant lines. 
      <span class="green"><b>83</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;test_helper&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">class API::V1::Chat::PinChatsTest &lt; ActionDispatch::IntegrationTest</code>
        </li>
      
        <li class="covered" data-hits="12" data-linenumber="4">
          <span class="hits">12</span>
          
          <code class="ruby">  setup { host! &#39;api.example.com&#39; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;user1 attempt to pin chat with not array qiscus room id&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">    session1 = auth_sessions(:user1_session1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">    qiscus_room_id = &quot;123&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">    post &#39;/api/v1/chat/conversations/pin_chats&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">      params: {:qiscus_room_id=&gt; qiscus_room_id}, # not array qiscus room id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session1.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 422, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal &#39;Qiscus room id must be an array of qiscus room id.&#39;, response_data[&#39;error&#39;][&#39;message&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;user1 attempt to pin chat without qiscus room id&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">    session1 = auth_sessions(:user1_session1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">    post &#39;/api/v1/chat/conversations/pin_chats&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">      params: {:qiscus_room_id=&gt; []}, # nil qiscus room id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session1.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 422, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal &#39;Qiscus room id must be present.&#39;, response_data[&#39;error&#39;][&#39;message&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;user1 attempt to pin chat not listed qiscus room id&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">    session1 = auth_sessions(:user1_session1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="33">
          <span class="hits">1</span>
          
          <code class="ruby">    qiscus_room_ids = 5</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="35">
          <span class="hits">1</span>
          
          <code class="ruby">    post &#39;/api/v1/chat/conversations/pin_chats&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">      params: {:qiscus_room_id=&gt; [qiscus_room_ids]},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session1.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="39">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 422, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="40">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="41">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal &#39;Chat room with qiscus_room_id [5] not found.&#39;, response_data[&#39;error&#39;][&#39;message&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="44">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;user1 attempt to pin chat more than 3 qiscus room id&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="45">
          <span class="hits">1</span>
          
          <code class="ruby">    session1 = auth_sessions(:user1_session1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="46">
          <span class="hits">1</span>
          
          <code class="ruby">    qiscus_room_ids = [22, 234, 25, 221]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="48">
          <span class="hits">1</span>
          
          <code class="ruby">    post &#39;/api/v1/chat/conversations/pin_chats&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">      params: {:qiscus_room_id=&gt; qiscus_room_ids},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session1.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="52">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 422, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="53">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="54">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal &#39;You can only pin up 3 chats.&#39;, response_data[&#39;error&#39;][&#39;message&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="57">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;user1 attempt to pin chat that already pinned&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="58">
          <span class="hits">1</span>
          
          <code class="ruby">    session1 = auth_sessions(:user1_session1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="59">
          <span class="hits">1</span>
          
          <code class="ruby">    qiscus_room_ids = [1]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="61">
          <span class="hits">1</span>
          
          <code class="ruby">    post &#39;/api/v1/chat/conversations/pin_chats&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">      params: {:qiscus_room_id=&gt; qiscus_room_ids},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session1.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="65">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 422, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="66">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="67">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal &#39;Chat room with qiscus_room_id [1] already pinned.&#39;, response_data[&#39;error&#39;][&#39;message&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="70">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;user2 attempt to pin chat room 2, success&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="71">
          <span class="hits">1</span>
          
          <code class="ruby">    session2 = auth_sessions(:user2_session2)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="72">
          <span class="hits">1</span>
          
          <code class="ruby">    room2 = chat_rooms(:user2_chatroom200)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="73">
          <span class="hits">1</span>
          
          <code class="ruby">    qiscus_room_ids = [room2.qiscus_room_id]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">    # mock QiscusSdk#get_rooms_info</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="76">
          <span class="hits">1</span>
          
          <code class="ruby">    qiscus_sdk = mock(&#39;object&#39;)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="77">
          <span class="hits">1</span>
          
          <code class="ruby">    qiscus_sdk.expects(:get_rooms_info).returns([200, {}])</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="78">
          <span class="hits">1</span>
          
          <code class="ruby">    QiscusSdk.expects(:new).returns(qiscus_sdk)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="80">
          <span class="hits">1</span>
          
          <code class="ruby">    post &#39;/api/v1/chat/conversations/pin_chats&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">      params: {:qiscus_room_id=&gt; qiscus_room_ids},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session2.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="84">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 200, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="85">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="86">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal room2.qiscus_room_name, response_data[&#39;data&#39;][0][&#39;qiscus_room_name&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="89">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;user1 attempt to destroy pin chat with not array qiscus room id&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="90">
          <span class="hits">1</span>
          
          <code class="ruby">    session1 = auth_sessions(:user1_session1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="91">
          <span class="hits">1</span>
          
          <code class="ruby">    qiscus_room_id = &quot;123&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="93">
          <span class="hits">1</span>
          
          <code class="ruby">    delete &#39;/api/v1/chat/conversations/pin_chats&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">      params: {:qiscus_room_id=&gt; qiscus_room_id}, # not array qiscus room id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session1.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="97">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 422, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="98">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="99">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal &#39;Qiscus room id must be an array of qiscus room id.&#39;, response_data[&#39;error&#39;][&#39;message&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="102">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;user1 attempt to destroy pin chat without qiscus room id&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="103">
          <span class="hits">1</span>
          
          <code class="ruby">    session1 = auth_sessions(:user1_session1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="105">
          <span class="hits">1</span>
          
          <code class="ruby">    delete &#39;/api/v1/chat/conversations/pin_chats&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby">      params: {:qiscus_room_id=&gt; []}, # nil qiscus room id</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session1.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="109">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 422, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="110">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="111">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal &#39;Qiscus room id must be present.&#39;, response_data[&#39;error&#39;][&#39;message&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="112">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="113">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="114">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;user1 attempt to destroy pin chat qith invalid qiscus room id&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="115">
          <span class="hits">1</span>
          
          <code class="ruby">    session1 = auth_sessions(:user1_session1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="116">
          <span class="hits">1</span>
          
          <code class="ruby">    qiscus_room_ids = 5</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="118">
          <span class="hits">1</span>
          
          <code class="ruby">    delete &#39;/api/v1/chat/conversations/pin_chats&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="119">
          
          
          <code class="ruby">      params: {:qiscus_room_id=&gt; [qiscus_room_ids]},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session1.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="122">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 422, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="123">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="124">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal &#39;Invalid chat room with qiscus_room_id [5].&#39;, response_data[&#39;error&#39;][&#39;message&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="127">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;user1 attempt to destroy not pinned chat&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="128">
          <span class="hits">1</span>
          
          <code class="ruby">    session1 = auth_sessions(:user1_session1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="129">
          <span class="hits">1</span>
          
          <code class="ruby">    qiscus_room_ids = 2</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="130">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="131">
          <span class="hits">1</span>
          
          <code class="ruby">    delete &#39;/api/v1/chat/conversations/pin_chats&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="132">
          
          
          <code class="ruby">      params: {:qiscus_room_id=&gt; [qiscus_room_ids]},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session1.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="135">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 422, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="136">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="137">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal &#39;Chat room with qiscus_room_id [2] is not pin chats.&#39;, response_data[&#39;error&#39;][&#39;message&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="139">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="140">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;user1 attempt to destroy pin chat 1, success&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="141">
          <span class="hits">1</span>
          
          <code class="ruby">    session1 = auth_sessions(:user1_session1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="142">
          <span class="hits">1</span>
          
          <code class="ruby">    room1 = chat_rooms(:user1_chatroom100)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="143">
          <span class="hits">1</span>
          
          <code class="ruby">    qiscus_room_ids = [room1.qiscus_room_id]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="144">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="145">
          <span class="hits">1</span>
          
          <code class="ruby">    delete &#39;/api/v1/chat/conversations/pin_chats&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="146">
          
          
          <code class="ruby">      params: {:qiscus_room_id=&gt; qiscus_room_ids},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="147">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session1.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="149">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 200, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="150">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="151">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal room1.qiscus_room_name, response_data[&#39;data&#39;][0][&#39;qiscus_room_name&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="153">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="71b4b606f8728b4285dc516bf03eda795a91092c">
  <div class="header">
    <h3>test/integration/api/v1/contacts/favorites_test.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>53</b> relevant lines. 
      <span class="green"><b>53</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;test_helper&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">class API::V1::Contacts::FavoritesTest&lt; ActionDispatch::IntegrationTest</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="4">
          <span class="hits">7</span>
          
          <code class="ruby">  setup { host! &#39;api.example.com&#39; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;user1 attempt to add contact with invalid user_id&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">    session1 = auth_sessions(:user1_session1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">    post &quot;/api/v1/contacts/favorites&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">      params: {:user_id=&gt; 5},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session1.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 422, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal Mime[:json], response.content_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal &#39;User is not found.&#39;, response_data[&#39;error&#39;][&#39;message&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;user1 attempt to add contact with user_id that not in his contact&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">    user3 = users(:user3)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">    session1 = auth_sessions(:user1_session1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">    post &quot;/api/v1/contacts/favorites&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">      params: {:user_id=&gt; user3.id},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session1.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 422, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal Mime[:json], response.content_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal &#39;This user is not in your contact. Please add before mark it as favourites.&#39;, response_data[&#39;error&#39;][&#39;message&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="35">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;user1 attempt to add user2 as a favorite contact&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="36">
          <span class="hits">1</span>
          
          <code class="ruby">    user2 = users(:user2)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="37">
          <span class="hits">1</span>
          
          <code class="ruby">    session1 = auth_sessions(:user1_session1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="38">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="39">
          <span class="hits">1</span>
          
          <code class="ruby">    post &quot;/api/v1/contacts/favorites&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">      params: {:user_id=&gt; user2.id},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session1.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="43">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 200, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="44">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal Mime[:json], response.content_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby">    # Ensure that user1 success to add user2 as a favorite contact</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="47">
          <span class="hits">1</span>
          
          <code class="ruby">    get &quot;/api/v1/contacts/favorites&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">      params: {},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session1.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="51">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 200, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="52">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal Mime[:json], response.content_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="54">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="55">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal user2.fullname, response_data[&#39;data&#39;][0][&#39;fullname&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="58">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;user1 attempt to remove favorite contact with invalid id_user&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="59">
          <span class="hits">1</span>
          
          <code class="ruby">    session1 = auth_sessions(:user1_session1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="61">
          <span class="hits">1</span>
          
          <code class="ruby">    delete &quot;/api/v1/contacts/favorites/5&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby">      params: {:id=&gt; 5},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session1.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="65">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 422, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="66">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal Mime[:json], response.content_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="68">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="69">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal &quot;User is not found.&quot;, response_data[&#39;error&#39;][&#39;message&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="71">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="72">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;user1 attempt to remove favorite contact with id_user that not in his contact&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="73">
          <span class="hits">1</span>
          
          <code class="ruby">    session1 = auth_sessions(:user1_session1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="74">
          <span class="hits">1</span>
          
          <code class="ruby">    user3 = users(:user3)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="76">
          <span class="hits">1</span>
          
          <code class="ruby">    delete &quot;/api/v1/contacts/favorites/#{user3.id}&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">      params: {:id=&gt; user3.id},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session1.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="80">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 422, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="81">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal Mime[:json], response.content_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="83">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="84">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal &quot;This user is not in your contact. Please add before mark it as favourites.&quot;, response_data[&#39;error&#39;][&#39;message&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="86">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="87">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;user1 attempt to remove user2 as a favorite contact&quot; do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby">    # First, user1 add user2 as a fovorite contact</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="89">
          <span class="hits">1</span>
          
          <code class="ruby">    user2 = users(:user2)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="90">
          <span class="hits">1</span>
          
          <code class="ruby">    session1 = auth_sessions(:user1_session1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="92">
          <span class="hits">1</span>
          
          <code class="ruby">    post &quot;/api/v1/contacts/favorites&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">      params: {:user_id=&gt; user2.id},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session1.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="96">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 200, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="97">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal Mime[:json], response.content_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">    # Then user1 remove user2</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="100">
          <span class="hits">1</span>
          
          <code class="ruby">    delete &quot;/api/v1/contacts/favorites/#{user2.id}&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">      params: {:id=&gt; user2.id},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session1.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="103">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="104">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 200, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="105">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal Mime[:json], response.content_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="7f43bb67b8b6eaef0b7fe5af2306c60de496f257">
  <div class="header">
    <h3>test/integration/api/v1/contacts_test.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>185</b> relevant lines. 
      <span class="green"><b>185</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;test_helper&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">class API::V1::ContactsTest&lt; ActionDispatch::IntegrationTest</code>
        </li>
      
        <li class="covered" data-hits="21" data-linenumber="4">
          <span class="hits">21</span>
          
          <code class="ruby">  setup { host! &#39;api.example.com&#39; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;user1 attempt to add contact with user1 id&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">    user1 = users(:user1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">    session1 = auth_sessions(:user1_session1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">    post &quot;/api/v1/contacts&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">      params: {:contact_id=&gt; user1.id},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session1.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 422, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal Mime[:json], response.content_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal &#39;You can not add your self as contact.&#39;, response_data[&#39;error&#39;][&#39;message&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;user1 attempt to add user2, already on his contact&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">    user1 = users(:user1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">    user2 = users(:user2)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">    session1 = auth_sessions(:user1_session1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">    post &quot;/api/v1/contacts&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby">      params: {:contact_id=&gt; user2.id},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="28">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session1.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 422, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal Mime[:json], response.content_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="33">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal &#39;User already in your contact.&#39;, response_data[&#39;error&#39;][&#39;message&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="37">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;user1 attempt to add contact without contact id&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="38">
          <span class="hits">1</span>
          
          <code class="ruby">    user1 = users(:user1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="39">
          <span class="hits">1</span>
          
          <code class="ruby">    session1 = auth_sessions(:user1_session1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="41">
          <span class="hits">1</span>
          
          <code class="ruby">    post &quot;/api/v1/contacts&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">      params: {:contact_id=&gt; &quot;&quot;},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session1.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="45">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 422, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="46">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal Mime[:json], response.content_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="48">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="49">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal &#39;Contact id must be present.&#39;, response_data[&#39;error&#39;][&#39;message&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="52">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;user1 attempt to add not known user&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="53">
          <span class="hits">1</span>
          
          <code class="ruby">    user1 = users(:user1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="54">
          <span class="hits">1</span>
          
          <code class="ruby">    user4 = users(:user4) # there is no user4</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="55">
          <span class="hits">1</span>
          
          <code class="ruby">    session1 = auth_sessions(:user1_session1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="57">
          <span class="hits">1</span>
          
          <code class="ruby">    post &quot;/api/v1/contacts&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">      params: {:contact_id=&gt; user4.id},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session1.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="61">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 422, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="62">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal Mime[:json], response.content_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="63">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="64">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="65">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal &#39;Contact id is not found.&#39;, response_data[&#39;error&#39;][&#39;message&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="68">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;user1 attempt to add user3, success&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="69">
          <span class="hits">1</span>
          
          <code class="ruby">    user1 = users(:user1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="70">
          <span class="hits">1</span>
          
          <code class="ruby">    user3 = users(:user3)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="71">
          <span class="hits">1</span>
          
          <code class="ruby">    session1 = auth_sessions(:user1_session1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="72">
          <span class="hits">1</span>
          
          <code class="ruby">    session3 = auth_sessions(:user3_session3)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="74">
          <span class="hits">1</span>
          
          <code class="ruby">    post &quot;/api/v1/contacts&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="75">
          
          
          <code class="ruby">      params: {:contact_id=&gt; user3.id},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session1.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="78">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 200, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="79">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal Mime[:json], response.content_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">    # User3 get contact list to ensure that user1 in his contact</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="82">
          <span class="hits">1</span>
          
          <code class="ruby">    get &quot;/api/v1/contacts&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby">      params: {:exclude=&gt; &#39;official&#39;},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session3.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="86">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 200, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="87">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal Mime[:json], response.content_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="89">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="90">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal user1.id, response_data[&#39;data&#39;][0][&#39;id&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="92">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">  # test to delete user</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="94">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;user1 attempt to delete user with empty string&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="95">
          <span class="hits">1</span>
          
          <code class="ruby">    user1 = users(:user1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="96">
          <span class="hits">1</span>
          
          <code class="ruby">    session1 = auth_sessions(:user1_session1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="97">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="98">
          <span class="hits">1</span>
          
          <code class="ruby">    delete &quot;/api/v1/contacts/delete_contact&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">      params: {:contact_id=&gt; &quot;&quot;},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session1.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="102">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 422, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="103">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal Mime[:json], response.content_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="105">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="106">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal &#39;Contact id can not be empty string.&#39;, response_data[&#39;error&#39;][&#39;message&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="107">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="108">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="109">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;user1 attempt to delete user2&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="110">
          <span class="hits">1</span>
          
          <code class="ruby">    user1 = users(:user1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="111">
          <span class="hits">1</span>
          
          <code class="ruby">    user2 = users(:user2)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="112">
          <span class="hits">1</span>
          
          <code class="ruby">    session1 = auth_sessions(:user1_session1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="113">
          <span class="hits">1</span>
          
          <code class="ruby">    session2 = auth_sessions(:user2_session2)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="114">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="115">
          <span class="hits">1</span>
          
          <code class="ruby">    delete &quot;/api/v1/contacts/delete_contact&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="116">
          
          
          <code class="ruby">      params: {:contact_id=&gt; user2.id},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session1.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="119">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 200, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="120">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal Mime[:json], response.content_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="122">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="123">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal user2.id, response_data[&#39;data&#39;][&#39;id&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="124">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="126">
          
          
          <code class="ruby">  # test to search user</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="127">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;user1 attempt to search user3 with invalid phone number&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="128">
          <span class="hits">1</span>
          
          <code class="ruby">    user1 = users(:user1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="129">
          <span class="hits">1</span>
          
          <code class="ruby">    user3 = users(:user3)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="130">
          <span class="hits">1</span>
          
          <code class="ruby">    session1 = auth_sessions(:user1_session1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="131">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="132">
          <span class="hits">1</span>
          
          <code class="ruby">    post &quot;/api/v1/contacts/search&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="133">
          
          
          <code class="ruby">      params: {:phone_number=&gt; user3.phone_number.chomp(&quot;2345&quot;)},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="134">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session1.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="135">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="136">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 404, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="137">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal Mime[:json], response.content_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="138">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="139">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="140">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal &quot;User not found.&quot;, response_data[&#39;error&#39;][&#39;message&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="141">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="142">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="143">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;user1 attempt to search user2 with valid but already in his contact&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="144">
          <span class="hits">1</span>
          
          <code class="ruby">    user1 = users(:user1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="145">
          <span class="hits">1</span>
          
          <code class="ruby">    user2 = users(:user2)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="146">
          <span class="hits">1</span>
          
          <code class="ruby">    session1 = auth_sessions(:user1_session1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="147">
          <span class="hits">1</span>
          
          <code class="ruby">    session2 = auth_sessions(:user2_session2)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="148">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="149">
          <span class="hits">1</span>
          
          <code class="ruby">    post &quot;/api/v1/contacts/search&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="150">
          
          
          <code class="ruby">      params: {:phone_number=&gt; user2.phone_number},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="151">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session1.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="152">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="153">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 422, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="154">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal Mime[:json], response.content_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="155">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="156">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="157">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal &quot;User already in your contact.&quot;, response_data[&#39;error&#39;][&#39;message&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="158">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="159">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="160">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;user1 attempt to search user with invalid minimum phone number&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="161">
          <span class="hits">1</span>
          
          <code class="ruby">    user1 = users(:user1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="162">
          <span class="hits">1</span>
          
          <code class="ruby">    session1 = auth_sessions(:user1_session1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="163">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="164">
          <span class="hits">1</span>
          
          <code class="ruby">    post &quot;/api/v1/contacts/search&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="165">
          
          
          <code class="ruby">      params: {:phone_number=&gt; &quot;12345&quot;},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="166">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session1.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="167">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="168">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 422, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="169">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal Mime[:json], response.content_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="170">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="171">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="172">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal &quot;Minimum phone number is 9&quot;, response_data[&#39;error&#39;][&#39;message&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="173">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="174">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="175">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;user1 attempt to search user3 with valid phone number&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="176">
          <span class="hits">1</span>
          
          <code class="ruby">    user1 = users(:user1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="177">
          <span class="hits">1</span>
          
          <code class="ruby">    user3 = users(:user3)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="178">
          <span class="hits">1</span>
          
          <code class="ruby">    session1 = auth_sessions(:user1_session1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="179">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="180">
          <span class="hits">1</span>
          
          <code class="ruby">    post &quot;/api/v1/contacts/search&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="181">
          
          
          <code class="ruby">      params: {:phone_number=&gt; user3.phone_number},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="182">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session1.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="183">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="184">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 200, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="185">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal Mime[:json], response.content_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="186">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="187">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="188">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal user3.id, response_data[&#39;data&#39;][&#39;id&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="189">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="190">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="191">
          
          
          <code class="ruby">  # test search by qiscus_email</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="192">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;user1 attempt to search user with empty qiscus email&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="193">
          <span class="hits">1</span>
          
          <code class="ruby">    user1 = users(:user1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="194">
          <span class="hits">1</span>
          
          <code class="ruby">    session1 = auth_sessions(:user1_session1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="195">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="196">
          <span class="hits">1</span>
          
          <code class="ruby">    post &quot;/api/v1/contacts/search_by_qiscus_email&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="197">
          
          
          <code class="ruby">      params: {:qiscus_email=&gt; &quot;&quot;},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="198">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session1.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="199">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="200">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 422, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="201">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal Mime[:json], response.content_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="202">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="203">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="204">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal &quot;Qiscus email can&#39;t be empty.&quot;, response_data[&#39;error&#39;][&#39;message&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="205">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="206">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="207">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;user1 attempt to search unknown user&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="208">
          <span class="hits">1</span>
          
          <code class="ruby">    user1 = users(:user1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="209">
          <span class="hits">1</span>
          
          <code class="ruby">    user4 = users(:user4)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="210">
          <span class="hits">1</span>
          
          <code class="ruby">    session1 = auth_sessions(:user1_session1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="211">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="212">
          <span class="hits">1</span>
          
          <code class="ruby">    post &quot;/api/v1/contacts/search_by_qiscus_email&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="213">
          
          
          <code class="ruby">      params: {:qiscus_email=&gt; user4.qiscus_email},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="214">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session1.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="215">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="216">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 422, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="217">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal Mime[:json], response.content_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="218">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="219">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="220">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal &quot;User not found.&quot;, response_data[&#39;error&#39;][&#39;message&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="221">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="222">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="223">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;user1 attempt to search user3 with valid qiscus email&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="224">
          <span class="hits">1</span>
          
          <code class="ruby">    user1 = users(:user1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="225">
          <span class="hits">1</span>
          
          <code class="ruby">    user3 = users(:user3)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="226">
          <span class="hits">1</span>
          
          <code class="ruby">    session1 = auth_sessions(:user1_session1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="227">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="228">
          <span class="hits">1</span>
          
          <code class="ruby">    post &quot;/api/v1/contacts/search_by_qiscus_email&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="229">
          
          
          <code class="ruby">      params: {:qiscus_email=&gt; user3.qiscus_email},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="230">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session1.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="231">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="232">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 200, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="233">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal Mime[:json], response.content_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="234">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="235">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="236">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal user3.qiscus_email, response_data[&#39;data&#39;][&#39;qiscus_email&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="237">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="238">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="239">
          
          
          <code class="ruby">  # test search by email</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="240">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;user1 attempt to search user with empty email&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="241">
          <span class="hits">1</span>
          
          <code class="ruby">    user1 = users(:user1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="242">
          <span class="hits">1</span>
          
          <code class="ruby">    session1 = auth_sessions(:user1_session1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="243">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="244">
          <span class="hits">1</span>
          
          <code class="ruby">    post &quot;/api/v1/contacts/search_by_email&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="245">
          
          
          <code class="ruby">      params: {:email=&gt; &quot;&quot;},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="246">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session1.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="247">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="248">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 422, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="249">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal Mime[:json], response.content_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="250">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="251">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="252">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal &quot;Email can&#39;t be empty.&quot;, response_data[&#39;error&#39;][&#39;message&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="253">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="254">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="255">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;user1 attempt to search unknown user with email&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="256">
          <span class="hits">1</span>
          
          <code class="ruby">    user1 = users(:user1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="257">
          <span class="hits">1</span>
          
          <code class="ruby">    user4 = users(:user4)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="258">
          <span class="hits">1</span>
          
          <code class="ruby">    session1 = auth_sessions(:user1_session1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="259">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="260">
          <span class="hits">1</span>
          
          <code class="ruby">    post &quot;/api/v1/contacts/search_by_email&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="261">
          
          
          <code class="ruby">      params: {:email=&gt; user4.email},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="262">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session1.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="263">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="264">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 422, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="265">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal Mime[:json], response.content_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="266">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="267">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="268">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal &quot;User not found.&quot;, response_data[&#39;error&#39;][&#39;message&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="269">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="270">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="271">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;user1 attempt to search user3 with valid email&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="272">
          <span class="hits">1</span>
          
          <code class="ruby">    user1 = users(:user1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="273">
          <span class="hits">1</span>
          
          <code class="ruby">    user3 = users(:user3)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="274">
          <span class="hits">1</span>
          
          <code class="ruby">    session1 = auth_sessions(:user1_session1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="275">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="276">
          <span class="hits">1</span>
          
          <code class="ruby">    post &quot;/api/v1/contacts/search_by_email&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="277">
          
          
          <code class="ruby">      params: {:email=&gt; user3.email},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="278">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session1.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="279">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="280">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 200, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="281">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal Mime[:json], response.content_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="282">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="283">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="284">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal user3.email, response_data[&#39;data&#39;][&#39;email&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="285">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="286">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="287">
          
          
          <code class="ruby">  # search by all field</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="288">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;user1 attempt to search user2 with valid query&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="289">
          <span class="hits">1</span>
          
          <code class="ruby">    user1 = users(:user1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="290">
          <span class="hits">1</span>
          
          <code class="ruby">    user2 = users(:user2)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="291">
          <span class="hits">1</span>
          
          <code class="ruby">    session1 = auth_sessions(:user1_session1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="292">
          <span class="hits">1</span>
          
          <code class="ruby">    query = &quot;+6285643123456 Setiawan setiawan@gmail.com userid_2_6285643123456@qisme.com&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="293">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="294">
          <span class="hits">1</span>
          
          <code class="ruby">    post &quot;/api/v1/contacts/search_by_all_field&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="295">
          
          
          <code class="ruby">      params: {:query=&gt; query},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="296">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session1.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="297">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="298">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 200, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="299">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal Mime[:json], response.content_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="300">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="301">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="302">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal user2.fullname, response_data[&#39;data&#39;][0][&#39;fullname&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="303">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="304">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="305">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;user1 attempt to search user2 with using not-complete fullname, email, qiscus_email, and phone_number&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="306">
          <span class="hits">1</span>
          
          <code class="ruby">    user1 = users(:user1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="307">
          <span class="hits">1</span>
          
          <code class="ruby">    user2 = users(:user2)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="308">
          <span class="hits">1</span>
          
          <code class="ruby">    session1 = auth_sessions(:user1_session1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="309">
          <span class="hits">1</span>
          
          <code class="ruby">    query = &quot;+6285643123 Setia&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="310">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="311">
          <span class="hits">1</span>
          
          <code class="ruby">    post &quot;/api/v1/contacts/search_by_all_field&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="312">
          
          
          <code class="ruby">      params: {:query=&gt; query},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="313">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session1.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="314">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="315">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 200, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="316">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal Mime[:json], response.content_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="317">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="318">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="319">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal user2.fullname, response_data[&#39;data&#39;][0][&#39;fullname&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="320">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="321">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="322">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;user1 attempt to search without query&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="323">
          <span class="hits">1</span>
          
          <code class="ruby">    user1 = users(:user1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="324">
          <span class="hits">1</span>
          
          <code class="ruby">    session1 = auth_sessions(:user1_session1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="325">
          <span class="hits">1</span>
          
          <code class="ruby">    user_count = User.where.not(id: user1.id).where(application_id: user1.application_id).count</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="326">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="327">
          <span class="hits">1</span>
          
          <code class="ruby">    post &quot;/api/v1/contacts/search_by_all_field&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="328">
          
          
          <code class="ruby">      params: {:query=&gt; nil},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="329">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session1.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="330">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="331">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 200, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="332">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal Mime[:json], response.content_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="333">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="334">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="335">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal user_count, response_data[&#39;meta&#39;][&#39;total&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="336">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="337">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="338">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="b87a960705e60d0c11a530b64a54627eff80fcd7">
  <div class="header">
    <h3>test/integration/api/v1/me_test.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>81</b> relevant lines. 
      <span class="green"><b>81</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;test_helper&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">class API::V1::MeTest&lt; ActionDispatch::IntegrationTest</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="4">
          <span class="hits">6</span>
          
          <code class="ruby">  setup { host! &#39;api.example.com&#39; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;user1 attempt to change fullname with 4 character&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">    session1 = auth_sessions(:user1_session1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="8">
          <span class="hits">1</span>
          
          <code class="ruby">    new_fullname = &quot;abc&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">    qiscus_sdk = mock()</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">    qiscus_sdk.expects(:update_profile).returns()</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">    QiscusSdk.expects(:new).returns(qiscus_sdk)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">    post &quot;/api/v1/me/update_profile&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">      params: {:user =&gt; {:fullname =&gt; new_fullname}},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session1.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 422, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal Mime[:json], response.content_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal &#39;Fullname is too short (minimum is 4 characters).&#39;, response_data[&#39;error&#39;][&#39;message&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;user1 attempt to change fullname and success&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">    session1 = auth_sessions(:user1_session1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">    user1 = users(:user1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">    new_fullname = user1.fullname + &quot; Fullname&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">    qiscus_sdk = mock()</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">    qiscus_sdk.expects(:update_profile).returns()</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">    QiscusSdk.expects(:new).returns(qiscus_sdk)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">    post &quot;/api/v1/me/update_profile&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">      params: {:user =&gt; {:fullname =&gt; new_fullname}},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session1.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="38">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 200, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="39">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal Mime[:json], response.content_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="41">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="42">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal new_fullname, response_data[&#39;data&#39;][&#39;fullname&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="45">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;user1 attempt to change email with existing email&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="46">
          <span class="hits">1</span>
          
          <code class="ruby">    session1 = auth_sessions(:user1_session1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="47">
          <span class="hits">1</span>
          
          <code class="ruby">    user1 = users(:user1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="48">
          <span class="hits">1</span>
          
          <code class="ruby">    user2 = users(:user2)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="49">
          <span class="hits">1</span>
          
          <code class="ruby">    new_fullname = user1.fullname + &quot; Fullname&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="50">
          <span class="hits">1</span>
          
          <code class="ruby">    new_email = user2.email # using user2 email as new email</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="52">
          <span class="hits">1</span>
          
          <code class="ruby">    qiscus_sdk = mock()</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="53">
          <span class="hits">1</span>
          
          <code class="ruby">    qiscus_sdk.expects(:update_profile).returns()</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="54">
          <span class="hits">1</span>
          
          <code class="ruby">    QiscusSdk.expects(:new).returns(qiscus_sdk)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="56">
          <span class="hits">1</span>
          
          <code class="ruby">    post &quot;/api/v1/me/update_profile&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">      params: {:user =&gt; {:fullname =&gt; new_fullname, :email=&gt; new_email}},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session1.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="60">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 422, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="61">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal Mime[:json], response.content_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="63">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="64">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal &quot;Your submitted email already used by another user. Please use another email.&quot;, response_data[&#39;error&#39;][&#39;message&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="67">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;user1 attempt to change email and success&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="68">
          <span class="hits">1</span>
          
          <code class="ruby">    session1 = auth_sessions(:user1_session1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="69">
          <span class="hits">1</span>
          
          <code class="ruby">    user1 = users(:user1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="70">
          <span class="hits">1</span>
          
          <code class="ruby">    new_fullname = user1.fullname + &quot; Fullname&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="71">
          <span class="hits">1</span>
          
          <code class="ruby">    new_email = &quot;new_email@gmail.com&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="73">
          <span class="hits">1</span>
          
          <code class="ruby">    qiscus_sdk = mock()</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="74">
          <span class="hits">1</span>
          
          <code class="ruby">    qiscus_sdk.expects(:update_profile).returns()</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="75">
          <span class="hits">1</span>
          
          <code class="ruby">    QiscusSdk.expects(:new).returns(qiscus_sdk)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="77">
          <span class="hits">1</span>
          
          <code class="ruby">    post &quot;/api/v1/me/update_profile&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby">      params: {:user =&gt; {:fullname =&gt; new_fullname, :email=&gt; new_email}},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session1.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="80">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="81">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 200, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="82">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal Mime[:json], response.content_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="83">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="84">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="85">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal new_fullname, response_data[&#39;data&#39;][&#39;fullname&#39;]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="86">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal new_email, response_data[&#39;data&#39;][&#39;email&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="88">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="89">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;user1 attempt to change gender, date_of_birth, is_public, description&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="90">
          <span class="hits">1</span>
          
          <code class="ruby">    session1 = auth_sessions(:user1_session1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="91">
          <span class="hits">1</span>
          
          <code class="ruby">    user1 = users(:user1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="92">
          <span class="hits">1</span>
          
          <code class="ruby">    new_fullname = user1.fullname + &quot; Fullname&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="93">
          <span class="hits">1</span>
          
          <code class="ruby">    new_email = &quot;new_email@gmail.com&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="94">
          <span class="hits">1</span>
          
          <code class="ruby">    new_gender = &quot;male&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="95">
          <span class="hits">1</span>
          
          <code class="ruby">    new_date_of_birth = &quot;2000-12-12&quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="96">
          <span class="hits">1</span>
          
          <code class="ruby">    new_is_public = true</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="97">
          <span class="hits">1</span>
          
          <code class="ruby">    new_description = &quot;This is Description&quot;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="99">
          <span class="hits">1</span>
          
          <code class="ruby">    qiscus_sdk = mock()</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="100">
          <span class="hits">1</span>
          
          <code class="ruby">    qiscus_sdk.expects(:update_profile).returns()</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="101">
          <span class="hits">1</span>
          
          <code class="ruby">    QiscusSdk.expects(:new).returns(qiscus_sdk)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="103">
          <span class="hits">1</span>
          
          <code class="ruby">    post &quot;/api/v1/me/update_profile&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="104">
          
          
          <code class="ruby">      params: {:user =&gt; {:fullname =&gt; new_fullname, :email=&gt; new_email, :gender =&gt; new_gender, :date_of_birth =&gt; new_date_of_birth, :is_public =&gt; new_is_public, :description =&gt; new_description}},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="105">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session1.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="106">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="107">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 200, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="108">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal Mime[:json], response.content_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="109">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="110">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="111">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal new_fullname, response_data[&#39;data&#39;][&#39;fullname&#39;]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="112">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal new_email, response_data[&#39;data&#39;][&#39;email&#39;]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="113">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal new_fullname, response_data[&#39;data&#39;][&#39;fullname&#39;]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="114">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal new_date_of_birth, response_data[&#39;data&#39;][&#39;date_of_birth&#39;]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="115">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal new_is_public, response_data[&#39;data&#39;][&#39;is_public&#39;]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="116">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal new_description, response_data[&#39;data&#39;][&#39;description&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="117">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="118">
          
          
          <code class="ruby">    # Show user profile to ensure that update profile successfully</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="119">
          <span class="hits">1</span>
          
          <code class="ruby">    get &quot;/api/v1/me/&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="120">
          
          
          <code class="ruby">      params: {},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="121">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session1.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="122">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="123">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 200, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="124">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal Mime[:json], response.content_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="125">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="126">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="127">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal new_fullname, response_data[&#39;data&#39;][&#39;fullname&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="128">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="129">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="bae6a658d1a519a274a23a08d1eec2f9334bc8ee">
  <div class="header">
    <h3>test/integration/api/v1/posts/comments_test.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>56</b> relevant lines. 
      <span class="green"><b>56</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;test_helper&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">class API::V1::Posts::CommentsTest&lt; ActionDispatch::IntegrationTest</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="4">
          <span class="hits">7</span>
          
          <code class="ruby">  setup { host! &#39;api.example.com&#39; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;user2 attempt to comment with invalid post_id&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">    session2 = auth_sessions(:user2_session2)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">    post &quot;/api/v1/posts/20/comments&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">      params: {:post_id =&gt; 20},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session2.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 422, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal Mime[:json], response.content_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal &#39;Post not found.&#39;, response_data[&#39;error&#39;][&#39;message&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;user2 attempt to comment with empty comment content&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">    session2 = auth_sessions(:user2_session2)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">    post1 = posts(:post1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">    post &quot;/api/v1/posts/#{post1.id}/comments&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">      params: {:post_id =&gt; post1.id},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session2.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 422, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal Mime[:json], response.content_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal &#39;Comment content cannot be empty.&#39;, response_data[&#39;error&#39;][&#39;message&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="33">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="35">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;user2 attempt to comment with valid post_id and comment content&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="36">
          <span class="hits">1</span>
          
          <code class="ruby">    session2 = auth_sessions(:user2_session2)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="37">
          <span class="hits">1</span>
          
          <code class="ruby">    post1 = posts(:post1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="38">
          <span class="hits">1</span>
          
          <code class="ruby">    user2 = users(:user2)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="40">
          <span class="hits">1</span>
          
          <code class="ruby">    post &quot;/api/v1/posts/#{post1.id}/comments&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">      params: {:post_id =&gt; post1.id, :content =&gt; &#39;Comment for Post 2&#39;},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session2.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="44">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 200, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="45">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal Mime[:json], response.content_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="47">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">    # Ensure user2 is comment creator</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="49">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal user2.fullname, response_data[&#39;data&#39;][&#39;comments&#39;][&#39;creator&#39;][&#39;fullname&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">    # Ensure that post1 is commented post</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="51">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal post1.id, response_data[&#39;data&#39;][&#39;post&#39;][&#39;id&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="52">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="53">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="54">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;user1 attempt to delete comment with invalid comment_id&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="55">
          <span class="hits">1</span>
          
          <code class="ruby">    session1 = auth_sessions(:user1_session1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="56">
          <span class="hits">1</span>
          
          <code class="ruby">    post1 = posts(:post1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="57">
          <span class="hits">1</span>
          
          <code class="ruby">    user2 = users(:user2)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="59">
          <span class="hits">1</span>
          
          <code class="ruby">    delete &quot;/api/v1/posts/#{post1.id}/comments/100&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="60">
          
          
          <code class="ruby">      params: {:post_id =&gt; post1.id, :comment_id =&gt; 100},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="61">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session1.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="63">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 422, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="64">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal Mime[:json], response.content_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="65">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="66">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="67">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal &quot;Comment not found.&quot;, response_data[&#39;error&#39;][&#39;message&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="68">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="69">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="70">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;user2 attempt to delete comment by user1&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="71">
          <span class="hits">1</span>
          
          <code class="ruby">    session2 = auth_sessions(:user2_session2)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="72">
          <span class="hits">1</span>
          
          <code class="ruby">    post1 = posts(:post1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="73">
          <span class="hits">1</span>
          
          <code class="ruby">    comment2 = comments(:comment2)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="75">
          <span class="hits">1</span>
          
          <code class="ruby">    delete &quot;/api/v1/posts/#{post1.id}/comments/#{comment2.id}&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="76">
          
          
          <code class="ruby">      params: {:post_id =&gt; post1.id, :comment_id =&gt; comment2.id},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session2.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="78">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="79">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 422, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="80">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal Mime[:json], response.content_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="82">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="83">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal &quot;Not post owner or comment owner.&quot;, response_data[&#39;error&#39;][&#39;message&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="84">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="85">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="86">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;user2 attempt to delete his own comment&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="87">
          <span class="hits">1</span>
          
          <code class="ruby">    session2 = auth_sessions(:user2_session2)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="88">
          <span class="hits">1</span>
          
          <code class="ruby">    post1 = posts(:post1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="89">
          <span class="hits">1</span>
          
          <code class="ruby">    comment1 = comments(:comment1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="90">
          <span class="hits">1</span>
          
          <code class="ruby">    user2 = users(:user2)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="92">
          <span class="hits">1</span>
          
          <code class="ruby">    delete &quot;/api/v1/posts/#{post1.id}/comments/#{comment1.id}&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="93">
          
          
          <code class="ruby">      params: {:post_id =&gt; post1.id, :comment_id =&gt; comment1.id},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session2.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="95">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="96">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 200, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="97">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal Mime[:json], response.content_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="98">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="99">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="100">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal user2.id, response_data[&#39;data&#39;][&#39;user_id&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="102">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="cffa6b31be90178f499f2b7d7e858ac5bf65686d">
  <div class="header">
    <h3>test/integration/api/v1/posts_test.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>51</b> relevant lines. 
      <span class="green"><b>51</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;test_helper&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">class API::V1::PostsTest&lt; ActionDispatch::IntegrationTest</code>
        </li>
      
        <li class="covered" data-hits="7" data-linenumber="4">
          <span class="hits">7</span>
          
          <code class="ruby">  setup { host! &#39;api.example.com&#39; }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="6">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;user1 attempt to share a new post with empty post content and media&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="7">
          <span class="hits">1</span>
          
          <code class="ruby">    session1 = auth_sessions(:user1_session1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="9">
          <span class="hits">1</span>
          
          <code class="ruby">    post &quot;/api/v1/posts&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">      params: {},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session1.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 422, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal Mime[:json], response.content_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal &#39;Post content or media cannot be empty.&#39;, response_data[&#39;error&#39;][&#39;message&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;user1 attempt to share a new post with empty media&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">    session1 = auth_sessions(:user1_session1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">    user1 = users(:user1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">    post &quot;/api/v1/posts&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">      params: {:content =&gt; &#39;Post Content&#39;},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session1.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 200, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal Mime[:json], response.content_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">    # Ensure user1 is post creator</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="33">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal user1.fullname, response_data[&#39;data&#39;][&#39;creator&#39;][&#39;fullname&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="36">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;user2 attempt to delete user1 post&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="37">
          <span class="hits">1</span>
          
          <code class="ruby">    session2 = auth_sessions(:user2_session2)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="38">
          <span class="hits">1</span>
          
          <code class="ruby">    post1 = posts(:post1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="40">
          <span class="hits">1</span>
          
          <code class="ruby">    delete &quot;/api/v1/posts/#{post1.id}&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby">      params: {:post_id=&gt; post1.id},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="42">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session2.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="44">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 422, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="45">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal Mime[:json], response.content_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="47">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="48">
          
          
          <code class="ruby">    # Post not found because user2 cannot delete user1 post</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="49">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal &#39;Post not found&#39;, response_data[&#39;error&#39;][&#39;message&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="51">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="52">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;user1 attempt to delete post1&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="53">
          <span class="hits">1</span>
          
          <code class="ruby">    session1 = auth_sessions(:user1_session1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="54">
          <span class="hits">1</span>
          
          <code class="ruby">    post1 = posts(:post1)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="56">
          <span class="hits">1</span>
          
          <code class="ruby">    delete &quot;/api/v1/posts/#{post1.id}&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="57">
          
          
          <code class="ruby">      params: {:post_id=&gt; post1.id},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="58">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session1.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="59">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="60">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 200, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="61">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal Mime[:json], response.content_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="62">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="63">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="64">
          
          
          <code class="ruby">    # User 1 success to donwload post1</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="65">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal post1.content, response_data[&#39;data&#39;][&#39;content&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="66">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="67">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="68">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;user3 attempt to get post list&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="69">
          <span class="hits">1</span>
          
          <code class="ruby">    session3 = auth_sessions(:user3_session3)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="70">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="71">
          <span class="hits">1</span>
          
          <code class="ruby">    get &quot;/api/v1/posts&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="72">
          
          
          <code class="ruby">      params: {},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="73">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session3.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="74">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="75">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 200, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="76">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal Mime[:json], response.content_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="77">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="78">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="79">
          
          
          <code class="ruby">    # User3 contact is empty, so user3 cant get post list</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="80">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal [], response_data[&#39;data&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="81">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="82">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="83">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;user1 attempt to get post list&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="84">
          <span class="hits">1</span>
          
          <code class="ruby">    session1 = auth_sessions(:user1_session1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="85">
          <span class="hits">1</span>
          
          <code class="ruby">    post1 = posts(:post1)</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="86">
          <span class="hits">1</span>
          
          <code class="ruby">    post2 = posts(:post2)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="87">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="88">
          <span class="hits">1</span>
          
          <code class="ruby">    get &quot;/api/v1/posts&quot;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="89">
          
          
          <code class="ruby">      params: {},</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="90">
          
          
          <code class="ruby">      headers: { &#39;Authorization&#39; =&gt; token_header(session1.jwt_token) }</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="91">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="92">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal 200, response.status</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="93">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal Mime[:json], response.content_type</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="94">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="95">
          <span class="hits">1</span>
          
          <code class="ruby">    response_data = JSON.parse(response.body)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="96">
          
          
          <code class="ruby">    # User1 only friend with user2</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="97">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal post1.id, response_data[&#39;data&#39;][0][&#39;id&#39;]</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="98">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_equal post2.id, response_data[&#39;data&#39;][1][&#39;id&#39;]</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="99">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="100">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="101">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="c571c37ea7cc8c588c9916a29b17287e19d19f53">
  <div class="header">
    <h3>test/models/application_test.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>23</b> relevant lines. 
      <span class="green"><b>23</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;test_helper&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">class ApplicationTest &lt; ActiveSupport::TestCase</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">	setup do</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="5">
          <span class="hits">6</span>
          
          <code class="ruby">		@application = Application.new(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">			app_id: &#39;dummy&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">			app_name: &#39;Dummy Application&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">			description: &#39;Description Dummy Application&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">			qiscus_sdk_url: &#39;http://dummy.qiscus.com&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">			qiscus_sdk_secret: &#39;dummy-123&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">		)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">  	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">  	test &quot;should be valid&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">    	assert @application.valid?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">  	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">	test &#39;app_id should be present&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">    	@application.app_id = &quot;         &quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">    	assert_not @application.app_id?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">	test &#39;app_name should be present&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">    	@application.app_name = &quot;         &quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="25">
          <span class="hits">1</span>
          
          <code class="ruby">    	assert_not @application.app_name?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="27">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">	test &#39;qiscus_sdk_url should be present&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">    	@application.qiscus_sdk_url = &quot;         &quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">    	assert_not @application.qiscus_sdk_url?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="33">
          <span class="hits">1</span>
          
          <code class="ruby">	test &#39;qiscus_sdk_secret should be present&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">    	@application.qiscus_sdk_secret = &quot;         &quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="35">
          <span class="hits">1</span>
          
          <code class="ruby">    	assert_not @application.qiscus_sdk_secret?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="37">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="38">
          <span class="hits">1</span>
          
          <code class="ruby">	test &quot;app_id should be unique&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="39">
          <span class="hits">1</span>
          
          <code class="ruby">    	duplicate_application = @application.dup</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="40">
          <span class="hits">1</span>
          
          <code class="ruby">    	duplicate_application.app_id = @application.app_id.upcase</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="41">
          <span class="hits">1</span>
          
          <code class="ruby">    	@application.save</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="42">
          <span class="hits">1</span>
          
          <code class="ruby">    	assert_not duplicate_application.valid?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="43">
          
          
          <code class="ruby">  	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="ba195a3e1b5447aac224746a0d10d89d11c97c21">
  <div class="header">
    <h3>test/models/bot_test.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>2</b> relevant lines. 
      <span class="green"><b>2</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;test_helper&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">class BotTest &lt; ActiveSupport::TestCase</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="4">
          
          
          <code class="ruby">  # test &quot;the truth&quot; do</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="5">
          
          
          <code class="ruby">  #   assert true</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">  # end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="c02484425aacc756410117fb9597485275b73ebc">
  <div class="header">
    <h3>test/models/chat_room_test.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>21</b> relevant lines. 
      <span class="green"><b>21</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;test_helper&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">class ChatRoomTest &lt; ActiveSupport::TestCase</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">	setup do</code>
        </li>
      
        <li class="covered" data-hits="6" data-linenumber="5">
          <span class="hits">6</span>
          
          <code class="ruby">		@chat_room = ChatRoom.new(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">			qiscus_room_name: &#39;qiscus-room-name-1&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">			qiscus_room_id: &#39;100&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">			is_group_chat: &#39;false&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">			user_id: &#39;3&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">			group_chat_name: &#39;Single Chat Name&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">			application_id: &#39;1&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">			group_avatar_url: &#39;https://res.cloudinary.com/qiscus/image/upload/NITXR7pLhz/avatar.jpg&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">			is_official_chat: &#39;false&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">			target_user_id: &#39;4&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">		)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">  	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">  	test &quot;should be valid&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">    	assert @chat_room.valid?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">  	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">  	test &#39;qiscus_room_name should be present&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">    	@chat_room.qiscus_room_name = &quot;         &quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">    	assert_not @chat_room.qiscus_room_name?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">	test &#39;qiscus_room_id should be present&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">    	@chat_room.qiscus_room_id = &quot;         &quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">    	assert_not @chat_room.qiscus_room_id?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">	test &#39;user_id should be present&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="33">
          <span class="hits">1</span>
          
          <code class="ruby">    	@chat_room.user_id = &quot;         &quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="34">
          <span class="hits">1</span>
          
          <code class="ruby">    	assert_not @chat_room.user_id?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="36">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="37">
          <span class="hits">1</span>
          
          <code class="ruby">	test &#39;application_id should be present&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="38">
          <span class="hits">1</span>
          
          <code class="ruby">    	@chat_room.application_id = &quot;         &quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="39">
          <span class="hits">1</span>
          
          <code class="ruby">    	assert_not @chat_room.application_id?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="41">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="42">
          <span class="hits">1</span>
          
          <code class="ruby">	test &#39;target_user_id should be present&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="43">
          <span class="hits">1</span>
          
          <code class="ruby">    	@chat_room.target_user_id = &quot;         &quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="44">
          <span class="hits">1</span>
          
          <code class="ruby">    	assert_not @chat_room.target_user_id?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="46">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="47">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="6ccc3dbca789c9e7a97eb2ff9110babb5c633d62">
  <div class="header">
    <h3>test/models/chat_user_test.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>12</b> relevant lines. 
      <span class="green"><b>12</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;test_helper&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">class ChatUserTest &lt; ActiveSupport::TestCase</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">	setup do</code>
        </li>
      
        <li class="covered" data-hits="3" data-linenumber="5">
          <span class="hits">3</span>
          
          <code class="ruby">		@chat_user = ChatUser.new(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">			user_id: &#39;100&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">			chat_room_id: &#39;100&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">		)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">  	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">  	test &quot;should be valid&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">    	assert @chat_user.valid?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">  	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">  	test &#39;user_id should be present&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">    	@chat_user.user_id = &quot;         &quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">    	assert_not @chat_user.user_id?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">	test &#39;chat_room_id should be present&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">    	@chat_user.chat_room_id = &quot;         &quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">    	assert_not @chat_user.chat_room_id?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="d30decbde173754d61114d776724d1bcc555a638">
  <div class="header">
    <h3>test/models/comment_media_test.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>27</b> relevant lines. 
      <span class="green"><b>27</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;test_helper&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">class CommentMediaTest &lt; ActiveSupport::TestCase</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">	setup do</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="5">
          <span class="hits">8</span>
          
          <code class="ruby">		@comment_media = CommentMedia.new(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">			comment_id: 100,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">			content_type: &#39;image/jpeg&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">			media_type: &#39;image&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">			sub_type: &#39;jpeg&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">			size: &#39;7053&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">			original_filename: &#39;avatar.jpg&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">			compressed_link: &#39;http://res.cloudinary.com/qiscus/image/upload/q_60/v1/post_media_qisme_user_id_1/ueccavm1gyfzuhfwtcle&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">			link: &#39;http://res.cloudinary.com/qiscus/image/upload/v1494313786/post_media_qisme_user_id_1/ueccavm1gyfzuhfwtcle.jpg&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">		)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">  	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">  	test &quot;should be valid&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">    	assert @comment_media.valid?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">  	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">  	test &#39;content_type should be present&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">    	@comment_media.content_type= &quot;         &quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">    	assert_not @comment_media.content_type?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">  	test &#39;media_type should be present&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">    	@comment_media.media_type= &quot;         &quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">    	assert_not @comment_media.media_type?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">  	test &#39;sub_type should be present&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">    	@comment_media.sub_type= &quot;         &quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="33">
          <span class="hits">1</span>
          
          <code class="ruby">    	assert_not @comment_media.sub_type?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="36">
          <span class="hits">1</span>
          
          <code class="ruby">  	test &#39;size should be present&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="37">
          <span class="hits">1</span>
          
          <code class="ruby">    	@comment_media.size = &quot;         &quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="38">
          <span class="hits">1</span>
          
          <code class="ruby">    	assert_not @comment_media.size?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="41">
          <span class="hits">1</span>
          
          <code class="ruby">  	test &#39;original_filename should be present&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="42">
          <span class="hits">1</span>
          
          <code class="ruby">    	@comment_media.original_filename = &quot;         &quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="43">
          <span class="hits">1</span>
          
          <code class="ruby">    	assert_not @comment_media.original_filename?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="46">
          <span class="hits">1</span>
          
          <code class="ruby">  	test &#39;compressed_link should be present&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="47">
          <span class="hits">1</span>
          
          <code class="ruby">    	@comment_media.compressed_link = &quot;         &quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="48">
          <span class="hits">1</span>
          
          <code class="ruby">    	assert_not @comment_media.compressed_link?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="51">
          <span class="hits">1</span>
          
          <code class="ruby">  	test &#39;link should be present&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="52">
          <span class="hits">1</span>
          
          <code class="ruby">    	@comment_media.link = &quot;         &quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="53">
          <span class="hits">1</span>
          
          <code class="ruby">    	assert_not @comment_media.link?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="21d72370ce743bbe41aedaf90fac1148db50f4df">
  <div class="header">
    <h3>test/models/comment_test.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>15</b> relevant lines. 
      <span class="green"><b>15</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;test_helper&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">class CommentTest &lt; ActiveSupport::TestCase</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">	setup do</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="5">
          <span class="hits">4</span>
          
          <code class="ruby">		@comment = Comment.new(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">			user_id: 100,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">			post_id: 100,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">			content: &#39;This is a comment&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">		)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">  	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="12">
          <span class="hits">1</span>
          
          <code class="ruby">  	test &quot;should be valid&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">    	assert @comment.valid?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">  	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">  	test &#39;user_id should be present&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">    	@comment.user_id = &quot;         &quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">    	assert_not @comment.user_id?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">  	test &#39;post_id should be present&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">    	@comment.post_id = &quot;         &quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">    	assert_not @comment.comment_id?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">  	test &#39;comment should be present&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">    	@comment.content = &quot;         &quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">    	assert_not @comment.content?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="067ba9919b903c7abce36cb226e9aff5049e7050">
  <div class="header">
    <h3>test/models/contact_test.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>18</b> relevant lines. 
      <span class="green"><b>18</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;test_helper&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">class ContactTest &lt; ActiveSupport::TestCase</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">  setup do</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="5">
          <span class="hits">4</span>
          
          <code class="ruby">    @user1     = users(:user1)</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="6">
          <span class="hits">4</span>
          
          <code class="ruby">    @user2     = users(:user2)</code>
        </li>
      
        <li class="covered" data-hits="4" data-linenumber="7">
          <span class="hits">4</span>
          
          <code class="ruby">		@contact  = Contact.new(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">                user_id: @user1.id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">                contact_id: @user2.id,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">              )</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="13">
          <span class="hits">1</span>
          
          <code class="ruby">  test &quot;should be valid&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">    	assert @contact.valid?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">  	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">  test &#39;user_id should be present&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">    	@contact.user_id = nil</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">    	assert_not @contact.valid?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">  test &#39;contact_id should be present&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">    	@contact.contact_id = &quot;         &quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="24">
          <span class="hits">1</span>
          
          <code class="ruby">    	assert_not @contact.valid?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="26">
          
          
          <code class="ruby">  </code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">  test &#39;user_id and contact_id cant be same&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">    @contact.contact_id = @user1.id</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="29">
          <span class="hits">1</span>
          
          <code class="ruby">    assert_not @contact.valid?</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="30">
          <span class="hits">1</span>
          
          <code class="ruby">    refute_nil @contact.errors</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">  end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="32">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="067499bd0c163a88669702e91400e0ada36cfc0b">
  <div class="header">
    <h3>test/models/post_media_test.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>27</b> relevant lines. 
      <span class="green"><b>27</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;test_helper&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">class PostMediaTest &lt; ActiveSupport::TestCase</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">	setup do</code>
        </li>
      
        <li class="covered" data-hits="8" data-linenumber="5">
          <span class="hits">8</span>
          
          <code class="ruby">		@post_media = PostMedia.new(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">			post_id: 100,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">			content_type: &#39;image/jpeg&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">			media_type: &#39;image&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">			sub_type: &#39;jpeg&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">			size: &#39;7053&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">			original_filename: &#39;avatar.jpg&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">			compressed_link: &#39;http://res.cloudinary.com/qiscus/image/upload/q_60/v1/post_media_qisme_user_id_1/ueccavm1gyfzuhfwtcle&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">			link: &#39;http://res.cloudinary.com/qiscus/image/upload/v1494313786/post_media_qisme_user_id_1/ueccavm1gyfzuhfwtcle.jpg&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">		)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">  	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="17">
          <span class="hits">1</span>
          
          <code class="ruby">  	test &quot;should be valid&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">    	assert @post_media.valid?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">  	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="21">
          <span class="hits">1</span>
          
          <code class="ruby">  	test &#39;content_type should be present&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">    	@post_media.content_type= &quot;         &quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">    	assert_not @post_media.content_type?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">  	test &#39;media_type should be present&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">    	@post_media.media_type= &quot;         &quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">    	assert_not @post_media.media_type?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="31">
          <span class="hits">1</span>
          
          <code class="ruby">  	test &#39;sub_type should be present&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="32">
          <span class="hits">1</span>
          
          <code class="ruby">    	@post_media.sub_type= &quot;         &quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="33">
          <span class="hits">1</span>
          
          <code class="ruby">    	assert_not @post_media.sub_type?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="34">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="35">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="36">
          <span class="hits">1</span>
          
          <code class="ruby">  	test &#39;size should be present&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="37">
          <span class="hits">1</span>
          
          <code class="ruby">    	@post_media.size = &quot;         &quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="38">
          <span class="hits">1</span>
          
          <code class="ruby">    	assert_not @post_media.size?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="39">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="40">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="41">
          <span class="hits">1</span>
          
          <code class="ruby">  	test &#39;original_filename should be present&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="42">
          <span class="hits">1</span>
          
          <code class="ruby">    	@post_media.original_filename = &quot;         &quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="43">
          <span class="hits">1</span>
          
          <code class="ruby">    	assert_not @post_media.original_filename?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="44">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="45">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="46">
          <span class="hits">1</span>
          
          <code class="ruby">  	test &#39;compressed_link should be present&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="47">
          <span class="hits">1</span>
          
          <code class="ruby">    	@post_media.compressed_link = &quot;         &quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="48">
          <span class="hits">1</span>
          
          <code class="ruby">    	assert_not @post_media.compressed_link?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="49">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="50">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="51">
          <span class="hits">1</span>
          
          <code class="ruby">  	test &#39;link should be present&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="52">
          <span class="hits">1</span>
          
          <code class="ruby">    	@post_media.link = &quot;         &quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="53">
          <span class="hits">1</span>
          
          <code class="ruby">    	assert_not @post_media.link?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="54">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="55">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="56">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="969ab43ab22653aecdf4c69d4e3d52e06754a0b8">
  <div class="header">
    <h3>test/models/post_test.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>9</b> relevant lines. 
      <span class="green"><b>9</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;test_helper&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">class PostTest &lt; ActiveSupport::TestCase</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">	setup do</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="5">
          <span class="hits">2</span>
          
          <code class="ruby">		@post = Post.new(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">			user_id: 100,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">			content: &#39;This is new post&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">			post_id: 100,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">			is_shared_post: &#39;FALSE&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">			is_public_post: &#39;TRUE&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">		)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">  	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">  	test &quot;should be valid&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">    	assert @post.valid?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">  	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="18">
          <span class="hits">1</span>
          
          <code class="ruby">  	test &#39;user_id should be present&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="19">
          <span class="hits">1</span>
          
          <code class="ruby">    	@post.user_id = &quot;         &quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="20">
          <span class="hits">1</span>
          
          <code class="ruby">    	assert_not @post.user_id?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="22">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="23">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="a9f15db1e3be8af36fe7f2e99fbbb93745760648">
  <div class="header">
    <h3>test/models/role_test.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>9</b> relevant lines. 
      <span class="green"><b>9</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;test_helper&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">class RoleTest &lt; ActiveSupport::TestCase</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">	setup do</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="5">
          <span class="hits">2</span>
          
          <code class="ruby">		@role = Role.new(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">			name: &#39;New Role&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">		)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">  	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="10">
          <span class="hits">1</span>
          
          <code class="ruby">  	test &quot;should be valid&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="11">
          <span class="hits">1</span>
          
          <code class="ruby">    	assert @role.valid?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">  	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="14">
          <span class="hits">1</span>
          
          <code class="ruby">	test &#39;name should be present&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="15">
          <span class="hits">1</span>
          
          <code class="ruby">    	@role.name = &quot;         &quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="16">
          <span class="hits">1</span>
          
          <code class="ruby">    	assert_not @role.name?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="873bee41279604614faa73ef0d734744ca578219">
  <div class="header">
    <h3>test/models/user_test.rb</h3>
    <h4><span class="green">100.0 %</span> covered</h4>
    <div>
      <b>9</b> relevant lines. 
      <span class="green"><b>9</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>
  </div>
  
  <pre>
    <ol>
      
        <li class="covered" data-hits="1" data-linenumber="1">
          <span class="hits">1</span>
          
          <code class="ruby">require &#39;test_helper&#39;</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="2">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="3">
          <span class="hits">1</span>
          
          <code class="ruby">class UserTest &lt; ActiveSupport::TestCase</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="4">
          <span class="hits">1</span>
          
          <code class="ruby">	setup do</code>
        </li>
      
        <li class="covered" data-hits="2" data-linenumber="5">
          <span class="hits">2</span>
          
          <code class="ruby">		@user = User.new(</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="6">
          
          
          <code class="ruby">			phone_number: &#39;+6285123456789&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="7">
          
          
          <code class="ruby">			fullname: &#39;User 1&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="8">
          
          
          <code class="ruby">			email: &#39;user1@gmail.com&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="9">
          
          
          <code class="ruby">			gender: &#39;male&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="10">
          
          
          <code class="ruby">			date_of_birth: &#39;1990-01-01&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="11">
          
          
          <code class="ruby">			avatar_url: &#39;https://res.cloudinary.com/qiscus/image/upload/NITXR7pLhz/avatar.jpg&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="12">
          
          
          <code class="ruby">			application_id: &#39;1&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="13">
          
          
          <code class="ruby">			is_public: &#39;false&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="14">
          
          
          <code class="ruby">			verification_attempts: &#39;0&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="15">
          
          
          <code class="ruby">			qiscus_token: &#39;IaF7RqdC5xj96lfO8umL&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="16">
          
          
          <code class="ruby">			qiscus_email: &#39;userid_1_6285123456789@dummy.com&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="17">
          
          
          <code class="ruby">			description: &#39;Hello World!&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="18">
          
          
          <code class="ruby">			callback_url: &#39;&#39;,</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="19">
          
          
          <code class="ruby">		)</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="20">
          
          
          <code class="ruby">  	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="21">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="22">
          <span class="hits">1</span>
          
          <code class="ruby">  	test &quot;should be valid&quot; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="23">
          <span class="hits">1</span>
          
          <code class="ruby">    	assert @user.valid?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="24">
          
          
          <code class="ruby">  	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="25">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="26">
          <span class="hits">1</span>
          
          <code class="ruby">	test &#39;qiscus_email should be present&#39; do</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="27">
          <span class="hits">1</span>
          
          <code class="ruby">    	@user.qiscus_email = &quot;         &quot;</code>
        </li>
      
        <li class="covered" data-hits="1" data-linenumber="28">
          <span class="hits">1</span>
          
          <code class="ruby">    	assert_not @user.qiscus_email?</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="29">
          
          
          <code class="ruby">	end</code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="30">
          
          
          <code class="ruby"></code>
        </li>
      
        <li class="never" data-hits="" data-linenumber="31">
          
          
          <code class="ruby">end</code>
        </li>
      
    </ol>
  </pre>
</div>

      
      </div>
    </div>
  </body>
</html>
